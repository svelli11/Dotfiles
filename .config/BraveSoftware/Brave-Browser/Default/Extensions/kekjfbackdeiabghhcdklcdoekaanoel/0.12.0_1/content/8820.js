"use strict";(self.webpackChunkMALSync=self.webpackChunkMALSync||[]).push([[8820],{31481:(t,e,s)=>{s.d(e,{v:()=>c});var i=s(14424),a=s(19701),n=s(59465),r=s(90849),o=s(87217),h=s(70698),l=s(53728),u=s(48894),m=s(78584),d=s(26017),g=s(13647);class c extends i.D{constructor(t){return super(t),this.url=t,this.displayUrl="",this.shortName="AniList",this.authenticationUrl="https://anilist.co/api/v2/oauth/authorize?client_id=1487&response_type=token",this.logger=m.m(this.shortName,"#3db4f2"),this}handleUrl(t){if(t.match(/anilist\.co\/(anime|manga)\/\d*/i))return this.type="anime"===d.urlPart(t,3)?"anime":"manga",void(this.ids.ani=Number(d.urlPart(t,4)));if(t.match(/myanimelist\.net\/(anime|manga)\/\d*/i))return this.type="anime"===d.urlPart(t,3)?"anime":"manga",void(this.ids.mal=Number(d.urlPart(t,4)));throw new n.pH(t)}getCacheKey(){return this.getKey(["ANILIST"])}getPageId(){return this.ids.ani}_getStatus(){return parseInt(a.Fn[this.animeInfo.mediaListEntry.status])}_setStatus(t){this.animeInfo.mediaListEntry.status=a.Fn[t]}_getStartDate(){return a.u(this.animeInfo.mediaListEntry.startedAt)}_setStartDate(t){this.animeInfo.mediaListEntry.startedAt=a.Hl(t)}_getFinishDate(){return a.u(this.animeInfo.mediaListEntry.completedAt)}_setFinishDate(t){this.animeInfo.mediaListEntry.completedAt=a.Hl(t)}_getRewatchCount(){return this.animeInfo.mediaListEntry.repeat}_setRewatchCount(t){this.animeInfo.mediaListEntry.repeat=t}_getScore(){if(0===Number(this.animeInfo.mediaListEntry.score))return 0;const t=Math.round(Number(this.animeInfo.mediaListEntry.score)/10);return 0===t?1:t}_setScore(t){this.animeInfo.mediaListEntry.score=10*t}_getAbsoluteScore(){return Number(this.animeInfo.mediaListEntry.score)}_setAbsoluteScore(t){this.animeInfo.mediaListEntry.score=Number(t)}_getEpisode(){return this.animeInfo.mediaListEntry.progress}_setEpisode(t){this.animeInfo.mediaListEntry.progress=parseInt(`${t}`)}_getVolume(){return this.animeInfo.mediaListEntry.progressVolumes}_setVolume(t){this.animeInfo.mediaListEntry.progressVolumes=t}_getTags(){let t=this.animeInfo.mediaListEntry.notes;return null!==t&&"null"!==t||(t=""),t}_setTags(t){this.animeInfo.mediaListEntry.notes=t}_getTitle(){return this.animeInfo.title.userPreferred}_getTotalEpisodes(){const t=this.animeInfo.episodes?this.animeInfo.episodes:this.animeInfo.chapters;return null===t?0:t}_getTotalVolumes(){return this.animeInfo.volumes||0}_getDisplayUrl(){return""!==this.displayUrl&&null!==this.displayUrl?this.displayUrl:this.url}_getImage(){return a.Mv(this.animeInfo.coverImage.large)}_getRating(){return Promise.resolve(this.animeInfo.averageScore)}async _update(){let t=this.ids.mal,e="idMal";Number.isNaN(this.ids.mal)&&(t=this.ids.ani,e="id");const s=`\n    query ($id: Int, $type: MediaType) {\n      Media (${e}: $id, type: $type) {\n        id\n        idMal\n        siteUrl\n        episodes\n        chapters\n        volumes\n        averageScore\n        coverImage{\n          large\n        }\n        title {\n          userPreferred\n        }\n        mediaListEntry {\n          id\n          status\n          startedAt {\n            year\n            month\n            day\n          }\n          completedAt {\n            year\n            month\n            day\n          }\n          progress\n          progressVolumes\n          score(format: POINT_100)\n          repeat\n          notes\n        }\n      }\n    }\n    `,i={id:t,type:this.type.toUpperCase()};return this._authenticated=!0,this.apiCall(s,i).catch((t=>{if(t instanceof n.jH)return this._authenticated=!1,this.apiCall(s,i,!1);throw t})).then((t=>{if(this.logger.log("[SINGLE]","Data",t),this.animeInfo=t.data.Media,this.ids.ani=this.animeInfo.id,Number.isNaN(this.ids.mal)&&this.animeInfo.idMal&&(this.ids.mal=this.animeInfo.idMal),this.displayUrl=this.animeInfo.siteUrl,this._onList=!0,null===this.animeInfo.mediaListEntry&&(this._onList=!1,this.animeInfo.mediaListEntry={notes:"",progress:0,progressVolumes:0,repeat:0,score:0,status:"PLANNING",startedAt:{year:null,month:null,day:null},completedAt:{year:null,month:null,day:null}}),!this._authenticated)throw new n.jH("Not Authenticated")}))}async _sync(){let t="\n      mutation ($mediaId: Int, $status: MediaListStatus, $startedAt: FuzzyDateInput, $completedAt: FuzzyDateInput, $progress: Int, $scoreRaw: Int, $repeat: Int, $notes: String) {\n        SaveMediaListEntry (mediaId: $mediaId, status: $status, startedAt: $startedAt, completedAt: $completedAt, progress: $progress, scoreRaw: $scoreRaw, repeat: $repeat, notes: $notes) {\n          id\n          status\n          progress\n        }\n      }\n    ";const e={mediaId:this.ids.ani,status:this.animeInfo.mediaListEntry.status,startedAt:this.animeInfo.mediaListEntry.startedAt,completedAt:this.animeInfo.mediaListEntry.completedAt,progress:this.animeInfo.mediaListEntry.progress,scoreRaw:this.animeInfo.mediaListEntry.score,repeat:this.animeInfo.mediaListEntry.repeat,notes:this.animeInfo.mediaListEntry.notes,volumes:null};return"manga"===this.type&&(t="\n        mutation ($mediaId: Int, $status: MediaListStatus, $startedAt: FuzzyDateInput, $completedAt: FuzzyDateInput, $progress: Int, $scoreRaw: Int, $repeat: Int, $notes: String, $volumes: Int) {\n          SaveMediaListEntry (mediaId: $mediaId, status: $status, startedAt: $startedAt, completedAt: $completedAt, progress: $progress, scoreRaw: $scoreRaw, repeat: $repeat, notes: $notes, progressVolumes: $volumes) {\n            id\n            status\n            progress\n            progressVolumes\n          }\n        }\n      ",e.volumes=this.animeInfo.mediaListEntry.progressVolumes),this.apiCall(t,e).then((t=>(t&&t.data&&t.data.SaveMediaListEntry&&t.data.SaveMediaListEntry.id&&(this.animeInfo.mediaListEntry.id=t.data.SaveMediaListEntry.id),t)))}apiCall(t,e,s=!0){return a.H2(t,e,s)}getScoreMode(){switch(g.settings.get("anilistOptions").scoreFormat){case"POINT_100":return r.Q;case"POINT_3":return h.$;case"POINT_5":return l.L;case"POINT_10_DECIMAL":return u.X;default:return o.W}}_delete(){const t={mediaId:this.animeInfo.mediaListEntry.id};return this.apiCall("\n      mutation ($mediaId: Int) {\n        DeleteMediaListEntry(id: $mediaId) {\n          deleted\n        }\n      }\n    ",t)}}},71711:(t,e,s)=>{s.d(e,{v:()=>c});var i=s(14424),a=s(76003),n=s(39678),r=s(59465),o=s(87217),h=s(69803),l=s(13163),u=s(81102),m=s(78584),d=s(26017),g=s(13647);class c extends i.D{constructor(t){return super(t),this.url=t,this.shortName="Kitsu",this.authenticationUrl="https://kitsu.app/404?mal-sync=authentication",this.logger=m.m(this.shortName,"#d65e43"),this}listI(){return this.animeInfo.data[0]}animeI(){return this.animeInfo.included[0]}handleUrl(t){if(t.match(/kitsu\.app\/(anime|manga)\/.*/i))return this.type="anime"===d.urlPart(t,3)?"anime":"manga",void(this.ids.kitsu.slug=d.urlPart(t,4));if(t.match(/myanimelist\.net\/(anime|manga)\/\d*/i))return this.type="anime"===d.urlPart(t,3)?"anime":"manga",void(this.ids.mal=Number(d.urlPart(t,4)));throw new r.pH(t)}getCacheKey(){return this.getKey(["KITSU"])}getPageId(){return this.ids.kitsu.id}_getStatus(){return this.listI().attributes.reconsuming&&"current"===this.listI().attributes.status?n.h.Rewatching:parseInt(a.tG(this.listI().attributes.status))}_setStatus(t){t===n.h.Rewatching?(t=n.h.Watching,this.listI().attributes.reconsuming=!0):this.listI().attributes.reconsuming=!1,this.listI().attributes.status=a.tG(t,parseInt(t.toString()))}_getStartDate(){return a.kU(this.listI().attributes.startedAt)}_setStartDate(t){this.listI().attributes.startedAt=a.M7(t)}_getFinishDate(){return a.kU(this.listI().attributes.finishedAt)}_setFinishDate(t){this.listI().attributes.finishedAt=a.M7(t)}_getRewatchCount(){return this.listI().attributes.reconsumeCount}_setRewatchCount(t){this.listI().attributes.reconsumeCount=t}_getScore(){if(!this.listI().attributes.ratingHundred)return 0;const t=Math.round(this.listI().attributes.ratingHundred/10);return 0===t?1:t}_setScore(t){this.listI().attributes.ratingHundred=t?10*t:null}_getAbsoluteScore(){return Number(this.listI().attributes.ratingHundred)}_setAbsoluteScore(t){this.listI().attributes.ratingHundred=Number(t)}_getTwentyScore(){const t=this.listI().attributes.ratingHundred;return t?t<5?1:Math.round(t/5):null}_getEpisode(){return this.listI().attributes.progress}_setEpisode(t){this.listI().attributes.progress=parseInt(`${t}`)}_getVolume(){return this.listI().attributes.volumesOwned}_setVolume(t){this.listI().attributes.volumesOwned=t}_getTags(){let t=this.listI().attributes.notes;return null!==t&&"null"!==t||(t=""),t}_setTags(t){this.listI().attributes.notes=t}_getTitle(){try{return a.LK(this.animeI().attributes.titles,this.animeI().attributes.canonicalTitle)}catch(t){return console.error("title",t),"Failed"}}_getTotalEpisodes(){const t=this.animeI().attributes.episodeCount?this.animeI().attributes.episodeCount:this.animeI().attributes.chapterCount;return null===t?0:t}_getTotalVolumes(){return this.animeI().attributes.volumeCount||0}_getDisplayUrl(){return`https://kitsu.app/${this.getType()}/${this.animeI().attributes.slug}`}_getImage(){return this.animeI().attributes.posterImage&&this.animeI().attributes.posterImage.large?this.animeI().attributes.posterImage.large:""}_getRating(){return null===this.animeI().attributes.averageRating?Promise.resolve(""):Promise.resolve(`${this.animeI().attributes.averageRating}%`)}async _update(){if(Number.isNaN(this.ids.mal)){var t=await this.kitsuSlugtoKitsu(this.ids.kitsu.slug,this.getType());try{this.ids.kitsu.id=Number(t.res.data[0].id),this.ids.mal=Number(t.malId)}catch(t){throw this._authenticated=!0,new r.m_("Not found")}}if(Number.isNaN(this.ids.kitsu.id)){var e=await this.malToKitsu(this.ids.mal,this.getType());try{const t=e.data.find((t=>t.relationships.item.data.type===this.getType()));if(!t)throw new r.m_("Not found");this.ids.kitsu.id=Number(t.relationships.item.data.id)}catch(t){throw this._authenticated=!0,new r.m_(`No entry found for malId ${this.ids.mal}`)}}return this._authenticated=!0,this.userId().then((t=>this.apiCall("GET",`https://kitsu.app/api/edge/library-entries?filter[user_id]=${t}&filter[kind]=${this.getType()}&filter[${this.getType()}_id]=${this.ids.kitsu.id}&page[limit]=1&page[limit]=1&include=${this.getType()}&fields[${this.getType()}]=slug,titles,canonicalTitle,averageRating,posterImage,${"anime"===this.getType()?"episodeCount":"chapterCount,volumeCount"}`))).catch((t=>{if(t instanceof r.jH)return this._authenticated=!1,{data:[],included:[]};throw t})).then((async s=>{const i=s;this._onList=!0,s.data.length||(this._onList=!1,i.data[0]={attributes:{notes:"",progress:0,volumesOwned:0,reconsuming:!1,reconsumeCount:0,ratingTwenty:null,status:"planned",startedAt:null,finishedAt:null}},void 0!==e?i.included=e.included:t?i.included=t.res.data:(e=await this.malToKitsu(this.ids.mal,this.getType()),i.included=e.included)),i.data[0].attributes.ratingHundred?i.data[0].attributes.ratingHundred=0:i.data[0].attributes.ratingHundred=Number(5*i.data[0].attributes.ratingTwenty),this.animeInfo=i;try{this.animeI()}catch(t){throw this.logger.error(t),new r.m_("Not found")}if(!this._authenticated)throw new r.jH("Not Authenticated")}))}async _sync(){const t={data:{attributes:{notes:this.listI().attributes.notes,progress:this.listI().attributes.progress,volumesOwned:this.listI().attributes.volumesOwned,reconsuming:this.listI().attributes.reconsuming,reconsumeCount:this.listI().attributes.reconsumeCount,ratingTwenty:this._getTwentyScore(),status:this.listI().attributes.status,startedAt:this.listI().attributes.startedAt,finishedAt:this.listI().attributes.finishedAt},type:"library-entries"}},e=this.getType();if(!e)return Promise.resolve();let s,i;return this.isOnList()?(s=`https://kitsu.app/api/edge/library-entries/${this.listI().id}`,t.data.id=this.listI().id,i="PATCH"):(s="https://kitsu.app/api/edge/library-entries/",t.data.relationships={[e]:{data:{type:e,id:this.ids.kitsu.id}},user:{data:{type:"users",id:await this.userId()}}},i="POST"),this.logger.log(i,t),this.apiCall(i,s,t).then((t=>(t&&t.data&&t.data.id&&(this.listI().id=t.data.id),t)))}apiCall(t,e,s={},i=!0){return a.H2(t,e,s,i).catch((t=>{if(t instanceof r.jH)throw new r.jH(t.message);throw t}))}kitsuSlugtoKitsu(t,e){return this.apiCall("GET",`https://kitsu.app/api/edge/${e}?filter[slug]=${t}&page[limit]=1&include=mappings`,{}).catch((s=>{if(s instanceof r.jH)return this._authenticated=!1,this.apiCall("GET",`https://kitsu.app/api/edge/${e}?filter[slug]=${t}&page[limit]=1&include=mappings`,{},!1);throw s})).then((t=>{let s=NaN;if(void 0!==t&&void 0!==t.included)for(let i=0;i<t.included.length;i++){const a=t.included[i];if("mappings"===a.type){if(a.attributes.externalSite===`myanimelist/${e}`){s=Number(a.attributes.externalId),t.included.splice(i,1);break}a.attributes.externalSite===`anilist/${e}`&&(this.ids.ani=Number(a.attributes.externalId))}}return{res:t,malId:s}}))}malToKitsu(t,e){return this.apiCall("GET",`https://kitsu.app/api/edge/mappings?filter[externalSite]=myanimelist/${e}&filter[externalId]=${t}&include=item&fields[item]=id`,{}).catch((s=>{if(s instanceof r.jH)return this._authenticated=!1,this.apiCall("GET",`https://kitsu.app/api/edge/mappings?filter[externalSite]=myanimelist/${e}&filter[externalId]=${t}&include=item&fields[item]=id`,{},!1);throw s})).then((t=>t))}async userId(){const t=await g.storage.get("kitsuUserId");return void 0!==t&&t?t:this.apiCall("GET","https://kitsu.app/api/edge/users?filter[self]=true").then((t=>{if(void 0===t.data||!t.data.length||void 0===t.data[0])throw new r.jH("Not Authenticated");return g.storage.set("kitsuUserId",t.data[0].id),t.data[0].id}))}getScoreMode(){switch(g.settings.get("kitsuOptions").ratingSystem){case"simple":return l.g;case"regular":return u.x;case"advanced":return h.G;default:return o.W}}_delete(){return this.apiCall("DELETE",`https://kitsu.app/api/edge/library-entries/${this.listI().id}`)}}},15558:(t,e,s)=>{s.d(e,{v:()=>l});var i=s(14424),a=s(59465),n=s(39678),r=s(78584),o=s(26017),h=s(13647);class l extends i.D{constructor(t){return super(t),this.url=t,this.shortName="Local",this.authenticationUrl="",this.rewatchingSupport=!1,this.datesSupport=!1,this.logger=r.m(this.shortName,"black"),this}handleUrl(t){if(t.match(/local:\/\/.*/i))return this.id=o.urlPart(t,4),this.type="anime"===o.urlPart(t,3)?"anime":"manga",this.page=o.urlPart(t,2),this.key=`local://${this.page}/${this.type}/${this.id}`,void(o.urlPart(t,5)?this.title=decodeURIComponent(o.urlPart(t,5)):this.title="Unknown");throw new a.pH(t)}getCacheKey(){return`local:${this.id}:${this.page}`}getPageId(){return this.getCacheKey()}_getStatus(){return this.animeInfo.status}_setStatus(t){t!==n.h.Rewatching||this.supportsRewatching()||(t=n.h.Watching),this.animeInfo.status=t}_getStartDate(){throw new Error("Local sync does not support Start Date")}_setStartDate(t){throw new Error("Local sync does not support Start Date")}_getFinishDate(){throw new Error("Local sync does not support Finish Date")}_setFinishDate(t){throw new Error("Local sync does not support Finish Date")}_getRewatchCount(){throw new Error("Local sync does not support Rewatch Count")}_setRewatchCount(t){throw new Error("Local sync does not support Rewatch Count")}_getScore(){return this.animeInfo.score}_setScore(t){this.animeInfo.score=t}_getAbsoluteScore(){return 10*this.getScore()}_setAbsoluteScore(t){t?t<10?this.setScore(1):this.setScore(Math.round(t/10)):this.setScore(0)}_getEpisode(){return this.animeInfo.progress}_setEpisode(t){this.animeInfo.progress=parseInt(`${t}`)}_getVolume(){return this.animeInfo.volumeprogress}_setVolume(t){this.animeInfo.volumeprogress=t}_getTags(){let{tags:t}=this.animeInfo;return t||(t=""),t}_setTags(t){this.animeInfo.tags=t}_getTitle(t=!1){return t?this.animeInfo.name:`[L] ${this.animeInfo.name}`}_getTotalEpisodes(){return 0}_getTotalVolumes(){return 0}_getDisplayUrl(){return"https://github.com/MALSync/MALSync/wiki/Local-Sync"}_getImage(){return this.animeInfo&&this.animeInfo.image?this.animeInfo.image:""}setImage(t){this.animeInfo.image=t,this._onList&&this.sync()}_getRating(){return Promise.resolve("Local")}async _update(){this._authenticated=!0,this.animeInfo=await h.storage.get(this.key),this._onList=!0,this.animeInfo||(this._onList=!1,this.animeInfo={name:this.title,tags:"",sUrl:"",image:"",progress:0,volumeprogress:0,score:0,status:n.h.PlanToWatch})}async _sync(){return h.storage.set(this.key,this.animeInfo)}_delete(){return h.storage.remove(this.key)}setStreamingUrl(t){return this.animeInfo&&t&&(this.animeInfo.sUrl=t),super.setStreamingUrl(t)}getStreamingUrl(){return this.animeInfo&&this.animeInfo.sUrl?this.animeInfo.sUrl:super.getStreamingUrl()}}},90284:(t,e,s)=>{s.d(e,{v:()=>m});var i=s(14424),a=s(59465),n=s(70248),r=s(39678),o=s(19701),h=s(69099),l=s(78584),u=s(26017);class m extends i.D{constructor(t){return super(t),this.url=t,this.displayUrl="",this.pending=!1,this.shortName="MAL",this.authenticationUrl=n.As,this.apiCall=n.H2,this.logger=l.m(this.shortName,"#2e51a2"),this}handleUrl(t){if(t.match(/myanimelist\.net\/(anime|manga)\/\d*/i))return this.type="anime"===u.urlPart(t,3)?"anime":"manga",void(this.ids.mal=Number(u.urlPart(t,4)));throw new a.pH(t)}getCacheKey(){return this.ids.mal}getPageId(){return this.ids.mal}_getStatus(){let t;return t="manga"===this.type?parseInt(n.d2[this.animeInfo.my_list_status.status]):parseInt(n.fz[this.animeInfo.my_list_status.status]),this.getRewatching()&&t===r.h.Completed?r.h.Rewatching:t}_setStatus(t){t===r.h.Rewatching?(t=r.h.Completed,this.setRewatching(!0)):this.setRewatching(!1),"manga"!==this.type?this.animeInfo.my_list_status.status=n.fz[t]:this.animeInfo.my_list_status.status=n.d2[t]}increaseRewatchCount(){"manga"===this.type?this.animeInfo.my_list_status.num_times_reread++:this.animeInfo.my_list_status.num_times_rewatched++}_getStartDate(){return n.S6(this.animeInfo.my_list_status.start_date)}_setStartDate(t){this.animeInfo.my_list_status.start_date=t}_getFinishDate(){return n.S6(this.animeInfo.my_list_status.finish_date)}_setFinishDate(t){this.animeInfo.my_list_status.finish_date=t}_getRewatchCount(){return"manga"===this.type?this.animeInfo.my_list_status.num_times_reread:this.animeInfo.my_list_status.num_times_rewatched}_setRewatchCount(t){"manga"===this.type?this.animeInfo.my_list_status.num_times_reread=t:this.animeInfo.my_list_status.num_times_rewatched=t}_getScore(){return this.animeInfo.my_list_status.score}_setScore(t){this.animeInfo.my_list_status.score=t}_getAbsoluteScore(){return 10*this.getScore()}_setAbsoluteScore(t){t?t<10?this.setScore(1):this.setScore(Math.round(t/10)):this.setScore(0)}_getEpisode(){return"manga"===this.type?this.animeInfo.my_list_status.num_chapters_read:this.animeInfo.my_list_status.num_watched_episodes}_setEpisode(t){t||(t=0),"manga"!==this.type?this.animeInfo.my_list_status.num_watched_episodes=t:this.animeInfo.my_list_status.num_chapters_read=t}_getVolume(){return"manga"===this.type?this.animeInfo.my_list_status.num_volumes_read:0}_setVolume(t){"manga"===this.type&&(this.animeInfo.my_list_status.num_volumes_read=t)}_getTags(){return this.animeInfo.my_list_status.tags.length?this.animeInfo.my_list_status.tags.join(","):""}_setTags(t){t&&","!==t.trim()?this.animeInfo.my_list_status.tags=t.split(","):this.animeInfo.my_list_status.tags=[]}getRewatching(){return"manga"===this.type?this.animeInfo.my_list_status.is_rereading:this.animeInfo.my_list_status.is_rewatching}setRewatching(t){"manga"!==this.type?this.animeInfo.my_list_status.is_rewatching=t:this.animeInfo.my_list_status.is_rereading=t}_getTitle(){return this.animeInfo.title}_getTotalEpisodes(){return"manga"===this.type?this.animeInfo.num_chapters:this.animeInfo.num_episodes}_getTotalVolumes(){return"manga"===this.type?this.animeInfo.num_volumes:0}_getDisplayUrl(){return this.url}_getImage(){return this.animeInfo.main_picture?.medium??""}_getRating(){return Promise.resolve(this.animeInfo.mean)}async _update(){return this.apiCall({type:"GET",path:`${this.type}/${this.ids.mal}`,fields:["my_list_status{tags,is_rewatching,is_rereading,num_times_rewatched,num_times_reread,start_date,finish_date}","num_episodes","mean","num_chapters","num_volumes"]}).catch((t=>{throw t instanceof a.jH&&(this._authenticated=!1),t})).then((t=>{this.logger.m("Api").log(t),this._authenticated=!0,this.animeInfo=t,this._onList=!0,this.animeInfo.my_list_status||(this._onList=!1,"manga"===this.type?this.animeInfo.my_list_status={is_rereading:!1,num_chapters_read:0,num_volumes_read:0,num_times_reread:0,score:0,status:"plan_to_read",tags:[]}:this.animeInfo.my_list_status={is_rewatching:!1,num_watched_episodes:0,num_times_rewatched:0,score:0,status:"plan_to_watch",tags:[]}),this.animeInfo.my_list_status&&void 0!==this.animeInfo.my_list_status.num_episodes_watched&&(this.animeInfo.my_list_status.num_watched_episodes=this.animeInfo.my_list_status.num_episodes_watched,delete this.animeInfo.my_list_status.num_episodes_watched)}))}async _sync(){const t={};for(const e in this.animeInfo.my_list_status)switch(e){case"priority":case"num_watched_episodes":case"num_volumes_read":case"num_chapters_read":case"score":case"is_rewatching":case"is_rereading":case"num_times_rewatched":case"num_times_reread":case"rewatch_value":case"reread_value":case"tags":case"comments":case"status":t[e]=this.animeInfo.my_list_status[e];break;case"start_date":case"finish_date":t[e]=this.animeInfo.my_list_status[e]??""}return this.logger.m("Sync").log(this.ids.mal,t),this.apiCall({type:"PUT",path:`${this.type}/${this.ids.mal}/my_list_status`,dataObj:t}).then((t=>{this.logger.m("Sync").log("res",t)}))}_delete(){return this.apiCall({type:"DELETE",path:`${this.type}/${this.ids.mal}/my_list_status`})}async fillRelations(){const t=new h.l(`fillRelations/${this.ids.mal}/${this.getType()}`,6048e5);return t.hasValueAndIsNotEmpty().then((e=>e?t.getValue().then((t=>{t&&t.da&&parseInt(t.da)&&(this.ids.ani=parseInt(t.da))})):(0,o.kE)(this.ids.mal,this.getType()).then((e=>(e&&parseInt(e)&&(this.ids.ani=parseInt(e)),t.setValue({da:e}))))))}}},95190:(t,e,s)=>{s.d(e,{v:()=>i});const i=s(90284).v},87217:(t,e,s)=>{s.d(e,{W:()=>a});var i=s(13647);const a={ui:{module:"dropdown"},getOptions:()=>[{value:0,label:i.storage.lang("UI_Score_Not_Rated")},{value:100,label:i.storage.lang("UI_Score_Masterpiece")},{value:90,label:i.storage.lang("UI_Score_Great")},{value:80,label:i.storage.lang("UI_Score_VeryGood")},{value:70,label:i.storage.lang("UI_Score_Good")},{value:60,label:i.storage.lang("UI_Score_Fine")},{value:50,label:i.storage.lang("UI_Score_Average")},{value:40,label:i.storage.lang("UI_Score_Bad")},{value:30,label:i.storage.lang("UI_Score_VeryBad")},{value:20,label:i.storage.lang("UI_Score_Horrible")},{value:10,label:i.storage.lang("UI_Score_Appalling")}],valueToOptionValue:t=>t?t<10?10:10*Math.round(t/10):0,optionValueToValue:t=>t?Number(t):0}},90849:(t,e,s)=>{s.d(e,{Q:()=>a});var i=s(13647);const a={ui:{module:"input",pattern:"^([0-9]{1,2}|100)$"},getOptions(){const t=[{value:0,label:i.storage.lang("UI_Score_Not_Rated")}];for(let e=1;e<101;e++)t.push({value:e,label:String(e)});return t},valueToOptionValue:t=>t?Number(t):0,optionValueToValue:t=>t?Number(t):0}},48894:(t,e,s)=>{s.d(e,{X:()=>a});var i=s(13647);const a={ui:{module:"input",pattern:"^([0-9](\\.[0-9]?)?|10(.0)?)$"},getOptions(){const t=[{value:0,label:i.storage.lang("UI_Score_Not_Rated")}];for(let e=1;e<101;e++)t.push({value:e/10,label:(e/10).toFixed(1)});return t},valueToOptionValue:t=>t?Number(t/10):0,optionValueToValue:t=>t?Number(10*t):0}},81102:(t,e,s)=>{s.d(e,{x:()=>a});var i=s(13647);const a={ui:{module:"dropdown"},getOptions(){const t=[{value:0,label:i.storage.lang("UI_Score_Not_Rated")}];for(let e=1;e<11;e++)t.push({value:10*e,label:(e/2).toFixed(1).toString()});return t},valueToOptionValue:t=>t?t<10?10:10*Math.round(t/10):0,optionValueToValue:t=>t?Number(t):0}},69803:(t,e,s)=>{s.d(e,{G:()=>a});var i=s(13647);const a={ui:{module:"dropdown"},getOptions(){const t=[{value:0,label:i.storage.lang("UI_Score_Not_Rated")}];for(let e=2;e<21;e++)t.push({value:5*e,label:(e/2).toFixed(1).toString()});return t},valueToOptionValue:t=>t?t<10?10:5*Math.round(Number(t)/5):0,optionValueToValue:t=>t?Number(t):0}},70698:(t,e,s)=>{s.d(e,{$:()=>a});var i=s(13647);const a={ui:{module:"click",type:"smiley"},getOptions:()=>[{value:0,label:i.storage.lang("UI_Score_Not_Rated")},{value:85,label:"ðŸ™‚"},{value:60,label:"ðŸ˜"},{value:35,label:"ðŸ™"}],valueToOptionValue:t=>t?t>=73?85:t<=47?35:60:0,optionValueToValue:t=>t?Number(t):0}},13163:(t,e,s)=>{s.d(e,{g:()=>a});var i=s(13647);const a={ui:{module:"click",type:"smiley"},getOptions:()=>[{value:0,label:i.storage.lang("UI_Score_Not_Rated")},{value:100,label:"ðŸ˜€"},{value:70,label:"ðŸ™‚"},{value:40,label:"ðŸ˜"},{value:10,label:"ðŸ™"}],valueToOptionValue:t=>t?t<25?10:t<55?40:t<85?70:100:0,optionValueToValue:t=>t?Number(t):0}},53728:(t,e,s)=>{s.d(e,{L:()=>a});var i=s(13647);const a={ui:{module:"click",type:"star"},getOptions:()=>[{value:0,label:i.storage.lang("UI_Score_Not_Rated")},{value:90,label:"â˜…â˜…â˜…â˜…â˜…"},{value:70,label:"â˜…â˜…â˜…â˜…"},{value:50,label:"â˜…â˜…â˜…"},{value:30,label:"â˜…â˜…"},{value:10,label:"â˜…"}],valueToOptionValue:t=>t?t<20?10:t<40?30:t<60?50:t<80?70:90:0,optionValueToValue:t=>t?Number(t):0}},97886:(t,e,s)=>{s.d(e,{v:()=>l});var i=s(14424),a=s(27010),n=s(59465),r=s(87217),o=s(78584),h=s(26017);class l extends i.D{constructor(t){return super(t),this.url=t,this.shortName="Shiki",this.authenticationUrl=a.GC,this.datesSupport=!1,this.logger=o.m(this.shortName,"#3db4f2"),this}handleUrl(t){if(t.match(/shikimori\.one\/(animes|mangas|ranobe)\/\D?\d+/i)){this.type="animes"===h.urlPart(t,3)?"anime":"manga";const e=h.urlPart(t,4).match(/^\D?(\d+)/);if(e&&e[1])return void(this.ids.mal=Number(e[1]))}if(t.match(/myanimelist\.net\/(anime|manga)\/\d*/i))return this.type="anime"===h.urlPart(t,3)?"anime":"manga",void(this.ids.mal=Number(h.urlPart(t,4)));throw new n.pH(t)}getCacheKey(){return this.ids.mal}getPageId(){return this.ids.mal}_getStatus(){return a.Fn[this.animeInfo.status]}_setStatus(t){this.animeInfo.status=a.Fn[t]}_getStartDate(){throw new Error("Shikimori does not support Start Date")}_setStartDate(t){throw new Error("Shikimori does not support Start Date")}_getFinishDate(){throw new Error("Shikimori does not support Finish Date")}_setFinishDate(t){throw new Error("Shikimori does not support Finish Date")}_getRewatchCount(){return this.animeInfo.rewatches}_setRewatchCount(t){this.animeInfo.rewatches=t}_getScore(){return this.animeInfo.score}_setScore(t){this.animeInfo.score=t}_getAbsoluteScore(){return 10*this.getScore()}_setAbsoluteScore(t){t?t<10?this.setScore(1):this.setScore(Math.round(t/10)):this.setScore(0)}_getEpisode(){return"manga"===this.type?this.animeInfo.chapters:this.animeInfo.episodes}_setEpisode(t){"manga"!==this.type?this.animeInfo.episodes=parseInt(`${t}`):this.animeInfo.chapters=parseInt(`${t}`)}_getVolume(){return this.animeInfo.volumes}_setVolume(t){this.animeInfo.volumes=t}_getTags(){let t=this.animeInfo.text;return null!==t&&"null"!==t||(t=""),t}_setTags(t){this.animeInfo.text=t}_getTitle(){return a.DD(this.animeMeta.russian,this.animeMeta.name)}_getTotalEpisodes(){return("anime"===this.type?this.animeMeta.episodes:this.animeMeta.chapters)||0}_getTotalVolumes(){return this.animeMeta.volumes||0}_getDisplayUrl(){return this.animeMeta.url?`${a.bl}${this.animeMeta.url}`:this.url}_getImage(){return this.animeMeta.image.preview?`${a.bl}${this.animeMeta.image.preview}`:""}_getRating(){return Promise.resolve(this.animeMeta.score)}async _update(){const t=await a.J3(),e=await a.H2({path:`${this.type}s/${this.ids.mal}`,type:"GET"});if(!e.id)throw new n.m_(this.url);this.animeMeta=e;const s=await a.H2({path:"v2/user_rates",type:"GET",parameter:{target_id:this.ids.mal,user_id:t,target_type:"anime"===this.type?"Anime":"Manga"}});return s.length?(this._onList=!0,[this.animeInfo]=s):(this._onList=!1,this.animeInfo={user_id:t,target_id:this.ids.mal,target_type:"anime"===this.type?"Anime":"Manga",score:0,status:"planned",rewatches:0,episodes:0,volumes:0,chapters:0,text:""}),this._authenticated=!0,Promise.resolve()}async _sync(){const t=this._onList?"PUT":"POST",e=this._onList?`v2/user_rates/${this.animeInfo.id}`:"v2/user_rates";return a.H2({type:t,path:e,dataObj:{user_rate:this.animeInfo}})}getScoreMode(){return r.W}_delete(){return a.H2({type:"DELETE",path:`v2/user_rates/${this.animeInfo.id}`})}}},93215:(t,e,s)=>{s.d(e,{v:()=>l});var i=s(14424),a=s(78371),n=s(39678),r=s(59465),o=s(78584),h=s(26017);class l extends i.D{constructor(t){return super(t),this.url=t,this.episodeUpdate=!1,this.statusUpdate=!1,this.ratingUpdate=!1,this.minWatchedEp=1,this.curWatchedEp=0,this.shortName="Simkl",this.authenticationUrl=a.OT(),this.rewatchingSupport=!1,this.datesSupport=!1,this.syncList=a.Iy,this.getSingle=a.fe,this.call=a.T1,this.errorHandling=a.Q9,this.logger=o.m(this.shortName,"#9b7400"),this}handleUrl(t){if(t.match(/simkl\.com\/(anime|manga)\/\d*/i)){if(this.type="anime"===h.urlPart(t,3)?"anime":"manga",this.ids.simkl=parseInt(h.urlPart(t,4)),"manga"===this.type)throw"Simkl has no manga support"}else{if(!t.match(/myanimelist\.net\/(anime|manga)\/\d*/i))throw new r.pH(t);if(this.type="anime"===h.urlPart(t,3)?"anime":"manga",this.ids.mal=Number(h.urlPart(t,4)),"manga"===this.type)throw"Simkl has no manga support"}}getCacheKey(){return this.getKey(["SIMKL"])}getPageId(){return this.ids.simkl}_getStatus(){return parseInt(a.tG(this.animeInfo.status))}_setStatus(t){t===n.h.Rewatching&&(t=n.h.Watching),(t=a.tG(t,parseInt(t.toString())))!==this.animeInfo.status&&(this.statusUpdate=!0),this.animeInfo.status=t}_getStartDate(){throw new Error("Simkl does not support Start Date")}_setStartDate(t){throw new Error("Simkl does not support Start Date")}_getFinishDate(){throw new Error("Simkl does not support Finish Date")}_setFinishDate(t){throw new Error("Simkl does not support Finish Date")}_getRewatchCount(){throw new Error("Simkl does not support Rewatch Count")}_setRewatchCount(t){throw new Error("Simkl does not support Rewatch Count")}_getScore(){const t=this.animeInfo.user_rating;return null===t?0:t}_setScore(t){0===t&&(t=null),t!==this.animeInfo.user_rating&&(this.ratingUpdate=!0),this.animeInfo.user_rating=t}_getAbsoluteScore(){return 10*this.getScore()}_setAbsoluteScore(t){t?t<10?this.setScore(1):this.setScore(Math.round(t/10)):this.setScore(0)}_getEpisode(){return this._getStatus()===n.h.Completed?this._getTotalEpisodes():this.curWatchedEp}_setEpisode(t){t!==this.curWatchedEp&&(this.episodeUpdate=!0),this.curWatchedEp=t}_getVolume(){return 0}_setVolume(t){this.logger.error("You cant set Volumes for animes")}_getTags(){let t=this.animeInfo.private_memo;return null!==t&&"null"!==t||(t=""),t}_setTags(t){this.animeInfo.private_memo=t}_getTitle(){return this.animeInfo.show.title}_getTotalEpisodes(){const t=this.animeInfo.total_episodes_count;return null===t?0:t}_getTotalVolumes(){return 0}_getDisplayUrl(){return`https://simkl.com/${this.getType()}/${this.ids.simkl}`}_getImage(){return`https://simkl.in/posters/${this.animeInfo.show.poster}_ca.jpg`}async _getRating(){try{return(await this.call("https://api.simkl.com/ratings",{simkl:this.ids.simkl},!0)).simkl.rating}catch(t){return this.logger.error(t),"N/A"}}async _update(){let t;return t=Number.isNaN(this.ids.mal)?{simkl:this.ids.simkl}:{mal:this.ids.mal},this._authenticated=!0,this.getSingle(t).catch((t=>{if(t instanceof r.jH)return this._authenticated=!1,"";throw t})).then((async e=>{if(this.logger.log(e),this.episodeUpdate=!1,this.statusUpdate=!1,this.ratingUpdate=!1,this.animeInfo=e,this._onList=!0,!this.animeInfo){let e;if(this._onList=!1,t.simkl){if(e=await this.call(`https://api.simkl.com/anime/${t.simkl}`,{extended:"full"},!0),!e)throw new r.m_("Anime not found")}else{if(e=await this.call("https://api.simkl.com/search/id",t,!0),!e?.length)throw new r.m_("Anime not found");if(e[0].mal&&e[0].mal.type&&"Special"===e[0].mal.type)throw new Error("Is a special");e=e[0]}this.animeInfo={last_watched:"",last_watched_at:"",next_to_watch:"",not_aired_episodes_count:0,private_memo:"",status:"plantowatch",total_episodes_count:0,user_rating:null,watched_episodes_count:0,show:e},this.logger.log("Add anime",this.animeInfo)}if(Number.isNaN(this.ids.simkl)&&(this.ids.simkl=parseInt(this.animeInfo.show.ids.simkl)),Number.isNaN(this.ids.mal)&&void 0!==this.animeInfo.show.ids.mal&&(this.ids.mal=this.animeInfo.show.ids.mal),this.curWatchedEp=a.qm(this.animeInfo.last_watched),!this.curWatchedEp&&this.animeInfo.next_to_watch){const t=a.qm(this.animeInfo.next_to_watch);t&&(this.curWatchedEp=t-1)}if(this.minWatchedEp=this.curWatchedEp+1,!this._authenticated)throw new r.jH("Not Authenticated")}))}async _sync(){if(this.logger.log("[SET] Object:",this.animeInfo,"status",this.statusUpdate,"episode",this.episodeUpdate,"rating",this.ratingUpdate,"minWatchedEp",this.minWatchedEp,"curWatchedEp",this.curWatchedEp),this.statusUpdate||!this.isOnList()){const t=await this.call("https://api.simkl.com/sync/add-to-list",JSON.stringify({shows:[{to:this.animeInfo.status,ids:{simkl:this.ids.simkl}}]}),!1,"POST");this.logger.log("Status response",t)}if(this.episodeUpdate||!this.isOnList()){const t=this.curWatchedEp,e=[];if(this.minWatchedEp<=t){if(t){for(let s=this.minWatchedEp;s<=t;s++)e.push({number:s});const s=await this.call("https://api.simkl.com/sync/history",JSON.stringify({shows:[{ids:{simkl:this.ids.simkl},private_memo:this.animeInfo.private_memo,seasons:[{number:1,episodes:e}]}]}),!1,"POST");this.logger.log("Episode response",s)}}else{for(let s=this.minWatchedEp-1;s>t;s-=1)e.push({number:s});const s=await this.call("https://api.simkl.com/sync/history/remove",JSON.stringify({shows:[{ids:{simkl:this.ids.simkl},seasons:[{number:1,episodes:e}]}]}),!1,"POST");this.logger.log("Episode remove response",s)}this.minWatchedEp=t+1}if(this.ratingUpdate)if(this.animeInfo.user_rating){const t=await this.call("https://api.simkl.com/sync/ratings",JSON.stringify({shows:[{rating:this.animeInfo.user_rating,ids:{simkl:this.ids.simkl}}]}),!1,"POST");this.logger.log("Rating response",t)}else{const t=await this.call("https://api.simkl.com/sync/ratings/remove",JSON.stringify({shows:[{ids:{simkl:this.ids.simkl}}]}),!1,"POST");this.logger.log("Rating remove response",t)}this.episodeUpdate=!1,this.statusUpdate=!1,this.ratingUpdate=!1}_delete(){return this.call("https://api.simkl.com/sync/history/remove",JSON.stringify({shows:[{ids:{simkl:this.ids.simkl}}]}),!1,"POST")}}},14424:(t,e,s)=>{s.d(e,{D:()=>p});var i=s(39678),a=s(18770),n=s(71641),r=s(92959),o=s(64126),h=s(26017),l=s(59465),u=s(87217),m=s(78584),d=s(13647),g=s(26017),c=s(7263);Object.seal(r.P);class p{constructor(t){return this.url=t,this.type=null,this.syncMethod="normal",this.askCompleted=!1,this.rewatchingSupport=!0,this.datesSupport=!0,this.ids={mal:NaN,ani:NaN,kitsu:{id:NaN,slug:""},simkl:NaN},this.options=null,this.progress=!1,this.updateProgress=!1,this._onList=!1,this._authenticated=!1,this.handleUrl(t),this.logger=m.m("[S]","#348fff"),this}getType(){return this.type}getUrl(){return this.url}supportsRewatching(){return this.rewatchingSupport}supportsDates(){return this.datesSupport}getApiCacheKey(){return this.getKey(["ANILIST"])}getRulesCacheKey(){return this.getKey(["ANILIST","KITSU"],!1)}setStatus(t){return t=Number(t),this._setStatus(t),this}getStatus(){return this.isOnList()?this._getStatus():i.h.NoState}setStartDate(t){return this.supportsDates()&&this._setStartDate(t),this}getStartDate(){return this.supportsDates()?this._getStartDate():null}setFinishDate(t){return this.supportsDates()&&this._setFinishDate(t),this}getFinishDate(){return this.supportsDates()?this._getFinishDate():null}setRewatchCount(t){return this.supportsRewatching()&&this._setRewatchCount(t),this}getRewatchCount(){return this.supportsRewatching()?this._getRewatchCount():null}getScoreMode(){return u.W}setScore(t){return(t=parseInt(`${t}`))||(t=0),this._setScore(t),this}getScore(){return this._getScore()||0}setAbsoluteScore(t){return t=parseInt(`${t}`),this._setAbsoluteScore(t),this}getAbsoluteScore(){return this._getAbsoluteScore()||0}setEpisode(t){return t=parseInt(`${t}`),this.getTotalEpisodes()&&t>this.getTotalEpisodes()&&(t=this.getTotalEpisodes()),this._setEpisode(t),this}getEpisode(){return this._getEpisode()}setVolume(t){return this._setVolume(t),this}getVolume(){return this._getVolume()}setStreamingUrl(t){return this.options&&(this.options.u=t),this}getStreamingUrl(){if(this.options&&this.options.u)return this.options.u}cleanTags(){this.options=null}async initProgress(){const t=await(0,n.qx)(this.getType(),this.getApiCacheKey());return new a.k(this.getCacheKey(),this.getType()).init({uid:this.getCacheKey(),apiCacheKey:this.getApiCacheKey(),title:this.getTitle(),cacheKey:this.getCacheKey(),progressMode:this.getProgressMode(),watchedEp:this.getEpisode(),single:this,xhr:t}).then((e=>{this.updateProgress=!1,this.progress=e,this.progressXhr=t}))}getProgress(){return!!this.progress&&this.progress}getProgressFormated(){const t=[],e=new Intl.DisplayNames("en",{type:"language"});return m.log(this.progressXhr),this.progressXhr&&Object.keys(this.progressXhr).length&&this.progressXhr.forEach((s=>{t.push({type:s.type,key:s.id,state:s.state,label:e.of(s.lang.replace(/^jp$/,"ja"))||s.lang,dropped:"dropped"===s.state||"discontinued"===s.state,episode:s.lastEp&&s.lastEp.total?s.lastEp.total:0,lastEp:s.lastEp,predicition:s.prediction})})),t}getProgressOptions(){return this.getProgressFormated().filter((t=>"complete"!==t.state))}getProgressCompleted(){return this.getProgressFormated().filter((t=>"complete"===t.state))}getProgressMode(){return this.options&&this.options.p?this.options.p:""}setProgressMode(t){this.options&&(this.options.p=t,this.updateProgress=!0),d.settings.get("malTags")||g.setEntrySettings(this.type,this.getCacheKey(),this.options,this._getTags()).then((()=>this.initProgress()))}getProgressKey(){let t=this.getProgressMode();if(t||(t="anime"===this.getType()?d.settings.get("progressIntervalDefaultAnime"):d.settings.get("progressIntervalDefaultManga")),!t)return null;const e=/^([^/]*)\/(.*)$/.exec(t);return e?{key:t,lang:e[1],type:e[2]}:null}getPageRelations(){const t=this.shortName,e=[];return this.ids.mal&&"MAL"!==t&&e.push({name:"MAL",icon:"https://cdn.myanimelist.net/images/favicon.ico",link:`https://myanimelist.net/${this.type}/${this.ids.mal}`}),this.ids.ani&&"AniList"!==t&&e.push({name:"AniList",icon:"https://anilist.co/img/icons/favicon-32x32.png",link:`https://anilist.co/${this.type}/${this.ids.ani}`}),this.ids.kitsu.id&&"Kitsu"!==t&&e.push({name:"Kitsu",icon:"https://kitsu.app/favicon-32x32-3e0ecb6fc5a6ae681e65dcbc2bdf1f17.png",link:`https://kitsu.app/${this.type}/${this.ids.kitsu.id}`}),this.ids.simkl&&"Simkl"!==t&&e.push({name:"Simkl",icon:"https://eu.simkl.in/img_favicon/v2/favicon-32x32.png",link:`https://simkl.com/${this.type}/${this.ids.simkl}`}),e}fillRelations(){return Promise.resolve()}update(){return this.logger.log("[SINGLE]","Update info",this.ids),this.lastError=null,this._update().catch((t=>{throw this.lastError=t,t})).then((()=>(this.persistanceState=this.getStateEl(),g.getEntrySettings(this.type,this.getCacheKey(),this._getTags())))).then((t=>{this.options=t,this.registerEvent(),this.emitUpdate("state")}))}async sync(){return this.logger.log("[SINGLE]","Sync",this.ids),this.lastError=null,this._setTags(await g.setEntrySettings(this.type,this.getCacheKey(),this.options,this._getTags())),this.fixDates(),this._sync().catch((t=>{throw this.lastError=t,t})).then((()=>{this.undoState=this.persistanceState,this.updateProgress&&this.initProgress(),this._onList=!0,this.emitUpdate()}))}emitUpdate(t="update"){(0,r.n)(`${t}.${this.getCacheKey()}`,{id:this.getPageId(),type:this.getType(),cacheKey:this.getCacheKey(),state:this.getStateEl(),meta:{title:this.getTitle(),image:this.getImage(),malId:this.getMalId(),totalEp:this.getTotalEpisodes(),url:this.getUrl()}})}async delete(){return this._delete().then((()=>{this._onList=!1,(0,r.n)(`delete.${this.getCacheKey()}`,{id:this.getPageId(),type:this.getType(),cacheKey:this.getCacheKey()})}))}registerEvent(){this.globalUpdateEvent||(this.globalUpdateEvent=r.P.on(`update.${this.getCacheKey()}`,(t=>this.updateEvent(t))))}updateEvent(t){this.isDirty()?this.logger.log("Ignore event"):t&&t.state&&(this.setStateEl(t.state),this.persistanceState=this.getStateEl(),r.P.emit("syncPage_fillUi"))}isDirty(){return JSON.stringify(this.persistanceState)!==JSON.stringify(this.getStateEl())||this.updateProgress}undo(){if(this.logger.log("[SINGLE]","Undo",this.undoState),!this.undoState)throw new o.yR("No undo state found");if(!this.undoState.onList){if(void 0===this.delete)throw new Error("Deleting an entry is not supported");return this.delete().then((()=>{this.setStateEl(this.undoState),this.undoState=null}))}return this.setStateEl(this.undoState),this.sync().then((()=>{this.undoState=null}))}getTitle(t=!1){return this._getTitle(t)}getTotalEpisodes(){let t=this._getTotalEpisodes();return t||(t=0),t}getTotalVolumes(){return this._getTotalVolumes()}isOnList(){return this._onList}isAuthenticated(){return this._authenticated}getDisplayUrl(){return this._getDisplayUrl()}getMalUrl(){return Number.isNaN(this.ids.mal)?null:`https://myanimelist.net/${this.getType()}/${this.ids.mal}`}getMalId(){return Number.isNaN(this.ids.mal)?null:this.ids.mal}getIds(){return this.ids}getImage(){return this._getImage()}getRating(){return this._getRating().then((t=>t||"N/A"))}setResumeWatching(t,e){return g.setResumeWaching(t,e,this.type,this.getCacheKey())}getResumeWatching(){return this.options&&this.options.r?this.options.r:null}setContinueWatching(t,e){return g.setContinueWaching(t,e,this.type,this.getCacheKey())}getContinueWatching(){return this.options&&this.options.c?this.options.c:null}increaseRewatchCount(){}getStateEl(){return{onList:this.isOnList(),episode:this.getEpisode(),volume:this.getVolume(),status:this.getStatus(),startDate:this.getStartDate(),finishDate:this.getFinishDate(),rewatchCount:this.getRewatchCount(),score:this.getScore(),absoluteScore:this.getAbsoluteScore()}}setStateEl(t){this._onList=t.onList,this.setEpisode(t.episode),this.setVolume(t.volume),this.setStatus(t.status),this.setStartDate(t.startDate),this.setFinishDate(t.finishDate),this.setRewatchCount(t.rewatchCount),this.setScore(t.score),t.absoluteScore&&this.setAbsoluteScore(t.absoluteScore)}getStateDiff(){const t=this.getStateEl();if(t&&this.undoState){const e={};for(const s in t)t[s]!==this.undoState[s]&&(e[s]=t[s]);return e}}getSyncMethod(){return this.syncMethod}setSyncMethod(t){this.syncMethod=t}fixDates(){if(!this.supportsDates()||"listSync"===this.getSyncMethod())return;const t=(0,h.returnYYYYMMDD)();null===this.getStartDate()&&this._getStatus()===i.h.Watching&&this._getEpisode()>0&&this.setStartDate(t),null===this.getFinishDate()&&this._getStatus()===i.h.Completed&&(this.setFinishDate(t),null===this.getStartDate()&&this.setStartDate(t))}async lifeCycleHook(t){this.askCompleted&&("afterCheckSync"===t&&d.settings.get("askBefore")||"beforeSync"===t&&!d.settings.get("askBefore"))&&(this.askCompleted=!1,this.getStatus()===i.h.Rewatching?await this.finishRewatchingMessage():await this.finishWatchingMessage())}async checkSync(t,e){const s=this.getEpisode(),a=this.getStatus(),n=this.getVolume();return a===i.h.Completed?1===t&&this.startRewatchingMessage():!(s>=t&&!(void 0!==e&&(n||e>1||!t)&&e>n))&&(t&&t===this.getTotalEpisodes()?(this.askCompleted=!0,!0):a===i.h.Watching||a===i.h.Rewatching||this.startWatchingMessage())}async startWatchingMessage(){return g.flashConfirm(d.storage.lang(`syncPage_flashConfirm_start_${this.getType()}`),"add").then((t=>(t&&(this.setStatus(i.h.Watching),this.setStartDate((0,h.returnYYYYMMDD)())),t)))}async finishWatchingMessage(){const t=this.getScoreCheckboxValue();let e='<div><select id="finish_score" style="margin-top:5px; color:white; background-color:#4e4e4e; border: none;">';return this.getScoreCheckbox().forEach((s=>{e+=`<option value="${s.value}" ${t===s.value?"selected":""}>${s.label}</option>`})),e+="</select></div>",g.flashConfirm(d.storage.lang("syncPage_flashConfirm_complete")+e,"complete").then((t=>(t&&(this.setStatus(i.h.Completed),this.setFinishDate((0,h.returnYYYYMMDD)()),this.getStartDate()||this.setStartDate((0,h.returnYYYYMMDD)()),Number(c.$("#finish_score").val())>0&&(this.logger.log(`finish_score: ${c.$("#finish_score :selected").val()}`),this.handleScoreCheckbox(c.$("#finish_score :selected").val()))),t)))}async startRewatchingMessage(){return g.flashConfirm(d.storage.lang(`syncPage_flashConfirm_rewatch_start_${this.getType()}`),"add").then((t=>(t&&this.setStatus(i.h.Rewatching),t)))}async finishRewatchingMessage(){return g.flashConfirm(d.storage.lang(`syncPage_flashConfirm_rewatch_finish_${this.getType()}`),"complete").then((t=>(t&&(this.setStatus(i.h.Completed),this.increaseRewatchCount()),t)))}getScoreCheckbox(){return this.getScoreMode().getOptions()}getScoreCheckboxValue(){return this.getScoreMode().valueToOptionValue(this.getAbsoluteScore())}handleScoreCheckbox(t){this.setAbsoluteScore(this.getScoreMode().optionValueToValue(t))}getDisplayScoreCheckbox(){const t=this.getScoreCheckboxValue(),e=this.getScoreCheckbox().filter((e=>e.value===t));return e.length?e[0].label:""}getStatusCheckbox(){const t=[{value:i.h.Watching.toString(),label:d.storage.lang(`UI_Status_watching_${this.getType()}`)},{value:i.h.Completed.toString(),label:d.storage.lang("UI_Status_Completed")},{value:i.h.Onhold.toString(),label:d.storage.lang("UI_Status_OnHold")},{value:i.h.Dropped.toString(),label:d.storage.lang("UI_Status_Dropped")},{value:i.h.PlanToWatch.toString(),label:d.storage.lang(`UI_Status_planTo_${this.getType()}`)}];return this.supportsRewatching()&&t.push({value:i.h.Rewatching.toString(),label:d.storage.lang(`UI_Status_Rewatching_${this.getType()}`)}),t}handleStatusCheckbox(t){this.setStatus(t)}getStatusCheckboxValue(){return this.getStatus()}getKey(t,e=!0){return e&&this.ids.mal?this.ids.mal:this.ids.ani&&t.includes("ANILIST")?`anilist:${this.ids.ani}`:this.ids.kitsu.id&&t.includes("KITSU")?`kitsu:${this.ids.kitsu.id}`:this.ids.simkl&&t.includes("SIMKL")?`simkl:${this.ids.simkl}`:this.ids.mal}getLastError(){return this.lastError}getLastErrorMessage(){return this.errorMessage(this.getLastError())}flashmError(t){g.flashm(this.errorMessage(t),{error:!0,type:"error"})}errorMessage(t){return(0,l.gJ)(t,this.authenticationUrl)}}},59934:(t,e,s)=>{s.d(e,{f:()=>m});var i=s(91326),a=(s(69099),s(95190)),n=s(90284),r=s(31481),o=s(71711),h=s(93215),l=s(97886),u=s(15558);function m(t){if(/^local:\/\//i.test(t))return new u.v(t);const e=i.$(t);if("MAL"===e)return new a.v(t);if("MALAPI"===e)return new n.v(t);if("ANILIST"===e)return new r.v(t);if("KITSU"===e)return new o.v(t);if("SIMKL"===e)return new h.v(t);if("SHIKI"===e)return new l.v(t);throw"Unknown sync mode"}},64126:(t,e,s)=>{s.d(e,{yR:()=>i}),Error;class i extends Error{constructor(t){super(t),this.name="SafeError"}}Error,Error},81039:(t,e,s)=>{s.d(e,{A:()=>u});var i=s(20641),a=s(90033),n=s(22388),r=s(85577),o=s(72702);const h={class:"info"},l=(0,i.pM)({__name:"image-text",props:{href:{type:String,default:""},image:{type:String,default:""},imageType:{type:String,default:"round"},loading:{type:Boolean,default:!1}},setup:t=>(e,s)=>((0,i.uX)(),(0,i.CE)("div",{class:(0,a.C4)(["head",{loading:t.loading}])},[(0,i.bF)(o.A,{href:t.href,class:(0,a.C4)(["img",{[t.imageType]:!0}])},{default:(0,i.k6)((()=>["cover"===t.imageType?((0,i.uX)(),(0,i.Wv)(r.A,{key:0,loading:t.loading,src:t.image,class:"img-el",mode:"cover"},null,8,["loading","src"])):((0,i.uX)(),(0,i.CE)(i.FK,{key:1},[t.loading?(0,i.Q3)("v-if",!0):((0,i.uX)(),(0,i.Wv)(n.A,{key:0,src:t.image,class:"img-el"},null,8,["src"]))],64))])),_:1},8,["href","class"]),(0,i.Lk)("div",h,[(0,i.RG)(e.$slots,"default")])],2))}),u=(0,s(66262).A)(l,[["styles",["/* stylelint-disable prettier/prettier */\n/* Aspect ratios */\n/* Transitions */\n/* Typography */\n/* Shadows */\n/* Fonts */\n@keyframes skeleton-loading-malsync-0617b4bf {\nto {\n    transform: translateX(100%);\n}\n}\n.head[data-v-0617b4bf] {\n  display: flex;\n  gap: 20px;\n}\n.head .img[data-v-0617b4bf] {\n  width: calc(var(--base-font-size) * 6.25);\n  min-width: calc(var(--base-font-size) * 6.25);\n}\n.head .img.round[data-v-0617b4bf] {\n  box-shadow: 0 11px 21px rgba(0, 0, 0, 0.065), 0 4px 8px rgba(0, 0, 0, 0.1);\n  height: calc(var(--base-font-size) * 6.25);\n  border-radius: 50%;\n  overflow: hidden;\n}\n.head .img.round .img-el[data-v-0617b4bf] {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n}\n.head .info[data-v-0617b4bf] {\n  flex-grow: 1;\n  display: flex;\n  flex-direction: column;\n  justify-content: space-around;\n}\n.head.loading .img.round[data-v-0617b4bf] {\n  position: relative;\n  overflow: hidden;\n  transition: background-color 0.1s ease-in-out;\n  background-color: var(--cl-backdrop);\n}\n.head.loading .img.round[data-v-0617b4bf]::after {\n  opacity: var(--cl-loading);\n  transition: opacity 0.25s ease-in-out;\n  animation: skeleton-loading-malsync-0617b4bf 1.5s infinite;\n  content: '';\n  height: 100%;\n  left: 0;\n  position: absolute;\n  right: 0;\n  top: 0;\n  transform: translateX(-100%);\n  z-index: 1;\n  background: linear-gradient(90deg, hsla(0, 0%, 100%, 0), var(--cl-backdrop), hsla(0, 0%, 100%, 0));\n  filter: brightness(1.15);\n}\n.head.loading .info[data-v-0617b4bf] {\n  overflow: hidden;\n}\n"]],["__scopeId","data-v-0617b4bf"],["__file","image-text.vue"]])}}]);
//# sourceMappingURL=8820.js.map