(self.webpackChunk=self.webpackChunk||[]).push([[1330],{27341:(e,t,i)=>{i.d(t,{c:()=>s});var n=i(95804);const s=e=>e.isGateEnabled(n.K.KnowledgeHubGmail)},11550:(e,t,i)=>{i.d(t,{q:()=>n});var n,s=i(11633),o=i(21147);!function(e){let t;!function(e){e.codec=s.UQ(s.Z_,(e=>"string"==typeof e),"AnnotationId"),e.create=function(e){return e},e.eq=o.yv}(t=e.Id||(e.Id={})),e.eq=o.MW({id:t.eq,span:o.MW({s:o.lr,e:o.lr})})}(n||(n={}))},61266:(e,t,i)=>{i.d(t,{Lu:()=>o,hX:()=>n,jA:()=>s});var n,s,o,r=i(64297);!function(e){e.create=function(e){return e}}(n||(n={})),function(e){let t,i;!function(e){e.start="start",e.error="error",e.updateContextInfoFinished="updateContextInfoFinished",e.docFinished="docFinished",e.knowledgeHubItem="knowledgeHubItem"}(t=e.Kind||(e.Kind={})),e.isUpdateContextInfoFinished=function(e){return e.kind===t.updateContextInfoFinished},e.isDocFinished=function(e){return e.kind===t.docFinished},function(e){let i;e.isItem=function(e){return e.kind===t.knowledgeHubItem},function(e){e.create=e=>e,e.toAlertId=e=>e}(i=e.ItemId||(e.ItemId={}))}(i=e.KnowledgeHub||(e.KnowledgeHub={})),e.isKnowledgeHub=i.isItem}(s||(s={})),(0,r.L0)(void 0),function(e){e.LOOKED="LOOKED",e.IGNORE="IGNORE"}(o||(o={}))},40454:(e,t,i)=>{i.d(t,{I:()=>n,n:()=>s});var n,s,o=i(64297),r=i(21147);!function(e){let t,i;!function(e){e.knowledgeHubItem="knowledgeHubItem"}(t=e.Kind||(e.Kind={})),function(e){e.isItem=function(e){return e.kind===t.knowledgeHubItem}}(i=e.KnowledgeHub||(e.KnowledgeHub={}))}(n||(n={})),(0,o.L0)(void 0),function(e){e.eq=r.yv}(s||(s={}))},6164:(e,t,i)=>{i.r(t),i.d(t,{Gmail:()=>qi,getSiblingsContextEventObservable:()=>$i});var n=i(58303),s=i(90023),o=i(32073),r=i(8867),a=i(64271),d=i(44071),c=i(84308),l=i(84714),u=i(29416),h=i(59179),g=i(89408),p=i(90572),m=i(29479),f=i(954),b=i(20161),_=i(14683),v=i(27341),x=i(28777),w=i(13391),I=i(63532),C=i(68340),y=i(50750),S=i(36344),k=i(32082),E=i(45013),U=i(50809);class N{constructor(e,t,n,s,a,d=E.OB,c=k.Y.create("gmail.knowledgeHub.pageIntegration")){this._csState=n,this._csActions=s,this._felog=a,this._getEnv=d,this._logger=c,this.type=U.M.generalPurpose,this._subscriptions=new o.w0,this._knowledgeHubCSState=w.h.create(x.v3.get(this._csState.page.knowledgeHubSettings)),this._disposed=w.h.create(!1),this.disposed=this._disposed.view(),this._logger.info("Initing knowledgeHubIntegration",{csState:this._csState.page.knowledgeHubSettings}),this._subscriptions.add(this._knowledgeHubCSState.view((e=>e.enabled)).pipe(I.b((e=>this._logger.info("Integration state change. State: "+(e?"on":"off")))),b.w((n=>n?e.pipe(C.cp((({threadContext:e,checkingService:n,annotationsManager:o})=>y.D(Promise.all([i.e(8226),i.e(9689),i.e(6248),i.e(5123),i.e(8338),i.e(3695),i.e(8513)]).then(i.bind(i,83330))).pipe(b.w((({createKnowledgeHubThreadIntegration:i})=>new r.y((()=>{const r=i(n,o,e,t,a,s,this._knowledgeHubCSState,this._getEnv);return()=>r()})))))))):S.E))).subscribe()),this._logger.debug("Page integration created")}update(e){this._logger.debug("Received cs state update",e),this._knowledgeHubCSState.set(x.v3.get(e.page.knowledgeHubSettings))}dispose(){this._disposed.set(!0),this._subscriptions.unsubscribe(),this._logger.debug("Page integration disposed")}}var A,G=i(90944),z=i(3601),O=i(70016),M=i(26547),T=i(30821),R=i(95714),F=i(57702),j=i(41169),q=i(71497),L=i(55496),P=i(33148),D=i(10140),V=i(29052),H=i(93995),K=i(93342),$=i(2816);!function(e){const t="gmail_quote";function i(e){return e.classList.contains(t)&&"DIV"===e.tagName}function n(e){return"BLOCKQUOTE"===(n=e).tagName&&n.classList.contains(t)||function(e){var i;return e.classList.contains("gmail_attr")&&(null===(i=e.parentElement)||void 0===i?void 0:i.classList.contains(t))}(e)||function(e){var t,n,s;return i(e)&&"-----"===(null===(s=null===(n=null===(t=e.firstElementChild)||void 0===t?void 0:t.firstChild)||void 0===n?void 0:n.textContent)||void 0===s?void 0:s.slice(0,5))}(e);var n}function s(e,t){return!(!$.Z.defaultFilterNodeAllowingBlockquote(e,t)||(i=e,"false"===i.getAttribute("contenteditable")&&!i.getAttribute("email")))&&!n(e);var i}function o(e,t){return n(e)?{...t,blockquote:!0}:"BLOCKQUOTE"===e.tagName?{...t}:"gmail_signature"===(i=e).getAttribute("data-smartmail")||i.classList.contains("gmail_signature")?{...t,signature:!0}:$.Z.defaultNodeFormatting(e,t);var i}e.maybeGmailHistoryQuote=i,e.gmailNodeFormatting=o,e.createTextMap=e=>new $.Z(e,s,void 0,void 0,void 0,void 0,void 0,o)}(A||(A={}));var W=i(43264),B=i(14027),Y=i(98961),Q=i(95804),X=i(26585),Z=i(75558),J=i(91988),ee=i(86399),te=i(92135),ie=i(55341),ne=i(24666),se=i(3199),oe=i(12518),re=i(13102),ae=i(58623),de=i(66738),ce=i(64297),le=i(31491),ue=i(74822),he=i(8065),ge=i(85251),pe=i(17869),me=i(39256),fe=i(85156),be=i(84358),_e=i(21147),ve=i(61266);function xe(e){return(t,i)=>o=>(0,s.zG)(o,ae.cq(e)(t,(0,s.ls)(n.G,i)),n.fS((()=>(0,s.zG)(o,ae.ZQ(e)(t,i(n.YP))))))}var we=i(40454);const Ie=ve.jA.isKnowledgeHub,Ce=(e,t)=>(0,le.Kg)(((e,t)=>(0,le.W9)((0,le.Kg)(Ie,ve.jA.isDocFinished),(i=>i.updateContextInfoId===t&&i.docId===e)))(e,t),(e=>(0,le.W9)(ve.jA.isUpdateContextInfoFinished,(t=>t.updateContextInfoId===e)))(t));class ye{constructor(e,t=k.Y.create("StaticChecksStateManagerImpl")){this._messages=e,this._logger=t,this._subscriptions=new o.w0,this._updateRequests=new ue.x,this._checks=w.h.create(new Map),this._pendingUpdates=w.h.create(new Map),this._errors=w.h.create(new Map),this.checks=this._checks.view(),this.pendingUpdates=this._pendingUpdates.view(),this.errors=this._errors.view(),this._subscriptions.add(this._updateRequests.pipe(he.b((({docIds:e,updateContextInfoTask:t})=>l.of(...e.map((e=>({docId:e,updateContextInfoTask:t})))))),ge.v((e=>e.docId)),pe.z(b.w((({docId:e,updateContextInfoTask:t})=>this._handleUpdateContextInfoTask(e,t))))).subscribe())}updateChecksState(e,t){(0,s.zG)(t,oe.g_((t=>this._updateRequests.next({docIds:e,updateContextInfoTask:Promise.resolve(oe.t$(t))})),(t=>this._updateRequests.next({docIds:e,updateContextInfoTask:t}))))}dispose(){this._subscriptions.unsubscribe()}_handleUpdateContextInfoTask(e,t){return this._pendingUpdates.modify(ae.EG(re.e.eq)(e)),(0,s.zG)(y.D(t),b.w(oe.g_((t=>(this._logger.warn(`Error getting checks for ${e}`,t),this._errors.modify(Se(e,de.ri("all"),t)),S.E)),(t=>(this._pendingUpdates.modify(ae.ZQ(re.e.eq)(e,{updateContextInfoId:t,featureChecksCompleted:new Set})),this._handleUpdateContextInfoMessages(e,t))))))}_handleUpdateContextInfoMessages(e,t){return this._messages.pipe(p.h(Ce(e,t)),me.o((0,s.ff)(ve.jA.isUpdateContextInfoFinished)),fe.x((()=>{this._pendingUpdates.modify(ae.EG(re.e.eq)(e)),this._checks.modify((i=>{var n;return(null===(n=i.get(e))||void 0===n?void 0:n.updateContextInfoId)===t?i:(0,s.zG)(i,ae.EG(re.e.eq)(e))}))})),I.b((0,s.ls)(n.DT(ve.jA.isDocFinished),be.bw((({features:t,failed:i})=>this._featuresChecksCompleted(e,t,i))))),p.h(Ie),I.b((0,s.ls)(ke,be.bw(this._insertCheck(e,t)))))}_insertCheck(e,t){return i=>this._checks.modify(xe(re.e.eq)(e,(e=>(0,s.zG)(e,n.g_((()=>({updateContextInfoId:t,checks:[i]})),(e=>({updateContextInfoId:t,checks:[...e.checks,i]})))))))}_featuresChecksCompleted(e,t,i){this._pendingUpdates.modify((i=>(0,s.zG)(i,ae.cq(re.e.eq)(e,(e=>({updateContextInfoId:e.updateContextInfoId,featureChecksCompleted:de.G0(_e.yv)(t,e.featureChecksCompleted)}))),n.fS((()=>i))))),i&&(this._logger.warn(`CAPI error gettings checks for ${[...t].join(", ")} - ${e}`),this._errors.modify(Se(e,t,new Error(`CAPI failed getting checks for ${e}`))))}}function Se(e,t,i){return xe(re.e.eq)(e,n.g_((()=>new Map([...t].map((e=>[e,[i]])))),(e=>(0,s.zG)([...t],ee.u4(e,((e,t)=>(0,s.zG)(e,xe(we.n.eq)(t,n.g_((()=>ee.of(i)),ee.QI(i))))))))))}function ke(e){if(e.kind===ve.jA.Kind.knowledgeHubItem)return n.G({kind:we.I.Kind.knowledgeHubItem,id:e.id,span:e.span,docId:e.docId,termId:e.termId,headerText:e.headerText,headerIconSrc:e.headerIconSrc,articleTitle:e.articleTitle,aliases:e.aliases,articleContent:e.articleContent,pointPeople:e.pointPeople,relatedMaterials:e.relatedMaterials,suggestCorrectionUrl:e.suggestCorrectionUrl,grammsUrl:e.grammsUrl});(0,ce.L0)(e.kind)}var Ee,Ue,Ne=i(18117),Ae=i(10474);class Ge extends ce.sH{constructor(e){super(e)}}!function(e){e.eq=_e.MW({node:_e.w4,rev:_e.lr})}(Ee||(Ee={})),function(e){e.eqByDocId=_e.Uz((e=>e.id))(re.e.eq)}(Ue||(Ue={}));var ze=i(84178),Oe=i(15015),Me=i(88305);var Te=i(18342),Re=i(78129);class Fe{constructor(e,t){this._checkingService=e,this._threadContext=t,this._subscriptions=new o.w0,this._optedIn=new ie.t(1),this._staticChecksManager=new ye(this._checkingService.messages),this.sessionUuid=this._checkingService.sessionUuid,this.checks=this._staticChecksManager.checks,this.pendingUpdates=this._staticChecksManager.pendingUpdates,this.errors=this._staticChecksManager.errors;this._subscriptions.add(je(((e,t)=>this._staticChecksManager.updateChecksState(t,oe.t$(e))),this._optedIn,this._threadContext).subscribe((({docIds:e,docInfo:t})=>this._staticChecksManager.updateChecksState(e,oe.F2(this._checkingService.updateContextInfo(t))))))}sendKnowledgeHubFeedback(e){this._checkingService.sendKnowledgeHubFeedback(e)}dataOptIn(e){this._optedIn.next(e)}dispose(){this._subscriptions.unsubscribe(),this._staticChecksManager.dispose()}}function je(e,t,i){return i.view((e=>new Set(e.messageIndexToIdMap.values()))).pipe((0,Te.Gx)(t.pipe(ne.x())),se.R(((e,t)=>new Set(Array.from(e).concat(Array.from(t)))),new Set),(o=re.e.eq,(0,s.ls)(f.O(new Set),Re.G(),h.U((([e,t])=>de.e5(o)(e)(t))),p.h((e=>e.size>0)))),function(e,t=0){return i=>{const o=new ue.x;return(0,s.zG)(i,he.b((e=>y.D(Array.from(e)))),pe.z((t=>e.pipe(h.U((e=>(0,s.zG)(n.ij(e.expandedMessages.get(t)),n.g_(s.jv,Ae.d6)))),p.h(Me.fQ),ze.q(1),m.h(t)))),I.b((()=>o.next(void 0))),Oe.R((()=>o.pipe(u.b(t)))),h.U((e=>new Set(e))),p.h((e=>e.size>0)))}}(i),h.U((t=>(0,s.zG)([...t],ee.UI((t=>(0,s.zG)(function(e,t){return(0,s.zG)(oe.ij(new Ge(`message ${e} is not expanded`))(t.expandedMessages.get(e)),oe.tS((t=>Ae.d6(t)?oe.F2(t.value):oe.t$(new Ge(Ae.IR(t)?t.error.message:`message ${e} not extracted`)))),oe.tS((e=>Ne.Yt(oe.wE)({containerType:oe.F2("email"),docId:oe.F2(e.id),title:t.subject,delta:oe.F2(e.textMap.getRichText()),siblingIndex:oe.F2(e.index),authors:(0,s.zG)(t.loggedUser,oe.UI((t=>[{email:e.context.author.email,name:e.context.author.name,currentSessionUser:e.context.author.email===t.email}]))),audience:(0,s.zG)(t.loggedUser,oe.UI((t=>e.context.audience.map((e=>({email:e.email,name:e.email,currentSessionUser:e.email===t.email}))))),oe.tS((e=>Ne.Yt(oe.wE)({recipients:oe.F2(e),channelId:t.threadId,channelName:t.subject})))),metadata:oe.F2({email:e.context.metadata})}))))}(t,i.get()),oe.Vn((i=>e(i,[t]))),n.Uo))),ee.oA,te.c2,n.UI((e=>({docIds:(0,s.zG)(e,te.UI((e=>e.docId))),docInfo:{...e[0],siblings:e.slice(1)}})))))),C.oA);var o}var qe=i(89877),Le=i(62552),Pe=i(59833),De=i(93299),Ve=i(18827),He=i(88347),Ke=i(54115),$e=i(72106),We=i(6655),Be=i(47096),Ye=i(41048),Qe=i(39953),Xe=i(28214);class Ze{constructor(e,t){this._rpc=e,this._settings=t,this._token=this._rpc.startSession(this._settings),this.setSessionOption=(...e)=>this._token.then((t=>this._rpc.setSessionOption({token:t,args:e}))),this.ping=(...e)=>this._token.then((t=>this._rpc.ping({token:t,args:e}))),this.close=(...e)=>this._token.then((t=>this._rpc.close({token:t,args:e}))),this.sendFeedback=(...e)=>this._token.then((t=>this._rpc.sendFeedback({token:t,args:e}))),this.getStatus=(...e)=>this._token.then((t=>this._rpc.getStatus({token:t,args:e}))),this.getStatusObs=(...e)=>this._token.then((t=>this._rpc.getStatusObs({token:t,args:e}))),this.getEventsObs=(...e)=>this._token.then((t=>this._rpc.getEventsObs({token:t,args:e}))),this.connect=(...e)=>this._token.then((t=>this._rpc.connect({token:t,args:e}))),this.updateContextInfo=(...e)=>this._token.then((t=>this._rpc.updateContextInfo({token:t,args:e})))}dispose(){this._token.then((e=>this._rpc.stopSession(e)))}}var Je=i(18413);class et{constructor(e,t,i,s,o,r,a,d,c=E.OB,l=k.Y.create("StaticCAPIRpcConnection")){this._domainName=e,this._capiUrl=t,this._supportedFeatures=i,this._clientName=s,this._clientSubType=o,this._clientVersion=r,this._useDlp=a,this._startSessionOptions=d,this._getEnv=c,this._log=l,this._id=Je._.createWithRandomId("dn"),this._sessionUuid=null,this._initialSessionUuid=null,this._attemptingReconnect=!1,this._reconnectRequestIncludesReconnectInfo=!1,this._subscriptions=[],this._reconnectInfo=n.YP,this._reconnectionStatus=w.h.create(Ye.Td.ready),this._connectionStatus=w.h.create(Ye.QK.waitingForConnection),this.getStatusObs=()=>this._rpc.getStatusObs(),this.reconnect=(e=!0)=>(this.close("Need to reconnect"),e?(this._attemptingReconnect=!0,this._reconnectRequestIncludesReconnectInfo=n.pC(this._reconnectInfo),this._log.debug("[RECONNECT] Reconnecting to existing CAPI session")):(this._attemptingReconnect=!1,this._reconnectRequestIncludesReconnectInfo=!1,this._reconnectInfo=n.YP),this._reconnectionStatus.set(Ye.Td.inProgress),this._initRpcClient(),this._connectionStatus.set(Ye.QK.startingConnection),this._rpc.connect()),this.close=e=>{this._log.trace("Closing connection.",{reason:e}),this._rpc.close(e).catch((t=>{this._log.warn("Can't close api instance",{reason:e,error:t.message?t.message:JSON.stringify(t)})})),this._rpc.dispose(),this._cleanListeners(),this._connectionStatus.set(Ye.QK.waitingForReconnection)},this.getEventsObs=()=>this._rpc.getEventsObs(),this.sendFeedback=async e=>this._reconnectionStatus.get()===Ye.Td.reconnectRequired?(await this.reconnect(),this._rpc.sendFeedback(e)):this._rpc.sendFeedback(e),this.setSessionOption=async e=>this._reconnectionStatus.get()===Ye.Td.reconnectRequired?(await this.reconnect(),this._rpc.setSessionOption(e)):this._rpc.setSessionOption(e),this.updateContextInfo=async e=>this._reconnectionStatus.get()===Ye.Td.reconnectRequired?(await this.reconnect(),this._rpc.updateContextInfo(e)):this._rpc.updateContextInfo(e),this._onSessionStart=({sessionUuid:e,isNewSession:t,reconnectedInfo:i})=>{if(this._sessionUuid=e,t){if(this._log.debug(`[RECONNECT] Initing new session (${e})`),this._id=Je._.createWithRandomId("dn"),this._connectionStatus.set(Ye.QK.newSessionStarted),this._attemptingReconnect){const e=(0,Ye.x)(this._reconnectRequestIncludesReconnectInfo,i);(0,X.Tb)().sendFemetricsRate("reconnectToSessionFailed",{reconnectFailedReason:e}),this._log.debug("[RECONNECT] reconnect failed",e)}this._log.debug(`[RECONNECT] New session (${e})`)}else this._log.debug(`[RECONNECT] Continuing existing session (${e})`),this._connectionStatus.set(Ye.QK.existingSessionStarted),(0,X.Tb)().sendFemetricsRate("reconnectToSessionSuccess");this._attemptingReconnect=!1,this._initialSessionUuid=this._initialSessionUuid||e,this._reconnectionStatus.set(Ye.Td.ready)},this._initListeners=()=>{this._subscriptions.push(y.D(this.getEventsObs()).pipe(Ke.B()).subscribe((e=>{Xe.X.is("session_started")(e)?this._onSessionStart(e):Xe.X.is("reconnect_info_updated")(e)&&this._onReconnectInfo(e)})))},this._onReconnectInfo=e=>{this._log.debug("Update reconnect info",e.reconnectInfo),this._reconnectInfo=n.ij(e.reconnectInfo)},this._cleanListeners=()=>{this._subscriptions.forEach((e=>e.unsubscribe())),this._subscriptions=[]},this._initRpcClient=()=>{this._rpc=new Ze(this._getEnv().staticCapiBgRpc.api,{domain:this._domainName,capiUrl:this._capiUrl,supportedFeatures:this._supportedFeatures.includes(_.z.reconnect)?this._supportedFeatures:[...this._supportedFeatures,_.z.reconnect],clientName:this._clientName,clientSubType:this._clientSubType,clientVersion:this._clientVersion,startSessionOptions:{...this._startSessionOptions,...(0,Qe.zG)(this._reconnectInfo,n.g_((()=>this._initialSessionUuid?{reconnectInfo:{sessionUuid:this._initialSessionUuid}}:{}),(e=>({reconnectInfo:e}))))},useDlp:this._useDlp}),this._initListeners()},this._listenSWShutdown=()=>{this._getEnv().message.on("bgSW-shutdown",(()=>{this._reconnectionStatus.get()!==Ye.Td.reconnectRequired&&this._connectionStatus.get()!==Ye.QK.waitingForConnection&&(this._log.debug("[RECONNECT] Lost connection to service worker. Queuing up reconnection."),this._reconnectionStatus.set(Ye.Td.reconnectRequired))}))},this._initRpcClient(),this._listenSWShutdown()}get id(){return this._id}get sessionUuid(){return this._sessionUuid}get initialSessionUuid(){return this._initialSessionUuid}get connectionStatus(){return this._connectionStatus}}var tt=i(47056);class it{constructor(e,t=E.OB){this._staticCapiSettings=e,this._getEnv=t,this._subscriptions=[],this._connectionLevelSubscriptions=[],this._sessionUuid=w.h.create(n.YP),this._messages=new ue.x,this._logger=k.Y.create("StaticCheckingServiceImpl"),this._capi=new et(this._staticCapiSettings.domain,this._staticCapiSettings.capiUrl,this._staticCapiSettings.supportedFeatures,this._staticCapiSettings.clientName,this._staticCapiSettings.clientSubType,this._staticCapiSettings.clientVersion,this._staticCapiSettings.useDlp,this._staticCapiSettings.startSessionOptions,this._getEnv),this.messages=this._messages.asObservable(),this.sessionUuid=this._sessionUuid.view(),this._initConnectionLevelListeners=()=>{this._connectionLevelSubscriptions.push(y.D(this._capi.getStatusObs()).pipe(Ke.B()).subscribe((e=>this._logger.info("CAPI API",e)))),this._connectionLevelSubscriptions.push(y.D(this._capi.getEventsObs()).pipe(Ke.B()).subscribe((e=>{switch(e.kind){case"session_started":this._messages.next({kind:ve.jA.Kind.start,sessionUuid:ve.hX.create(e.sessionUuid),isNewSession:e.isNewSession}),this._sessionUuid.set(n.G(ve.hX.create(e.sessionUuid))),(0,s.zG)(this._sendContainerId(),$e.Vn((e=>this._logger.warn("Could not send containerId to CAPI",e))))();break;case"error":this._messages.next({kind:ve.jA.Kind.error,error:e.error,severity:e.severity});break;case"update_context_info_finished":this._messages.next({kind:ve.jA.Kind.updateContextInfoFinished,updateContextInfoId:e.updateContextInfoId});break;case"doc_finished":this._messages.next({kind:ve.jA.Kind.docFinished,updateContextInfoId:e.updateContextInfoId,docId:e.docId,features:new Set(e.features),failed:e.failed});break;case"reader_doc_info":case"reader_action_item":case"reader_main_point":case"reader_debug":case"reader_summary_item":case"reader_summary_finished":default:break;case"alert_received":{const t=(0,tt.IM)(e.alert,Je.Q.fromString(e.alert.rev.toString())),i=(0,Be.VI)(t);this._messages.next({id:ve.jA.KnowledgeHub.ItemId.create(e.alert.id),kind:ve.jA.Kind.knowledgeHubItem,docId:e.alert.docId,updateContextInfoId:e.alert.updateContextInfoId,span:{s:t.highlightRanges[0].start,e:t.highlightRanges[0].end},termId:i.termId,headerText:i.headerText,headerIconSrc:n.ij(i.headerIconSrc),articleContent:i.articleContent,articleTitle:i.articleTitle,aliases:i.aliases,pointPeople:i.pointPeople,relatedMaterials:i.relatedMaterials,suggestCorrectionUrl:i.suggestCorrectionUrl,grammsUrl:i.grammsUrl});break}}})))},this._cleanConnectionLevelListeners=()=>{this._connectionLevelSubscriptions.forEach((e=>e.unsubscribe()))},this._subscriptions.push(this._messages.subscribe((e=>this._logger.debug("Received CAPI message",e)))),this._initConnectionLevelListeners(),this._subscriptions.push(this._capi.connectionStatus.subscribe((e=>this._handleConnectionStatus(e))))}updateContextInfo(e){return this._logger.debug("Received updateContextInfo command",{docId:e.docId}),this._capi.updateContextInfo(e)}sendKnowledgeHubFeedback(e){const t={id:ve.jA.KnowledgeHub.ItemId.toAlertId(e.itemId),kind:nt(e.kind)};this._capi.sendFeedback(t)}dispose(e){this._subscriptions.forEach((e=>e.unsubscribe())),this._connectionLevelSubscriptions.forEach((e=>e.unsubscribe())),this._logger.trace("Closing connection.",{reason:e}),this._capi.close(e)}_sendContainerId(){return(0,s.zG)((()=>this._getEnv().bgRpc.api.getContainerIdOrUndefined("StaticCheckingService").then(oe.ij(new Error("Got undefined containerId")))),$e.UI((e=>()=>this._capi.setSessionOption({kind:We.rP.GnarContainerId,id:e}))))}_handleConnectionStatus(e){switch(e){case Ye.QK.startingConnection:this._initConnectionLevelListeners();break;case Ye.QK.waitingForConnection:case Ye.QK.newSessionStarted:case Ye.QK.existingSessionStarted:break;case Ye.QK.waitingForReconnection:this._cleanConnectionLevelListeners();break;default:(0,ce.L0)(e)}}}function nt(e){switch(e){case ve.Lu.IGNORE:return We.PZ.IGNORE;case ve.Lu.LOOKED:return We.PZ.LOOKED;default:return(0,ce.L0)(e)}}var st,ot=i(69088),rt=i(79451),at=i(69781),dt=i(49231),ct=i(47387),lt=i(14944),ut=i(81446),ht=i(47913),gt=i(66016),pt=i(89055),mt=i(84345),ft=i(88637),bt=i(29037),_t=i(25419),vt=i(23044),xt=i(57866),wt=i(49295);function It(e,t,i,n=!1,s=!1){const o=(0,q.Me)(e).body,r=(0,q.Jj)(e);let a={left:"0px",top:"0px"};if(t.fieldPaintingPositioning===vt.Q.nonPositioned&&t.positionedAncestor===o){const e=r.getComputedStyle(o);a={left:e.marginLeft||"0px",top:e.marginRight||"0px"}}else if(t.positionedAncestor!==o){const e=r.getComputedStyle(t.positionedAncestor);a={left:e.borderLeftWidth&&`-${e.borderLeftWidth}`||"0px",top:e.borderTopWidth&&`-${e.borderTopWidth}`||"0px"}}return o=>{o.style.position="absolute",o.style.top=a.top,o.style.left=n?"auto":a.left,s||(o.style.right=n?a.left:"auto",o.style.pointerEvents="none"),function({subjectElement:e,isPositioned:t,subjectElementStyle:i,integrationRoot:n,positionedAncestor:s}){t?(n.style.zIndex=i.zIndex,e.insertAdjacentElement("afterend",n)):s.insertAdjacentElement("afterbegin",n)}({subjectElement:e,isPositioned:t.fieldPaintingPositioning===vt.Q.positioned,subjectElementStyle:i,integrationRoot:o,positionedAncestor:t.positionedAncestor})}}function Ct(e){return gt.Pf.create({...e.client,...e.size})}class yt{constructor(e,t=!1,i){this._highlightsSubject=e,this._innerElementsInteractive=t,this._subscriptions=new o.w0,this._mouse=w.h.create({offset:null,client:null}),this._fakeMouse=w.h.create(null),this._prepareHighlights=(e,t=(0,q.is)(e))=>{const i=(0,q.o)(e),n=(0,xt.fL)(e,!1,i,t);return{layout:n,rootInjector:It(e,n,i)}},this._prepareInnerElements=(e,t=(0,q.is)(e),i)=>{const n=(0,q.o)(e),s=i||(0,xt.fL)(e,!1,n,t);return{layout:s,rootInjector:It(e,s,n,!0,this._innerElementsInteractive)}},this._highlights=this._prepareHighlights(this._highlightsSubject),this._innerElements=this._prepareInnerElements(this._highlightsSubject,void 0,this._highlights.layout),this._win=(0,q.Jj)(this._highlightsSubject),this._createTextNodeRect=e=>({page:R.Cv.fromClient(e.client,{top:this._win.scrollY,left:this._win.scrollX}),offset:e.offset,client:e.client,size:e.size,padding:e.padding}),this.textNode={rect:this._highlights.layout.textField.paddingRect.map(this._createTextNodeRect),visibleRect:this._highlights.layout.textField.visibleRect.map(this._createTextNodeRect),scroll:this._highlights.layout.textField.scroll,scrollSize:this._highlights.layout.textField.scrollSize,scroller:(0,F.iX)(this._highlightsSubject,{rect:this._highlights.layout.textField.paddingRect.map(this._createTextNodeRect),scrollSize:this._highlights.layout.textField.scrollSize})},this.highlightHeightOffset=0,this.mouse=w.h.combine(this._mouse,this._fakeMouse,((e,t)=>t||e)),this._subscriptions.add(c.a([this._highlights.layout.textField.paddingRect.behavior,this._highlights.layout.textField.scroll.behavior]).pipe((0,h.U)((([e,t])=>({rect:Ct(e),scroll:t}))),(0,b.w)((({rect:e,scroll:t})=>(0,G.Am)()?(0,mt.q7)(this._win,e,t):(0,mt.B0)(this._win,e,t))),(0,ne.x)(Me.fS)).subscribe(ut.wW(this._mouse))),i&&this._subscriptions.add(c.a([this._highlights.layout.textField.paddingRect.behavior,this._highlights.layout.textField.scroll.behavior]).pipe((0,h.U)((([e,t])=>({rect:Ct(e),scroll:t}))),(0,b.w)((({rect:e,scroll:t})=>i.pipe(h.U((i=>{if(i){const n=R.Ir.create({left:i.clientX,top:i.clientY});return{client:n,offset:gt.UL.contains(n,e)?R.p8.fromClientPoint(n,e,t):null}}return null}))))),(0,ne.x)(Me.fS)).subscribe(ut.wW(this._fakeMouse)))}createGeometryLayout(){return new pt.D((()=>Ct(this._highlights.layout.textField.paddingRect.getCurrent())),(()=>this._highlights.layout.textField.scroll.getCurrent()),(()=>Ct(this._highlights.layout.textField.paddingRect.getApproximate())),(()=>this._highlights.layout.textField.scroll.getApproximate()))}render(e,t){var i;const n=(0,q.Me)(this._highlightsSubject),s=null!==(i=t.highlightsLayoutMargin)&&void 0!==i?i:0,o=e.highlights&&ft.V.get({monitorAs:"highlights"}).inject(bt.EM.fromDocument(n,"grammarly-extension"),(e=>{this._highlights.rootInjector(e)}),_t.G7.showWhenLoaded(dt.createElement("div",{"data-grammarly-part":"highlights",style:{position:"absolute",top:0,left:0}},dt.createElement(wt.V,{layout:this._highlights.layout,margin:s},dt.createElement(ct.F.div,{style:this.textNode.scrollSize.behavior.pipe(h.U((e=>({position:"absolute",height:e.height,width:e.width,top:s,left:s}))))},dt.createElement(e.highlights,null)))))),r=e.innerElements&&ft.V.get({monitorAs:"inner-elements"}).inject(bt.EM.fromDocument(n,"grammarly-extension"),this._innerElements.rootInjector,_t.G7.showWhenLoaded(dt.createElement("div",{"data-grammarly-part":"inner-elements",style:{position:"absolute",top:0,right:0}},dt.createElement(ht.Lm,null),dt.createElement(e.innerElements,null)))),a=e.outerElements&&ft.V.get({monitorAs:"outer-elements"}).inject(bt.EM.fromDocument(n,"grammarly-extension"),bt.zs.appendChild(n.documentElement),_t.G7.showWhenLoaded(dt.createElement(e.outerElements,null)),{eventPropagationHandler:t.eventPropagationHandler});return{dispose:()=>{null==o||o.dispose(),null==a||a.dispose(),null==r||r.dispose()}}}dispose(){this._subscriptions.unsubscribe()}}!function(e){e.ord=lt.Uz((e=>e.order))(lt.Mh)}(st||(st={}));class St{constructor(e,t,i,n){this._docId=e,this._docNode=t,this._textMap=i,this._mouseOverride=n,this._views=new Map,this._rootView=null}addAnnotationsViewFactories(e){this._rootView=this._rootView||this._createRootView();for(const[t,i]of e){const e=i(this._docId,this._docNode,this._textMap,this._rootView.layout);this._views.set(t,e),this._rootView.cards.modify((i=>i.concat({id:t,view:e.cardsUI}))),this._rootView.highlights.modify((i=>i.concat({id:t,view:e.highlightsUI,order:e.highlightsLayerOrder})))}}removeAnnotationsView(e){var t;this._rootView&&(this._rootView.cards.modify(ee.hX((t=>t.id!==e))),this._rootView.highlights.modify(ee.hX((t=>t.id!==e)))),null===(t=this._views.get(e))||void 0===t||t.dispose(),this._views.delete(e),0===this._views.size&&this._clearRootView()}dispose(){this._views.forEach((e=>e.dispose())),this._clearRootView()}_clearRootView(){this._rootView&&(this._rootView.renderResult.dispose(),this._rootView.layout.dispose(),this._rootView=null)}_createRootView(){var e;const t=new yt(this._docNode,!0,null===(e=this._mouseOverride)||void 0===e?void 0:e.pipe(h.U(n.WG))),i=w.h.create([]),o=w.h.create([]);return{cards:i,highlights:o,layout:t,renderResult:t.render({highlights:()=>dt.createElement(ct.F.Fragment,null,o.view((0,s.ls)(ee.DY(st.ord),ee.UI((({id:e,view:t})=>dt.createElement(t,{key:e})))))),outerElements:()=>dt.createElement(ct.F.Fragment,null,i.view(ee.UI((({id:e,view:t})=>dt.createElement(t,{key:e})))))},{highlightsLayoutMargin:0})}}}var kt,Et=i(11550),Ut=i(16582),Nt=i(56218),At=i(82377),Gt=i(14554),zt=i(82129);class Ot{constructor(e=!0){this._collateLines=e}create(e,t){return{getRects:()=>{var i;const n=[];let o,r=e.start,a=!1;do{const s=t.getFragmentAtOrBeforeOffset(r);if(s&&o!==r){o=r;if(null===(i=s.node.textContent)||void 0===i?void 0:i.replace(/\s/g,"")){const i=zt.M.createRange(t,r,Math.min(s.endOffset,e.end));i&&n.push(...Array.from(i.getClientRects()))}r=s.endOffset===r?s.endOffset+1:s.endOffset}else a=!0}while(r<e.end&&!a);return(0,Qe.zG)(n,Gt.es,this._collateLines?Gt.yX:s.yR,Pe.UI(gt.Pf.create))}}}getClientRects(e){return e.getRects()}getIsInvalid(e){return!1}getIsConsistent(e,t,i){return!0}dispose(e){}}function Mt(e,t,i,o,r,a,d){const c=new Ot(!1),l=new Nt.C(c,o.createGeometryLayout(),(()=>a),(0,Ut.u)(),(0,At.WF)(o.textNode)),u=new Map,g=t.pipe(function(e){return(0,s.ls)(h.U(ae.P5(re.e.eq)(e)),f.O(n.YP),Re.G(),h.U((([e,t])=>(0,s.zG)(t,n.UI((t=>{const{removed:i,added:o}=function(e,t){const{left:i,right:n}=(0,s.zG)(at.yi(Et.q.eq)(new Map(e.map((e=>[e.id,e]))),new Map(t.map((e=>[e.id,e])))),rt.vh.reduce({left:[],right:[]},((e,t)=>({...e,left:e.left.concat(t)})),((e,t,i)=>({left:e.left.concat(t),right:e.right.concat(i)})),((e,t)=>({...e,right:e.right.concat(t)}))));return{removed:i,added:n}}((0,s.zG)(e,n.fS((()=>[]))),t);return{kind:"update",annotations:t,removed:i,added:o}})),n.Gk((()=>(0,s.zG)(e,n.UI((e=>({kind:"allRemoved",removed:e}))))))))),C.oA)}(e)).subscribe((t=>{if("allRemoved"===t.kind)l.removeHighlights(Array.from(u.values())),u.clear(),d.trace(`Annotations for ${e} cleared`);else if("update"===t.kind){const e=(0,s.zG)(t.removed,ee.UI((e=>e.id)),ee.u4([],((e,t)=>(0,s.zG)(u,ae.P5(Et.q.Id.eq)(t),n.g_((()=>e),(i=>(u.delete(t),e.concat(i))))))));e.length>0&&(l.removeHighlights(e),d.trace("Removed annotation highlights",e));const i=t.added.map((e=>{const t=At.y$.Id.create(e.id);return u.set(e.id,t),l.addHighlight(t,{start:e.span.s,end:e.span.e},{highlightId:t,annotation:e,highlightColor:null,highlightDisplayFormat:null,highlightLiveliness:null,alertId:""}),t}));i.length>0&&d.trace("Added annotation highlight",i)}else(0,ce.L0)(t)})),p=i({docId:e,docNode:r,docLayout:o,highlightsCollection:l});return{highlightsLayerOrder:p.highlightsLayerOrder,highlightsUI:p.highlightsUI,cardsUI:p.cardsUI,dispose:()=>{p.dispose(),g.unsubscribe(),l.dispose(),d.trace("Annotations view disposed")}}}!function(e){e.eq=_e.Uz((e=>({docId:e.docId,textNode:e.textNode})))(_e.MW({docId:re.e.eq,textNode:Ee.eq}))}(kt||(kt={}));class Tt{constructor(e,t,i=k.Y.create("gmail.annotationsManager")){this._messagesRoot=t,this._logger=i,this._subscriptions=new ot.Lv,this._nodesAndIntegrations=new Map,this._annotationsViewsFactories=new Map,this._textNodeToDocId=new WeakMap,this._hiddenDocs=new WeakMap,this._nodeChangesOverride=new ue.x,this._intersectionObserver=this._initIntersectionObserver(),this._mouseOverride=new Le.X(n.YP),this._subscriptions.add(a.T(e.pipe((0,s.ls)(f.O(new Map),Re.G(),h.U((([e,t])=>(0,s.zG)(at.yi(kt.eq)(e,t),rt.vh.reduce([],((e,{docId:t})=>e.concat({kind:"remove",docId:t})),((e,t,i)=>Ee.eq.equals(t.textNode,i.textNode)?e:e.concat({kind:"remove",docId:t.docId},{kind:"add",...i})),((e,t)=>e.concat({kind:"add",...t})))))),pe.z(s.yR))),this._nodeChangesOverride).subscribe((e=>{if("remove"===e.kind)(0,s.zG)(n.ij(this._nodesAndIntegrations.get(e.docId)),be.bw((e=>{e.integration.dispose(),this._textNodeToDocId.delete(e.textNode.node),this._intersectionObserver.unobserve(e.textNode.node)}))),this._nodesAndIntegrations.delete(e.docId),this._logger.trace(`Annotation integrations for ${e.docId} cleared`);else if("add"===e.kind){const t=new St(e.docId,e.textNode.node,e.textMap,this._mouseOverride);t.addAnnotationsViewFactories(this._annotationsViewsFactories),this._nodesAndIntegrations.set(e.docId,{docId:e.docId,textMap:e.textMap,textNode:e.textNode,integration:t}),this._textNodeToDocId.set(e.textNode.node,e.docId),this._intersectionObserver.observe(e.textNode.node)}else(0,ce.L0)(e)})))}createIntegration(e){const t=Me.iy.create(),i=(t,i,n,s)=>Mt(t,e.annotations,e.createAnnotationsView,s,i,n,this._logger);this._annotationsViewsFactories.set(t,i),this._nodesAndIntegrations.forEach((({integration:e})=>e.addAnnotationsViewFactories(new Map([[t,i]]))));const n=(e.mouseOverride||S.E).subscribe((e=>{this._mouseOverride.next(e)}));return{dispose:()=>{n.unsubscribe(),this._nodesAndIntegrations.forEach((({integration:e})=>e.removeAnnotationsView(t))),this._annotationsViewsFactories.delete(t)}}}_initIntersectionObserver(){return new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting?(0,s.zG)(n.ij(this._hiddenDocs.get(e.target)),be.bw((t=>{this._logger.debug(`Message ${t.docId} visible, restoring annotation integrations`),this._hiddenDocs.delete(e.target),this._nodeChangesOverride.next({kind:"add",...t})}))):(0,s.zG)(n.ij(this._textNodeToDocId.get(e.target)),n.tS((e=>n.ij(this._nodesAndIntegrations.get(e)))),be.bw((({docId:t,textNode:i,textMap:n})=>{this._logger.debug(`Message ${t} hidden, clearing annotation integrations`),this._nodeChangesOverride.next({kind:"remove",docId:t}),this._hiddenDocs.set(e.target,{docId:t,textNode:i,textMap:n}),this._intersectionObserver.observe(i.node)})))}))}),{root:this._messagesRoot})}dispose(){this._subscriptions.unsubscribe(),this._intersectionObserver.disconnect(),this._nodesAndIntegrations.forEach((({integration:e})=>e.dispose())),this._nodesAndIntegrations.clear(),this._annotationsViewsFactories.clear()}}var Rt=i(2613),Ft=i(9273),jt=i(45246);const qt='[role="main"] [data-thread-perm-id]',Lt='[role="main"] [role="list"]',Pt="data-message-id",Dt='[data-message-id] [jslog] > div[id^=":"]',Vt='span[title][role="gridcell"]',Ht='span[role="gridcell"] span[email][name]',Kt='span:not([role="gridcell"]) span[email][name]',$t="lang",Wt="html[lang]",Bt=`${Dt} a[href]`,Yt="h3 span[idlink][role=link]";var Qt,Xt,Zt;!function(e){e.empty=function(){return{messages:new Map,added:new Set,updated:new Set,removed:new Set}}}(Qt||(Qt={})),function(e){e.isExpanded=function(e){return n.pC(e.bodyNode)&&n.pC(e.id)}}(Xt||(Xt={})),function(e){e.eqByBodyNodeAndRev=_e.Uz((0,He.ei)("bodyNode"))(n.Eh(Ee.eq))}(Zt||(Zt={}));class Jt{constructor(e,t=k.Y.create("gmail.expandedMessages")){var i;this._messageList=e,this._logger=t,this._messageCount=w.h.create(ti(this._messageList).length),this.messageCount=this._messageCount.view(),this.expandedMessages=(i=this._messageList,new r.y((e=>{const t=new o.w0,a=new Map,d=new Le.X(new Map),c=new ue.x,u=new IntersectionObserver((e=>e.forEach((e=>{e.isIntersecting||c.next(e.target)}))),{root:null});return t.add(Y.x.create(i,{childList:!0}).pipe(h.U((e=>({added:e.flatMap((e=>Array.from(e.addedNodes))).filter(ii),removed:e.flatMap((e=>Array.from(e.removedNodes))).filter(ii)}))),f.O({added:ti(i),removed:new Array})).subscribe((({added:e,removed:t})=>{t.forEach((e=>{var t;null===(t=a.get(e))||void 0===t||t.unsubscribe(),d.next((0,s.zG)(ae.EG(_e.w4)(e)(d.value),ei(i)))})),e.forEach((e=>{var t;null===(t=a.get(e))||void 0===t||t.unsubscribe();const g=function(e,t,i){return new r.y((r=>{const a=new o.w0,d=new Le.X({bodyNode:(0,s.zG)(ni(i),n.UI((e=>({node:e,rev:0})))),id:si(i)});return n.Wi(d.value.bodyNode)&&a.add(Y.x.create(i,{attributes:!0,attributeFilter:["aria-expanded","tabindex"]}).pipe(h.U((()=>ni(i))),C.oA,ze.q(1)).subscribe((e=>d.next({bodyNode:n.G({node:e,rev:0}),id:(0,s.zG)(d.value.id,n.wp((()=>si(i))))})))),a.add(d.subscribe((({bodyNode:t,id:i})=>{(0,s.zG)(t,be.bw((t=>{e.observe(t.node)}))),r.next({bodyNode:t,id:i})}))),a.add(t.pipe(p.h((e=>(0,s.zG)(d.value.bodyNode,n.UI((e=>e.node)),be.FX(e))&&!document.contains(e)))).subscribe((t=>{e.unobserve(t),d.next({bodyNode:(0,s.zG)(ni(i),n.UI((e=>({node:e,rev:0})))),id:d.value.id})}))),()=>{a.unsubscribe()}})).pipe(b.w((({bodyNode:e,id:t})=>(0,s.zG)(e,n.g_((()=>l.of({bodyNode:n.YP,id:t})),(e=>Y.x.create(e.node,{subtree:!0,childList:!0,attributes:!1,characterData:!0}).pipe(se.R((e=>e+1),e.rev),f.O(0),h.U((i=>({bodyNode:n.G({node:e.node,rev:i}),id:t}))))))))))}(u,c,e).pipe(f.O({bodyNode:n.YP,id:n.YP}),Re.G()).subscribe((([{bodyNode:t},{bodyNode:o,id:r}])=>{n.pC(t)&&n.Wi(o)?d.next((0,s.zG)(ae.EG(_e.w4)(e)(d.value),ei(i))):d.next((0,s.zG)(d.value,ae.cq(_e.w4)(e,(e=>({...e,bodyNode:o,id:r}))),n.fS((()=>ae.ZQ(_e.w4)(e,{messageNode:e,bodyNode:o,id:r,index:d.value.size})(d.value)))))}));a.set(e,g)}))}))),t.add(d.subscribe((t=>e.next(t)))),()=>{t.unsubscribe();for(const e of a.values())e.unsubscribe();u.disconnect()}}))).pipe(I.b((e=>this._messageCount.set(e.size))),Rt.e(50),I.b((e=>this._logger.debug("message nodes map updated",e))),h.U(ae.hX(Xt.isExpanded)),Ft.shareReplay({bufferSize:1,refCount:!0}),f.O(ae.cS),Re.G(),h.U((([e,t])=>function(e,t){return(0,s.zG)(at.yi(Zt.eqByBodyNodeAndRev)(e,t),rt.vh.reduce({messages:new Map(Array.from(t.values()).map((e=>[e.id.value,{...e,id:e.id.value,bodyNode:e.bodyNode.value}]))),added:new Set,updated:new Set,removed:new Set},((e,t)=>({...e,removed:e.removed.add(t.id.value)})),((e,t,i)=>({...e,updated:e.updated.add(i.id.value)})),((e,t)=>({...e,added:e.added.add(t.id.value)}))))}(e,t))))}}function ei(e){const t=new Map(ti(e).map(((e,t)=>[e,t])));return e=>(0,s.zG)(e,ae.Su(((e,i)=>(0,s.zG)(n.ij(t.get(e)),n.g_((()=>i),(e=>({...i,index:e})))))))}function ti(e){return Array.from(e.children).filter(ii)}function ii(e){return e instanceof HTMLDivElement&&(e.matches("[aria-expanded]")&&!!e.innerText||!e.matches("[aria-expanded]"))}function ni(e){return(0,E.OB)().experimentClient.isGateEnabled(Q.K.FixGmailHouseCat)?(0,s.zG)(n.ij(document.contains(e)?e.querySelector(Dt):null),n.hX(jt.Re)):(0,s.zG)(n.ij(e.querySelector(Dt)),n.hX(jt.Re))}function si(e){var t,i;return n.ij(null===(i=null===(t=e.querySelector("[data-message-id]"))||void 0===t?void 0:t.getAttribute(Pt))||void 0===i?void 0:i.slice(1))}var oi=i(23964);var ri,ai,di,ci=i(55263),li=i(18767),ui=i(32734),hi=i(66878),gi=i(18519),pi=i(11633),mi=i(8783);!function(e){e.codec=pi.UQ(pi.Z_,(e=>"string"==typeof e&&e.trim().length>0),"LinkMIMEType"),e.create=function(t){return t?(0,s.zG)(e.codec.decode(t),n.Uo):n.YP}}(ri||(ri={})),function(e){e.codec=pi.UQ(pi.Z_,(e=>"string"==typeof e&&e.trim().length>0),"LinkURL"),e.create=function(t){return t?(0,s.zG)(e.codec.decode(t),n.Uo):n.YP},e.eq=_e.yv}(ai||(ai={})),function(e){e.hyperlink="hyperlink",e.email="email",e.attachment="attachment"}(di||(di={}));const fi=pi.OT(pi.dt({name:pi.Z_,url:ai.codec,type:mi.Dy.createStringEnum(di,"mailLinkType")})),bi=pi.jV([fi,pi.OT(pi.dt({type:pi.i0(di.email)}))]),_i=pi.jV([fi,pi.OT(pi.dt({type:pi.i0(di.hyperlink)}))]),vi=pi.jV([fi,pi.OT(pi.dt({type:pi.i0(di.attachment)})),pi.OT(pi.r$({mimeType:ri.codec}))]);var xi;!function(e){e.isAttachment=e=>e.type===di.attachment,e.codec=pi.G0([bi,_i,vi])}(xi||(xi={}));var wi=i(24576);function Ii(e){const t=[];e.querySelectorAll("table").forEach((e=>{0!==t.length&&t[t.length-1].contains(e)||t.push(e)}));const i=e.innerText.replace(/\s+/g,""),n=t.map((e=>e.innerText.replace(/\s+/g,"")));let s=i;for(const e of n)s=s.replace(e,"");const o=Math.max(0,Math.min(1,(i.length-s.length)/i.length));return Number.isNaN(o)?void 0:o}function Ci(e,t,i){return n=>new r.y((o=>{const r=n.pipe(li.u(),h.U((e=>({message:e}))),ui.B()).pipe(ge.v((e=>e.message.id)),pe.z((i=>i.pipe(b.w((i=>function(e,t,i){var n;const o=(0,s.zG)(oe.ij(new Ge("No message date found"))(null===(n=t.messageNode.querySelector(Vt))||void 0===n?void 0:n.getAttribute("title")),oe.UI((t=>(0,s.zG)(new Date(t),(i=>{var n;return Number.isNaN(i.valueOf())?{kind:"unparsedDate",date:t,locale:(null===(n=e.querySelector(Wt))||void 0===n?void 0:n.getAttribute($t))||void 0}:{kind:"parsedDate",timestamp:i.getTime()}}))))),r=(0,s.zG)(oe.ij(new Ge("No message author found"))(t.messageNode.querySelector(Ht)),oe.tS(yi)),a=(0,s.zG)(oe.ij(new Ge("No <to> field found in message"))(t.messageNode.querySelectorAll(Kt)),oe.tS((e=>(0,s.zG)(Array.from(e),Pe.UI(yi),Pe.IX.sequence(oe.wE),oe.tS((0,s.ls)(te.nI,oe.Yo((()=>new Ge("No audience found"))))))))),d=(0,s.zG)(t.messageNode.querySelector(Yt),(e=>oe.F2(!!e)));return c.a([l.of({date:o,author:r,audience:a,hasListUnsubscribeLink:d}),i(t.messageNode)]).pipe(h.U((([{date:e,author:i,audience:n,hasListUnsubscribeLink:s},o])=>Ne.Yt(oe.wE)({date:e,author:i,audience:n,links:oe.F2(o),hasListUnsubscribeLink:s,tableTextCoverage:oe.F2(Ii(t.bodyNode.node))}))))}(e,i.message,t).pipe(h.U((e=>({...i,messageId:i.message.id,domContext:e}))),function(e,t=6e3){return i=>i.pipe((0,Te.Vh)(t),hi.K((t=>l.of(e(t)))))}((e=>({...i,messageId:i.message.id,domContext:oe.t$(new Ge("DOM extraction timeout"+((0,wi.H)(e)?` [${e.message}]`:"")))}))),h.U((e=>({...e,type:"fromDOM"}))))))))),I.b((e=>(0,s.zG)(e.domContext,oe.g_((t=>i.warn(`DOM context extraction error for ${e.messageId}`,t)),(t=>i.trace(`DOM context extracted for ${e.messageId}`,t)))))),ui.B()),a=r.pipe(h.U((e=>({message:e.message,context:(0,s.zG)(e.domContext,oe.UI((e=>({author:e.author,audience:e.audience,date:e.date,links:e.links,metadata:{tableTextCoverage:e.tableTextCoverage,listUnsubscribe:e.hasListUnsubscribeLink?["has-unsubscribe-link"]:void 0,replyTo:void 0,contentType:void 0}}))))}))),I.b((e=>(0,s.zG)(e.context,oe.g_((t=>i.warn(`Context extraction error for ${e.message.id}`,t)),(t=>i.info(`Context extracted for ${e.message.id}`,t))))))).subscribe((e=>o.next(e)));return()=>a.unsubscribe()}))}function yi(e){return Ne.Yt(oe.wE)({email:(0,s.zG)(oe.ij(new Ge("No email found"))(null==e?void 0:e.getAttribute("email")),oe.tS((e=>oe.Yo((()=>new Ge("Invalid email address")))(ci.G.create(e))))),name:(0,s.zG)(oe.ij(new Ge("No name found"))(null==e?void 0:e.getAttribute("name")),oe.UI((e=>e||void 0)))})}function Si(e){return(0,s.zG)(Array.from(e.querySelectorAll(Bt)),Pe.DZ((0,s.ls)(n.DT((e=>!e.closest(".gmail_quote")&&!e.matches("a.gmail_plusreply"))),n.tS((e=>(0,s.zG)(ai.create(e.getAttribute("href")),n.UI((t=>({url:t,name:(0,s.zG)(n.ij(e.getAttribute("aria-label")),n.fS((()=>e.innerText.trim()))),type:t.startsWith("mailto:")?di.email:di.hyperlink})))))))))}function ki(e){return(0,s.zG)(n.ij(e),n.tS((e=>n.ij(/^([^:]+):([^:]+):(https?:\/\/.+)?(https?:\/\/.+)$/.exec(e)))),n.tS((([e,t,i,o,r])=>(0,s.zG)(ai.create(r),n.UI((e=>({name:decodeURIComponent(i),url:e,type:di.attachment,mimeType:n.FS(ri.create(t))})))))))}function Ei(e){return(0,s.zG)(ai.create(e.getAttribute("href")),n.UI((t=>{var i;return{name:e.getAttribute("data-tooltip")||(null===(i=e.querySelector("div"))||void 0===i?void 0:i.innerText)||e.innerText,url:t,type:di.attachment,mimeType:void 0}})))}function Ui(e){return c.a([l.of(Si(e)),(0,s.zG)(Array.from(e.querySelectorAll("a[role=link]")).map((e=>function(e,t=4e3){return(0,s.zG)(e.getAttribute("href")||"",n.DT((e=>!/^https?:\/\/docs\.google\.[^./]+\//.test(e))),n.UI((i=>new r.y((t=>{var i;(0,s.zG)(n.ij(null===(i=e.parentElement)||void 0===i?void 0:i.getAttribute("download_url")),n.hX((e=>!!e)),n.g_((()=>t.error("Attachment not found")),(()=>{t.next(!0),t.complete()})))})).pipe((0,Te.WV)(t/200,200),gi.V(t),hi.K((()=>l.of(!1))),h.U((t=>{var i;return(0,s.zG)(n.ij(null===(i=e.parentElement)||void 0===i?void 0:i.getAttribute("download_url")),n.tS(ki),n.wp((()=>Ei(e))))}))))),n.fS((()=>l.of(Ei(e)))),C.oA)}(e))),(e=>e.length>0?c.a(e):l.of([])))]).pipe(h.U((([e,t])=>Array.from(e.concat(t).reduce(((e,t)=>e.set(t.url,t)),new Map).values()))))}var Ni=i(30181),Ai=i(21001),Gi=i(10883),zi=i(98189),Oi=i(14969),Mi=i(36807),Ti=i(93415),Ri=i(5913),Fi=i(10918);var ji,qi,Li=i(25064);!function(e){function t(e){const t=e.ownerDocument&&e.ownerDocument.defaultView&&e.ownerDocument.defaultView.getComputedStyle(e);return!!t&&("auto"===t.overflow||"scroll"===t.overflow||"auto"===t.overflowY||"scroll"===t.overflowY||"auto"===t.overflowX||"scroll"===t.overflowX)}function i(e){const i=e.closest('div[style*="max-height"]'),n=i&&i.querySelector('div > div[style*="display:none"]');return i&&t(i)&&n?i:(0,Fi.dk)(e,50).find((e=>t(e)))||null}e.getComposeFieldContainer=i,e.hasOverlayAncestor=function(e){const t=e.closest("body > div");if(!t)return!1;const i=e.ownerDocument&&e.ownerDocument.defaultView&&e.ownerDocument.defaultView.getComputedStyle(t);return!!i&&"absolute"===i.position&&0===parseInt(i.top||"",10)&&0===parseInt(i.left||"",10)},e.getFormattingToolbarContainer=function(e){const t=e&&e.querySelector('div[aria-label="Formatting options"], div[role="toolbar"]');return t&&(t.closest('[style*="visibility"]')||t.closest('[style*="display"]'))},e.getSendButton=function(e){const t=e&&e.closest("table"),i=t&&t.querySelector("table[role=group] [aria-haspopup=true]");return i&&i.parentElement},e.getMinimizableComposeContainer=function(e){const t=e.closest('div[role="region"][aria-label]');return t&&t.parentElement&&t.parentElement.parentElement&&t.parentElement.parentElement.parentElement},e.getSubmitObservable=function(t,i){const n=e.getComposeFieldContainer(t),s=n?e.getSendButton(n):null,o=(0,Ti.O)().config.systemInfo.os.isMac,r=(0,d.R)(t,"keydown").pipe((0,p.h)((e=>13===e.keyCode&&e[o?"metaKey":"ctrlKey"]))),c=s?(0,d.R)(s,"click"):null;return(c?(0,a.T)(r,c):r).pipe((0,Gi.M)(null!=i?i:(0,l.of)(null)),(0,zi.n)((([e,t])=>{var i,n,s;return(null!==(s=null===(n=null===(i=null==t?void 0:t.docContextInfo.audience)||void 0===i?void 0:i.recipients)||void 0===n?void 0:n.length)&&void 0!==s?s:0)<1})),(0,ui.B)(),(0,ze.q)(1))};class o{constructor(){this._suggestionsSelectors=["[data-suggestion-text]"],this._underlinesSelectors=['[aria-invalid="spelling"]','[aria-invalid="grammar"]'],this._hideCallsCount=0}_getNativeSuggestionParent(){var e,t;const i=document.querySelector(this._suggestionsSelectors.join(",")),n=null===(t=null===(e=null==i?void 0:i.parentElement)||void 0===e?void 0:e.parentElement)||void 0===t?void 0:t.parentElement;return n instanceof HTMLElement&&"absolute"===n.style.position?n:null}_addStyles(e){this._styleEl=document.createElement("STYLE"),this._styleEl.innerHTML=(e?`.${e}{display: none !important}`:"")+this._underlinesSelectors.map((e=>`${e}{background: none !important}`)).join(""),document.head.appendChild(this._styleEl)}_removeStyles(){this._styleEl&&(this._styleEl.remove(),this._styleEl=null)}_cleanupSubscription(){this._popupContainerWaiter&&(this._popupContainerWaiter.unsubscribe(),this._popupContainerWaiter=null)}hide(){if(this._hideCallsCount++,1===this._hideCallsCount){const e=this._getNativeSuggestionParent();e?this._addStyles(e.className):(this._popupContainerWaiter=Y.x.observeChildList(document.body).pipe((0,h.U)((e=>this._getNativeSuggestionParent())),(0,Oi.P)((e=>!!e)),(0,ze.q)(1),(0,h.U)((e=>{this._removeStyles(),this._cleanupSubscription(),this._addStyles(e.className)}))).subscribe(),this._addStyles(null))}}show(){if(this._hideCallsCount--,0===this._hideCallsCount){this._cleanupSubscription(),this._removeStyles();const e=this._getNativeSuggestionParent();if(e){const t=e.querySelector(this._suggestionsSelectors.join(","));if(t&&t instanceof HTMLElement){const i=t.style.height;t.style.height="auto";const n=t.clientHeight,s=t.clientWidth;e.style.height=`${n}px`,e.style.width=`${s}px`,t.style.height=i}}}this._hideCallsCount<0&&(this._hideCallsCount=0)}}let r;function u(e,t,i){return e?Ri.S.sec1.pipe((0,f.O)(null),(0,h.U)(t),(0,Oi.P)((e=>!!e)),(0,ze.q)(1),(0,b.w)(i),(0,f.O)(null)):(0,l.of)(null)}e.hideNativeSuggestions=function(){r||(r=new o),r.hide()},e.showNativeSuggestions=function(){r&&r.show()},e.isCompose=function(t){const i=t.closest('[style*="float"]');return!!i&&(!(!t.ownerDocument||!t.ownerDocument.defaultView)&&"right"===t.ownerDocument.defaultView.getComputedStyle(i).cssFloat&&e.hasOverlayAncestor(t))},e.isFullscreenCompose=function(t){return e.hasOverlayAncestor(t)&&!e.isCompose(t)},e.isStandaloneCompose=function(e){return 0===e.ownerDocument.querySelectorAll('[role*="navigation"], [role*="complimentary"], [aria-label*="Hangouts"]').length},e.isComposeReply=function(e){const t=e.closest("[role=list]");return!!t&&!!t.querySelector("[data-message-id]")},e.isInConfidentialMode=function(e){const t=(i(e)||e).closest("table");return!!(null==t?void 0:t.querySelector('[aria-label="Turn off confidential mode"]'))};const m=e=>e?Y.x.observeStyle(e).pipe((0,f.O)(e.style),(0,h.U)((e=>"collapse"!==e.visibility&&"hidden"!==e.visibility&&"none"!==e.display)),(0,ne.x)(Me.fS),(0,h.U)((t=>({visible:t,el:e})))):(0,l.of)(null);e.createToolbarVisibleObservable=function(t){return u(t,(i=>t&&e.getFormattingToolbarContainer(t)),m)},e.createMinimizableComposeContainerVisibilityObservable=function(t){return u(t,(i=>t&&e.getMinimizableComposeContainer(t)),m)};const _="input[name=attach][type=hidden]",v="div[aria-label^='Uploading attachment:']";e.createAttachmentsListObservable=function(e){return u(e,(t=>{if(e){const t=(0,Fi.Yq)(e,1);return t?t.querySelector(_)||t.querySelector(v):null}return null}),(e=>{const t=(0,Fi.Yq)(e,3);return t?Y.x.observeChildList(t).pipe((0,f.O)(t.childNodes),(0,h.U)((e=>Array.from(e).filter((e=>!!(0,jt.Tv)(e)&&(!!e.querySelector(_)||!!e.querySelector(v)))).map((e=>e))))):(0,l.of)(null)}))},e.attachmentsMetricsObservable=(e,t,i)=>(0,c.a)(e,t,i,((e,t,i)=>{{const t={top:0,width:0};if(e&&e.length){const i=e[0].firstElementChild;if(i&&(0,jt.Tv)(i)&&"DIV"===i.nodeName){const e=i,n=e.offsetTop;if(n)return{top:n,width:e.offsetWidth};{const i=e.offsetParent;return i&&"DIV"===i.nodeName?{top:i.offsetTop,width:e.offsetWidth}:t}}return t}return t}}));const x=[{recipientNodeSelector:"[data-name]",authorNodeSelector:'header [role="button"] a[aria-label]',authorIndex:"first",recipientFromNode:(e,t)=>e.matches(t)?{name:e.getAttribute("data-name")||void 0,email:e.getAttribute("data-hovercard-id")||void 0}:null},{recipientNodeSelector:"input[name=to]",authorNodeSelector:'header a[role="button"][aria-label]',authorIndex:"last",recipientFromNode:(e,t)=>e.matches(t)?function(e){const t=/^[\"\']?([^\<\>\"\']+)[\"\']? \<(.+)\>/.exec(e);return t?{name:t[1],email:t[2]}:{email:e}}(e.value||""):null}];function w(e,t){return e.map((e=>x.reduce(((t,i)=>{if(t)return t;const n=i.recipientFromNode(e,i.recipientNodeSelector);return n?{...n,kind:S(e)}:null}),null))).filter((e=>Boolean(e&&(e.name||e.email)))).reduce(((e,t)=>(e.find((e=>e.email===t.email&&e.name===t.name))||e.push(t),e)),[]).map((e=>({...e,currentSessionUser:Boolean(t&&e.email===t.email)})))}function I(e,t){return(0,s.zG)(n.ij(document.querySelector(`[data-message-id="${e}"]`)),n.UI((e=>Array.from(e.querySelectorAll("[name][email][data-hovercard-id]")).slice(1))),n.UI((e=>e.map((e=>({name:e.getAttribute("name")||void 0,email:e.getAttribute("data-hovercard-id")||void 0,kind:"direct"}))).filter((e=>Boolean(e.name||e.email))).reduce(((e,t)=>(e.find((e=>e.email===t.email&&e.name===t.name))||e.push(t),e)),t?[t]:[]))),n.g_((()=>[]),s.yR))}function C(e,t){return(0,s.zG)(n.ij(document.querySelector(`[data-message-id="${e}"]`)),n.tS((e=>n.ij(e.querySelector("[name][email][data-hovercard-id]")))),n.UI((e=>({name:e.getAttribute("name")||void 0,email:e.getAttribute("data-hovercard-id")||void 0}))),n.hX((e=>Boolean(e.name||e.email))),n.UI((e=>({...e,currentSessionUser:Boolean(t&&e.email===t.email)}))),n.WG)}function y(e){const t=(e=>`[data-message-id="${e}"] [jslog] > div[id^=":"]`)(e);return(0,s.zG)(n.ij(document.querySelector(t)),n.hX(jt.Re),n.UI(Di),n.UI((e=>e.getRichText())),n.g_((()=>(new Mi.i).insert("")),s.yR))}function S(e){return e.closest("[name=to]")?"direct":e.closest("[name=cc]")?"indirect":e.closest("[name=bcc]")?"undisclosed":"direct"}function k(e,t){const i=(0,s.zG)(n.ij(null==e?void 0:e.rt),n.tS((e=>n.ij(e.value))),n.UI((e=>({docid:e,containerType:"email",authors:(0,s.zG)(n.ij(C(e,t)),n.g_(s.r5,(e=>[e]))),audience:{recipients:I(e,t)},delta:y(e)})))),o=(0,s.zG)(n.ij(null==e?void 0:e.rm),n.tS((e=>n.ij(e.value))),n.UI((e=>({docid:e,containerType:"email",authors:(0,s.zG)(n.ij(C(e,t)),n.g_(s.r5,(e=>[e]))),parents:(0,s.zG)(i,n.g_(s.r5,(e=>[e]))),audience:{recipients:I(e,t)},delta:y(e)}))));return(0,s.zG)(o,n.wp((()=>i)),n.WG)}e.getRecipientsNodes=function(e){return x.slice(1).reduce(((t,i)=>t.length?t:e.querySelectorAll(i.recipientNodeSelector)),e.querySelectorAll(x[0].recipientNodeSelector))},e.getRecipientsFromComposeNodes=w,e.getRecipientsFromParentMessage=I,e.getAuthorFromParentMessage=C,e.getTextFromParentMessage=y,e.getAuthor=function(){var e;const t=x.reduce(((e,t)=>{if(e)return e;const i=document.querySelectorAll(t.authorNodeSelector);return i?i["first"===t.authorIndex?0:i.length-1]:null}),null);if(t){const i=Li.l((null===(e=t.attributes.getNamedItem("aria-label"))||void 0===e?void 0:e.value)||"");return i?{...i,currentSessionUser:!0}:null}return null},e.getAuthorDomain=function(){const t=e.getAuthor();return(null==t?void 0:t.email)?qe.X.getDomainFromEmail(t.email):null},e.getAuthorContextEventObservable=function(e){return(0,l.of)(e).pipe((0,p.h)(Me.fQ),(0,h.U)((e=>V.t.createDocContextUpdatedEvent({authors:[e]}))))},e.getRecipientKind=S,e.getRecipientsContextEventObservable=function(t,i){return Y.x.createUnsafe(t,{childList:!0,subtree:!0}).pipe((0,p.h)((e=>Array.from(e).some((e=>Array.from(e.removedNodes).filter((e=>"querySelector"in e)).some((e=>x.some((t=>e.querySelector(t.recipientNodeSelector)))))||Array.from(e.addedNodes).filter((e=>"getAttribute"in e)).some((e=>x.some((t=>e.matches(t.recipientNodeSelector))))))))),(0,h.U)((i=>e.getRecipientsNodes(t)))).pipe((0,f.O)(e.getRecipientsNodes(t)),(0,h.U)((e=>Array.from(e))),(0,h.U)((e=>w(e,i))),(0,g.d)({bufferSize:1,refCount:!0}))},e.getParentsContext=k,e.getParentsContextEventObservable=function(e,t){const i=k(e,t);return i?(0,l.of)(i).pipe((0,h.U)((e=>V.t.createDocContextUpdatedEvent({parents:[e]})))):null}}(ji||(ji={}));class Pi{constructor(e,t,i,r,a=k.Y.create("gmail.threadContext")){this._doc=e,this._expandedMessagesProvider=t,this._telemetry=r,this._logger=a,this._subscriptions=new o.w0,this._state=w.h.create((0,s.zG)(function(e){const t=oe.ij(new Ge("Cannot find thread subject container"))(e.querySelector(qt));return{threadId:(0,s.zG)(t,oe.tS((e=>oe.ij(new Ge("Cannot find thread ID"))(e.getAttribute("data-thread-perm-id"))))),subject:(0,s.zG)(t,oe.tS((e=>oe.ij(new Ge("Cannot find thread Subject"))(e.textContent)))),loggedUser:(0,s.zG)(oe.ij(new Ge("Cannot extract user from avatar"))(ji.getAuthor()),oe.tS((e=>(0,s.zG)(ci.G.create(e.email),n.UI((t=>({name:e.name?e.name:void 0,email:t}))),oe.Yo((()=>new Ge("No email address found in avatar")))))))}}(this._doc),(e=>({threadId:e.threadId,subject:e.subject,loggedUser:e.loggedUser,expandedMessages:new Map,messageIndexToIdMap:new Map})))),this.threadContext=w.h.combine(this._state,this._expandedMessagesProvider.messageCount,((e,t)=>({...e,messageCount:t}))),(0,s.zG)(this._state.get(),(e=>Ne.Yt(oe.wE)({threadId:e.threadId,subject:e.subject,loggedUser:e.loggedUser})),oe.Vn((e=>{this._telemetry.gmailThreadContext.warning("threadContextExtraction",e.message),this._logger.warn("Static thread context extraction error",e)}))),this._subscriptions.add((0,s.zG)(this._expandedMessagesProvider.expandedMessages,p.h((e=>e.added.size>0||e.updated.size>0||e.removed.size>0)),I.b((({added:e,updated:t,removed:i,messages:o})=>{this._logger.info(`Expanded messages changed - added [${Array.from(e).join(", ")}] - updated [${Array.from(t).join(", ")}] - removed [${Array.from(i).join(", ")}]`),this._state.modify((i=>({...i,expandedMessages:(0,s.zG)(o,ae.DZ((o=>e.has(o.id)?n.G(Ai.x5):t.has(o.id)?(0,s.zG)(n.ij(i.expandedMessages.get(o.id)),n.UI((e=>Ae.VZ(e)||Ae.IR(e)?Ai.x5:e))):n.ij(i.expandedMessages.get(o.id))))),messageIndexToIdMap:new Map(Array.from(o.values()).map((({index:e,id:t})=>[e,t])))})))})),h.U((({added:e,updated:t,messages:i})=>(0,s.zG)(Array.from(e).concat(Array.from(t)),Pe.DZ((e=>n.ij(i.get(e)))),Pe.UI((e=>({id:e.id,index:e.index,messageNode:e.messageNode,bodyNode:e.bodyNode})))))),p.h((e=>e.length>0)),i,I.b((({message:{id:e,messageNode:t,bodyNode:i,index:n},context:o})=>this._state.lens("expandedMessages").modify((r=>new Map(r).set(e,(0,s.zG)(o,oe.g_((t=>{const i=`Could not extract context for #${e}: ${String(t)}`;return this._logger.warn(i),Ai.kH(new Ge(i))}),(s=>(this._logger.trace(`Message #${e} extracted`),Ai.Vp({id:e,index:n,messageNode:t,bodyNode:i,context:s,textMap:Di(i.node)}))))))))))).subscribe())}dispose(){this._subscriptions.unsubscribe()}}function Di(e){const t="none"===(0,q.Jj)(e).getComputedStyle(e).display;return new $.Z(e,((e,t)=>$.Z.defaultFilterNodeAllowList(["PRE","CODE","BLOCKQUOTE"])(e,t)&&!A.maybeGmailHistoryQuote(e)),void 0,$.Z.isBlockNodeFromTagList((0,s.zG)(new Set($.Z.blockTags),Ni.Od(_e.yv)("CODE"))),void 0,void 0,((e,i)=>t||e instanceof Element&&"false"===e.getAttribute("aria-expanded")),A.gmailNodeFormatting,void 0,void 0,!1)}function Vi(e,t){return d.R((0,q.Jj)(e.documentElement),"popstate").pipe(f.O(null),Ve.g(50),b.w((()=>function(e,t){const i=new ue.x;return i.pipe(f.O(null),b.w((()=>new r.y((i=>{t.trace("trying to find message list node");const n=e.querySelector(Lt);n?(t.debug("message list found",n),i.next(n)):i.error("Message list not found")})).pipe((0,Te.yF)(10,100,(()=>S.E)),ne.x(),b.w((n=>oi.n(n,{root:e}).pipe(h.U((e=>{const n=e.every((e=>e.isIntersecting));return n||(t.debug("message list disappeared"),i.next(void 0)),n})),me.o((e=>!0===e)),m.h(n)))),ne.x()))))}(e,t).pipe(f.O(null)))),u.b(50),ne.x(),h.U(n.ij))}function Hi(e,t,i,n){const s=new Jt(e),o=k.Y.create("gmail.threadContext"),r=Ci(t,i?Ui:()=>l.of([]),o);return{threadContextProvider:new Pi(t,s,r,n,o),expandedMessagesProvider:s}}class Ki extends De.J{constructor(e,t,i,a,d=E.OB,c=(0,X.Tb)(),u=k.Y.create("gmail.threadContext.pageIntegration")){const g=new Le.X(n.YP),p=(0,s.zG)(a,Pe.DZ((e=>e(g))));super(...p.map((e=>e.integration))),this._state=e,this._pageIntegrationContext=t,this._getEnv=d,this._telemetry=c,this._logger=u,this._subscriptions=new o.w0,this._userChanged=new ue.x;const m=p.some((e=>e.extractLinks));this._subscriptions.add((p.length>0?(0,s.zG)(Vi(this._pageIntegrationContext.doc,this._logger),b.w(n.g_((()=>l.of(n.YP)),(e=>new r.y((t=>{const o=()=>function(e,t,i,o,r,a){const{threadContextProvider:d,expandedMessagesProvider:c}=Hi(e,t.doc,i,a),l=(0,Me.Vo)((()=>(0,s.zG)(new it({domain:t.domain,capiUrl:t.config.appConfig.url.capiStatic,supportedFeatures:o(),clientName:t.config.appConfig.capi.clientType,clientSubType:t.config.appConfig.capi.clientSubType,clientVersion:t.config.buildInfo.version,useDlp:Boolean(t.dynamicConfig.dlpEnabled)},r),(e=>({checkingService:e,adapter:new Fe(e,d.threadContext)}))))),u=new Tt((0,s.zG)(d.threadContext.view((0,s.ls)((0,He.ei)("expandedMessages"),ae.DZ((0,s.ls)(be.xC,n.UI((e=>({docId:e.id,textMap:e.textMap,textNode:e.bodyNode})))))))),e);return{integrationContext:{messageList:e,threadContext:d.threadContext,expandedMessages:c.expandedMessages,checkingService:l.map((e=>e.adapter)),annotationsManager:u},dispose:e=>{d.dispose(),u.dispose(),l.hasValue&&(l.get().adapter.dispose(),l.get().checkingService.dispose(e))}}}(e,this._pageIntegrationContext,m,i,this._getEnv,this._telemetry),r=new Le.X(o()),a=[this._userChanged.subscribe((()=>{r.value.dispose("User changed"),r.next(o())})),r.pipe(h.U((e=>n.G(e.integrationContext)))).subscribe(t)];return()=>{a.forEach((e=>e.unsubscribe())),r.value.dispose("Disposed")}})))))):S.E).subscribe(g)),this._logger.debug("Page integration created")}update(e){e.user.id===this._state.user.id&&e.user.type===this._state.user.type||this._userChanged.next(null),this._state=e,super.update(e)}dispose(){this._subscriptions.unsubscribe(),super.dispose(),this._logger.debug("Page integration disposed")}}function $i(e,t){return(0,s.zG)(Vi(e.field.ownerDocument,t),(0,p.h)((e=>(0,n.pC)(e))),(0,h.U)((({value:t})=>{const{threadContextProvider:i}=Hi(t,e.field.ownerDocument,!0,e.felog);return i})),(0,b.w)((t=>new r.y((i=>{const n=new o.w0;return n.add(je((t=>{e.felog.gmailThreadContext.warning("getDocumentContext",t.message)}),(0,l.of)(!0),t.threadContext).subscribe((({docInfo:e})=>i.next(e)))),()=>{n.unsubscribe(),t.dispose()}})))),(0,h.U)((e=>Wi(e))))}function Wi(e){var t,i;return{...e,docId:Bi(e.docId),audience:{...e.audience,channelId:(null===(t=e.audience)||void 0===t?void 0:t.channelId)?Bi(e.audience.channelId):void 0},siblings:null===(i=e.siblings)||void 0===i?void 0:i.map(Wi)}}function Bi(e){return e.startsWith("#")?e:`#${e}`}!function(e){let t;const b={cheetahOverflowCustomCaret:!0,cheetahEnableQuickReplies:!0};function x(e,n,s,a,d){if(L.d.shouldCreate(a.config.bundleInfo.browser,a.domain,s.dynamicConfig,s.user)){const s=new o.w0;return new r.y((o=>{o.next(null),Promise.all([i.e(4527),i.e(5932),i.e(4100)]).then(i.bind(i,59357)).then((({ProofitGmailInProgressRequestTracker:i,ProofitGmailIntegrationForComposeWindow:r,ProofitGmailIntegrationForThreads:a})=>{t||(t=new i);const c=new("composeWindow"===d?r:a)(e,n,t);return o.next(c.getProofitLayout()),s.add(Y.x.observeStyle(e).pipe((0,u.b)(200),(0,h.U)((()=>c.getProofitLayout()))).subscribe((e=>o.next(e)))),()=>s.unsubscribe()}))})).pipe((0,g.d)())}}const w=e=>!!e.state.dynamicConfig.confidentialModeEnabled&&ji.isInConfidentialMode(e.field),I=e=>()=>(0,a.T)((0,d.R)(e.field,"focus").pipe((0,p.h)((()=>w(e)))),(0,D.Jj)(e.field)).pipe((0,m.h)(void 0)),C=(e,t)=>P.T.contentEditable("Gmail.compose",(i=>{const s=ji.getComposeFieldContainer(i.field);return{integrationName:t,extraCondition:t=>e(t.field)&&!w(t),expiration:I(i),createLayout:e=>{const t=x(e,s,i.state,i.pageContext,"composeWindow"),n="show"===i.state.dapi.emogenieEmojiState,o=T.V.getTotalWidth(T.V.gButtonMaxSize,n)+8,r=(0,z.Cq)((s||i.field).closest("table")),a=ji.createToolbarVisibleObservable(r),d=ji.createAttachmentsListObservable(r);return new j.A7(s||i.field,{gbuttonMinPadding:6,proofitLayout:t,createGbuttonShiftBehavior:e=>{const t=(0,c.a)([a,e.rect.behavior],((e,t)=>{if(e&&e.visible&&e.el){const i=e.el.getBoundingClientRect();return t.size.width-i.width-4<o?i.height+(i.bottom-t.client.top-t.size.height):0}return 0})),i=(0,c.a)([ji.attachmentsMetricsObservable(d,e.rect.behavior,a),e.rect.behavior,e.scroll.behavior],((e,t,i)=>t.size.height-e.top+i.top>0&&t.size.width-e.width-4<o?t.size.height-e.top+i.top+4:0));return(0,c.a)([t,i],((e,t)=>Math.max(e,t))).pipe((0,h.U)((e=>({top:-e,left:0}))),(0,g.d)())},injectIntegrationRoot:({editorElement:e,integrationRoot:t})=>{var i;null===(i=e.parentElement)||void 0===i||i.appendChild(t)},getScrollValue:e=>({top:e.scrollTop,left:i.field.scrollLeft})})},textMap:{createFieldTextMap:A.createTextMap},customizations:{richText:M.kn.isAvailable(i),applyFormatting:!0,getDocumentId:()=>{var e,t,n;const s=null===(e=i.field.closest('table[role="presentation"]'))||void 0===e?void 0:e.querySelector("form");return(null===(t=null==s?void 0:s.draft)||void 0===t?void 0:t.value)?(0,O.m3)(null===(n=null==s?void 0:s.draft)||void 0===n?void 0:n.value):void 0},getContainerType:()=>"email",getDocEvents:()=>{var e;const t=null===(e=i.field.closest('table[role="presentation"]'))||void 0===e?void 0:e.querySelector("form"),n=ji.getAuthor(),s=ji.getAuthorContextEventObservable(n),o=(0,W.c)(null==t?void 0:t.subjectbox).pipe((0,u.b)(300),(0,h.U)((e=>V.t.createDocContextUpdatedEvent({title:e}))),(0,g.d)({bufferSize:1,refCount:!0})),r=t?ji.getRecipientsContextEventObservable(t,n).pipe((0,h.U)((e=>V.t.createDocContextUpdatedEvent({audience:{recipients:e,indirectRecipients:e.filter((e=>"indirect"===e.kind)),undisclosedRecipients:e.filter((e=>"undisclosed"===e.kind))}})))):null,d=ji.getSubmitObservable(i.field,r).pipe((0,h.U)(V.t.createPublishedEvent)),c=t?ji.getParentsContextEventObservable(t,n):null;return(0,a.T)(d,s,o,...r?[r]:[],...c?[c]:[])},...b},onCreate:ji.hideNativeSuggestions,onDispose:()=>{ji.showNativeSuggestions()},getFromEmailDomainAndSignature:e=>ne(e),getVBarsIntegrationInfo:e=>n.G({kind:"gmail",integrationName:e,domain:i.pageContext.domain,isInsideIFrame:!1})}})),y=C(ji.isCompose,J.u.gmailCompose),S=C(ji.isFullscreenCompose,J.u.gmailComposeFullScreen),E=C(ji.isStandaloneCompose,J.u.gmailComposeStandalone);const U=P.T.contentEditable("Gmail.reply",(e=>{const t=k.Y.create("gmail.reply.pageIntegration"),i=e.experimentClient.isGateEnabled(Q.K.TrackSiblingDataForGMail);return{integrationName:J.u.gmailReply,extraCondition:e=>ji.isComposeReply(e.field)&&!w(e),expiration:I(e),createLayout:()=>function(e,t,i){const n=e.closest("table"),s=null==n?void 0:n.closest("table:not(:scope)"),o=null==s?void 0:s.querySelector('[command="Files"]'),r=null==o?void 0:o.closest("table"),a=(null==r?void 0:r.closest("div"))||null,l=(0,z.Cq)(e.offsetParent&&e.offsetParent.nodeType===Node.ELEMENT_NODE?"TD"===e.offsetParent.nodeName?n:e.offsetParent:null),u=(0,q.wr)(e,(e=>!!e.id&&"scroll"===(0,q.o)(e).overflowY))||e,p=(0,F.z)(u),m=(0,z.Cq)(e.closest("[role=listitem]")),b=x(e,l,t,i,"threads"),_=ji.createToolbarVisibleObservable(m),v=ji.createAttachmentsListObservable(m),w="show"===t.dapi.emogenieEmojiState,I=14,C=T.V.getTotalWidth(T.V.gButtonMaxSize,w)+4;return new j.A7(e,{scroller:p,proofitLayout:b,customGbuttonPositioning:{injectionElement:a,createPositionStyleBehavior:e=>e.pipe((0,h.U)((e=>({position:"absolute",transform:"translate(0, -100%)",width:"auto",height:"auto",pointerEvents:"all",right:I-e.left+"px",top:`${-14+e.top}px`})))),injectionStyle:{top:"0",left:"auto",right:"0"},calculateMetrics:(e,t,i)=>{const n=R.p8.create({top:i.top-I,left:e.size.width+i.left-I});return{offset:n,page:R.Cv.fromOffset(n,R.Cv.fromClient(e.client,{top:t.scrollY,left:t.scrollX}),{top:0,left:0}),client:R.Ir.create(R.E9.plus(e.client,n)),effectivePadding:{top:0,right:0,bottom:0,left:0},size:T.V.gButtonMaxSize}},createShiftBehavior:(e,t)=>{const i=(0,c.a)([_,e.behavior]).pipe((0,h.U)((([e,t])=>{if(e&&e.visible&&e.el){const i=e.el.getBoundingClientRect();return i.left+i.width+4>t.client.left+t.size.width-C-I?t.client.top-i.top:0}return 0}))),n=(0,c.a)([ji.attachmentsMetricsObservable(v,t.rect.behavior,_),t.rect.behavior,e.behavior,(0,d.R)(u,"scroll").pipe((0,f.O)(null))]).pipe((0,h.U)((([i,n,s,o])=>{if(i.top){const n=t.rect.getCurrent(),s=e.getCurrent(),o=s.client.left+s.size.width-C-I;return i.top&&n.client.left+i.width>o&&n.client.top+i.top<s.client.top?s.client.top-(n.client.top+i.top):0}return 0})));return(0,c.a)([i,n]).pipe((0,h.U)((([e,t])=>Math.max(e,t)))).pipe((0,h.U)((e=>({top:-e,left:0}))),(0,f.O)({top:0,left:0}),(0,g.d)())}}})}(e.field,e.state,e.pageContext),textMap:{createFieldTextMap:A.createTextMap},onCreate:ji.hideNativeSuggestions,onDispose:ji.showNativeSuggestions,customizations:{richText:M.kn.isAvailable(e),applyFormatting:!0,getDocumentId:e=>{var t,i,n;const s=null===(t=e.closest('table[role="presentation"]'))||void 0===t?void 0:t.querySelector("form");return(null===(i=null==s?void 0:s.draft)||void 0===i?void 0:i.value)?(0,O.m3)(null===(n=null==s?void 0:s.draft)||void 0===n?void 0:n.value):void 0},getContainerType:()=>"email",getDocEvents:()=>{var n;const s=ji.getAuthor(),o=ji.getAuthorContextEventObservable(s),r=null===(n=e.field.closest('table[role="presentation"]'))||void 0===n?void 0:n.querySelector("form"),d=r?ji.getRecipientsContextEventObservable(r,s).pipe((0,h.U)((e=>V.t.createDocContextUpdatedEvent({audience:{recipients:e,indirectRecipients:e.filter((e=>"indirect"===e.kind)),undisclosedRecipients:e.filter((e=>"undisclosed"===e.kind))}})))):null,c=ji.getSubmitObservable(e.field,d).pipe((0,h.U)(V.t.createPublishedEvent)),u=r?ji.getParentsContextEventObservable(r,s):null,g=(null==r?void 0:r.subject)?(0,l.of)(String((null==r?void 0:r.subject.value)||"")).pipe((0,h.U)((e=>V.t.createDocContextUpdatedEvent({title:e})))):null,p=i?$i(e,t).pipe((0,h.U)(V.t.createDocContextUpdatedEvent)):null;return(0,a.T)(...[c,o,g,d,u,p].filter((e=>!!e)))},...b},getFromEmailDomainAndSignature:e=>ne(e)}})),$=(0,H.$W)({name:"gmail",domain:B.ki,pathname:/^\/mail\/.*$/,andCanExecute:e=>!e.doc.querySelector("body>table"),eventPropagationHandler:e=>{(0,Z.OB)().experimentClient.isGateEnabled(Q.K.CentralizeStopEventPropagation)||e.addEventListener("keypress",(e=>{e.stopPropagation()}))},customizations:(0,Z.OB)().experimentClient.isGateEnabled(Q.K.AttributesTriggerFieldIntegration)?{attributesToTriggerInit:["contenteditable"]}:void 0},[U,S,E,y,K.k.iframeHostRule]),ee=(0,H.AY)({name:"gmail-general-purpose",domain:B.ki,pathname:/^\/mail\/.*$/,andCanExecute:e=>!e.doc.querySelector("body>table")&&(0,v.c)(e.experimentClient)},[(e,t,i,o)=>new Ki(t,e,(()=>[...(0,v.c)(e.experimentClient)?[_.z.knowledgeHub]:[]]),[r=>(0,s.zG)((0,v.c)(e.experimentClient),(e=>e?n.G({integration:new N(r,o,t,i,(0,X.Tb)())}):n.YP))])],"gmail-general-purpose-page-integration-rule"),te=(0,H.$W)({name:"gmail-chat",domain:B.ki,pathname:/^\/chat\/.*$/},[K.k.iframeHostRule,...K.k.newLayoutRules]),ie=(0,H.$W)({name:"gmail-feedback",andCanExecute:e=>{var t,i,n;return(0,G.n_)()&&"google-feedback-iframe"===(null===(n=null===(i=null===(t=e.doc)||void 0===t?void 0:t.defaultView)||void 0===i?void 0:i.frameElement)||void 0===n?void 0:n.getAttribute("id"))}},[P.T.textarea("Gmail.feedback",(e=>({createLayout:()=>new j.A7(e.field,{}),extraCondition:()=>!1})))]);function ne(e){return{fromEmailDomain:ji.getAuthorDomain(),emailSignature:qe.X.getSignature(e)}}e.pages=[$,te,ie],e.generalPurpose=[ee]}(qi||(qi={}))},89877:(e,t,i)=>{i.d(t,{X:()=>n});var n,s=i(33632);!function(e){e.getSignature=function(e){const t=[];e.getRichText().eachLine(((e,i)=>(!0===i.signature&&t.push(e),!0)));const i=t.map((e=>e.ops.reduce(((e,t)=>s.s.isInsertString(t)&&t.insert?e+t.insert:e),"")));return i.length?i.join(";"):null},e.getDomainFromEmail=function(e){const t=e.indexOf("@");return t>=0?e.substring(t+1):null}}(n||(n={}))},43264:(e,t,i)=>{i.d(t,{c:()=>c});var n=i(44071),s=i(36344),o=i(59179),r=i(90572),a=i(24666),d=i(954);function c(e){const t=e||null;return t?(0,n.R)(t,"input").pipe((0,o.U)((e=>e.target)),(0,r.h)((e=>e===t)),(0,o.U)((e=>e.value)),(0,a.x)(),(0,d.O)(t.value)):s.E}},25064:(e,t,i)=>{i.d(t,{l:()=>o});var n=i(90023),s=i(58303);function o(e){const t=e.split("Google");return(0,n.zG)(s.ij(t[1]),s.UI((e=>{const t=e.split(":");return t.length>1?t[1]:t[0]})),s.g_(n.gn,(e=>{const t=/^(.*?)\s*\n\((.+)\).*$/.exec(e);return t?{name:t[1].trim(),email:t[2].trim()}:null})))}}}]);