import{p as s,k as Q,y as g,a6 as T,af as C,r as z,a7 as b,ag as U,q as E,z as X,J as Y,g as Z,ah as tt,o as et,d as H,l as it,v as nt,a as $,ai as ot,i as at,K as rt,aj as st,h as ct,R as dt,L as M,m as pt,c as A}from"./index-uVYElzgq.js";import{s as lt}from"./share-BO0c2DMx.js";import{r as G}from"./race-DbiJq4jp.js";import{t as D}from"./take-A312jYgg.js";import{o as N}from"./of-DPWY87hm.js";import{d as V,c as ut}from"./delay-Cs5qaBTb.js";import{t as ft}from"./tap-BL_zgIju.js";import{s as ht}from"./startWith-DFLDsqXv.js";import{InlineCardInteractionContextToken as mt,TextDecorationInteractionObserverToken as gt}from"./index-4N3nZzsP.js";import{m as L}from"./NonEmptyArrayFns-oGa02u3x-CLyX5YlY.js";import{t as wt}from"./PointFns-Bd1JBOhL--ZyEh-AF.js";import{d as vt}from"./defineFactory-DJYNRBNc-CmRNy_rl.js";import"./mergeAll-CSDR5lBs.js";import"./async-dh0JxqdS.js";import"./concat-DqL665aX.js";import"./timer-B6bjwuU9.js";import"./PluginModule-CRib3PLZ-LTQDm_KX.js";function kt(e){return{x:-e.x,y:-e.y}}function yt(e,t){return{x:e.x+t.x,y:e.y+t.y}}const St={invert:kt,add:yt};function j(e){return t=>t.kind==="pointerEnter"&&t.decoration.id!==e||t.kind==="pointerLeave"&&t.decoration.id===e}function _t(e,t){return i=>{const n=i.decoration.id;return s(e,g(j(n)),C(()=>G(s(N({kind:"stop"}),V(t)),s(e,g(o=>o.decoration.id===n&&o.kind==="pointerEnter"),D(1),z(()=>null)))),g(T),D(1),ht({kind:"start",event:i}))}}function Wt(e,t){let i={kind:"not-hovering"};return s(e,g(xt),g(n=>i.kind==="not-hovering"||n.decoration.id!==i.decorationId),C(n=>G(s(N(n),V(t),C(_t(e,t-1)),ft(o=>{i=o.kind==="start"?{kind:"hovering",decorationId:o.event.decoration.id}:{kind:"not-hovering"}})),s(e,g(j(n.decoration.id)),D(1),z(()=>null)))),g(T),lt(),Q)}function xt(e){return e.kind==="pointerEnter"}var bt=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),_=e=>{throw TypeError(e)},R=(e,t,i)=>t.has(e)||_("Cannot "+i),a=(e,t,i)=>(R(e,t,"read from private field"),i?i.call(e):t.get(e)),f=(e,t,i)=>t.has(e)?_("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),w=(e,t,i,n)=>(R(e,t,"write to private field"),t.set(e,i),i),v=(e,t,i)=>(R(e,t,"access private method"),i),Mt=(e,t,i)=>{if(t!=null){typeof t!="object"&&typeof t!="function"&&_("Object expected");var n;n===void 0&&(n=t[bt("dispose")]),typeof n!="function"&&_("Object not disposable"),e.push([i,n,t])}return t},Ct=(e,t,i)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,l,d,h){return h=Error(d),h.name="SuppressedError",h.error=r,h.suppressed=l,h},o=r=>t=i?new n(r,t,"An error was suppressed during disposal"):(i=!0,r),c=r=>{for(;r=e.pop();)try{var l=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(l).then(c,d=>(o(d),c()))}catch(d){o(d)}if(i)throw t};return c()},y,W,x,S,m,p,k,u,J,K,I,q,F;class Dt{constructor(t,i,n){this.documentSessionExecution=t,this.windowFactory=i,this.decorationStoreManager=n,f(this,u),f(this,y,new AsyncDisposableStack),f(this,W),f(this,x),f(this,S),f(this,m,new Set),f(this,p,null),f(this,k,new DisposableStack),w(this,x,i),w(this,S,n.getRootStore()),w(this,W,t),a(this,y).defer(()=>b(a(this,p))),a(this,y).defer(()=>a(this,k).dispose())}observe(t){var i;const n={predicate:t.predicate,plugins:(i=t.plugins)!=null?i:[],window:null,pendingWindow:null};return a(this,m).size===0&&v(this,u,J).call(this),a(this,m).add(n),v(this,u,F).call(this,n),U(()=>{a(this,m).delete(n),n.window&&n.window.close(),n.pendingWindow&&s(n.pendingWindow,E(o=>o.close())),a(this,m).size===0&&a(this,k).dispose()})}async[Symbol.asyncDispose](){await a(this,y).disposeAsync()}}y=new WeakMap;W=new WeakMap;x=new WeakMap;S=new WeakMap;m=new WeakMap;p=new WeakMap;k=new WeakMap;u=new WeakSet;J=function(){var e=[];try{const n=Mt(e,new DisposableStack);n.use(Wt(s(X(a(this,S).onPointerHoverChange),ut(o=>Y([o.pointerLeave,o.pointerEnter].filter(T)))),100).subscribe(o=>{switch(o.kind){case"start":{const c=s(a(this,m),Z(({predicate:r})=>r(o.event.decoration.id,o.event.decoration.metadata)),tt);c?v(this,u,K).call(this,c,o.event):v(this,u,I).call(this);break}case"stop":v(this,u,I).call(this);break}})),a(this,k).dispose(),w(this,k,n.move())}catch(n){var t=n,i=!0}finally{Ct(e,t,i)}};K=function(e,t){t.decoration.focus(t.segment.id),b(a(this,p)),w(this,p,null),s(v(this,u,q).call(this,e,t),et(H(i=>it.error("Failed to create inline-card-interaction execution scope",i))))};I=function(){b(a(this,p)),w(this,p,null),a(this,S).focus(null)};q=async function(e,t){return s(v(this,u,F).call(this,e),$(async i=>{const n=St.add(t.viewportOffset,t.windowOffset),o=wt(n),c=st(n),r={windowId:i.id,decorationId:t.decoration.id,metadata:t.decoration.metadata,geometryData:{pointerPosition:o(t.position),segmentRect:c(t.rect),segmentRects:s(t.segmentRects,L(c)),decorationRects:s(t.decorationRects,L(c))}};return ot(l=>{const d=l(a(this,W).createExecutionScopeController("inline-card-interaction",{data:r}));return d.register({token:mt,useValue:r}),at(d)})}),$(i=>(a(this,p)&&b(a(this,p)),w(this,p,i),i.start())),E(nt))};F=async function(e){if(e.window)return rt(e.window);if(e.pendingWindow)return e.pendingWindow;const t=a(this,x).createWindow({name:"inline-card",injectionOptions:{kind:"popup"},clickThroughTransparent:!1,plugins:[...e.plugins,"inline-card"],scopes:["inline-card-interaction"],fitContent:!0,initializationData:null});return e.pendingWindow=t,s(t,E(H(i=>{e.window=i,e.pendingWindow=null})))};const Kt=async e=>{const t=A(Symbol("InlineCardWindow")),i=A(Symbol("InlineCardManager")),n=e.getExecutionScopeDefinition("document-session"),o=e.getExecutionScopeDefinition("document-group");return s(e.getPlugins(["text-decoration","document-group"]),ct(([c,r])=>dt.all([n.register({token:i,useFactory:vt(Dt,[n.instanceToken,t,c.provides.TextDecorationStoreManager])},{lifetime:M.Singleton}),n.register({token:gt,useFactory:l=>{const d=e.getResolutionMetadata(),h=d?[d.plugin]:[];return s(l.resolve(i),pt(B=>({observe:O=>{var P;return B.observe({...O,plugins:[...h,...(P=O.additionalPlugins)!=null?P:[]]})}})))}},{lifetime:M.Transient}),o.register({token:t,useFactory:l=>l.resolve(r.provides.WindowFactory)},{lifetime:M.Singleton})])))};export{Kt as activate};
//# sourceMappingURL=index-DjT-JosF.js.map
