import{n as ie,y as Tt,l as H,S as $,p as d,s as ms,z as ot,i as ye,o as gs,g as _s,k as w,C as qe,q as $e,b as _t,B as Xe,A as Ds,D as ws,f as K,r as Dt,m as P,G as N,w as X,H as le,I as k,_ as Cs,h as Pt,x as Ss,J as ys,j as Ft,K as ks,R as wt,v as Is,L as _,E as bs,c as $s}from"./start-BFd-djfI.js";import{ConnectorMessageTransportToken as At,ConnectorToken as xs,ConnectorDocumentManagerToken as at,ConnectorTextDecorationToken as Ot,ConnectorExperimentationToken as Ws,ConnectorCAPIToken as Ct,ConnectorSDUIToken as Rs,CAPIProviderToken as Ms}from"./index-WrA72bii.js";import{T as Es}from"./TextRevisionSynchronizedQueue-DQV4bu5q-DZsfBpcW.js";import{D as Gt}from"./Delta-D-dso3t3-DM06-Vr-.js";import{a as ut}from"./subscribableState-Y8YW7N9Z-L1DO2Tta.js";import{c as xe,u as Ts,a as Ps}from"./RectFns-ndpeBtT0-CdOd3O5S.js";import{c as Fs}from"./PointFns-Bd1JBOhL--ZyEh-AF.js";import{c as As}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{L as Os}from"./LRUCache-D4SXcJs8-0gDlvbKA.js";import{c as Vt}from"./concat-Bl9EyBSW.js";import{d as Nt}from"./defer-DJy-7hgl.js";import{a as Gs}from"./asap-_5Afx9lb.js";import{o as Vs}from"./of-Boi_-3cC.js";import{E as Ns}from"./mergeAll-D275NTmK.js";import{D as Bs}from"./CAPIWebSocketTransport-DztTrDg1-8WOYftOV.js";import{d as W}from"./defineFactory-DJYNRBNc-BvZfVSHA.js";import"./PluginModule-CRib3PLZ-B43Hjk20.js";import"./PluginDependency-Boc6-pxl-tjuTwLTj.js";import"./AsyncScheduler-BhBy18pz.js";import"./dateTimestampProvider-CV0dHcg-.js";var Bt=t=>{throw TypeError(t)},pt=(t,e,s)=>e.has(t)||Bt("Cannot "+s),y=(t,e,s)=>(pt(t,e,"read from private field"),s?s.call(t):e.get(t)),We=(t,e,s)=>e.has(t)?Bt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),Us=(t,e,s,n)=>(pt(t,e,"write to private field"),e.set(t,s),s),St=(t,e,s)=>(pt(t,e,"access private method"),s),he,V,Z,Pe,rt;class Fe{constructor(e,s){We(this,Pe),We(this,he),We(this,V,new Map),We(this,Z,new DisposableStack),Us(this,he,e),y(this,Z).use(y(this,he).messages.subscribe(n=>St(this,Pe,rt).call(this,n.message).next(n))),y(this,Z).use(s.documentWillDestroy.subscribe(n=>{ie(y(this,V).get(n.id)),y(this,V).delete(n.id)})),y(this,Z).defer(()=>{ie(y(this,V).values()),y(this,V).clear()})}create(e){return{messages:St(this,Pe,rt).call(this,{documentID:e}),send:s=>y(this,he).send({...s,documentID:e})}}[Symbol.dispose](){y(this,Z).dispose()}}he=new WeakMap;V=new WeakMap;Z=new WeakMap;Pe=new WeakSet;rt=function(t){const e=t.documentID;let s=y(this,V).get(e);return s||(s=new Tt,y(this,V).set(e,s)),s};var Ut=t=>{throw TypeError(t)},Lt=(t,e,s)=>e.has(t)||Ut("Cannot "+s),R=(t,e,s)=>(Lt(t,e,"read from private field"),s?s.call(t):e.get(t)),Re=(t,e,s)=>e.has(t)?Ut("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),Q=(t,e,s,n)=>(Lt(t,e,"write to private field"),e.set(t,s),s),ue,j,U,pe;class Ls{constructor(e,s){Re(this,ue),Re(this,j),Re(this,U,null),Re(this,pe,null),Q(this,j,e),Q(this,ue,s)}[Symbol.dispose](){ie(R(this,pe))}async create(e){ie(R(this,pe));let s=R(this,U);const n=H.createLogger("CAPITransport",R(this,j)),r=R(this,j),a=new Map,i=new Es,v=new Tt,I=new $,C=new $,de=Promise.withResolvers(),Ie=new DisposableStack;s!==null&&de.resolve(s);const be=R(this,ue).messages.subscribe(c=>{if(Ie.disposed)return H.warn("Received a message after the transport was disposed.",{delivery:!1});switch(c.kind){case"connected":Q(this,U,c.message.sessionID),s===null?(s=c.message.sessionID,n.verbose("Connected to session ".concat(s)),de.resolve(s)):s!==c.message.sessionID&&(n.warn("Received a 'connected' message for session \"".concat(c.message.sessionID,'" while already connected with the session ').concat(s,"."),{delivery:!1}),ie(be),I.next({webSocket:void 0}));break;case"disconnected":R(this,U)===c.message.sessionID&&Q(this,U,null),s===c.message.sessionID?(de.reject(new Js(s)),n.verbose("Disconnected from session ".concat(s)),s=null,ie(be),I.next({webSocket:void 0})):s!==null?n.warn("Received a 'disconnected' message for session \"".concat(c.message.sessionID,'" while connected with the session "').concat(s,'".'),{delivery:!1}):n.warn("Received a 'disconnected' message for session \"".concat(c.message.sessionID,'" while not connected.'),{delivery:!1});break;case"messageReceived":{const p=c.message.message;s===null?(s=c.message.sessionID,n.verbose("Connected to session ".concat(s)),Q(this,U,s),de.resolve(s),n.warn("Received a '".concat(p.action,"' message before 'connected' message. Assuming CAPI is connected with the session \"").concat(s,'".'),{delivery:!1}),i.enqueue(p,"rev"in p?p.rev:void 0)):s===c.message.sessionID?i.enqueue(p,"rev"in p?p.rev:void 0):n.warn("Received a '".concat(p.action,"' message for session \"").concat(c.message.sessionID,'" while connected with the session "').concat(s,'".'),{delivery:!1});break}case"textRevision":{const{capiRevision:p,documentRevision:gt}=c.message;s===c.message.sessionID?(n.verbose("Received text revision:",c.message),a.set(p,gt),i.pushNewTextRevision(p)):n.warn("Received a text revision (capi ".concat(p," -> ").concat(gt,') for session "').concat(c.message.sessionID,'" while connected with the session "').concat(s,'".'),{delivery:!1});break}}});return Ie.use(be),Q(this,pe,be),Ie.use(d(ot(i.messages),ms(c=>{if("rev"in c){const p=a.get(c.rev);p===void 0?n.warn("Received a message (".concat(c.action,") with unknown revision ").concat(c.rev),{delivery:!1}):Reflect.set(c,"rev",p)}v.next(c)}))),ye({sessionId:de.promise,send:c=>{s===null?(n.warn("Attempt to send a message without a sessionID",{delivery:!1}),n.verbose("Message:",c)):d(R(this,ue).send({documentID:r,sessionID:s,message:c}),gs(_s(p=>{n.error("Failed to send a message",p,{delivery:!0}),n.verbose("Message:",c)})))},didClose:w(I),didError:w(C),didReceive:v,[Symbol.dispose](){Ie.dispose()}})}toString(){return"PerDocumentTransportFactory(".concat(R(this,j),")")}}ue=new WeakMap;j=new WeakMap;U=new WeakMap;pe=new WeakMap;class Js extends qe{constructor(e){super("CAPI Transport disconnected (SessionId: ".concat(e,")"))}}const ct={clientType:"unknown",clientVersion:"0.0.0",capiOptions:{clientSupports:[],clientConfigs:{},sduiRenderers:{}}};var zs=Object.defineProperty,Jt=t=>{throw TypeError(t)},Hs=(t,e,s)=>e in t?zs(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,u=(t,e,s)=>Hs(t,typeof e!="symbol"?e+"":e,s),zt=(t,e,s)=>e.has(t)||Jt("Cannot "+s),f=(t,e,s)=>(zt(t,e,"read from private field"),s?s.call(t):e.get(t)),Ae=(t,e,s)=>e.has(t)?Jt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),et=(t,e,s,n)=>(zt(t,e,"write to private field"),e.set(t,s),s),Oe,O,q,M;class Ks{constructor(e,s=ct){Ae(this,Oe,new DisposableStack),u(this,"id"),u(this,"hasFocusSubject",new Xe(!1)),u(this,"geometryWillChangeSubject",new $),u(this,"geometryDidChangeSubject",new $),u(this,"textDidChangeSubject",new $),u(this,"selectionDidChangeSubject",new $),u(this,"hasFocus",ut(this.hasFocusSubject)),u(this,"geometryWillChange",w(this.geometryWillChangeSubject)),u(this,"geometryDidChange",w(this.geometryDidChangeSubject)),u(this,"textDidChange",w(this.textDidChangeSubject)),u(this,"selectionDidChange",w(this.selectionDidChangeSubject)),u(this,"settings"),this.id=e,this.settings=s,f(this,Oe).defer(()=>{this.hasFocusSubject.complete(),this.geometryDidChangeSubject.complete(),this.geometryWillChangeSubject.complete(),this.selectionDidChangeSubject.complete(),this.textDidChangeSubject.complete(),this.selectionDidChangeSubject.complete()})}[Symbol.dispose](){f(this,Oe).dispose()}}Oe=new WeakMap;class tt{constructor(e,s,n){Ae(this,O),Ae(this,q),Ae(this,M),u(this,"id"),u(this,"hasFocus"),u(this,"geometryWillChange"),u(this,"geometryDidChange"),u(this,"textDidChange"),u(this,"selectionDidChange"),u(this,"settings"),et(this,q,H.createLogger("RemoteDocument",e.id)),et(this,M,e),et(this,O,n),this.id=e.id,this.hasFocus=e.hasFocus,this.geometryWillChange=e.geometryWillChange,this.geometryDidChange=e.geometryDidChange,this.textDidChange=e.textDidChange,this.selectionDidChange=e.selectionDidChange,this.settings=s}[Symbol.dispose](){f(this,M)[Symbol.dispose]()}async getText(){return await d(f(this,O).getDocumentText({documentID:f(this,M).id}),$e(e=>({revision:e.revision,content:new Gt(e.document.ops)})))}async setText(e){return await f(this,O).applyDocumentTextChange({documentID:f(this,M).id,revision:e.revision,changes:e.change.toJSON()})}async setSelection(e,s){return await f(this,O).setDocumentSelectedTextRanges({documentID:f(this,M).id,revision:e,ranges:s})}getGeometry(){return d(f(this,O).getDocumentGeometry({documentID:f(this,M).id}),$e(e=>{var s;return{windowFrame:xe(e.windowFrame),viewportFrame:xe(e.viewportFrame),documentFrame:xe(e.documentFrame),visibleTextRange:(s=e.visibleTextRange)!=null?s:{start:0,end:1/0},scrollPosition:e.documentScrollOffset?Fs(e.documentScrollOffset):void 0}}))}getRectsForRanges(e,s){return s.size===0&&f(this,q).warn("getRectsForRanges() is called with an empty range map.",{delivery:!1}),d(f(this,O).getBoundingBoxesForTextRanges({documentID:f(this,M).id,revision:e,ranges:Object.fromEntries(s)}),$e(n=>({rects:new Map(d(s.keys(),_t(r=>{const a=n.boundingBoxes[r];return a||f(this,q).warn("No bounding box found for range with id: ".concat(r),{delivery:!1}),[r,(a!=null?a:[]).map(i=>xe(i))]}))),textRevision:As(n.revision)})))}getBoundingRectForRanges(e,s){return s.size===0&&f(this,q).warn("getBoundingRectForRanges() is called with an empty range map.",{delivery:!1}),d(this.getRectsForRanges(e,s),$e(n=>({rects:new Map(d(n.rects.entries(),_t(([r,a])=>[r,d(a,Ts(Ps()))]))),textRevision:n.textRevision})))}}O=new WeakMap;q=new WeakMap;M=new WeakMap;var Qs=Object.defineProperty,Ys=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),Ze=t=>{throw TypeError(t)},Xs=(t,e,s)=>e in t?Qs(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,T=(t,e,s)=>Xs(t,typeof e!="symbol"?e+"":e,s),ft=(t,e,s)=>e.has(t)||Ze("Cannot "+s),o=(t,e,s)=>(ft(t,e,"read from private field"),s?s.call(t):e.get(t)),g=(t,e,s)=>e.has(t)?Ze("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),B=(t,e,s,n)=>(ft(t,e,"write to private field"),e.set(t,s),s),D=(t,e,s)=>(ft(t,e,"access private method"),s),Zs=(t,e,s)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Ze("Object expected");var n;n===void 0&&(n=e[Ys("dispose")]),typeof n!="function"&&Ze("Object not disposable"),t.push([s,n,e])}return e},js=(t,e,s)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(i,v,I,C){return C=Error(I),C.name="SuppressedError",C.error=i,C.suppressed=v,C},r=i=>e=s?new n(i,e,"An error was suppressed during disposal"):(s=!0,i),a=i=>{for(;i=t.pop();)try{var v=i[1]&&i[1].call(i[2]);if(i[0])return Promise.resolve(v).then(a,I=>(r(I),a()))}catch(I){r(I)}if(s)throw e};return a()},ae,oe,fe,F,we,re,Ce,ve,vt,me,A,m,Ht,Kt,Qt,Yt,Xt,Zt,jt,qt,ke,es,x,ee;const qs="ca77b3794901e345f5f1a3c5872169ec06411679: O Grammarly, O Grammarly, wherefore art thou open devtools? Deny thy debugger and refuse thy console.log; Or, if thou wilt not, be but sworn my love, And I'll no longer be a developer.";class te{constructor(e,s){g(this,m),g(this,ae,H.createLogger("ConnectorDocumentManager")),g(this,oe,new DisposableStack),g(this,fe),g(this,F,o(this,oe).use(new Os({capacity:10}))),g(this,we,new $),g(this,re,new $),g(this,Ce,new Xe(!1)),g(this,ve,0),g(this,vt,new Xe(null)),g(this,me,ct),g(this,A,null),T(this,"documentDidCreate",w(d(Vt(Nt(()=>ws(o(this,F).values())),o(this,we)),Ds(Gs)))),T(this,"documentWillDestroy",w(o(this,re))),T(this,"debugEnabled",ut(o(this,Ce))),T(this,"handler",{echo:i=>N(i),cancel:()=>N(),documentDidFocus:i=>D(this,m,jt).call(this,i,o(this,me)),documentDidDestroy:i=>X(D(this,m,qt).call(this,i)),documentGeometryWillChange:i=>X(D(this,m,Qt).call(this,i)),documentGeometryDidChange:i=>X(D(this,m,Zt).call(this,i)),documentTextDidChange:i=>X(D(this,m,Yt).call(this,i)),documentSelectedTextRangesDidChange:i=>X(D(this,m,Xt).call(this,i)),handshake:async i=>{var v;return B(this,me,{capiOptions:(v=i.options.capiOptions)!=null?v:ct.capiOptions,clientType:i.client,clientVersion:i.version}),i.protocolVersion!==o(this,ve)?le(new en({protocolVersion:i.protocolVersion,expectedProtocolVersion:o(this,ve)})):ye({client:o(this,fe).name,version:o(this,fe).version,protocolVersion:o(this,ve),options:{}})}});var n=[];try{B(this,fe,s);const i=Zs(n,new DisposableStack);i.defer(()=>{o(this,we).complete(),o(this,re).complete(),o(this,Ce).complete()}),o(this,oe).use(i.move())}catch(i){var r=i,a=!0}finally{js(n,r,a)}}get settings(){return o(this,me)}[Symbol.dispose](){o(this,oe).dispose()}getRemoteDocument(e){const s=o(this,F).get(e);return s?ye(s):K(new ce(e))}}ae=new WeakMap;oe=new WeakMap;fe=new WeakMap;F=new WeakMap;we=new WeakMap;re=new WeakMap;Ce=new WeakMap;ve=new WeakMap;vt=new WeakMap;me=new WeakMap;A=new WeakMap;m=new WeakSet;Ht=function(t){var e;((e=o(this,A))==null?void 0:e.id)===t&&B(this,A,null);const s=o(this,F).get(t);return s?(s[Symbol.dispose](),o(this,F).delete(t),k(()=>o(this,re).next(s))):K(new ce(t))};Kt=function(t,e){var s;return((s=o(this,A))==null?void 0:s.id)===t&&B(this,A,null),e[Symbol.dispose](),k(()=>o(this,re).next(e))};Qt=function(t){const e=D(this,m,ke).call(this,t.documentID);return e?k(()=>e.geometryWillChangeSubject.next(new Set(t.reasons))):K(new ce(t.documentID))};Yt=function(t){const e=D(this,m,ke).call(this,t.documentID);if(!e)return K(new ce(t.documentID));const s=t.changes.ops.find(n=>"insert"in n&&typeof n.insert=="string");if(s&&String(s.insert).includes(qs))try{o(this,Ce).next(!0)}catch{}return k(()=>e.textDidChangeSubject.next({revision:t.revision,change:new Gt(t.changes.ops)}))};Xt=function(t){const e=D(this,m,ke).call(this,t.documentID);return e?k(()=>e.selectionDidChangeSubject.next(t.ranges)):K(new ce(t.documentID))};Zt=function(t){const e=D(this,m,ke).call(this,t.documentID);return e?k(()=>e.geometryDidChangeSubject.next(new Set(t.reasons))):K(new ce(t.documentID))};jt=function(t,e){return Cs(async s=>{const n=t?t.documentID:null;s(k(()=>o(this,vt).next(n)));const r=o(this,A);if(n===null)return r!==null&&(s(k(()=>r.hasFocusSubject.next(!1))),o(this,ae).verbose({context:r.id},"Document blurred"),B(this,A,null)),N();let a=o(this,F).get(n);return a||(a=await s(D(this,m,es).call(this,n,e))),r!==null&&a.id!==r.id&&(o(this,ae).verbose({context:r.id},"Document blurred"),s(k(()=>r.hasFocusSubject.next(!1)))),B(this,A,a),s(k(()=>a.hasFocusSubject.next(!0))),o(this,ae).verbose({context:a.id},"Document focused"),N()})};qt=function(t){return D(this,m,Ht).call(this,t.documentID)};ke=function(t){return o(this,F).get(t)};es=function(t,e){o(this,ae).verbose({context:t},"Document created");const s=o(this,oe).use(new Ks(t,e)),n=o(this,F).set(t,s);if(n){const[r,a]=n,i=D(this,m,Kt).call(this,r,a);if(!i.ok)return i}return d(k(()=>o(this,we).next(s)),P(()=>s))};class st{constructor(e,s){g(this,x),g(this,ee),T(this,"debugEnabled"),T(this,"documentDidCreate"),T(this,"documentWillDestroy"),B(this,x,e),B(this,ee,s.createClient()),this.debugEnabled=o(this,x).debugEnabled,this.documentDidCreate=d(ot(o(this,x).documentDidCreate),Dt(n=>new tt(n,o(this,x).settings,o(this,ee))),w),this.documentWillDestroy=d(ot(o(this,x).documentWillDestroy),Dt(n=>new tt(n,o(this,x).settings,o(this,ee))),w)}get settings(){return o(this,x).settings}getRemoteDocument(e){return d(o(this,x).getRemoteDocument(e),P(s=>new tt(s,this.settings,o(this,ee))))}}x=new WeakMap;ee=new WeakMap;class ce extends qe{constructor(e){super("Document not found"),this.documentId=e}toJSON(){return{...super.toJSON(),documentId:this.documentId}}}class en extends qe{constructor(e){super("Unsupported protocol version"),T(this,"protocolVersion"),T(this,"expectedProtocolVersion"),this.protocolVersion=e.protocolVersion,this.expectedProtocolVersion=e.expectedProtocolVersion}toJSON(){return{...super.toJSON(),protocolVersion:this.protocolVersion,expectedProtocolVersion:this.expectedProtocolVersion}}}var tn=Object.defineProperty,ts=t=>{throw TypeError(t)},sn=(t,e,s)=>e in t?tn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,yt=(t,e,s)=>sn(t,typeof e!="symbol"?e+"":e,s),ss=(t,e,s)=>e.has(t)||ts("Cannot "+s),l=(t,e,s)=>(ss(t,e,"read from private field"),s?s.call(t):e.get(t)),Y=(t,e,s)=>e.has(t)?ts("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),kt=(t,e,s,n)=>(ss(t,e,"write to private field"),e.set(t,s),s),Ge,E,ge,dt,L,J;class Ve{constructor(e,s){Y(this,Ge,new DisposableStack),Y(this,E,new $),Y(this,ge,new Set),Y(this,dt,H.createLogger("ConnectorCAPI")),Y(this,L),Y(this,J),yt(this,"messages",w(l(this,E))),yt(this,"handler",{capiConnected:async n=>d(l(this,L).getRemoteDocument(n.documentID),P(()=>{l(this,ge).add(n.sessionID),l(this,E).next({kind:"connected",message:n})})),capiDisconnected:async n=>d(l(this,L).getRemoteDocument(n.documentID),P(()=>{l(this,ge).delete(n.sessionID),l(this,E).next({kind:"disconnected",message:n})})),capiMessageReceived:async n=>d(l(this,L).getRemoteDocument(n.documentID),P(()=>l(this,E).next({kind:"messageReceived",message:n}))),capiAlertRemoved:async n=>d(l(this,L).getRemoteDocument(n.documentID),Pt(()=>l(this,ge).has(n.sessionID)?ye(l(this,E).next({kind:"messageReceived",message:{documentID:n.documentID,sessionID:n.sessionID,message:{id:parseInt(n.alertID),action:"remove"}}})):(l(this,dt).warn("Received capiAlertRemoved for disconnected session ".concat(n.sessionID),{delivery:!1}),K(new nn(n.sessionID))))),capiTextRevision:n=>N(l(this,E).next({kind:"textRevision",message:n})),capiWebSocketCreate:n=>l(this,J).handleCreate(n),capiWebSocketSend:n=>l(this,J).handleSend(n),capiWebSocketConnect:n=>l(this,J).handleConnect(n),capiWebSocketClose:n=>l(this,J).handleClose(n)}),kt(this,L,e),kt(this,J,s),l(this,Ge).defer(()=>l(this,E).complete())}[Symbol.dispose](){l(this,Ge).dispose()}}Ge=new WeakMap;E=new WeakMap;ge=new WeakMap;dt=new WeakMap;L=new WeakMap;J=new WeakMap;class nn extends qe{constructor(e){super("Unknown CAPI session ID"),this.sessionId=e}toJSON(){return{...super.toJSON(),sessionId:this.sessionId}}}var on=Object.defineProperty,ns=t=>{throw TypeError(t)},an=(t,e,s)=>e in t?on(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,rn=(t,e,s)=>an(t,e+"",s),is=(t,e,s)=>e.has(t)||ns("Cannot "+s),It=(t,e,s)=>(is(t,e,"read from private field"),s?s.call(t):e.get(t)),bt=(t,e,s)=>e.has(t)?ns("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),$t=(t,e,s)=>(is(t,e,"access private method"),s),je,Ne,lt;class Be{constructor(){bt(this,Ne),bt(this,je,new Map),rn(this,"handler",{setInlineCardState:async e=>k(()=>{const s=$t(this,Ne,lt).call(this,e.documentID);s.getValue().enabled!==e.enabled&&s.next({enabled:e.enabled})})})}getInlineCardState(e){return ut($t(this,Ne,lt).call(this,e))}}je=new WeakMap;Ne=new WeakSet;lt=function(t){let e=It(this,je).get(t);return e||(e=new Xe({enabled:!0}),It(this,je).set(t,e)),e};var cn=Object.defineProperty,os=t=>{throw TypeError(t)},dn=(t,e,s)=>e in t?cn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,ln=(t,e,s)=>dn(t,e+"",s),as=(t,e,s)=>e.has(t)||os("Cannot "+s),b=(t,e,s)=>(as(t,e,"read from private field"),s?s.call(t):e.get(t)),Me=(t,e,s)=>e.has(t)?os("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),hn=(t,e,s,n)=>(as(t,e,"write to private field"),e.set(t,s),s),_e,De,Ue,se;class Le{constructor(e){Me(this,_e,new DisposableStack),Me(this,De,new $),Me(this,Ue),Me(this,se,new Map),ln(this,"handler",{setTextDecorationVisibility:async s=>d(b(this,Ue).getRemoteDocument(s.documentID),P(n=>{let r=b(this,se).get(n.id);r||(r=new Map,b(this,se).set(n.id,r)),s.partial||r.clear(),s.changes.forEach(a=>{a.visibility==="hidden"?r.delete(a.alertId):r.set(a.alertId,a)}),b(this,De).next(s)}))}),hn(this,Ue,e),b(this,_e).use(e.documentWillDestroy.subscribe(s=>{b(this,se).delete(s.id)})),b(this,_e).defer(()=>b(this,De).complete())}getTextDecorationVisibilityChangeRequests(e){return d(Vt(Nt(()=>{var s;const n=(s=b(this,se).get(e))!=null?s:new Map;return n.size>0?Vs({documentId:e,partial:!1,changes:Array.from(n.values())}):Ns}),d(b(this,De),Ss(s=>s.documentID===e))),w)}[Symbol.dispose](){b(this,_e).dispose()}}_e=new WeakMap;De=new WeakMap;Ue=new WeakMap;se=new WeakMap;function un(t,e){return d(Ft([e.resolve(At),e.resolve(te),e.resolve(Ve),e.resolve(Le),e.resolve(Be),e.resolve(t.provides.Monitoring)]),P(([s,n,r,a,i,v])=>{const I=new ks({probability:.01});return new ys(s,{logger:{location:"Background",name:"Connector"},handler:{...n.handler,...r.handler,...a.handler,...i.handler},report:v&&I.shouldSelect()?C=>v.duration("".concat(C.kind,"_rpc_call"),{labels:{rpc_method_name:C.action}}).close(C.error,{durationInSeconds:C.durationInMs/1e3}):void 0})}))}var pn=Object.defineProperty,rs=t=>{throw TypeError(t)},fn=(t,e,s)=>e in t?pn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,vn=(t,e,s)=>fn(t,e+"",s),mn=(t,e,s)=>e.has(t)||rs("Cannot "+s),h=(t,e,s)=>(mn(t,e,"read from private field"),s?s.call(t):e.get(t)),nt=(t,e,s)=>e.has(t)?rs("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),G,S,z;class Ee{constructor(){nt(this,G,new DisposableStack),nt(this,S,new Map),nt(this,z,new $),vn(this,"outboundMessages",w(h(this,z))),h(this,G).defer(()=>{for(const e of h(this,S).values())e[Symbol.dispose]();h(this,S).clear()})}[Symbol.dispose](){h(this,G).dispose()}handleCreate(e){const s=new Bs(e.endpointUrl);return h(this,S).set(e.documentID,s),h(this,G).use(s.didOpen.subscribe(()=>{h(this,z).next({method:"capiWebSocketOpened",data:{documentID:e.documentID}})})),h(this,G).use(s.didClose.subscribe(n=>{h(this,z).next({method:"capiWebSocketClosed",data:{documentID:e.documentID,code:n.code,reason:n.reason,wasClean:n.wasClean}})})),h(this,G).use(s.messageReceived.subscribe(n=>{h(this,z).next({method:"capiWebSocketMessage",data:{documentID:e.documentID,data:n.data}})})),h(this,G).use(s.didError.subscribe(()=>{h(this,z).next({method:"capiWebSocketError",data:{documentID:e.documentID,message:"An error occurred in the web socket connection."}})})),N()}handleConnect(e){if(h(this,S).has(e.documentID)){const s=h(this,S).get(e.documentID);if(s)return s.connect(),N()}return le(new Error("No socket found"))}handleClose(e){if(h(this,S).has(e.documentID)){const s=h(this,S).get(e.documentID);if(s)return s.close(),h(this,S).delete(e.documentID),s[Symbol.dispose](),N()}return le(new Error("No socket found"))}handleSend(e){if(h(this,S).has(e.documentID)){const s=h(this,S).get(e.documentID);return s?X(s.send(e.data)):le(new Error("Failed to send message"))}return le(new Error("No socket found"))}}G=new WeakMap;S=new WeakMap;z=new WeakMap;var gn=Object.defineProperty,cs=t=>{throw TypeError(t)},_n=(t,e,s)=>e in t?gn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,Dn=(t,e,s)=>_n(t,e+"",s),mt=(t,e,s)=>e.has(t)||cs("Cannot "+s),Je=(t,e,s)=>(mt(t,e,"read from private field"),s?s.call(t):e.get(t)),it=(t,e,s)=>e.has(t)?cs("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),wn=(t,e,s,n)=>(mt(t,e,"write to private field"),e.set(t,s),s),Cn=(t,e,s)=>(mt(t,e,"access private method"),s),ze,Se,ht,ds;class Sn{constructor(e,s,n){it(this,ht),it(this,ze,new DisposableStack),it(this,Se),Dn(this,"messages"),wn(this,Se,e.createClient()),this.messages=s.messages,Je(this,ze).use(n.outboundMessages.subscribe(r=>Cn(this,ht,ds).call(this,r)))}[Symbol.dispose](){Je(this,ze).dispose()}send(e){return Je(this,Se).sendCapiMessage(e)}}ze=new WeakMap;Se=new WeakMap;ht=new WeakSet;ds=function(t){const e=Je(this,Se)[t.method];e(t.data)};var ls=t=>{throw TypeError(t)},hs=(t,e,s)=>e.has(t)||ls("Cannot "+s),yn=(t,e,s)=>(hs(t,e,"read from private field"),s?s.call(t):e.get(t)),kn=(t,e,s)=>e.has(t)?ls("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),In=(t,e,s,n)=>(hs(t,e,"write to private field"),e.set(t,s),s),He;class bn{constructor(e){kn(this,He),In(this,He,e.createClient())}makeExperimentationRequest(e){return yn(this,He).makeExperimentationRequest(e)}}He=new WeakMap;var us=t=>{throw TypeError(t)},ps=(t,e,s)=>e.has(t)||us("Cannot "+s),Te=(t,e,s)=>(ps(t,e,"read from private field"),s?s.call(t):e.get(t)),xt=(t,e,s)=>e.has(t)?us("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),Wt=(t,e,s,n)=>(ps(t,e,"write to private field"),e.set(t,s),s),Ke,ne;class $n{constructor(e,s){xt(this,Ke),xt(this,ne),Wt(this,Ke,s),Wt(this,ne,e.createClient())}getInlineCardState(e){return Te(this,Ke).getInlineCardState(e)}applyAlerts(e){return Te(this,ne).applyAlerts(e)}openGrammarlyGo(e){return Te(this,ne).openGrammarlyGo(e)}upgradeToPremium(e){return Te(this,ne).upgradeToPremium(e)}}Ke=new WeakMap;ne=new WeakMap;var fs=t=>{throw TypeError(t)},vs=(t,e,s)=>e.has(t)||fs("Cannot "+s),Rt=(t,e,s)=>(vs(t,e,"read from private field"),s?s.call(t):e.get(t)),Mt=(t,e,s)=>e.has(t)?fs("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),Et=(t,e,s,n)=>(vs(t,e,"write to private field"),e.set(t,s),s),Qe,Ye;class xn{constructor(e,s){Mt(this,Qe),Mt(this,Ye),Et(this,Qe,e.createClient()),Et(this,Ye,s)}getTextDecorationVisibilityChangeRequests(e){return Rt(this,Ye).getTextDecorationVisibilityChangeRequests(e)}notifyTextDecorationInteraction(e){return Rt(this,Qe).handleTextDecorationInteraction(e)}}Qe=new WeakMap;Ye=new WeakMap;const Zn=t=>d(t.getPlugin("monitoring"),Pt(e=>{const s=t.getExecutionScopeDefinition("global"),n=new Set,r={initialize:a=>{if(n.has(a))return wt.all([]);n.add(a);const i=[],v=t.getExecutionScopeDefinition(a);return i.push(...Rn(v,e)),i.push(ye(Wn(v))),H.verbose('Connector plugin is configured for "'.concat(a,'" execution scope.')),wt.all(i)}};return s.register({token:xs,useValue:r})}));function Wn(t){return t.onStart(async e=>(H.verbose('Connector plugin is starting in "'.concat(e.name,'" execution scope.')),d(Ft([e.resolve(at),e.resolve(Ot),e.resolve(Fe)]),P(Is))))}function Rn(t,e){const s=$s(Symbol("ConnectorRPCToken"));return[t.register({token:s,useFactory:n=>un(e,n)},{lifetime:_.Singleton}),t.register({token:st,useFactory:W(st,[te,s])},{lifetime:_.Singleton}),t.register({token:at,useToken:st}),t.register({token:Ws,useFactory:W(bn,[s])},{lifetime:_.Singleton}),t.register({token:Ct,useFactory:W(Sn,[s,Ve,Ee])},{lifetime:_.Singleton}),t.register({token:Ot,useFactory:W(xn,[s,Le])},{lifetime:_.Singleton}),t.register({token:Rs,useFactory:W($n,[s,Be])},{lifetime:_.Singleton}),t.register({token:Fe,useFactory:W(Fe,[Ct,at])},{lifetime:_.Singleton}),t.register({token:Ms,useFactory:n=>d(n.resolve(Fe),P(r=>({create:a=>new Ls(a,r.create(a))})))},{lifetime:_.Singleton}),t.register({token:te,useFactory:W(te,[At,bs])},{lifetime:_.Singleton}),t.register({token:Ee,useClass:Ee},{lifetime:_.Singleton}),t.register({token:Ve,useFactory:W(Ve,[te,Ee])},{lifetime:_.Singleton}),t.register({token:Le,useFactory:W(Le,[te])},{lifetime:_.Singleton}),t.register({token:Be,useClass:Be},{lifetime:_.Singleton})]}export{Zn as activate};
//# sourceMappingURL=index-DSqSs-gH.js.map
