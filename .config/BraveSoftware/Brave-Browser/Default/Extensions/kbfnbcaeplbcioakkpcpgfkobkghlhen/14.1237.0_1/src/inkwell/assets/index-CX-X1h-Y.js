import{ak as Ue,l as re,p as u,s as fe,y as ai,x as li,t as le,e as ke,r as Pe,z as Me,ag as X,n as di,U as we,o as H,d as x,q as $e,aa as Re,aq as ci,a6 as ui,C as Ne,aj as hi,S as pi,k as gi,h as fi,R as Te,i as K,E as Oe,w as be,a as _e,j as Ge,K as vi,m as ae,v as mi,L as J,c as yi}from"./index-uVYElzgq.js";import{g as ki}from"./getDecorationStrategy-D8c5vEyH.js";import{t as wi}from"./timeoutWith-B7tsbJ8--DgEQKW6j.js";import{T as bi}from"./TextRangeUpdateSemantics-D8MqPOrG-S_bbHJO0.js";import{c as _i}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{t as Di}from"./PointFns-Bd1JBOhL--ZyEh-AF.js";import{c as Si}from"./concat-DqL665aX.js";import{d as Ii}from"./defer-BLWpl2MB.js";import{t as Ei}from"./tap-BL_zgIju.js";import{o as Ti}from"./of-DPWY87hm.js";import{E as Ci}from"./mergeAll-CSDR5lBs.js";import{TextDecorationControllerToken as Le}from"./index-BR87y4b4.js";import{d as ce}from"./defineFactory-DJYNRBNc-CmRNy_rl.js";import"./race-DbiJq4jp.js";import"./timer-B6bjwuU9.js";import"./async-dh0JxqdS.js";import"./PluginModule-CRib3PLZ-LTQDm_KX.js";const Ce="#2551DA",Ae="#FFBF47",ze="#16AC9A",ue="#016A5E",he="#707070",Fe="#5E47E5",Be="#EB0A00",We="#027D7D";function Ve(e){var i,t,s,o,r,c,a;return e.hidden&&((i=e.extra_properties)==null?void 0:i.free_premium)==="uphook"?"premiumUphook":e.group==="WritingExpert"?"writingExpert":((t=e.cardLayout)==null?void 0:t.outcome)==="Correctness"?"correctness":((s=e.cardLayout)==null?void 0:s.outcome)==="Tone"?"delivery":((o=e.cardLayout)==null?void 0:o.outcome)==="Clarity"?"clarity":((r=e.cardLayout)==null?void 0:r.outcome)==="Engagement"?"engagement":((c=e.cardLayout)==null?void 0:c.outcome)==="Originality"?"originality":((a=e.cardLayout)==null?void 0:a.outcome)==="Knowledge Hub"?"knowledgeHub":null}const E=Ue(2),T="outside",C=.15,Ai={premiumUphook:{underline:{color:Ae,style:"solid",thickness:E,align:T},emphasizedBackground:{color:l(Ae,C)}},writingExpert:{underline:{color:ue,style:"ellipsis",thickness:E,align:T},emphasizedBackground:{color:l(he,C)}},correctness:{underline:{color:Be,style:"solid",thickness:E,align:T},emphasizedBackground:{color:l(Be,C)}},delivery:{underline:{color:Fe,style:"solid",thickness:E,align:T},emphasizedBackground:{color:l(Fe,C)}},clarity:{underline:{color:Ce,style:"solid",thickness:E,align:T},emphasizedBackground:{color:l(Ce,C)}},engagement:{underline:{color:ue,style:"solid",thickness:E,align:T},emphasizedBackground:{color:l(ue,C)}},originality:{underline:{color:We,style:"solid",thickness:E,align:T},emphasizedBackground:{color:l(We,C)}},knowledgeHub:{background:{color:l(ze,.3)},emphasizedBackground:{color:l(ze,.5)}},other:{underline:{color:he,style:"solid",thickness:E,align:T},emphasizedBackground:{color:l(he,C)}}},d={Red30:"#F27388",Red50:"#EA1537",Blue30:"#79A8F2",Blue50:"#4A6EE0",Green30:"#87E8D1",Green40:"#41D9B5",Green50:"#15C39A",Purple30:"#BD79ED",Purple50:"#8F4CBF",Yellow30:"#FFC940",Yellow50:"#FFA600",Neutral40:"#9FA6BF",Neutral50:"#6D758D",Cyan30:"#75E1EB",Cyan60:"#09A4B2"},p=Ue(3),g="outside",A=.2,F=.8,zi={premiumUphook:{underline:{color:l(d.Yellow30,F),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Yellow50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Yellow30,A)}},writingExpert:{underline:{color:d.Green50,style:"ellipsis",thickness:p,align:g},emphasizedUnderline:{color:d.Green50,style:"ellipsis",thickness:p,align:g},emphasizedBackground:{color:l(d.Neutral50,A)}},correctness:{underline:{color:l(d.Red30,F),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Red50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Red30,A)}},delivery:{underline:{color:l(d.Purple30,F),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Purple50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Purple30,A)}},clarity:{underline:{color:l(d.Blue30,F),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Blue50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Blue30,A)}},engagement:{underline:{color:l(d.Green30,F),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Green50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Green30,A)}},originality:{underline:{color:l(d.Cyan30,F),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Cyan60,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Cyan30,A)}},knowledgeHub:{background:{color:l(d.Green40,.3)},emphasizedBackground:{color:l(d.Green40,.5)}},other:{underline:{color:l(d.Neutral40,F),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Neutral50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Neutral40,A)}}};function Fi(e){var i;return Ai[(i=Ve(e))!=null?i:"other"]}function Bi(e){var i;return zi[(i=Ve(e))!=null?i:"other"]}function l(e,i){return e.length===7?e+Math.round(i*255).toString(16).padStart(2,"0"):e}var Wi=Object.defineProperty,He=e=>{throw TypeError(e)},xi=(e,i,t)=>i in e?Wi(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,Ye=(e,i,t)=>xi(e,i+"",t),De=(e,i,t)=>i.has(e)||He("Cannot "+t),n=(e,i,t)=>(De(e,i,"read from private field"),t?t.call(e):i.get(e)),v=(e,i,t)=>i.has(e)?He("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(e):i.set(e,t),m=(e,i,t,s)=>(De(e,i,"write to private field"),i.set(e,t),t),w=(e,i,t)=>(De(e,i,"access private method"),t),f,_,b,Z,z,P,M,I,W,$,O,L,G,U,y,Ke,Je,Qe,ve,Xe,Ze,qe,je,ei,q;class j{constructor(i,t,s,o,r){v(this,y),v(this,f),v(this,_,new AsyncDisposableStack),v(this,b),v(this,Z),v(this,z),v(this,P,new Set),v(this,M),v(this,I,null),v(this,W,null),v(this,$),v(this,O),v(this,L,new Set),v(this,G,new Set),v(this,U,null),m(this,f,re.createLogger("CAPITextDecorationManager",s.id)),m(this,Z,i),m(this,b,t),m(this,O,o),m(this,z,s),m(this,M,r.client==="windows"||r.client==="preview-windows"?"windows":"regular")}init(){n(this,_).use(n(this,Z).changes.subscribe(i=>{i.kind==="suggestionsUpserted"?w(this,y,Je).call(this,i):i.kind==="suggestionsRemoved"&&w(this,y,Qe).call(this,i)})),w(this,y,qe).call(this),n(this,_).use(u(li(n(this,O).status),ai(i=>i.kind==="connected"&&i.isNewSession),fe(()=>n(this,L).clear()))),n(this,_).use(n(this,b).visibleOnscreenDecorations.subscribe(i=>{i.forEach(t=>w(this,y,Ke).call(this,t.metadata.capiAlertId)),n(this,f).verbose("Visible onscreen decorations",{documentID:n(this,z).id,visibleOnscreen:u(i,ke(t=>t.id),le)})}))}addVisibilitySource(i){const t=new Set,s=u(Me(i),Pe(Ui(t)),fe(o=>{n(this,f).verbose("Update visibility",{documentID:n(this,z).id,changes:o});const{toShow:r,toHide:c,toEmphasize:a}=Pi(o);c.forEach(h=>t.delete(h)),r.forEach(h=>t.add(h)),a.forEach(h=>t.add(h)),w(this,y,ve).call(this,{toHide:c,toShow:r,toEmphasize:a})}));return n(this,_).use(s),X(()=>{w(this,y,ve).call(this,{toHide:t,toShow:new Set,toEmphasize:new Set}),di(s)})}onTextDecorationInteraction(i,t){const s={observer:i,predicate:t};return n(this,G).add(s),X(()=>n(this,G).delete(s))}onUnhandledTextDecorationInteraction(i){return n(this,U)&&n(this,f).warn("Overwriting unhandledInteractionObserver",{delivery:!1}),m(this,U,i),X(()=>m(this,U,null))}async[Symbol.asyncDispose](){await n(this,_).disposeAsync()}}f=new WeakMap;_=new WeakMap;b=new WeakMap;Z=new WeakMap;z=new WeakMap;P=new WeakMap;M=new WeakMap;I=new WeakMap;W=new WeakMap;$=new WeakMap;O=new WeakMap;L=new WeakMap;G=new WeakMap;U=new WeakMap;y=new WeakSet;Ke=function(e){n(this,L).has(e)||(n(this,L).add(e),u(n(this,O).send({action:"feedback",type:"RENDERED",subtype:"inline",alertId:e}),H(x(i=>n(this,f).error("Failed to send RENDERED feedback for alert ".concat(e),i,{delivery:!1})))))};Je=function(e){n(this,f).verbose("Handling suggestions upsert",e),u(Re(e.suggestions.map(i=>w(this,y,Xe).call(this,i))),$e(x(()=>{n(this,f).verbose("Upserted decorations for alerts",{documentID:n(this,z).id,decorationIds:e.suggestions.map(i=>V(i)),alertIds:e.suggestions.map(i=>i.id)})})),H(x(i=>n(this,f).error("Failed to upsert decoration on suggestion upsert",new Mi(i,e.suggestions.map(t=>t.id)),{delivery:!1}))))};Qe=function(e){n(this,f).verbose("Handling suggestions removal",e),u(n(this,b).remove(e.suggestions.map(i=>V(i))),$e(x(()=>{n(this,f).verbose("Removed decorations for alerts",{documentID:n(this,z).id,decorationIds:e.suggestions.map(i=>V(i)),alertIds:e.suggestions.map(i=>i.id)})})),H(x(i=>n(this,f).error("Failed to remove decoration on suggestion removal",new $i(i,e.suggestions.map(t=>t.id)),{delivery:!1}))))};ve=async function({toHide:e,toShow:i,toEmphasize:t}){var s,o;const r=[];r.push(n(this,b).setVisibility(e,!1)),r.push(n(this,b).setVisibility(i,!0)),e.forEach(a=>n(this,P).delete(a)),i.forEach(a=>n(this,P).add(a)),t.forEach(a=>n(this,P).add(a));const c=u(t,ci(1),le).at(0);if(c){if(c===((s=n(this,I))==null?void 0:s.decorationId))return;r.push(n(this,b).focus(c,n(this,$)))}else((o=n(this,I))==null?void 0:o.decorationId)!==void 0&&i.has(n(this,I).decorationId)&&r.push(n(this,b).focus(null));await wi(u(Re(r),H(x(a=>n(this,f).error("Unexpected error when applying visibility changes",a,{delivery:!0})))),{timeoutMs:5e3,defaultValue:void 0,onTimeout:()=>n(this,f).warn("Timeout out when applying visibility changes",{delivery:!1})})};Xe=function(e){var i;const t=V(e),s=((i=n(this,I))==null?void 0:i.decorationId)===t;return n(this,b).upsert({id:t,revision:_i(e.metadata.rawAlert.rev),segments:ii(e.metadata.rawAlert,w(this,y,Ze).call(this,e.metadata.rawAlert),s,e.metadata.rawAlert.transformJson),visibility:s?"focused":n(this,P).has(t)?"visible":"hidden",metadata:{capiAlertId:e.metadata.rawAlert.id,suggestionId:e.id}})};Ze=function(e){if(n(this,M)==="windows")return Bi(e);if(n(this,M)==="regular")return Fi(e);throw new we(n(this,M))};qe=function(){n(this,_).use(n(this,b).onPointerHoverChange.subscribe(({pointerEnter:e,pointerLeave:i})=>{if(i&&n(this,W)===i.decoration.id&&(e==null?void 0:e.decoration.id)!==n(this,W)&&(m(this,W,null),m(this,$,void 0),w(this,y,q).call(this,i)),e){if(n(this,W)===e.decoration.id)return;m(this,W,e.decoration.id),m(this,$,e.segment.id),w(this,y,q).call(this,e)}})),n(this,_).use(n(this,b).onPointerClick.subscribe(e=>{m(this,$,e.segment.id),w(this,y,q).call(this,e)})),n(this,_).use(n(this,b).onFocusChange.subscribe(({decoration:e,segment:i,focused:t})=>{var s;t?(m(this,I,{decorationId:e.id,segmentId:i==null?void 0:i.id}),w(this,y,je).call(this,e,i)):(((s=n(this,I))==null?void 0:s.decorationId)===e.id&&m(this,I,null),w(this,y,ei).call(this,e))}))};je=function(e,i){e.segments.forEach(t=>t.patch(Se({segmentMeta:t.metadata,segmentFocused:t.id===(i==null?void 0:i.id),decorationFocused:!0})))};ei=function(e){e.segments.forEach(i=>i.patch(Se({segmentMeta:i.metadata,segmentFocused:!1,decorationFocused:!1})))};q=function({kind:e,rect:i,decorationRects:t,position:s,decoration:o,viewportOffset:r,windowOffset:c}){var a;if(e==="pointerUp"||e==="pointerDown")return;n(this,f).verbose("Sending pointer event",{kind:e,decoration:o.id,documentID:n(this,z).id});const h={kind:e,decorationId:o.id,suggestionId:o.metadata.suggestionId,position:s,rect:i,decorationRects:t,windowOffset:c,viewportOffset:r};for(const{observer:k,predicate:D}of n(this,G))if(D(h))return k(h);(a=n(this,U))==null||a.call(this,h)};function Se({segmentMeta:e,segmentFocused:i,decorationFocused:t}){var s,o,r,c,a,h;return t?{interactive:!0,background:(!e.hasEnclosing||e.kind==="enclosing")&&(o=(s=e.style.emphasizedBackground)!=null?s:e.style.background)!=null?o:null,underline:e.isSuperAlert&&!i?null:e.kind!=="enclosing"&&(c=(r=e.style.emphasizedUnderline)!=null?r:e.style.underline)!=null?c:null}:{interactive:e.kind!=="enclosing",background:(a=e.style.background)!=null?a:null,underline:e.kind==="enclosing"?null:(h=e.style.underline)!=null?h:null}}function Ui(e){return i=>{const t=s=>s.kind==="decoration"?s.decorationId:V({id:s.suggestionId});if(i.partial)return i.changes.map(s=>({decorationId:t(s.id),visibility:s.visibility}));{const s=new Set(i.changes.flatMap(r=>r.visibility==="hidden"?[]:[t(r.id)])),o=u(e.difference(s),ke(r=>({decorationId:r,visibility:"hidden"})),le);return i.changes.map(r=>({decorationId:t(r.id),visibility:r.visibility})).concat(o)}}}function Pi(e){const i=new Set,t=new Set,s=new Set;for(const o of e)if(o.visibility==="hidden")t.add(o.decorationId);else if(o.visibility==="visible")i.add(o.decorationId);else if(o.visibility==="emphasized")i.add(o.decorationId),s.add(o.decorationId);else throw new we(o.visibility);return{toShow:i,toHide:t,toEmphasize:s}}function V(e){return String(e.id)}function ii(e,i,t,s,o){return s?s.highlights.map(({type:r,s:c,e:a},h,k)=>{var D,Y;const R={kind:r==="enclosing"?"enclosing":"main",hasEnclosing:k.some(ri=>ri.type==="enclosing"),isSuperAlert:o===!0,style:i},{interactive:de,underline:Ie,background:Ee}=Se({segmentFocused:!1,decorationFocused:t,segmentMeta:R});return{range:{start:c+((D=s==null?void 0:s.context.s)!=null?D:0),end:a+((Y=s==null?void 0:s.context.s)!=null?Y:0)},updateSemantics:bi.Resize,metadata:R,interactive:de,underline:Ie!=null?Ie:void 0,background:Ee!=null?Ee:void 0}}):e.subalerts?e.subalerts.flatMap(r=>ii(e,i,t,r.transformJson,!0)).filter(ui):[]}class Mi extends Ne{constructor(i,t){super("Failed to upsert decoration",i),Ye(this,"suggestions"),this.suggestions=Array.from(t)}toJSON(){return{...super.toJSON(),suggestions:this.suggestions}}}class $i extends Ne{constructor(i,t){super("Failed to remove decoration",i),Ye(this,"suggestions"),this.suggestions=Array.from(t)}toJSON(){return{...super.toJSON(),suggestions:this.suggestions}}}var Ri=Object.defineProperty,ti=e=>{throw TypeError(e)},Ni=(e,i,t)=>i in e?Ri(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,Oi=(e,i,t)=>Ni(e,i+"",t),si=(e,i,t)=>i.has(e)||ti("Cannot "+t),N=(e,i,t)=>(si(e,i,"read from private field"),t?t.call(e):i.get(e)),Q=(e,i,t)=>i.has(e)?ti("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(e):i.set(e,t),pe=(e,i,t,s)=>(si(e,i,"write to private field"),i.set(e,t),t),ee,ie,te,se;class me{constructor(i,t,s){Q(this,ee),Q(this,ie),Q(this,te),Q(this,se,re.createLogger("ConnectorTextDecorationInteractionObserver")),Oi(this,"onTextDecorationInteraction",({kind:o,suggestionId:r,position:c,rect:a,decorationRects:h,viewportOffset:k})=>{if(r===void 0)return;const D=N(this,ie).get(r);if(!D)return N(this,se).error("Failed to find suggestion by id",{delivery:!1});const Y=Di(k),R=hi(k);u(N(this,te).notifyTextDecorationInteraction({documentID:N(this,ee).id,interactionType:o,alertId:String(D.metadata.rawAlert.id),position:Y(c),rect:R(a),decorationRects:h.map(R)}),H(x(de=>N(this,se).error("Failed to send notifyTextDecorationInteraction",de,{delivery:!1}))))}),pe(this,ee,i),pe(this,ie,t),pe(this,te,s)}}ee=new WeakMap;ie=new WeakMap;te=new WeakMap;se=new WeakMap;var Gi=Object.defineProperty,ni=e=>{throw TypeError(e)},Li=(e,i,t)=>i in e?Gi(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,Vi=(e,i,t)=>Li(e,i+"",t),Hi=(e,i,t)=>i.has(e)||ni("Cannot "+t),S=(e,i,t)=>(Hi(e,i,"read from private field"),i.get(e)),ge=(e,i,t)=>i.has(e)?ni("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(e):i.set(e,t),ne,B,oe;class ye{constructor(i,t){ge(this,ne,new DisposableStack),ge(this,B,new Map),ge(this,oe,new pi),Vi(this,"visibilityChanges",gi(Si(Ii(()=>S(this,B).size>0?Ti({partial:!1,changes:u(S(this,B).entries(),ke(([s,o])=>({id:{kind:"suggestion",suggestionId:s},visibility:o})),le)}):Ci),S(this,oe)))),S(this,ne).use(u(Me(t.getTextDecorationVisibilityChangeRequests(i.id)),Pe(s=>({partial:s.partial,changes:s.changes.map(o=>({id:{kind:"suggestion",suggestionId:o.alertId},visibility:o.visibility}))})),Ei(s=>{s.partial||S(this,B).clear(),s.changes.forEach(o=>{o.visibility==="hidden"?S(this,B).delete(o.id.suggestionId):S(this,B).set(o.id.suggestionId,o.visibility)})}),fe(S(this,oe))))}[Symbol.dispose](){S(this,ne).dispose()}}ne=new WeakMap;B=new WeakMap;oe=new WeakMap;const xe=yi(Symbol("CAPITextDecorationStore")),gt=e=>u(Ge([K(e.getExecutionScopeDefinition("document-group")),K(e.getExecutionScopeDefinition("document-session")),e.getPlugin("document-group"),e.getPlugin("document-session"),e.getPlugin("capi-suggestion"),e.getPlugin("text-decoration"),e.getPlugin("connector"),e.getPlugin("capi")]),fi(([i,t,s,o,r,c,a,h])=>Te.all([...Xi(t,c,r,o,a,h),K(t.onStart(async k=>Te.all([Ji(k),Qi(k)]))),K(i.onStart(k=>u(k.resolve(Oe),be,_e(D=>Yi(ki(D.client),k.observeExecutionScope("document-session"),s,o,k)))))])));function Yi(e,i,t,s,o){switch(e){case"showActiveDocumentOnly":return re.verbose("Showing decorations for active document session"),oi(t,o);case"showAllDocuments":return re.verbose("Showing decorations for all document sessions"),Ki(i,t,s);default:throw new we(e)}}function oi(e,i,t){return u(i.resolve(e.provides.WindowFactory),be,_e(s=>s.createWindow({name:"inline-decorations-".concat(t?"for-doc-"+t:"for-all-docs"),fitContent:!1,clickThroughTransparent:!0,injectionOptions:t?{kind:"documentOverlay",documentId:t}:{kind:"popup"},scopes:["document-session"],plugins:["inline-decorations"],initializationData:null})))}function Ki(e,i,t){const s=new AsyncDisposableStack;return s.use(e.onStart(o=>u(be(o.resolve(t.provides.TextDocumentInfo)),_e(r=>oi(i,o,r.id))))),vi(s)}function Ji(e){return u(e.resolve(j),ae(i=>i.init()),ae(()=>X(mi)))}function Qi(e){return u(Ge([e.resolve(ye),e.resolve(me),e.resolve(Le)]),ae(([i,t,s])=>{const o=new DisposableStack;return o.use(s.addVisibilitySource(i.visibilityChanges)),o.use(s.onUnhandledTextDecorationInteraction(t.onTextDecorationInteraction)),o}))}function Xi(e,i,t,s,o,r){return[e.register({token:Le,useToken:j}),e.register({token:xe,useFactory:c=>u(c.resolve(i.provides.TextDecorationStoreManager),ae(a=>a.createStore("capi")))},{lifetime:J.Singleton}),e.register({token:j,useFactory:ce(j,[t.provides.CAPISuggestionStore,xe,s.provides.TextDocument,r.provides.CAPIConnection,Oe])},{lifetime:J.Singleton}),e.register({token:ye,useFactory:ce(ye,[s.provides.TextDocument,o.provides.ConnectorTextDecoration])},{lifetime:J.Singleton}),e.register({token:me,useFactory:ce(me,[s.provides.TextDocument,t.provides.CAPISuggestionStore,o.provides.ConnectorTextDecoration])},{lifetime:J.Singleton})]}export{gt as activate};
//# sourceMappingURL=index-CX-X1h-Y.js.map
