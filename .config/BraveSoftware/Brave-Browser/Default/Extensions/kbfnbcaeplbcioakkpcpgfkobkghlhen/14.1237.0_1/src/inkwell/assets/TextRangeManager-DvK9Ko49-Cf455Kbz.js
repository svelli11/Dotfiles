var Ct=Object.defineProperty;var ht=s=>{throw TypeError(s)};var kt=(s,t,e)=>t in s?Ct(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var p=(s,t,e)=>kt(s,typeof t!="symbol"?t+"":t,e),Y=(s,t,e)=>t.has(s)||ht("Cannot "+e);var a=(s,t,e)=>(Y(s,t,"read from private field"),e?e.call(s):t.get(s)),E=(s,t,e)=>t.has(s)?ht("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,e),R=(s,t,e,r)=>(Y(s,t,"write to private field"),r?r.call(s,e):t.set(s,e),e),q=(s,t,e)=>(Y(s,t,"access private method"),e);var ct=(s,t,e,r)=>({set _(i){R(s,t,i,e)},get _(){return a(s,t,r)}});import{l as j,b8 as At,a6 as G,p as J,m as wt,t as Z,g as P,e as _,i as dt,f as xt,U as Mt,C as Dt}from"./index-uVYElzgq.js";import{b as mt,a as St,g as st,c as qt,D as Ft,d as $t}from"./Delta-D-dso3t3-DM06-Vr-.js";import{T as rt}from"./TextRangeUpdateSemantics-D8MqPOrG-S_bbHJO0.js";import{c as It}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";function ne(s,...t){return{start:Math.min(s.start,...t.map(e=>e.start)),end:Math.max(s.end,...t.map(e=>e.end))}}function ae(s,t){return!(t.start>s.end||t.end<s.start)}function fe(s,t,e=[0,Number.MAX_SAFE_INTEGER]){return{start:Math.max(s.start-t,e[0]),end:Math.min(s.end+t,e[1])}}function oe(s){return s.start===s.end}function ut(s){return"[".concat(s.start,", ").concat(s.end,")")}var L,k,v,A,S;class Wt{constructor(t){E(this,L);E(this,k,[]);E(this,v,0);E(this,A,0);E(this,S,0);R(this,L,t.capacity)}get length(){return a(this,S)}get isFull(){return a(this,S)===a(this,L)}at(t){if(a(this,S)===0)return;const e=t<0?a(this,S)+t:t;if(!(e>=a(this,S)))return a(this,k)[(a(this,v)+e)%a(this,L)]}push(t){const e=a(this,k)[a(this,v)],r=this.isFull;if(a(this,k)[a(this,A)]=t,R(this,S,Math.min(a(this,S)+1,a(this,L))),r&&a(this,v)===a(this,A)&&R(this,v,(a(this,v)+1)%a(this,L)),R(this,A,(a(this,A)+1)%a(this,L)),r)return e}shift(){if(a(this,S)===0)return;const t=a(this,k)[a(this,v)];return R(this,v,(a(this,v)+1)%a(this,L)),ct(this,S)._--,t}forEach(t){let e=0;for(const r of this)t(r,e++)}reduce(t,e){let r=e,i=0;for(const n of this)r=t(r,n,i++);return r}*[Symbol.iterator](){for(let t=0;t<a(this,S);t++)yield this.at(t)}}L=new WeakMap,k=new WeakMap,v=new WeakMap,A=new WeakMap,S=new WeakMap;function ft(s,t){return(s&1<<t)!==0}function ot(s,t){return s|1<<t}function lt(s,t){return s&~(1<<t)}const l={Black:0,Red:1},I={Resize:0,Collapse:1},it=0,nt=1,at=2,F=-(1<<30),$=1<<30;function g(s){return ft(s.metadata,it)===!0?l.Red:l.Black}function c(s,t){t?s.metadata=ot(s.metadata,it):s.metadata=lt(s.metadata,it)}function m(s){return ft(s.metadata,nt)}function u(s,t){t?s.metadata=ot(s.metadata,nt):s.metadata=lt(s.metadata,nt)}function Rt(s){return ft(s.metadata,at)===!0?I.Collapse:I.Resize}function yt(s,t){t?s.metadata=ot(s.metadata,at):s.metadata=lt(s.metadata,at)}var Nt,H,vt;const b=class b{constructor(t,e,r,i){p(this,"metadata");p(this,"parent");p(this,"left");p(this,"right");p(this,"start");p(this,"end");p(this,"offset");p(this,"maxEnd");p(this,"cachedRevision");p(this,"cachedAbsoluteStart");p(this,"cachedAbsoluteEnd");p(this,"onBeforeEditOperation");this.metadata=0,this.onBeforeEditOperation=i,this.parent=this,this.left=this,this.right=this,c(this,l.Red),this.start=t,this.end=e,this.offset=0,this.maxEnd=e,yt(this,r),this.cachedRevision=0,this.cachedAbsoluteStart=t,this.cachedAbsoluteEnd=e,u(this,!1)}reset(t,e,r){this.start=e,this.end=r,this.maxEnd=r,this.cachedRevision=t,this.cachedAbsoluteStart=e,this.cachedAbsoluteEnd=r}setCachedOffsets(t,e,r){this.cachedRevision=r,this.cachedAbsoluteStart=t,this.cachedAbsoluteEnd=e}detach(){this.parent=b.SENTINEL,this.left=b.SENTINEL,this.right=b.SENTINEL}};H=new WeakSet,vt=function(){const t=new b(0,0,I.Resize);return t.parent=t,t.left=t,t.right=t,c(t,l.Black),t},E(b,H),p(b,"SENTINEL",q(Nt=b,H,vt).call(Nt));let o=b;var W,Lt,Bt;class Jt{constructor(t=0){E(this,W);p(this,"root");p(this,"requestNormalizeOffsets");p(this,"revision");this.root=o.SENTINEL,this.revision=t,this.requestNormalizeOffsets=!1}intervalSearch(t,e){return this.root===o.SENTINEL?[]:Pt(this,t,e,this.revision)}getAllInOrder(){return this.root===o.SENTINEL?[]:Gt(this,this.revision)}insert(t){t.cachedRevision=this.revision,z(this,t),this.normalizeOffsetsIfNeeded()}delete(t){tt(this,t),this.normalizeOffsetsIfNeeded()}resolveNodeIfNeeded(t){if(t.cachedRevision!==this.revision){const e=t;let r=0;for(;t!==this.root;){if(t===o.SENTINEL)return j.warn("IntervalTree: Cannot resolve detached node");t===t.parent.right&&(r+=t.parent.offset),t=t.parent}const i=e.start+r,n=e.end+r;e.setCachedOffsets(i,n,this.revision)}}acceptEdit(t,e){const r=new Set;let i=0;t.ops.forEach(n=>{if(mt(n))i+=n.retain;else if(St(n)){const f=q(this,W,Lt).call(this,i,n);for(const d of f)r.add(d);i+=st(n)}else if(qt(n)){const f=q(this,W,Bt).call(this,i,n);for(const d of f)r.add(d)}}),this.revision=e;for(const n of r)this.resolveNodeIfNeeded(n);return[...r]}normalizeOffsetsIfNeeded(){this.requestNormalizeOffsets&&(this.requestNormalizeOffsets=!1,Ut(this))}}W=new WeakSet,Lt=function(t,e){var n;const r=typeof e.insert=="string"?e.insert:" ",i=Et(this,t,t);for(const f of i)(n=f.onBeforeEditOperation)==null||n.call(f,t,e);for(let f=0,d=i.length;f<d;f++){const h=i[f];tt(this,h)}this.normalizeOffsetsIfNeeded(),gt(this,t,t,r.length),this.normalizeOffsetsIfNeeded();for(let f=0,d=i.length;f<d;f++){const h=i[f];h.start=h.cachedAbsoluteStart,h.end=h.cachedAbsoluteEnd,Vt(h,t,r),h.maxEnd=h.end,z(this,h)}return this.normalizeOffsetsIfNeeded(),i},Bt=function(t,e){var n;const r=e.delete,i=Et(this,t,t+r);for(const f of i)(n=f.onBeforeEditOperation)==null||n.call(f,t,e);for(let f=0,d=i.length;f<d;f++){const h=i[f];tt(this,h)}this.normalizeOffsetsIfNeeded(),gt(this,t,t+r,0),this.normalizeOffsetsIfNeeded();for(let f=0,d=i.length;f<d;f++){const h=i[f];h.start=h.cachedAbsoluteStart,h.end=h.cachedAbsoluteEnd,Xt(h,t,r),h.maxEnd=h.end,z(this,h)}return this.normalizeOffsetsIfNeeded(),i};function Ut(s){let t=s.root,e=0;for(;t!==o.SENTINEL;){if(t.left!==o.SENTINEL&&!m(t.left)){t=t.left;continue}if(t.right!==o.SENTINEL&&!m(t.right)){e+=t.offset,t=t.right;continue}t.start=e+t.start,t.end=e+t.end,t.offset=0,D(t),u(t,!0),u(t.left,!1),u(t.right,!1),t===t.parent.right&&(e-=t.parent.offset),t=t.parent}u(s.root,!1)}function pt(s){const t=s.charCodeAt(0);return t<48||t===58||t===59||t===63||t===8220||t===8221||t===8216||t===8217}function Vt(s,t,e){const r=Rt(s);if(!(t<s.start||t>s.end||e.length===0))if(t===s.start){const i=pt(e.charAt(e.length-1));r===I.Collapse&&!i?s.start=s.end=t+e.length:(s.start+=e.length,s.end+=e.length)}else if(t===s.end){const i=pt(e.charAt(0));r===I.Collapse&&!i&&(s.end=s.start)}else r===I.Resize?s.end+=e.length:s.end=s.start}function Xt(s,t,e){const r=Rt(s);if(!(t+e<s.start||t>s.end||e===0))if(t<=s.start&&s.end<=t+e)s.end=s.start;else if(t<=s.start&&t+e>s.start)if(r===I.Collapse)s.end=s.start=t;else{const i=t+e-s.start,n=s.end-s.start-i;s.end=t+n,s.start=t}else t<=s.end&&t+e>s.end?r===I.Collapse?s.end=s.start:s.end=t:t>=s.start&&t+e<=s.end?r===I.Collapse?s.end=s.start:s.end-=e:r===I.Collapse?s.end=s.start=t:(s.end-=e,s.start-=e)}function Et(s,t,e){let r=s.root,i=0,n=0,f=0,d=0;const h=[];let O=0;for(;r!==o.SENTINEL;){if(m(r)){u(r.left,!1),u(r.right,!1),r===r.parent.right&&(i-=r.parent.offset),r=r.parent;continue}if(!m(r.left)){if(n=i+r.maxEnd,n<t){u(r,!0);continue}if(r.left!==o.SENTINEL){r=r.left;continue}}if(f=i+r.start,f>e){u(r,!0);continue}if(d=i+r.end,d>=t&&(r.setCachedOffsets(f,d,0),h[O++]=r),u(r,!0),r.right!==o.SENTINEL&&!m(r.right)){i+=r.offset,r=r.right;continue}}return u(s.root,!1),h}function gt(s,t,e,r){let i=s.root,n=0,f=0,d=0;const h=r-(e-t);for(;i!==o.SENTINEL;){if(m(i)){u(i.left,!1),u(i.right,!1),i===i.parent.right&&(n-=i.parent.offset),D(i),i=i.parent;continue}if(!m(i.left)){if(f=n+i.maxEnd,f<t){u(i,!0);continue}if(i.left!==o.SENTINEL){i=i.left;continue}}if(d=n+i.start,d>e){i.start+=h,i.end+=h,i.offset+=h,(i.offset<F||i.offset>$)&&(s.requestNormalizeOffsets=!0),u(i,!0);continue}if(u(i,!0),i.right!==o.SENTINEL&&!m(i.right)){n+=i.offset,i=i.right;continue}}u(s.root,!1)}function Gt(s,t){let e=s.root,r=0,i=0,n=0;const f=[];for(;e!==o.SENTINEL;){if(m(e)){u(e.left,!1),u(e.right,!1),e===e.parent.right&&(r-=e.parent.offset),e=e.parent;continue}if(e.left!==o.SENTINEL&&!m(e.left)){e=e.left;continue}if(i=r+e.start,n=r+e.end,e.setCachedOffsets(i,n,t),f.push(e),u(e,!0),e.right!==o.SENTINEL&&!m(e.right)){r+=e.offset,e=e.right;continue}}return u(s.root,!1),f}function Pt(s,t,e,r){let i=s.root,n=0,f=0,d=0,h=0;const O=[];for(;i!==o.SENTINEL;){if(m(i)){u(i.left,!1),u(i.right,!1),i===i.parent.right&&(n-=i.parent.offset),i=i.parent;continue}if(!m(i.left)){if(f=n+i.maxEnd,f<t){u(i,!0);continue}if(i.left!==o.SENTINEL){i=i.left;continue}}if(d=n+i.start,d>e){u(i,!0);continue}if(h=n+i.end,h>=t&&(i.setCachedOffsets(d,h,r),O.push(i)),u(i,!0),i.right!==o.SENTINEL&&!m(i.right)){n+=i.offset,i=i.right;continue}}return u(s.root,!1),O}function z(s,t){if(s.root===o.SENTINEL)return t.parent=o.SENTINEL,t.left=o.SENTINEL,t.right=o.SENTINEL,c(t,l.Black),s.root=t,s.root;_t(s,t),T(t.parent);let e=t;for(;e!==s.root&&g(e.parent)===l.Red;)if(e.parent===e.parent.parent.left){const r=e.parent.parent.right;g(r)===l.Red?(c(e.parent,l.Black),c(r,l.Black),c(e.parent.parent,l.Red),e=e.parent.parent):(e===e.parent.right&&(e=e.parent,U(s,e)),c(e.parent,l.Black),c(e.parent.parent,l.Red),V(s,e.parent.parent))}else{const r=e.parent.parent.left;g(r)===l.Red?(c(e.parent,l.Black),c(r,l.Black),c(e.parent.parent,l.Red),e=e.parent.parent):(e===e.parent.left&&(e=e.parent,V(s,e)),c(e.parent,l.Black),c(e.parent.parent,l.Red),U(s,e.parent.parent))}return c(s.root,l.Black),t}function _t(s,t){let e=0,r=s.root;const i=t.start,n=t.end;for(;;)if(Ht(i,n,r.start+e,r.end+e)<0)if(r.left===o.SENTINEL){t.start-=e,t.end-=e,t.maxEnd-=e,r.left=t;break}else r=r.left;else if(r.right===o.SENTINEL){t.start-=e+r.offset,t.end-=e+r.offset,t.maxEnd-=e+r.offset,r.right=t;break}else e+=r.offset,r=r.right;t.parent=r,t.left=o.SENTINEL,t.right=o.SENTINEL,c(t,l.Red)}function tt(s,t){let e,r;if(t.left===o.SENTINEL?(e=t.right,r=t,e.offset+=t.offset,(e.offset<F||e.offset>$)&&(s.requestNormalizeOffsets=!0),e.start+=t.offset,e.end+=t.offset):t.right===o.SENTINEL?(e=t.left,r=t):(r=jt(t.right),e=r.right,e.start+=r.offset,e.end+=r.offset,e.offset+=r.offset,(e.offset<F||e.offset>$)&&(s.requestNormalizeOffsets=!0),r.start+=t.offset,r.end+=t.offset,r.offset=t.offset,(r.offset<F||r.offset>$)&&(s.requestNormalizeOffsets=!0)),r===s.root){s.root=e,c(e,l.Black),t.detach(),et(),D(e),s.root.parent=o.SENTINEL;return}const i=g(r)===l.Red;if(r===r.parent.left?r.parent.left=e:r.parent.right=e,r===t?e.parent=r.parent:(r.parent===t?e.parent=r:e.parent=r.parent,r.left=t.left,r.right=t.right,r.parent=t.parent,c(r,g(t)),t===s.root?s.root=r:t===t.parent.left?t.parent.left=r:t.parent.right=r,r.left!==o.SENTINEL&&(r.left.parent=r),r.right!==o.SENTINEL&&(r.right.parent=r)),t.detach(),i){T(e.parent),r!==t&&(T(r),T(r.parent)),et();return}T(e),T(e.parent),r!==t&&(T(r),T(r.parent));let n;for(;e!==s.root&&g(e)===l.Black;)e===e.parent.left?(n=e.parent.right,g(n)===l.Red&&(c(n,l.Black),c(e.parent,l.Red),U(s,e.parent),n=e.parent.right),g(n.left)===l.Black&&g(n.right)===l.Black?(c(n,l.Red),e=e.parent):(g(n.right)===l.Black&&(c(n.left,l.Black),c(n,l.Red),V(s,n),n=e.parent.right),c(n,g(e.parent)),c(e.parent,l.Black),c(n.right,l.Black),U(s,e.parent),e=s.root)):(n=e.parent.left,g(n)===l.Red&&(c(n,l.Black),c(e.parent,l.Red),V(s,e.parent),n=e.parent.left),g(n.left)===l.Black&&g(n.right)===l.Black?(c(n,l.Red),e=e.parent):(g(n.left)===l.Black&&(c(n.right,l.Black),c(n,l.Red),U(s,n),n=e.parent.left),c(n,g(e.parent)),c(e.parent,l.Black),c(n.left,l.Black),V(s,e.parent),e=s.root));c(e,l.Black),et()}function jt(s){for(;s.left!==o.SENTINEL;)s=s.left;return s}function et(){o.SENTINEL.parent=o.SENTINEL,o.SENTINEL.offset=0,o.SENTINEL.start=0,o.SENTINEL.end=0}function U(s,t){const e=t.right;e.offset+=t.offset,(e.offset<F||e.offset>$)&&(s.requestNormalizeOffsets=!0),e.start+=t.offset,e.end+=t.offset,t.right=e.left,e.left!==o.SENTINEL&&(e.left.parent=t),e.parent=t.parent,t.parent===o.SENTINEL?s.root=e:t===t.parent.left?t.parent.left=e:t.parent.right=e,e.left=t,t.parent=e,D(t),D(e)}function V(s,t){const e=t.left;t.offset-=e.offset,(t.offset<F||t.offset>$)&&(s.requestNormalizeOffsets=!0),t.start-=e.offset,t.end-=e.offset,t.left=e.right,e.right!==o.SENTINEL&&(e.right.parent=t),e.parent=t.parent,t.parent===o.SENTINEL?s.root=e:t===t.parent.right?t.parent.right=e:t.parent.left=e,e.right=t,t.parent=e,D(t),D(e)}function bt(s){let t=s.end;if(s.left!==o.SENTINEL){const e=s.left.maxEnd;e>t&&(t=e)}if(s.right!==o.SENTINEL){const e=s.right.maxEnd+s.offset;e>t&&(t=e)}return t}function D(s){s.maxEnd=bt(s)}function T(s){for(;s!==o.SENTINEL;){const t=bt(s);if(s.maxEnd===t)return;s.maxEnd=t,s=s.parent}}function Ht(s,t,e,r){return s===e?t-r:s-e}var w,B,N,K,X,y,Ot,Tt;class le{constructor(t){E(this,y);E(this,w);E(this,B,new Map);E(this,N);E(this,K,new At);E(this,X,new Wt({capacity:1e3}));var e;R(this,w,j.createLogger((e=t.label)!=null?e:"TextRangeManager")),R(this,N,new Jt(t.initialTextRevision))}pushTextChange({change:t,revision:e}){a(this,X).push({change:new Ft(t),revision:e});const r=a(this,N).acceptEdit(t,e).map(d=>a(this,B).get(d)).filter(G),i=t.ops[0],n=i&&mt(i)?i.retain:0,f=()=>Qt(r,J(a(this,N).intervalSearch(n,Number.MAX_SAFE_INTEGER),_(d=>a(this,B).get(d)),P(G)));return a(this,w).verbose("pushTextChange",{change:t,revision:e,affectedRanges:r}),{affectedRanges:r,getChangedRanges:f}}add(t){return J(q(this,y,Ot).call(this,t,It(a(this,N).revision)),wt(e=>{var n;const r=new o(e.start,e.end,Yt(t.updateSemantics),t.onBeforeEditOperation);a(this,N).insert(r);const i=new Kt({id:(n=t.id)!=null?n:a(this,K).next(),node:r,intervalTree:a(this,N),metadata:t.metadata,onDispose:()=>{a(this,N).delete(r),a(this,B).delete(r)}});return a(this,B).set(r,i),i}))}getIntersecting(t){return J(a(this,N).intervalSearch(t.start,t.end),_(e=>a(this,B).get(e)),P(G),Z)}getAllInOrder(){return J(a(this,N).getAllInOrder(),_(t=>a(this,B).get(t)),P(G),Z)}[Symbol.dispose](){a(this,B).clear()}}w=new WeakMap,B=new WeakMap,N=new WeakMap,K=new WeakMap,X=new WeakMap,y=new WeakSet,Ot=function(t,e){const{range:r,revision:i,updateSemantics:n}=t;if(i===a(this,N).revision)return dt(r);const f=q(this,y,Tt).call(this,i),d=f.reduce((O,Q)=>Q.transformPosition(O),r.start),h=f.reduce((O,Q)=>Q.transformPosition(O,!0),r.end);return h-d<=0||h-d!==r.end-r.start&&n===rt.Collapse?(a(this,w).warn("Collapsed range ".concat(ut(r)," after rebasing from ").concat(i," to ").concat(a(this,N).revision,". New range: ").concat(ut({start:d,end:h})),{delivery:!1}),a(this,w).verbose("Changes:",f),xt(new Zt({fromRevision:t.revision,toRevision:e,range:t.range,rebasedRange:{start:d,end:h},deltas:f}))):dt({start:d,end:h})},Tt=function(t){return J(a(this,X),P(e=>e.revision>t),_(e=>e.change),Z)};var C,x,M;class Kt{constructor(t){E(this,C);E(this,x);E(this,M,new DisposableStack);p(this,"id");p(this,"metadata");this.id=t.id,R(this,C,t.node),R(this,x,t.intervalTree),this.metadata=t.metadata,a(this,M).defer(t.onDispose)}get start(){return a(this,M).disposed?(j.warn("Cannot access DefaultLiveTextRange.start after disposal"),NaN):(a(this,x).resolveNodeIfNeeded(a(this,C)),a(this,C).cachedAbsoluteStart)}get end(){return a(this,M).disposed?(j.warn("Cannot access DefaultLiveTextRange.end after disposal"),NaN):(a(this,x).resolveNodeIfNeeded(a(this,C)),a(this,C).cachedAbsoluteEnd)}get revision(){return It(a(this,x).revision)}[Symbol.dispose](){a(this,M).dispose()}toJSON(){return{start:this.start,end:this.end,revision:this.revision,metadata:this.metadata}}}C=new WeakMap,x=new WeakMap,M=new WeakMap;function*Qt(s,t){const e=new Set(s);for(const r of s)yield r;for(const r of t){if(e.size>0&&e.has(r)){e.delete(r);continue}yield r}}function Yt(s){if(s===rt.Resize)return I.Resize;if(s===rt.Collapse)return I.Collapse;throw new Mt(s)}class Zt extends Dt{constructor(e){super("Failed to rebase range");p(this,"fromRevision");p(this,"toRevision");p(this,"deltas");p(this,"range");p(this,"rebasedRange");this.fromRevision=e.fromRevision,this.toRevision=e.toRevision,this.deltas=e.deltas,this.range=e.range,this.rebasedRange=e.rebasedRange}toJSON(){return{...super.toJSON(),fromRevision:this.fromRevision,toRevision:this.toRevision,range:this.range,rebasedRange:this.rebasedRange,deltas:this.deltas.map(zt)}}}function zt(s){return{ops:s.ops.map(t=>({[$t(t)]:St(t)?"x".repeat(st(t)):st(t),...t.attributes?{attributes:{...t.attributes,..."link"in t.attributes?{link:"x"}:{}}}:{}}))}}export{le as D,ae as a,oe as i,ut as t,ne as u,fe as w};
//# sourceMappingURL=TextRangeManager-DvK9Ko49-Cf455Kbz.js.map
