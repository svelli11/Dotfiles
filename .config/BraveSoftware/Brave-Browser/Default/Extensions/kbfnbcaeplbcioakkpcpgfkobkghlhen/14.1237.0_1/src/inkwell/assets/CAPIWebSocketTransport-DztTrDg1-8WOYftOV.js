var H=Object.defineProperty;var U=i=>{throw TypeError(i)};var $=(i,e,t)=>e in i?H(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var d=(i,e,t)=>$(i,typeof e!="symbol"?e+"":e,t),W=(i,e,t)=>e.has(i)||U("Cannot "+t);var s=(i,e,t)=>(W(i,e,"read from private field"),t?t.call(i):e.get(i)),o=(i,e,t)=>e.has(i)?U("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),l=(i,e,t,r)=>(W(i,e,"write to private field"),r?r.call(i,t):e.set(i,t),t),b=(i,e,t)=>(W(i,e,"access private method"),t);var M=(i,e,t,r)=>({set _(n){l(i,e,n,t)},get _(){return s(i,e,r)}});import{u as v,S as w,k as m,I as K,f as Q,l as X,N as A,C as D,P as Y,O as Z}from"./start-BFd-djfI.js";const z={NormalClosure:1e3,GoingAway:1001,ProtocolError:1002,UnsupportedData:1003,NoStatusReceived:1005,AbnormalClosure:1006,InvalidFramePayloadData:1007,PolicyViolation:1008,MessageTooBig:1009,MandatoryExtension:1010,InternalServerError:1011,TLSHandshake:1015},ss=()=>new Y(Z);var N,x,F,h,c,p,g,I,T,y,S,G,J,L;class es{constructor(e){o(this,S);o(this,N,new w);o(this,x,new w);o(this,F,new w);o(this,h);o(this,c);o(this,p,Promise.withResolvers());o(this,g);o(this,I,"");o(this,T,0);o(this,y,!1);d(this,"didClose",m(s(this,N)));d(this,"didReceive",m(s(this,x)));d(this,"didError",m(s(this,F)));var r;l(this,h,{...e,capiFeatures:[...new Set(e.capiFeatures)],sduiComponents:[...new Set(e.sduiComponents)]}),l(this,g,(r=s(this,h).sanitizer)!=null?r:ss()),l(this,c,new WebSocket(s(this,h).getURL(s(this,h).documentId)));const t=new AbortController;s(this,c).onopen=async()=>{for(const n of[()=>b(this,S,G).call(this),()=>s(this,p).resolve(this)]){if(t.signal.aborted)return;try{await n()}catch(B){X.error(A(B))}}l(this,y,!0)},s(this,c).onerror=n=>{t.abort(),s(this,p).reject(n),s(this,F).next(A(n))},s(this,c).onmessage=async n=>{s(this,y)||await s(this,p).promise,!t.signal.aborted&&b(this,S,J).call(this,b(this,S,L).call(this,n))},s(this,c).onclose=n=>{t.abort(),s(this,p).reject(new D("WebSocket closed")),s(this,N).next({webSocket:{code:n.code,reason:n.reason,wasClean:n.wasClean}})}}get sessionId(){return s(this,p).promise.then(()=>s(this,I))}get waitForConnection(){return s(this,p).promise}send(e){const t=M(this,T)._++;return Reflect.set(e,"id",t),s(this,c).send(JSON.stringify(e,(r,n)=>typeof n=="string"?s(this,g).sanitize(n):n)),t}[Symbol.dispose](){switch(s(this,c).readyState){case WebSocket.CONNECTING:s(this,c).close(z.GoingAway);break;case WebSocket.OPEN:s(this,c).close(z.NormalClosure);break}}}N=new WeakMap,x=new WeakMap,F=new WeakMap,h=new WeakMap,c=new WeakMap,p=new WeakMap,g=new WeakMap,I=new WeakMap,T=new WeakMap,y=new WeakMap,S=new WeakSet,G=async function(){this.send({id:0,docid:s(this,h).documentId,action:"start",clientSupports:s(this,h).capiFeatures,client:s(this,h).clientType,clientSubtype:"general",clientVersion:s(this,h).clientVersion,clientConfigs:{sdui:{version:"4.0.0",config:{...s(this,h).sduiRenderers,"":{dslSchema:"4.49.1",supportedForms:["inline"],supportedComponents:s(this,h).sduiComponents}}}}})},J=function(e){e.action==="start"&&(l(this,I,e.sessionUuid),l(this,y,!0)),s(this,x).next(e)},L=function(e){if(typeof e.data!="string")throw new ts(s(this,c).binaryType,e.data);try{return JSON.parse(e.data,(t,r)=>typeof r=="string"?s(this,g).unsanitize(r):r)}catch(t){throw new is(e.data,t)}};var O;class ns{constructor(e){o(this,O);l(this,O,e)}create(e){return v(()=>new es({...e,...s(this,O)}).waitForConnection)}[Symbol.dispose](){}}O=new WeakMap;class ts extends D{constructor(t,r){super("Unsupported message data");d(this,"binaryType");d(this,"data");this.binaryType=t,this.data=r}}class is extends D{constructor(t,r){super("Failed to parse JSON message",A(r));d(this,"data");this.data=t}}var P,a,R,f,C,k,E,u,_,j,V,q;class as{constructor(e){o(this,u);o(this,P,new DisposableStack);o(this,a,null);o(this,R);o(this,f,new w);o(this,C,new w);o(this,k,new w);o(this,E,new w);d(this,"messageReceived",m(s(this,E)));d(this,"didClose",m(s(this,C)));d(this,"didError",m(s(this,k)));d(this,"didOpen",m(s(this,f)));l(this,R,e),s(this,P).defer(()=>{s(this,f).complete(),s(this,C).complete(),s(this,k).complete(),s(this,E).complete()})}[Symbol.dispose](){s(this,P).dispose()}connect(){l(this,a,new WebSocket(s(this,R))),s(this,a).onmessage=b(this,u,_).bind(this),s(this,a).onclose=b(this,u,j).bind(this),s(this,a).onerror=b(this,u,V).bind(this),s(this,a).onopen=b(this,u,q).bind(this)}send(e){return s(this,a)?K(()=>{var t;return(t=s(this,a))==null?void 0:t.send(e)}):Q(new Error("WebSocket does not exist"))}close(){var e;(e=s(this,a))==null||e.close()}}P=new WeakMap,a=new WeakMap,R=new WeakMap,f=new WeakMap,C=new WeakMap,k=new WeakMap,E=new WeakMap,u=new WeakSet,_=function(e){s(this,E).next(e)},j=function(e){s(this,a)&&(s(this,a).onmessage=null,s(this,a).onclose=null,s(this,a).onerror=null,s(this,a).onopen=null),s(this,C).next(e)},V=function(e){s(this,k).next(e)},q=function(e){s(this,f).next(e)};export{as as D,ns as W};
//# sourceMappingURL=CAPIWebSocketTransport-DztTrDg1-8WOYftOV.js.map
