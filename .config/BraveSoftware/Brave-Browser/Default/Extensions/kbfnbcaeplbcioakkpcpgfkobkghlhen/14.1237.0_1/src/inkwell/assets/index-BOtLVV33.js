var De=Object.defineProperty;var ne=t=>{throw TypeError(t)};var Ee=(t,e,s)=>e in t?De(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var oe=(t,e,s)=>Ee(t,typeof e!="symbol"?e+"":e,s),ue=(t,e,s)=>e.has(t)||ne("Cannot "+s);var l=(t,e,s)=>(ue(t,e,"read from private field"),s?s.call(t):e.get(t)),_=(t,e,s)=>e.has(t)?ne("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),h=(t,e,s,r)=>(ue(t,e,"write to private field"),r?r.call(t,s):e.set(t,s),s);import{C as pe,p as u,m as $,l as A,ah as $e,au as Re,j as te,e as p,a as We,K as be,w as Oe,f as X,i as se,n as Z,S as fe,k as ve,g as Ae,a6 as Pe,t as Fe,b3 as _e,v as Ne,b4 as me,h as Be,R as Le,L as le}from"./index-uVYElzgq.js";import{SuggestionStoreManagerToken as ce,SuggestionServiceToken as Ue}from"./index-U7nj2qyb.js";import{D as Y}from"./Delta-D-dso3t3-DM06-Vr-.js";import{i as Ge}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{D as Ie}from"./TextRangeManager-DvK9Ko49-Cf455Kbz.js";import{T as ze}from"./TextRangeUpdateSemantics-D8MqPOrG-S_bbHJO0.js";import{c as Ve}from"./concat-DqL665aX.js";import{d as qe}from"./defer-BLWpl2MB.js";import{f as b}from"./NonEmptyArrayFns-oGa02u3x-CLyX5YlY.js";import{o as Ke}from"./of-DPWY87hm.js";import{E as Ye}from"./mergeAll-CSDR5lBs.js";import{d as de}from"./defineFactory-DJYNRBNc-CmRNy_rl.js";import"./PluginModule-CRib3PLZ-LTQDm_KX.js";var He=Object.defineProperty,Je=(t,e,s)=>e in t?He(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,P=(t,e,s)=>Je(t,typeof e!="symbol"?e+"":e,s);class Qe extends pe{constructor(e){super("Suggestion not found"),P(this,"kind","SuggestionNotFoundError"),P(this,"suggestionId"),this.suggestionId=e}}class Xe extends pe{constructor(e,s){super("Suggestion alternative not found"),P(this,"kind","AlternativeIndexOutOfBoundsError"),P(this,"suggestionId"),P(this,"alternativeIndex"),this.suggestionId=e,this.alternativeIndex=s}}var Se=t=>{throw TypeError(t)},re=(t,e,s)=>e.has(t)||Se("Cannot "+s),we=(t,e,s)=>(re(t,e,"read from private field"),s?s.call(t):e.get(t)),H=(t,e,s)=>e.has(t)?Se("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),ge=(t,e,s,r)=>(re(t,e,"write to private field"),e.set(t,s),s),Ze=(t,e,s)=>(re(t,e,"access private method"),s),U,q,j,xe;class je{constructor(e,s){H(this,j),H(this,U),H(this,q),ge(this,U,e),ge(this,q,s.getRootStore())}apply(e){const s=u(te(u(e,p(({suggestionId:r,alternativeIndex:a})=>Ze(this,j,xe).call(this,r,a!=null?a:0)))),$(r=>Re(r.flat(),a=>a.revision)),$(r=>{var a;return r.size>1&&(A.warn("Multiple revisions in a single apply call.",{delivery:!0}),A.verbose("Request:",e),A.verbose("Replacements by revision:",r)),(a=$e(r.entries()))!=null?a:[Ge,[]]}));return u(Oe(s),We(([r,a])=>a.length===0?be():we(this,U).setText({revision:r,change:a.reduce((i,o)=>i.compose(o.delta),new Y)})))}}U=new WeakMap;q=new WeakMap;j=new WeakSet;xe=function(t,e){const s=we(this,q).get(t);if(!s)return X(new Qe(t));const r=[];for(const a of s.transforms){if(!a.alternatives)continue;const i=a.alternatives[e];if(!i)return X(new Xe(t,e));r.push({revision:s.revision,range:a.context,delta:new Y([{retain:a.context.start},...i.ops])})}return se(r)};var x;class et{constructor(e){_(this,x);h(this,x,new Ie({...e,initialTextRevision:e.textRevision,label:"TransformManager/TextRangeManager"}))}pushTextChange({change:e,revision:s}){const r=l(this,x).pushTextChange({change:e,revision:s}),a=[];for(const i of r.affectedRanges)a.push(i.metadata),i.metadata.onEditComplete(e);return{getChangedTransforms:()=>u(r.getChangedRanges(),p(i=>i.metadata)),affectedTransforms:a}}add({context:e,alternatives:s,metadata:r,revision:a}){const i=l(this,x).add({range:e,revision:a,updateSemantics:ze.Resize,metadata:new tt({getTextRange:()=>i.ok?i.value:e,getRevision:()=>i.ok?i.value.revision:a,onDispose:()=>Z(i),alternatives:s,metadata:r}),onBeforeEditOperation:(o,g)=>u(i,$(v=>v.metadata.onBeforeEditOperation(o,g)))});return u(i,$(o=>o.metadata))}[Symbol.dispose](){Z(l(this,x))}}x=new WeakMap;var N,B,L,f,k;class tt{constructor(e){_(this,N);_(this,B);_(this,L);_(this,f);_(this,k,null);oe(this,"metadata");h(this,N,e.onDispose),h(this,B,e.getTextRange),h(this,L,e.getRevision),h(this,f,e.alternatives),this.metadata=e.metadata}onBeforeEditOperation(e,s){l(this,k)!==null&&h(this,k,this.context.start)}onEditComplete(e){const s=l(this,k);s!==null&&(h(this,f,l(this,f).map(r=>r.compose(e.slice(s)))),h(this,k,null))}get context(){const e=l(this,B).call(this);return{start:e.start,end:e.end}}get alternatives(){return l(this,f)}get absoluteAlternatives(){return l(this,f).map(e=>new Y().retain(this.context.start).compose(e))}get revision(){return l(this,L).call(this)}[Symbol.dispose](){l(this,N).call(this)}}N=new WeakMap,B=new WeakMap,L=new WeakMap,f=new WeakMap,k=new WeakMap;var st=Object.defineProperty,ke=t=>{throw TypeError(t)},rt=(t,e,s)=>e in t?st(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,at=(t,e,s)=>rt(t,e+"",s),ae=(t,e,s)=>e.has(t)||ke("Cannot "+s),n=(t,e,s)=>(ae(t,e,"read from private field"),e.get(t)),y=(t,e,s)=>e.has(t)?ke("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),he=(t,e,s,r)=>(ae(t,e,"write to private field"),e.set(t,s),s),G=(t,e,s)=>(ae(t,e,"access private method"),s),E,F,d,S,w,D,ye,Me,ie;class it{constructor(e){y(this,D),y(this,E),y(this,F),y(this,d,new Map),y(this,S,new DisposableStack),y(this,w,new fe),at(this,"changes",u(Ve(qe(()=>{const s=b(this.values());return s?Ke({kind:"suggestionsUpserted",suggestions:s}):Ye}),n(this,w)),ve)),he(this,E,A.createLogger("SuggestionStore",e.textDocument.id)),n(this,S).defer(()=>e.onDispose()),he(this,F,n(this,S).use(new et({textRevision:e.textDocument.text.getValue().revision}))),n(this,S).use(e.textDocument.textChange.subscribe(s=>{const{affectedTransforms:r}=n(this,F).pushTextChange(s),a=u(new Set(r.map(i=>i.metadata)),p(i=>n(this,d).get(i)),Ae(Pe),p(i=>i.suggestion),b);a&&n(this,w).next({kind:"suggestionsAffectedByTextChange",suggestions:a})})),n(this,S).defer(()=>G(this,D,ye).call(this))}get(e){var s,r;return(r=(s=n(this,d).get(e))==null?void 0:s.suggestion)!=null?r:null}values(){return u(n(this,d).values(),p(e=>e.suggestion))}upsert(e){const r=Fe(e).map(i=>u(G(this,D,Me).call(this,i),$(()=>i))),a=u(_e(r).success,b);return a&&n(this,w).next({kind:"suggestionsUpserted",suggestions:a}),u(te(r),$(Ne))}remove(e){const s=u(e,p(r=>{var a;return(a=n(this,d).get(r))==null?void 0:a.suggestion}),me(r=>r&&G(this,D,ie).call(this,r.id)?[{id:r.id,kind:r.kind}]:[]),b);s&&n(this,w).next({kind:"suggestionsRemoved",suggestions:s})}clear(){return this.remove(u(this.values(),p(e=>e.id)))}[Symbol.dispose](){n(this,S).dispose()}}E=new WeakMap;F=new WeakMap;d=new WeakMap;S=new WeakMap;w=new WeakMap;D=new WeakSet;ye=function(){const t=b(u(n(this,d).values(),p(e=>({id:e.suggestion.id,kind:e.suggestion.kind}))));t&&n(this,w).next({kind:"suggestionsRemoved",suggestions:t})};Me=function(t){const e=t,{success:s,failure:r}=_e(u(e.transforms,p(a=>{var i,o;return n(this,F).add({revision:e.revision,context:a.context,alternatives:(o=(i=a.alternatives)==null?void 0:i.map(g=>new Y(g)))!=null?o:[],metadata:e.id})})));if(r.length>0){s.forEach(i=>i[Symbol.dispose]());const a=new AggregateError(r);return n(this,E).error("Error upserting suggestion",a,{delivery:!0}),n(this,E).verbose("Error upserting suggestion ".concat(e.id),a),X(a)}return G(this,D,ie).call(this,e.id),n(this,d).set(e.id,{suggestion:t,transforms:s}),n(this,E).verbose("Upserted suggestion ".concat(e.id),e),se()};ie=function(t){var e;const s=n(this,d).get(t);return s===void 0?!1:(Z((e=s==null?void 0:s.transforms)!=null?e:[]),n(this,d).delete(t),!0)};var nt=Object.defineProperty,ot=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),K=t=>{throw TypeError(t)},ut=(t,e,s)=>e in t?nt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,lt=(t,e,s)=>ut(t,e+"",s),ct=(t,e,s)=>e.has(t)||K("Cannot "+s),m=(t,e,s)=>(ct(t,e,"read from private field"),s?s.call(t):e.get(t)),J=(t,e,s)=>e.has(t)?K("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),dt=(t,e,s)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&K("Object expected");var r;r===void 0&&(r=e[ot("dispose")]),typeof r!="function"&&K("Object not disposable"),t.push([s,r,e])}return e},gt=(t,e,s)=>{var r=typeof SuppressedError=="function"?SuppressedError:function(o,g,v,R){return R=Error(v),R.name="SuppressedError",R.error=o,R.suppressed=g,R},a=o=>e=s?new r(o,e,"An error was suppressed during disposal"):(s=!0,o),i=o=>{for(;o=t.pop();)try{var g=o[1]&&o[1].call(o[2]);if(o[0])return Promise.resolve(g).then(i,v=>(a(v),i()))}catch(v){a(v)}if(s)throw e};return i()},ee,M,I;class ht{constructor(){J(this,ee,new DisposableStack),J(this,M,new Set),J(this,I,new fe),lt(this,"changes",ve(m(this,I)))}add(e){var s=[];try{const i=dt(s,new DisposableStack),o=e;return i.use(e.changes.subscribe(g=>m(this,I).next(g))),i.defer(()=>m(this,M).delete(o)),m(this,M).add(o),i.move()}catch(i){var r=i,a=!0}finally{gt(s,r,a)}}get(e){for(const s of m(this,M)){const r=s.get(e);if(r)return r}return null}values(){return u(m(this,M),me(e=>e.values()))}[Symbol.dispose](){m(this,ee).dispose()}}ee=new WeakMap;M=new WeakMap;I=new WeakMap;var Te=t=>{throw TypeError(t)},Ce=(t,e,s)=>e.has(t)||Te("Cannot "+s),c=(t,e,s)=>(Ce(t,e,"read from private field"),s?s.call(t):e.get(t)),W=(t,e,s)=>e.has(t)?Te("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),Q=(t,e,s,r)=>(Ce(t,e,"write to private field"),e.set(t,s),s),z,T,C,O,V;class pt{constructor(e){W(this,z),W(this,T,new DisposableStack),W(this,C,new Map),W(this,O),W(this,V),Q(this,z,A.createLogger("SuggestionStoreManager",e.id)),Q(this,V,e),Q(this,O,c(this,T).use(new ht)),c(this,T).defer(()=>c(this,C).clear())}createStore(e){const s=c(this,T).use(new it({textDocument:c(this,V),onDispose:()=>c(this,C).delete(e)}));return c(this,C).set(e,s),c(this,O).add(s),c(this,z).verbose("Created suggestions store",s),s}getRootStore(){return c(this,O)}getStore(e){var s;return(s=c(this,C).get(e))!=null?s:null}[Symbol.dispose](){c(this,T).dispose()}}z=new WeakMap;T=new WeakMap;C=new WeakMap;O=new WeakMap;V=new WeakMap;const $t=t=>u(te([se(t.getExecutionScopeDefinition("document-session")),t.getPlugin("document-session")]),Be(([e,s])=>Le.all([e.register({token:ce,useFactory:de(pt,[s.provides.TextDocument])},{lifetime:le.Singleton}),e.register({token:Ue,useFactory:de(je,[s.provides.TextDocument,ce])},{lifetime:le.Singleton})])));export{$t as activate};
//# sourceMappingURL=index-BOtLVV33.js.map
