var gs=Object.defineProperty;var nn=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),Lt=i=>{throw TypeError(i)};var ms=(i,e,t)=>e in i?gs(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var qt=(i,e,t)=>ms(i,typeof e!="symbol"?e+"":e,t),Ri=(i,e,t)=>e.has(i)||Lt("Cannot "+t);var c=(i,e,t)=>(Ri(i,e,"read from private field"),t?t.call(i):e.get(i)),y=(i,e,t)=>e.has(i)?Lt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),M=(i,e,t,n)=>(Ri(i,e,"write to private field"),n?n.call(i,t):e.set(i,t),t),N=(i,e,t)=>(Ri(i,e,"access private method"),t);var sn=(i,e,t,n)=>({set _(s){M(i,e,s,t)},get _(){return c(i,e,n)}});var et=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Lt("Object expected");var n;t&&(n=e[nn("asyncDispose")]),n===void 0&&(n=e[nn("dispose")]),typeof n!="function"&&Lt("Object not disposable"),i.push([t,n,e])}else t&&i.push([t]);return e},tt=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,d,l){return l=Error(d),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,d=>(s(d),a()))}catch(d){s(d)}if(t)throw e};return a()};import{p as m,m as xe,q as Ei,j as $i,R as lt,i as $e,L as ht,Q as ps,c as ni,f as Oi,aS as bn,C as vs,v as ws,l as zt,S as fe,k as Qt,ad as Pi,z as mt,s as Re,t as q,aM as Xi,b as I,aT as Oe,a1 as j,d as $,aR as Rn,r as pi,ah as rn,aU as Ut,aV as ys,a0 as an,aW as on,G as ce,o as Dt,g as pt,U as Mn,aO as oe,A as _s,a9 as xs,Y as bs,aX as ln,n as Rs,e as Ms,I as Mi,ag as hn,h as kn,B as ks}from"./start-BFd-djfI.js";import{r as Ss}from"./index-Bm4tEXCw.js";import{e as Ds,T as Ts}from"./index-DIq9RWYQ.js";import{TextDecorationsViewToken as Es}from"./index-oQtk5Yhs.js";import{e as Bs,i as Yi,n as Cs}from"./index-COojv98b.js";import{b as Sn}from"./finalize-u5oIwZfS.js";import{d as Dn}from"./debounceTime-DnL_PUPV.js";import{o as As}from"./of-Boi_-3cC.js";import{a as Is}from"./asap-_5Afx9lb.js";import{b as Ws,a as Gs,s as $s}from"./throttleTime-CTmwR84S.js";import{E as Tt}from"./mergeAll-D275NTmK.js";import{b as Os,c as Ps,i as Et,e as Xs,d as Zt,u as Vi,f as Ys,g as Vs,a as zs}from"./RectFns-ndpeBtT0-CdOd3O5S.js";import{c as Tn,t as cn}from"./PixelFns-BIHP7Exp-Cxsb96Xk.js";import{T as Fs}from"./TextRevisionSynchronizedQueue-DQV4bu5q-DZsfBpcW.js";import{i as dn,w as un,D as Ls,a as zi,t as Fi,u as qs}from"./TextRangeManager-DvK9Ko49-CTCZEC3i.js";import{m as si,f as vt,a as fn}from"./NonEmptyArrayFns-oGa02u3x-CLyX5YlY.js";import{d as En}from"./distinctUntilChanged-GMQNSCXg.js";import{s as ri}from"./switchMap-BkKtxKb2.js";import{i as Li}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{t as Us}from"./timer--E-2U5R1.js";import{t as gn}from"./take-gJdc_Sb0.js";import{w as Ns}from"./ScreenPointFns-7sGy0XGN-DYTqdHzE.js";import{j as Hs}from"./jsx-runtime-BtQ6Bsb4.js";import{d as Qs}from"./defineFactory-DJYNRBNc-BvZfVSHA.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-B43Hjk20.js";import"./merge-obdQTFL6.js";import"./async-BZW1XXsj.js";import"./AsyncScheduler-BhBy18pz.js";import"./dateTimestampProvider-CV0dHcg-.js";import"./Delta-D-dso3t3-DM06-Vr-.js";import"./TextRangeUpdateSemantics-D8MqPOrG-S_bbHJO0.js";function Zs(i){var s=[];try{const e=et(s,new DisposableStack);const t=ni();const n=ni();e.use(i.scopeDefinition.onStart(async d=>m($i([d.resolve(i.localEntityToken),d.resolve(n)]),xe(([l,f])=>{const g=m(d.realm.resolveEntity(i.remoteEntityToken,l),Ei(p=>p.entity));f.resolve(g)}))));return m(lt.all([i.scopeDefinition.register({token:n,useFactory:()=>$e(Promise.withResolvers())},{lifetime:ht.Singleton}),i.scopeDefinition.register({token:t,useFactory:d=>m(d.resolve(n),xe(l=>ps(l.promise)))},{lifetime:ht.Singleton})]),lt.use(e),xe(()=>{const d=e.move();return{remoteEntityToken:t,[Symbol.dispose]:()=>d.dispose()}}))}catch(a){var r=a,o=!0}finally{tt(s,r,o)}}const Js=(i,e)=>new Promise(t=>{queueMicrotask(async()=>{var n;if((n=e==null?void 0:e.signal)!=null&&n.aborted)return t(Oi(new Bn(e.signal.reason)));try{t($e(await i()))}catch(s){t(bn(s))}})});class Bn extends vs{constructor(e){super(e instanceof Error?e.message:String(e))}}function Ks(i,e){let t=null,n=!1;const s=r=>{t==null||t.abortController.abort(r),t==null||t.resolvers.resolve(Oi(new Bn(r!=null?r:"signal is aborted without reason"))),t=null},a=({resolvers:r})=>{n=!0,e(async()=>{if(!t)return;const o=t;t=null,await i(...o.args)},{signal:t==null?void 0:t.abortController.signal}).then(o=>{n=!1,r.resolve(m(o,xe(ws))),t&&a(t)},o=>{zt.error("Unexpected error when scheduling task in createSingletonTaskQueue()",o),n=!1,r.resolve(bn(o)),t&&a(t)})};return{enqueue:(...r)=>{var d,l;const o=(d=t==null?void 0:t.resolvers)!=null?d:Promise.withResolvers();return t={resolvers:o,args:r,abortController:(l=t==null?void 0:t.abortController)!=null?l:new AbortController},n||a(t),o.promise},get empty(){return!t},cancel:s,[Symbol.dispose]:s}}function js(i,e,t,n,s){Cn(i,e,t||0,n||i.length-1,s||er)}function Cn(i,e,t,n,s){for(;n>t;){if(n-t>600){var a=n-t+1,r=e-t+1,o=Math.log(a),d=.5*Math.exp(2*o/3),l=.5*Math.sqrt(o*d*(a-d)/a)*(r-a/2<0?-1:1),f=Math.max(t,Math.floor(e-r*d/a+l)),g=Math.min(n,Math.floor(e+(a-r)*d/a+l));Cn(i,e,f,g,s)}var p=i[e],v=t,w=n;for(xt(i,t,e),s(i[n],p)>0&&xt(i,t,n);v<w;){for(xt(i,v,w),v++,w--;s(i[v],p)<0;)v++;for(;s(i[w],p)>0;)w--}s(i[t],p)===0?xt(i,t,w):(w++,xt(i,w,n)),w<=e&&(t=w+1),e<=w&&(n=w-1)}}function xt(i,e,t){var n=i[e];i[e]=i[t],i[t]=n}function er(i,e){return i<e?-1:i>e?1:0}class An{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const n=[];if(!Ht(e,t))return n;const s=this.toBBox,a=[];for(;t;){for(let r=0;r<t.children.length;r++){const o=t.children[r],d=t.leaf?s(o):o;Ht(e,d)&&(t.leaf?n.push(o):Si(e,d)?this._all(o,n):a.push(o))}t=a.pop()}return n}collides(e){let t=this.data;if(!Ht(e,t))return!1;const n=[];for(;t;){for(let s=0;s<t.children.length;s++){const a=t.children[s],r=t.leaf?this.toBBox(a):a;if(Ht(e,r)){if(t.leaf||Si(e,r))return!0;n.push(a)}}t=n.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let n=0;n<e.length;n++)this.insert(e[n]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=t;else if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const n=this.data;this.data=t,t=n}this._insert(t,this.data.height-t.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=nt([]),this}remove(e,t){if(!e)return this;let n=this.data;const s=this.toBBox(e),a=[],r=[];let o,d,l;for(;n||a.length;){if(n||(n=a.pop(),d=a[a.length-1],o=r.pop(),l=!0),n.leaf){const f=tr(e,n.children,t);if(f!==-1)return n.children.splice(f,1),a.push(n),this._condense(a),this}!l&&!n.leaf&&Si(n,s)?(a.push(n),r.push(o),o=0,d=n,n=n.children[0]):d?(o++,n=d.children[o],l=!1):n=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const n=[];for(;e;)e.leaf?t.push(...e.children):n.push(...e.children),e=n.pop();return t}_build(e,t,n,s){const a=n-t+1;let r=this._maxEntries,o;if(a<=r)return o=nt(e.slice(t,n+1)),it(o,this.toBBox),o;s||(s=Math.ceil(Math.log(a)/Math.log(r)),r=Math.ceil(a/Math.pow(r,s-1))),o=nt([]),o.leaf=!1,o.height=s;const d=Math.ceil(a/r),l=d*Math.ceil(Math.sqrt(r));mn(e,t,n,l,this.compareMinX);for(let f=t;f<=n;f+=l){const g=Math.min(f+l-1,n);mn(e,f,g,d,this.compareMinY);for(let p=f;p<=g;p+=d){const v=Math.min(p+d-1,g);o.children.push(this._build(e,p,v,s-1))}}return it(o,this.toBBox),o}_chooseSubtree(e,t,n,s){for(;s.push(t),!(t.leaf||s.length-1===n);){let a=1/0,r=1/0,o;for(let d=0;d<t.children.length;d++){const l=t.children[d],f=ki(l),g=sr(e,l)-f;g<r?(r=g,a=f<a?f:a,o=l):g===r&&f<a&&(a=f,o=l)}t=o||t.children[0]}return t}_insert(e,t,n){const s=n?e:this.toBBox(e),a=[],r=this._chooseSubtree(s,this.data,t,a);for(r.children.push(e),Rt(r,s);t>=0&&a[t].children.length>this._maxEntries;)this._split(a,t),t--;this._adjustParentBBoxes(s,a,t)}_split(e,t){const n=e[t],s=n.children.length,a=this._minEntries;this._chooseSplitAxis(n,a,s);const r=this._chooseSplitIndex(n,a,s),o=nt(n.children.splice(r,n.children.length-r));o.height=n.height,o.leaf=n.leaf,it(n,this.toBBox),it(o,this.toBBox),t?e[t-1].children.push(o):this._splitRoot(n,o)}_splitRoot(e,t){this.data=nt([e,t]),this.data.height=e.height+1,this.data.leaf=!1,it(this.data,this.toBBox)}_chooseSplitIndex(e,t,n){let s,a=1/0,r=1/0;for(let o=t;o<=n-t;o++){const d=bt(e,0,o,this.toBBox),l=bt(e,o,n,this.toBBox),f=rr(d,l),g=ki(d)+ki(l);f<a?(a=f,s=o,r=g<r?g:r):f===a&&g<r&&(r=g,s=o)}return s||n-t}_chooseSplitAxis(e,t,n){const s=e.leaf?this.compareMinX:ir,a=e.leaf?this.compareMinY:nr,r=this._allDistMargin(e,t,n,s),o=this._allDistMargin(e,t,n,a);r<o&&e.children.sort(s)}_allDistMargin(e,t,n,s){e.children.sort(s);const a=this.toBBox,r=bt(e,0,t,a),o=bt(e,n-t,n,a);let d=Nt(r)+Nt(o);for(let l=t;l<n-t;l++){const f=e.children[l];Rt(r,e.leaf?a(f):f),d+=Nt(r)}for(let l=n-t-1;l>=t;l--){const f=e.children[l];Rt(o,e.leaf?a(f):f),d+=Nt(o)}return d}_adjustParentBBoxes(e,t,n){for(let s=n;s>=0;s--)Rt(t[s],e)}_condense(e){for(let t=e.length-1,n;t>=0;t--)e[t].children.length===0?t>0?(n=e[t-1].children,n.splice(n.indexOf(e[t]),1)):this.clear():it(e[t],this.toBBox)}}function tr(i,e,t){if(!t)return e.indexOf(i);for(let n=0;n<e.length;n++)if(t(i,e[n]))return n;return-1}function it(i,e){bt(i,0,i.children.length,e,i)}function bt(i,e,t,n,s){s||(s=nt(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let a=e;a<t;a++){const r=i.children[a];Rt(s,i.leaf?n(r):r)}return s}function Rt(i,e){return i.minX=Math.min(i.minX,e.minX),i.minY=Math.min(i.minY,e.minY),i.maxX=Math.max(i.maxX,e.maxX),i.maxY=Math.max(i.maxY,e.maxY),i}function ir(i,e){return i.minX-e.minX}function nr(i,e){return i.minY-e.minY}function ki(i){return(i.maxX-i.minX)*(i.maxY-i.minY)}function Nt(i){return i.maxX-i.minX+(i.maxY-i.minY)}function sr(i,e){return(Math.max(e.maxX,i.maxX)-Math.min(e.minX,i.minX))*(Math.max(e.maxY,i.maxY)-Math.min(e.minY,i.minY))}function rr(i,e){const t=Math.max(i.minX,e.minX),n=Math.max(i.minY,e.minY),s=Math.min(i.maxX,e.maxX),a=Math.min(i.maxY,e.maxY);return Math.max(0,s-t)*Math.max(0,a-n)}function Si(i,e){return i.minX<=e.minX&&i.minY<=e.minY&&e.maxX<=i.maxX&&e.maxY<=i.maxY}function Ht(i,e){return e.minX<=i.maxX&&e.minY<=i.maxY&&e.maxX>=i.minX&&e.maxY>=i.minY}function nt(i){return{children:i,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function mn(i,e,t,n,s){const a=[e,t];for(;a.length;){if(t=a.pop(),e=a.pop(),t-e<=n)continue;const r=e+Math.ceil((t-e)/n/2)*n;js(i,r,e,t,s),a.push(e,r,r,t)}}var At,me,It,dt,De,Fe,pe,ve,we,Z,Wt,Te,ut,fi,ft,G,gt,Le,V,In,Wn,Gn,$n,Jt;class ar{constructor(e){y(this,V);y(this,At);y(this,me,new DisposableStack);y(this,It);y(this,dt);y(this,De,new Map);y(this,Fe,new Map);y(this,pe,null);y(this,ve,new Map);y(this,we,new Set);y(this,Z,new or);y(this,Wt);y(this,Te);y(this,ut,c(this,me).use(Ks(()=>N(this,V,In).call(this),Js)));y(this,fi,0);y(this,ft,!0);y(this,G,null);y(this,gt,null);y(this,Le,new fe);qt(this,"onPointerEvent",Qt(c(this,Le)));var n,s;M(this,At,zt.createLogger("InteractiveGeometryManager",e.label)),M(this,Te,e.emitMetrics),M(this,dt,(n=e.pointerPositionThrottleTimeMs)!=null?n:Math.ceil(1e3/30));const t=m(mt(e.pointerMove),c(this,dt)===0?Pi:Ws(c(this,dt)));M(this,Wt,e.getViewport),c(this,me).use(m(t,Re(a=>N(this,V,Wn).call(this,a)))),c(this,me).use(e.pointerDown.subscribe(a=>N(this,V,Gn).call(this,a))),c(this,me).use(e.pointerUp.subscribe(a=>N(this,V,$n).call(this,a))),M(this,pe,e.compareZIndex?null:new Map),M(this,It,(s=e.compareZIndex)!=null?s:(a,r)=>{var o,d,l,f;return((d=(o=c(this,pe))==null?void 0:o.get(a.rect))!=null?d:0)-((f=(l=c(this,pe))==null?void 0:l.get(r.rect))!=null?f:0)}),c(this,me).defer(()=>this.clear())}async upsert(e,t){c(this,we).delete(e),c(this,ve).set(e,t),await c(this,ut).enqueue()}async remove(e){c(this,ve).delete(e),c(this,we).add(e),await c(this,ut).enqueue()}clear(){var e,t;c(this,Z).clear(),c(this,De).clear(),c(this,Fe).clear(),(e=c(this,pe))==null||e.clear(),c(this,ve).clear(),c(this,we).clear(),c(this,ut).cancel(),(t=c(this,Te))==null||t.call(this,{interactiveRectCount:0})}disablePointerEvents(){var e;M(this,ft,!1),(e=c(this,Te))==null||e.call(this,{interactiveRectCount:0})}enablePointerEvents(){var e;M(this,ft,!0),(e=c(this,Te))==null||e.call(this,{interactiveRectCount:c(this,Z).size})}[Symbol.dispose](){c(this,me).dispose()}}At=new WeakMap,me=new WeakMap,It=new WeakMap,dt=new WeakMap,De=new WeakMap,Fe=new WeakMap,pe=new WeakMap,ve=new WeakMap,we=new WeakMap,Z=new WeakMap,Wt=new WeakMap,Te=new WeakMap,ut=new WeakMap,fi=new WeakMap,ft=new WeakMap,G=new WeakMap,gt=new WeakMap,Le=new WeakMap,V=new WeakSet,In=function(){var s,a,r,o;var d=[];try{const e=m(c(this,we),Xi(p=>{var v;return(v=c(this,De).get(p))!=null?v:[]}),q);const t=m(c(this,ve),I(([p,v])=>{var w;return[(w=c(this,De).get(p))!=null?w:[],v]}),q);if(e.length===0&&t.length===0)return;const n=et(d,Oe.startSpan("InteractiveGeometryManager.flushQueues()",{attributes:{removals:e.length,updates:t.length,treeSize:c(this,Z).size}}));for(const p of e)c(this,Z).remove(p),c(this,Fe).delete(p),(s=c(this,pe))==null||s.delete(p);for(const p of c(this,we))c(this,De).delete(p),((a=c(this,G))==null?void 0:a.geometry)===p&&M(this,G,null);for(const[p,v]of t)for(const w of p)c(this,Z).remove(w);for(const[p,v]of c(this,ve)){for(const w of v)c(this,Fe).set(w,p),(r=c(this,pe))==null||r.set(w,sn(this,fi)._++);c(this,De).set(p,v)}c(this,Z).load(t.flatMap(([p,v])=>v));c(this,we).clear();c(this,ve).clear();(o=c(this,Te))==null||o.call(this,{interactiveRectCount:c(this,Z).size});c(this,At).verbose("queue flushed",{removals:e.length,updates:t.length,treeSize:c(this,Z).size})}catch(l){var f=l,g=!0}finally{tt(d,f,g)}},Wn=function(e){var s;const t=N(this,V,Jt).call(this,e),n={};if(t){if(((s=c(this,G))==null?void 0:s.geometry)===t.geometry)return;c(this,G)!==null&&c(this,G).geometry!==t.geometry&&(n.pointerLeave={kind:"pointerLeave",position:e,currentTarget:c(this,G).rect,target:c(this,G).geometry}),n.pointerEnter={kind:"pointerEnter",position:e,currentTarget:t.rect,target:t.geometry},M(this,G,t)}else c(this,G)!==null&&(n.pointerLeave={kind:"pointerLeave",position:e,currentTarget:c(this,G).rect,target:c(this,G).geometry},M(this,G,null));Object.values(n).some(j)&&c(this,Le).next(n)},Gn=function(e){const t=N(this,V,Jt).call(this,e);t&&(M(this,gt,t.geometry),c(this,Le).next({pointerDown:{kind:"pointerDown",position:e,currentTarget:t.rect,target:t.geometry}}))},$n=function(e){const t=N(this,V,Jt).call(this,e);if(!t)return;const n={pointerUp:{kind:"pointerUp",position:e,currentTarget:t.rect,target:t.geometry}};c(this,gt)===t.geometry&&(n.pointerClick={kind:"pointerClick",position:e,currentTarget:t.rect,target:t.geometry}),M(this,gt,null),Object.values(n).some(j)&&c(this,Le).next(n)},Jt=function(e){return!Os(c(this,Wt).call(this),e)||!c(this,ft)?null:m(c(this,Z).search({minX:e.x,minY:e.y,maxX:e.x,maxY:e.y}),I(t=>m(c(this,Fe).get(t),n=>n?{rect:t,geometry:n}:null)),$(j),q,t=>{var n;return(n=t.sort((s,a)=>c(this,It).call(this,s,a)).at(-1))!=null?n:null})};let or=class extends An{constructor(){super(...arguments);qt(this,"_rects",new Set)}toBBox(t){return{minX:t.x,minY:t.y,maxX:t.x+t.width,maxY:t.y+t.height}}compareMinX(t,n){return t.x-n.x}compareMinY(t,n){return t.y-n.y}load(t){return t.forEach(n=>this._rects.add(n)),super.load(t)}insert(t){return this._rects.add(t),super.insert(t)}remove(t,n){return this._rects.delete(t),super.remove(t,n)}clear(){var t;return(t=this._rects)==null||t.clear(),super.clear()}get size(){return this._rects.size}};function lr(i,e){return i.text>e.text&&i.geometry>=e.geometry||i.geometry>e.geometry&&i.text>=e.text}function hr(i,e){return i.text>=e.text&&i.geometry>=e.geometry}function cr({text:i,geometry:e}){return"Revision({ text: ".concat(i,", geometry: ").concat(e," })")}function dr(i){return{x:i.x,y:i.y}}function ur(i){return{x:i.x,y:i.y}}function fr(i){return{x:i.x,y:i.y}}function gr(i){return fr(i)}function Qe(i){return{x:i.x,y:i.y,width:i.width,height:i.height}}function pn(i){return e=>Qe({x:i(e.x),y:i(e.y),width:i(e.width),height:i(e.height)})}function mr(i){return{x:i.x,y:i.y,width:i.width,height:i.height}}function Me(i,e,t=Number.EPSILON){return Math.abs(i-e)<=t}function Ae(i,e=0){return e===0?.5+i|0:Math.round((i+Number.EPSILON)*10**e)/10**e}function pr(i,e=1.5,t=1.5){if(i.length===0)return[];if(i.length===1)return[i[0]];const n=[];let s=i[0];const a=i.length;for(let r=1;r<a;r++){const o=i[r],d=o.y+o.height,l=d<s.y,f=Me(d,s.y)&&o.height>0&&s.height>0;if(l||f)continue;const g=Math.min(s.x,o.x),p=Math.min(s.y,o.y),v=Math.max(s.x+s.width,o.x+o.width),w=Math.max(s.y+s.height,d),D=v-g,S=w-p,U=D<=s.width+o.width+e,he=S<=s.height+o.height-t,yt=Me(S,s.height+o.height)&&(Me(o.height,0)||Me(s.height,0));Me(o.width,s.width)&&Me(o.height,s.height)&&Me(o.x,s.x)&&Me(o.y,s.y)||(U&&(he||yt)?s=Ps({y:p,x:g,height:S,width:D}):(n.push(s),s=o))}return n.push(s),n}function Mt(i){return m(i,vr,pr)}function vr(i){return[...i].sort((e,t)=>e.y<t.y?-1:e.y>t.y?1:e.x<t.x?-1:e.x>t.x?1:0)}var ee,Ee,gi,Gt,Be,re,ye,_e,qe,$t,te,X,Ot,Pt,le,On,Pn,Xn,Yn;class wr{constructor(e){y(this,le);y(this,ee,zt.createLogger("TextRangeGeometryManager"));y(this,Ee,new DisposableStack);y(this,gi,new Rn);y(this,Gt,100);y(this,Be);y(this,re,new Map);y(this,ye,new Set);y(this,_e,new Set);y(this,qe,new fe);y(this,$t);y(this,te);y(this,X);y(this,Ot);y(this,Pt);M(this,Ot,e.getRects),M(this,Pt,e.getBoundingRects),M(this,$t,e.emitMetrics),M(this,X,e.initialRevision),M(this,te,dn(e.initialVisibleTextRange)?e.initialVisibleTextRange:un(e.initialVisibleTextRange,c(this,Gt))),M(this,Be,c(this,Ee).use(new Ls({initialTextRevision:e.initialRevision.text,label:"TextRangeGeometryManager/TextRangeManager"}))),c(this,Ee).defer(()=>{c(this,qe).complete(),c(this,re).clear(),c(this,ye).clear(),c(this,_e).clear()}),c(this,Ee).use(m(c(this,qe),Sn(m(c(this,qe),Dn(0))),pi(t=>rn(t,n=>n.minimumRevision)),Re(t=>{for(const[n,s]of t){lr(n,c(this,X))&&c(this,ee).warn("Unexpected geometry request for revision ".concat(n," greater than current revision ").concat(c(this,X)));const{visibleGroupsRequests:a,hiddenGroupsRequests:r}=N(this,le,On).call(this,s);a.length>0&&N(this,le,Pn).call(this,a),r.length>0&&(c(this,ee).warn("Unexpected geometry request for hidden groups [".concat(r.map(({group:o})=>o.id).join(", "),"] for revision ").concat(cr(n))),r.forEach(o=>o.resolve($e({rects:[],revision:c(this,X)}))))}})))}get _revisionForTests(){throw new Error("Only available for accessing the revision in tests")}add({id:e,metadata:t,revision:n,ranges:s,visible:a}){const r=$i(m(s,si(({id:f,range:g,metadata:p,updateSemantics:v})=>c(this,Be).add({id:f!=null?f:c(this,gi).next(),range:g,metadata:p,revision:n,updateSemantics:v}))));if(!r.ok)return r;const o=r.value,d=new DisposableStack;d.defer(()=>{l.ranges.forEach(f=>c(this,re).delete(f)),c(this,ye).delete(l.id)});const l=c(this,Ee).use(new yr({id:e,ranges:o,metadata:t,getRects:f=>{const g=Promise.withResolvers();return c(this,qe).next({group:l,minimumRevision:f.minimumRevision,geometryKind:f.geometryKind,resolve:p=>g.resolve(p)}),g.promise}}));return l.use(d),o.forEach(f=>c(this,re).set(f,l)),a&&c(this,ye).add(l.id),zi(c(this,te),l.boundingRange)&&c(this,_e).add(l.id),$e(l)}pushTextChange(e){var o=[];try{const t=et(o,Oe.startSpan("TextRangeGeometryManager.pushTextChange()",{attributes:{change:e}}));M(this,X,{geometry:c(this,X).geometry,text:e.revision});const{getChangedRanges:n,affectedRanges:s}=c(this,Be).pushTextChange(e);const a=m(s,I(g=>c(this,re).get(g)),$(j),Ut,q);const r=m(n(),I(g=>c(this,re).get(g)),$(j),ys(g=>g.boundingRange.start<c(this,te).end),$(g=>g.boundingRange.end>=c(this,te).start),Ut,vt);r==null||r.forEach(g=>{c(this,_e).add(g.id)});c(this,ee).verbose("pushTextChange",{change:e,affectedGroups:a.map(g=>g.id),onScreenChangedGroups:r==null?void 0:r.map(g=>g.id),revision:c(this,X)});return{affected:a,visibleChanged:r!=null?r:[]}}catch(d){var l=d,f=!0}finally{tt(o,l,f)}}pushDocumentGeometryChange(e,t){var a=[];try{const n=et(a,Oe.startSpan("TextRangeGeometryManager.pushDocumentGeometryChange()",{attributes:{visibleTextRange:e,geometryRevision:t}}));M(this,X,{text:c(this,X).text,geometry:t});M(this,te,dn(e)?e:un(e,c(this,Gt)));const s=m(c(this,Be).getIntersecting(c(this,te)),I(l=>c(this,re).get(l)),$(j),Ut,vt);c(this,_e).clear();s==null||s.forEach(l=>{c(this,_e).add(l.id)});c(this,ee).verbose("pushDocumentGeometryChange",{visibleTextRange:Fi(c(this,te)),onScreenGroups:s==null?void 0:s.map(l=>l.id),revision:c(this,X)});return{visible:s!=null?s:[]}}catch(r){var o=r,d=!0}finally{tt(a,o,d)}}getOnscreenTextRangeGroups(){return m(c(this,Be).getIntersecting(c(this,te)),I(e=>c(this,re).get(e)),$(j),Ut,q)}setVisibility(e,t){for(const n of e)t?c(this,ye).add(n):c(this,ye).delete(n)}[Symbol.dispose](){c(this,Ee).dispose()}}ee=new WeakMap,Ee=new WeakMap,gi=new WeakMap,Gt=new WeakMap,Be=new WeakMap,re=new WeakMap,ye=new WeakMap,_e=new WeakMap,qe=new WeakMap,$t=new WeakMap,te=new WeakMap,X=new WeakMap,Ot=new WeakMap,Pt=new WeakMap,le=new WeakSet,On=function(e){const t=[],n=[];return e.forEach(s=>{c(this,ye).has(s.group.id)&&c(this,_e).has(s.group.id)?t.push(s):n.push(s)}),{visibleGroupsRequests:t,hiddenGroupsRequests:n}},Pn=async function(e){var p,v,w,D;var S=[];try{const t={...c(this,X)};const n=et(S,Oe.startSpan("TextRangeGeometryManager.#requestGeometry()",{attributes:{revision:t,groups:e.map(({group:T,minimumRevision:_t})=>({id:T.id,ranges:T.ranges.length,minimumRevision:_t}))}}));const s=rn(e,({geometryKind:T})=>T==="singleBoundingBox"?"boundingBox":"rects");const a={forRects:(p=s.get("rects"))!=null?p:[],forBoundingBoxes:(v=s.get("boundingBox"))!=null?v:[]};const r={forRects:a.forRects.flatMap(({group:T})=>T.ranges),forBoundingBoxes:a.forBoundingBoxes.flatMap(({group:T})=>T.ranges)};c(this,ee).verbose("geometry request",{revision:t,requestRevision:(w=e[0])==null?void 0:w.minimumRevision,requests:a});const o=m(r.forRects,fn({nonEmpty:T=>N(this,le,Xn).call(this,T),empty:()=>ce({rects:new Map,revision:t})}));const d=m(r.forBoundingBoxes,fn({nonEmpty:T=>N(this,le,Yn).call(this,T),empty:()=>ce({rects:new Map,revision:t})}));const l={forRects:await o,forBoundingBoxes:await d};a.forRects.forEach(({group:T,resolve:_t,geometryKind:_i})=>_t(m(l.forRects,xe(({revision:xi,rects:bi})=>({rects:T.ranges.map(Ft=>{var tn;return(tn=bi.get(Ft.id))!=null?tn:[]}).map(_i==="lineBoundingBox"?Mt:Pi),revision:xi})))));a.forBoundingBoxes.forEach(({group:T,resolve:_t})=>_t(m(l.forBoundingBoxes,xe(({revision:_i,rects:xi})=>({rects:T.ranges.map(bi=>{var Ft;return[(Ft=xi.get(bi.id))!=null?Ft:[]].flat()}),revision:_i})))));const f=m(l.forRects,an({success:({rects:T})=>Array.from(T.values()).flat().length,failure:()=>0}));const g=m(l.forBoundingBoxes,an({success:({rects:T})=>T.size,failure:()=>0}));(D=c(this,$t))==null||D.call(this,{rangeCount:e.flatMap(({group:T})=>T.ranges).length,rectCount:f+g});c(this,ee).verbose("geometry response",{responseRevision:t,requests:a,responses:l})}catch(U){var he=U,yt=!0}finally{tt(S,he,yt)}},Xn=function(e){return on(()=>m(c(this,Ot).call(this,new Map(m(e,I(t=>[t.id,{start:t.start,end:t.end}])))),Dt(pt(t=>c(this,ee).error("Unexpected error getting rects",t,{delivery:!0})))),{maxRetries:3,delayMs:()=>1e3})},Yn=function(e){return on(()=>m(c(this,Pt).call(this,new Map(m(e,I(t=>[t.id,{start:t.start,end:t.end}])))),Dt(pt(t=>c(this,ee).error("Unexpected error getting bounding rects",t,{delivery:!0})))),{maxRetries:3,delayMs:()=>1e3})};var Xt,Yt,Ue,mi,Vt,Ce;class yr{constructor(e){y(this,Xt,new DisposableStack);y(this,Yt);y(this,Ue);y(this,mi,new Rn);y(this,Vt);y(this,Ce,null);qt(this,"id");var t;this.id=(t=e.id)!=null?t:c(this,mi).next(),M(this,Ue,e.ranges),M(this,Yt,e.metadata),M(this,Vt,e.getRects)}get metadata(){return c(this,Yt)}get revision(){return c(this,Ue)[0].revision}get ranges(){return c(this,Ue)}get boundingRange(){return qs(...c(this,Ue))}getGeometry(e){return c(this,Ce)&&hr(c(this,Ce).requestedRevision,e.minimumRevision)?c(this,Ce).response:(M(this,Ce,{requestedRevision:e.minimumRevision,response:c(this,Vt).call(this,e)}),c(this,Ce).response)}toString(){const e=this.ranges.map(t=>Fi(t)).join(", ");return"TextRangeGroupGeometry({ id: ".concat(this.id,", ranges: [").concat(e,"], revision: ").concat(this.revision," })")}use(e){return c(this,Xt).use(e)}[Symbol.dispose](){c(this,Xt).dispose()}}Xt=new WeakMap,Yt=new WeakMap,Ue=new WeakMap,mi=new WeakMap,Vt=new WeakMap,Ce=new WeakMap;function qi(i,e){if(i.kind==="fadeIn"){const t=vn(i.startTime,performance.now(),i.duration);return t===1&&(i.running=!1),{alpha:t,running:i.running}}else if(i.kind==="fadeOut"){const t=1-vn(i.startTime,performance.now(),i.duration);return t===0&&(i.running=!1),{alpha:t,running:i.running}}else throw new Mn(i.kind)}function vn(i,e,t){return Math.min(1,Math.max((e-i)/t,0))}var _r=Object.defineProperty,xr=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),ai=i=>{throw TypeError(i)},br=(i,e,t)=>e in i?_r(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,wn=(i,e,t)=>br(i,typeof e!="symbol"?e+"":e,t),Ui=(i,e,t)=>e.has(i)||ai("Cannot "+t),u=(i,e,t)=>(Ui(i,e,"read from private field"),e.get(i)),E=(i,e,t)=>e.has(i)?ai("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),H=(i,e,t,n)=>(Ui(i,e,"write to private field"),e.set(i,t),t),ct=(i,e,t)=>(Ui(i,e,"access private method"),t),Rr=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&ai("Object expected");var n;n===void 0&&(n=e[xr("dispose")]),typeof n!="function"&&ai("Object not disposable"),i.push([t,n,e])}return e},Mr=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,d,l){return l=Error(d),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,d=>(s(d),a()))}catch(d){s(d)}if(t)throw e};return a()},Ni,Hi,Kt,ge,C,oi,de,Ie,ae,se,ie,ne,Bt,Bi,Ne,Ct,z,B,ze,J,st,Pe,Vn,zn,Fn,Ln,qn,Un;class kr{constructor(e){E(this,Pe),E(this,Ni,!1),E(this,Hi,!1),E(this,Kt,new DisposableStack),E(this,ge),E(this,C),E(this,oi),E(this,de,new Map),E(this,Ie,new Set),E(this,ae,new Set),E(this,se,new Set),E(this,ie,new Set),E(this,ne,new Set),E(this,Bt,new Set),E(this,Bi,!0),E(this,Ne,new Sr({returnAllDrawables:!u(this,Bi)})),E(this,Ct),E(this,z,new fe),E(this,B),E(this,ze,!1),E(this,J),E(this,st,null),H(this,ge,e.canvas),H(this,C,e.canvas.getContext("2d")),H(this,B,e.viewportGeometry),H(this,oi,e.oversamplingFactor),H(this,Ct,e.emitRenderMetrics),u(this,Kt).use(m(u(this,z),Sn(m(u(this,z),Dn(0))),pi(t=>({reasons:new Set(t.map(n=>n.reason).filter(j)),immediate:t.some(n=>n.immediate)})),Bs(({reasons:t,immediate:n})=>m(As(null),_s(n?Is:Gs),xs(()=>u(this,st)?ct(this,Pe,Vn).call(this,u(this,st),[...t].join(", ")):Tt))),Re(t=>{t&&u(this,z).next({reason:"animation"})})))}add(e){for(const{drawable:t,visible:n,onscreen:s}of e)u(this,Ie).add(t),s&&(u(this,ie).add(t),u(this,ae).add(t)),n||u(this,se).add(t);u(this,z).next({reason:"add-drawable"})}remove(e){for(const t of e)u(this,ie).delete(t),u(this,ne).delete(t),u(this,ae).delete(t),u(this,Ie).delete(t),u(this,Ne).remove(t),u(this,Bt).add(t);u(this,z).next({reason:"remove-drawable"})}requestRender(e){for(const t of e)u(this,ne).add(t);u(this,z).next({reason:"request-render"})}requestLayout(e,t){H(this,st,t);for(const n of e)u(this,ie).add(n);u(this,z).next({reason:"request-layout",immediate:!0})}setViewport(e,t,n){H(this,st,n),H(this,B,t),u(this,ae).clear(),u(this,ie).clear(),u(this,Ne).clear();for(const s of e)u(this,ie).add(s),u(this,ae).add(s);u(this,z).next({reason:"viewport-change",immediate:!0})}setVisibility(e,t){for(const n of e)t?u(this,se).delete(n)&&u(this,ne).add(n):u(this,se).has(n)||(u(this,se).add(n),u(this,ne).add(n));u(this,z).next({reason:"set-visibility"})}showAllVisible(){if(u(this,ze)){H(this,ze,!1),H(this,J,{kind:"fadeIn",startTime:performance.now(),duration:300,running:!0,metadata:void 0});for(const e of u(this,ae))u(this,ne).add(e);u(this,z).next({reason:"show-all-visible"})}}hideAllVisible(){u(this,ze)||(H(this,ze,!0),H(this,J,void 0),u(this,z).next({reason:"hide-all-visible"}))}[Symbol.dispose](){u(this,Kt).dispose()}}Ni=new WeakMap;Hi=new WeakMap;Kt=new WeakMap;ge=new WeakMap;C=new WeakMap;oi=new WeakMap;de=new WeakMap;Ie=new WeakMap;ae=new WeakMap;se=new WeakMap;ie=new WeakMap;ne=new WeakMap;Bt=new WeakMap;Bi=new WeakMap;Ne=new WeakMap;Ct=new WeakMap;z=new WeakMap;B=new WeakMap;ze=new WeakMap;J=new WeakMap;st=new WeakMap;Pe=new WeakSet;Vn=async function(i,e){var t,n,s,a,r=[];try{const l=Rr(r,Oe.startSpan("CanvasRenderer.#render()",{attributes:{reason:e,minimumRevision:i}}));if(u(this,ze)&&!((t=u(this,J))!=null&&t.running)){u(this,C).clearRect(0,0,u(this,ge).width,u(this,ge).height);const he={drawablesRenderedOnLastRenderLoop:0,renderedVisibleOnscreenDrawables:new Set,visibleDrawables:u(this,Ie).difference(u(this,se)),allDrawables:new Set(u(this,Ie))};return queueMicrotask(()=>u(this,Ct).call(this,he)),!1}let f=(n=u(this,J))!=null&&n.running&&u(this,J).kind==="fadeOut"?u(this,B):await ct(this,Pe,qn).call(this,i);const g=u(this,oi),p=Ae(u(this,B).width*g),v=Ae(u(this,B).height*g);if((u(this,ge).width!==p||u(this,ge).height!==v)&&(u(this,ge).width=p,u(this,ge).height=v,f=u(this,B)),(s=u(this,J))!=null&&s.running&&u(this,J).kind==="fadeIn"&&(f=u(this,B)),!f)return!1;u(this,C).save(),u(this,C).scale(g,g),u(this,C).translate(-Ae(u(this,B).x),-Ae(u(this,B).y)),u(this,C).globalCompositeOperation="source-over";const w=u(this,J)?qi(u(this,J)).alpha:1;u(this,C).globalAlpha=w;const D=ct(this,Pe,zn).call(this,f),S=ct(this,Pe,Fn).call(this,f,D);u(this,Hi)&&(u(this,C).strokeStyle="blue",u(this,C).strokeRect(u(this,B).x,u(this,B).y,Math.floor(u(this,B).width),Math.floor(u(this,B).height))),u(this,C).restore();const U={drawablesRenderedOnLastRenderLoop:D.size,renderedVisibleOnscreenDrawables:m(u(this,ae).difference(u(this,se)),$(he=>Et(u(this,B),he.boundingRect)),$(he=>he.visibleRects.some(yt=>Et(u(this,B),yt))),oe),visibleDrawables:u(this,Ie).difference(u(this,se)),allDrawables:new Set(u(this,Ie))};return queueMicrotask(()=>u(this,Ct).call(this,U)),S||((a=u(this,J))==null?void 0:a.running)===!0}catch(l){var o=l,d=!0}finally{Mr(r,o,d)}};zn=function(i){return m((Xs(i,u(this,B))?u(this,ae):u(this,Ne).getIntersections(i)).difference(u(this,se)),$(e=>Et(u(this,B),e.boundingRect)),oe)};Fn=function(i,e){return u(this,C).clearRect(i.x,i.y,i.width,i.height),u(this,Ni)&&(u(this,C).strokeStyle="red",u(this,C).strokeRect(i.x,i.y,i.width,i.height)),u(this,C).rect(i.x,i.y,i.width,i.height),u(this,C).clip(),ct(this,Pe,Ln).call(this,e)};Ln=function(i){for(const n of u(this,de).keys())i.has(n)||u(this,de).delete(n);for(const n of i)u(this,de).has(n)||u(this,de).set(n,n.render(u(this,C)));let e=u(this,de).size;const t=q(u(this,de).entries()).sort((n,s)=>n[0].zIndex-s[0].zIndex);for(const[n,s]of t){for(const r of n.opaqueRects)u(this,C).clearRect(r.x,r.y,r.width,r.height);const{done:a}=s.next();a?(e--,u(this,ne).delete(n),u(this,de).set(n,n.render(u(this,C)))):u(this,ne).add(n)}return e>0};qn=async function(i){const e=[];if(u(this,ie).size>0){const n=await ct(this,Pe,Un).call(this,i);n&&e.push(n)}for(const n of u(this,ne))!Zt(n.boundingRect)&&Et(u(this,B),n.boundingRect)&&(e.push(n.boundingRect),u(this,ne).delete(n));for(const n of u(this,Bt))u(this,Bt).delete(n),!Zt(n.boundingRect)&&Et(u(this,B),n.boundingRect)&&e.push(n.boundingRect);const t=m(e.map(Ys(1)),Vi(null));return t&&!Zt(t)?Vs(t,u(this,B)):null};Un=async function(i){if(u(this,ie).size===0)return null;const e=[],t=new Set;for(const s of u(this,ie)){if(u(this,se).has(s)||!u(this,ae).has(s))continue;const a=s.boundingRect;e.push([a,s.layout(i)]),t.add(s),u(this,ie).delete(s),u(this,Ne).remove(s)}const n=await Promise.all(e.map(async([s,a])=>[s,await a]));return u(this,Ne).load(t),m(n,Xi(Pi),$(s=>!Zt(s)),q,Vi(null))};class Sr extends An{constructor(e){var t;super(),wn(this,"_drawables",new Set),wn(this,"_returnAllDrawables"),this._returnAllDrawables=(t=e.returnAllDrawables)!=null?t:!1}toBBox(e){const t=e.boundingRect;return{minX:t.x,minY:t.y,maxX:t.x+t.width,maxY:t.y+t.height}}compareMinX(e,t){const n=e.boundingRect,s=t.boundingRect;return n.x-s.x}compareMinY(e,t){const n=e.boundingRect,s=t.boundingRect;return n.y-s.y}load(e){const t=oe(e);return t.forEach(n=>this._drawables.add(n)),this._returnAllDrawables?this:super.load(q(t))}insert(e){return this._drawables.add(e),super.insert(e)}remove(e){return this._drawables.delete(e),this._returnAllDrawables?this:super.remove(e)}clear(){var e;return(e=this._drawables)==null||e.clear(),this._returnAllDrawables?this:super.clear()}getIntersections(e){return this._returnAllDrawables?this._drawables:new Set(super.search({minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height}))}}var Dr=Object.defineProperty,Nn=i=>{throw TypeError(i)},Tr=(i,e,t)=>e in i?Dr(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Er=(i,e,t)=>Tr(i,e+"",t),Qi=(i,e,t)=>e.has(i)||Nn("Cannot "+t),_=(i,e,t)=>(Qi(i,e,"read from private field"),t?t.call(i):e.get(i)),Q=(i,e,t)=>e.has(i)?Nn("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),P=(i,e,t,n)=>(Qi(i,e,"write to private field"),e.set(i,t),t),yn=(i,e,t)=>(Qi(i,e,"access private method"),t),Ci,St,rt,ke,kt,W,Xe,Ye,Se,Ai,jt,Ve,ei,Hn,Qn;const Br="outside",Zn=Tn(2);function Di(i,e){return JSON.stringify([i,e])}function Ii(i){const[e,t]=JSON.parse(i);return{decorationId:e,segmentId:t}}let Cr=0;class Ar{constructor(e){Q(this,Ve),Q(this,Ci,zt.createLogger("CanvasTextDecoration")),Q(this,St,new DisposableStack),Q(this,rt),Q(this,ke),Q(this,kt),Q(this,W),Q(this,Xe,null),Q(this,Ye,null),Q(this,Se,null),Q(this,Ai,Cr++/1e9),Q(this,jt,0),Er(this,"id"),this.id=e.decorationId,P(this,rt,e.interactiveGeometryManager),P(this,ke,e.rangesGroup),P(this,W,e.segments.map(t=>({...t,rects:[],rawRects:[]}))),P(this,kt,e.isFocused),_(this,St).defer(()=>{e.onDispose(),this.removeInteractiveGeometry()})}get segments(){return _(this,W)}get zIndex(){return _(this,kt).call(this)?Number.MAX_SAFE_INTEGER:_(this,jt)+_(this,Ai)}get opaqueRects(){return _(this,kt).call(this)?this.rects:[]}get boundingRect(){return _(this,Xe)?_(this,Xe):(P(this,Xe,m(_(this,W).flatMap(e=>e.rects),Vi(zs()))),_(this,Xe))}get boundingTextRange(){return _(this,ke).boundingRange}get visibleRects(){return _(this,Se)?_(this,Se):(P(this,Se,m(_(this,W),$(e=>!!e.background||!!e.underline),Xi(e=>Mt(e.rects)),q)),_(this,Se))}get rects(){return _(this,Ye)?_(this,Ye):(P(this,Ye,m(_(this,W).flatMap(e=>e.rects),Mt)),_(this,Ye))}toString(){return"CanvasTextDecoration({ id: ".concat(this.id,", rangesGroup: ").concat(_(this,ke)," })")}removeInteractiveGeometry(){for(const e of _(this,W))_(this,rt).remove(Di(this.id,e.id))}registerInteractiveGeometry(){for(const e of _(this,W))e.interactive?_(this,rt).upsert(Di(this.id,e.id),e.rects):_(this,rt).remove(Di(this.id,e.id))}patchSegment(e,{interactive:t,underline:n,background:s}){let a=!1;P(this,W,_(this,W).map(r=>{if(r.id!==e)return r;t!==r.interactive&&(a=!0);const o=n===null?void 0:n!=null?n:r.underline,d=s===null?void 0:s!=null?s:r.background;return{id:r.id,rawRects:r.rawRects,rects:r.rawRects.map(_n(o)),backgroundAnimation:Ir(s,r),underlineAnimation:Wr(n,r),interactive:t!=null?t:r.interactive,underline:o,background:d}})),a&&this.registerInteractiveGeometry(),P(this,Se,null)}async layout(e){if(_(this,Ve,ei))return this.boundingRect;const t=await m(_(this,ke).getGeometry({minimumRevision:e,geometryKind:"rects"}),bs({success:({rects:n})=>n,failure:n=>(_(this,Ci).error("Unexpected error getting rects - returning empty rects",n,{delivery:!0}),[])}));return _(this,Ve,ei)?this.boundingRect:(P(this,W,m(ln(_(this,W),t),q,n=>n.map(([s,a])=>({...s,rawRects:m(a,Mt,r=>r.map(pn(Ae))),rects:m(a.map(_n(s.underline)),Mt,r=>r.map(pn(Ae)))})))),this.registerInteractiveGeometry(),P(this,jt,m(ln(_(this,W),_(this,ke).ranges),$(([n])=>!!n.interactive),I(([n,s])=>s.start),q,n=>n.length===0?_(this,ke).ranges.map(s=>s.start):n,n=>n.length===0?0:Math.min(...n))),P(this,Xe,null),P(this,Ye,null),P(this,Se,null),this.boundingRect)}*render(e){if(!_(this,Ve,ei))for(;;){e.save();const t=yn(this,Ve,Hn).call(this,e),n=yn(this,Ve,Qn).call(this,e);if(e.restore(),t||n)yield;else return}}[Symbol.dispose](){_(this,St).dispose()}}Ci=new WeakMap;St=new WeakMap;rt=new WeakMap;ke=new WeakMap;kt=new WeakMap;W=new WeakMap;Xe=new WeakMap;Ye=new WeakMap;Se=new WeakMap;Ai=new WeakMap;jt=new WeakMap;Ve=new WeakSet;ei=function(){return _(this,St).disposed};Hn=function(i){var e;let t=!1;for(const n of _(this,W)){const s=n.backgroundAnimation,a=(e=n.background)!=null?e:s!=null&&s.running?s==null?void 0:s.metadata.background:void 0;if(a){if(i.save(),s){const{alpha:r,running:o}=qi(s);t||(t=o),i.globalAlpha=r}for(const r of n.rawRects)r.width<=0||r.height<=0||(i.fillStyle=a.color,i.fillRect(r.x,r.y,r.width,r.height));i.restore()}}return t};Qn=function(i){var e;let t=!1;for(const n of _(this,W)){const s=n.underlineAnimation,a=(e=n.underline)!=null?e:s!=null&&s.running?s==null?void 0:s.metadata.underline:void 0;if(!a)continue;const{underlineThickness:r,verticalOffset:o}=Kn(n.underline);if(i.save(),s){const{alpha:l,running:f}=qi(s);t||(t=f),i.globalAlpha=l}for(const l of n.rawRects)l.width<=0||l.height<=0||(i.lineWidth=r,i.strokeStyle=a.color,i.setLineDash(a.style==="dotted"?[r,r]:[]),i.lineCap="butt",i.beginPath(),i.moveTo(l.x,l.y+l.height+o),i.lineTo(l.x+l.width,l.y+l.height+o),i.stroke());i.restore();const d=n.rawRects.at(-1);if(a.style==="ellipsis"&&d){if(d.width<=0||d.height<=0)continue;i.beginPath(),i.lineWidth=0,i.fillStyle=a.color;const l=d.x+d.width,f=d.y+d.height+o,{radius:g,gap:p}=Jn(r),v=2*Math.PI;i.arc(l+p*1,f,g,0,v),i.arc(l+p*2,f,g,0,v),i.arc(l+p*3,f,g,0,v),i.fill()}}return t};function Jn(i){return{radius:.6*i,gap:2.5*i}}function Ir(i,e){return i&&!e.background?{kind:"fadeIn",startTime:performance.now(),duration:200,metadata:{background:i},running:!0}:i===null&&e.background?{kind:"fadeOut",startTime:performance.now(),duration:150,metadata:{background:e.background},running:!0}:e==null?void 0:e.backgroundAnimation}function Wr(i,e){return i&&!e.underline?{kind:"fadeIn",startTime:performance.now(),duration:200,metadata:{underline:i},running:!0}:i===null&&e.underline?{kind:"fadeOut",startTime:performance.now(),duration:150,metadata:{underline:e.underline},running:!0}:e==null?void 0:e.underlineAnimation}function Kn(i){var e,t;const n=(e=i==null?void 0:i.thickness)!=null?e:Zn,s=(t=i==null?void 0:i.align)!=null?t:Br,a=Tn(s==="inside"?-n/2:s==="center"?0:n/2);return{underlineThickness:cn(n),verticalOffset:cn(a),align:s}}function _n(i){return e=>{var t;const{underlineThickness:n,align:s}=Kn(i),a=s==="center"?n/2:s==="outside"?n:0,r=Jn((t=i==null?void 0:i.thickness)!=null?t:Zn),o=(i==null?void 0:i.style)==="ellipsis"?3*r.gap+r.radius:0;return Qe({...e,height:Ae(e.height+a+.5),width:Ae(e.width+o+.5)})}}var Gr=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),li=i=>{throw TypeError(i)},Zi=(i,e,t)=>e.has(i)||li("Cannot "+t),h=(i,e,t)=>(Zi(i,e,"read from private field"),t?t.call(i):e.get(i)),k=(i,e,t)=>e.has(i)?li("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),L=(i,e,t,n)=>(Zi(i,e,"write to private field"),e.set(i,t),t),R=(i,e,t)=>(Zi(i,e,"access private method"),t),$r=(i,e,t,n)=>({set _(s){L(i,e,s)},get _(){return h(i,e,n)}}),Ke=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&li("Object expected");var n;n===void 0&&(n=e[Gr("dispose")]),typeof n!="function"&&li("Object not disposable"),i.push([t,n,e])}return e},je=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,d,l){return l=Error(d),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,d=>(s(d),a()))}catch(d){s(d)}if(t)throw e};return a()},F,A,hi,We,x,ci,Ge,be,O,vi,wi,yi,at,di,ue,ti,Ze,He,K,Je,ui,Y,wt,b,jn,es,ts,is,ns,ss,Wi,Ji,Ki,rs,as,os,ls,ji,hs,cs,ds,us,en,ii,fs,ot;class Ti{constructor(e,t,n,s,a){k(this,b),k(this,F,new DisposableStack),k(this,A),k(this,hi),k(this,We),k(this,x,{geometry:null,documentFrameScrolling:!1,windowFrameResizing:!1,windowFrameMoving:!1}),k(this,ci,0),k(this,Ge),k(this,be),k(this,O,new Map),k(this,vi,new fe),k(this,wi,new fe),k(this,yi,new fe),k(this,at,new Map),k(this,di,new Set),k(this,ue,new Set),k(this,ti,null),k(this,Ze,new Set),k(this,He,document.createElement("canvas")),k(this,K,null),k(this,Je),k(this,ui,!0),k(this,Y,{documentScrolling:new fe,windowMoving:new fe,windowResizing:new fe}),k(this,wt,new Fs),L(this,Je,e),L(this,A,zt.createLogger("TextDecorationsViewController",n.id)),L(this,hi,a),L(this,We,n),h(this,He).style.width="100%",h(this,He).style.height="100%",L(this,Ge,h(this,F).use(R(this,b,ts).call(this))),L(this,be,h(this,F).use(R(this,b,is).call(this)));const r=m(t,pi(o=>o!==null),En());h(this,F).use(R(this,b,ns).call(this,s,r)),h(this,F).use(R(this,b,ss).call(this)),h(this,F).use(R(this,b,jn).call(this,t)),h(this,F).use(m(t,Re(({hideDecorationsOnScroll:o})=>L(this,ui,o)))),h(this,F).use(n.geometryWillChange.subscribe(o=>R(this,b,os).call(this,o))),h(this,F).use(h(this,We).textChange.subscribe(o=>R(this,b,as).call(this,o))),h(this,F).use(m(r,ri(o=>o?mt(h(this,We).geometry):Tt),Re(o=>R(this,b,ls).call(this,o))))}[Symbol.dispose](){h(this,F).dispose()}async upsert(e){var t,n,s;const a=await this.remove([e.id]);if(!a.ok)return a;e.visibility==="visible"&&h(this,ue).add(e.id);const r=vt(e.segments);if(!r)return $e();const o=new AbortController;if(h(this,at).set(e.id,o),await h(this,wt).enqueue({kind:"add",options:e},e.revision),h(this,at).get(e.id)===o&&h(this,at).delete(e.id),o.signal.aborted)return $e();const d=h(this,Ge).add({id:e.id,revision:e.revision,ranges:m(r,si(g=>({id:g.id,range:g.range,updateSemantics:g.updateSemantics,metadata:void 0}))),metadata:e.id,visible:h(this,ue).has(e.id)});if(!d.ok)return d;const l=d.value,f=new Ar({decorationId:e.id,rangesGroup:l,segments:r,interactiveGeometryManager:h(this,be),isFocused:()=>h(this,ti)===e.id,onDispose:()=>{Rs(l),m(this.remove([e.id]),Dt(pt(g=>h(this,A).error("Error removing decoration during dispose",g,{delivery:!0}))))}});return h(this,O).set(e.id,f),(s=h(this,K))==null||s.add([{drawable:f,visible:h(this,ue).has(e.id),onscreen:zi(l.boundingRange,(n=(t=h(this,x).geometry)==null?void 0:t.visibleTextRange)!=null?n:{start:0,end:0})}]),h(this,A).verbose("added ".concat(h(this,ue).has(e.id)?"visible":"hidden"," decoration"),e.id),$e()}remove(e){var t,n=[];try{const r=oe(e);r.forEach(l=>{var f;return(f=h(this,at).get(l))==null?void 0:f.abort()});const o=R(this,b,Wi).call(this,r);if(o.length===0)return ce();const d=Ke(n,new DisposableStack);return o.map(l=>{h(this,O).delete(l.id),d.use(l)}),(t=h(this,K))==null||t.remove(o),h(this,A).verbose("removed decorations",o.map(l=>l.id)),ce()}catch(r){var s=r,a=!0}finally{je(n,s,a)}}setVisibility(e){var t;const n=oe(e.ids);h(this,Ge).setVisibility(n,e.visible),n.forEach(a=>e.visible?h(this,ue).add(a):h(this,ue).delete(a));const s=R(this,b,Wi).call(this,n);return s.length===0?ce():(e.visible?s.forEach(a=>a.registerInteractiveGeometry()):s.forEach(a=>a.removeInteractiveGeometry()),(t=h(this,K))==null||t.setVisibility(s,e.visible),h(this,A).verbose(e.visible?"showing decorations":"hiding decorations",s.map(a=>a.id)),ce())}patchSegment({id:e,segmentId:t,patch:n}){var s;const a=h(this,O).get(e);return a?(a.patchSegment(t,n),(s=h(this,K))==null||s.requestRender([a]),h(this,A).verbose("patched segment ".concat(t," of decoration ").concat(e," with"),n),ce()):ce()}focus(e){return L(this,ti,e),ce()}dispose(){h(this,F).dispose()}}F=new WeakMap;A=new WeakMap;hi=new WeakMap;We=new WeakMap;x=new WeakMap;ci=new WeakMap;Ge=new WeakMap;be=new WeakMap;O=new WeakMap;vi=new WeakMap;wi=new WeakMap;yi=new WeakMap;at=new WeakMap;di=new WeakMap;ue=new WeakMap;ti=new WeakMap;Ze=new WeakMap;He=new WeakMap;K=new WeakMap;Je=new WeakMap;ui=new WeakMap;Y=new WeakMap;wt=new WeakMap;b=new WeakSet;jn=function(i){let e=null;return m(i,pi(({host:t})=>t),$s(t=>t===null),En(),Re(t=>{if(t){t.appendChild(h(this,He));const{renderer:n,disposable:s}=R(this,b,es).call(this);L(this,K,n),e=s}else h(this,He).remove(),e&&e[Symbol.dispose](),e=null,L(this,K,null)}))};es=function(){var i,e,t,n,s,a,r,o,d,l,f=[];try{const v=Ke(f,new DisposableStack),w=v.use(new kr({canvas:h(this,He),oversamplingFactor:1,viewportGeometry:Qe({x:(t=(e=(i=h(this,x).geometry)==null?void 0:i.scrollPosition)==null?void 0:e.x)!=null?t:0,y:(a=(s=(n=h(this,x).geometry)==null?void 0:n.scrollPosition)==null?void 0:s.y)!=null?a:0,width:(o=(r=h(this,x).geometry)==null?void 0:r.documentFrame.width)!=null?o:0,height:(l=(d=h(this,x).geometry)==null?void 0:d.documentFrame.height)!=null?l:0}),emitRenderMetrics:D=>{const S=m(D.renderedVisibleOnscreenDrawables,I(U=>U.id),oe);Ds(S,h(this,di))||(L(this,di,S),m(h(this,Je).onVisibleOnscreenDecorationsDidChange(S),Dt(pt(U=>h(this,A).error("Error sending visible onscreen decorations change",U,{delivery:!0}))))),R(this,b,ds).call(this,D)}}));return h(this,Ze).size>0&&(w.hideAllVisible(),h(this,be).disablePointerEvents()),h(this,O).size>0&&w.add(m(h(this,O).values(),I(D=>{var S,U;return{drawable:D,visible:h(this,ue).has(D.id),onscreen:zi(D.boundingTextRange,(U=(S=h(this,x).geometry)==null?void 0:S.visibleTextRange)!=null?U:{start:0,end:0})}}))),R(this,b,ji).call(this,w),v.defer(()=>{R(this,b,Ki).call(this,["rendererDisposed"]),h(this,A).verbose("renderer disposed")}),R(this,b,Ji).call(this,["rendererDisposed"]),h(this,A).verbose("renderer created"),{renderer:w,disposable:v.move()}}catch(v){var g=v,p=!0}finally{je(f,g,p)}};ts=function(){var i,e;return new wr({initialRevision:{text:Li,geometry:Yi},initialVisibleTextRange:(e=(i=h(this,x).geometry)==null?void 0:i.visibleTextRange)!=null?e:{start:0,end:0},getRects:t=>m(h(this,Je).getRects(t),Ei(({rects:n,revision:s})=>{var a,r;return s.geometry!==((a=h(this,x).geometry)==null?void 0:a.revision)&&((r=h(this,x).geometry)==null?void 0:r.scrollPosition)!==void 0&&h(this,A).warn("Expected document geometry revision ".concat(h(this,x).geometry.revision," to equal revision ").concat(s.geometry," from getRects() response"),{delivery:!1}),{rects:new Map(m(n.entries(),I(([o,d])=>[o,d.map(l=>{var f,g,p,v,w,D;return Qe({...l,x:l.x+((p=(g=(f=h(this,x).geometry)==null?void 0:f.scrollPosition)==null?void 0:g.x)!=null?p:0),y:l.y+((D=(w=(v=h(this,x).geometry)==null?void 0:v.scrollPosition)==null?void 0:w.y)!=null?D:0)})})]))),revision:s}})),getBoundingRects:t=>m(h(this,Je).getBoundingRects(t),Ei(({rects:n,revision:s})=>{var a,r;return s.geometry!==((a=h(this,x).geometry)==null?void 0:a.revision)&&((r=h(this,x).geometry)==null?void 0:r.scrollPosition)!==void 0&&h(this,A).warn("Expected document geometry revision ".concat(h(this,x).geometry.revision," to equal revision ").concat(s.geometry," from getRects() response"),{delivery:!1}),{rects:new Map(m(n.entries(),I(([o,d])=>{var l,f,g,p,v,w;return[o,Qe({...d,x:d.x+((g=(f=(l=h(this,x).geometry)==null?void 0:l.scrollPosition)==null?void 0:f.x)!=null?g:0),y:d.y+((w=(v=(p=h(this,x).geometry)==null?void 0:p.scrollPosition)==null?void 0:v.y)!=null?w:0)})]}))),revision:s}})),emitMetrics:t=>R(this,b,hs).call(this,t)})};is=function(){return new ar({label:h(this,We).id,pointerMove:Qt(h(this,vi)),pointerDown:Qt(h(this,yi)),pointerUp:Qt(h(this,wi)),getViewport:()=>{var i,e,t,n,s,a,r,o,d,l;return Qe({x:(t=(e=(i=h(this,x).geometry)==null?void 0:i.scrollPosition)==null?void 0:e.x)!=null?t:0,y:(a=(s=(n=h(this,x).geometry)==null?void 0:n.scrollPosition)==null?void 0:s.y)!=null?a:0,width:(o=(r=h(this,x).geometry)==null?void 0:r.documentFrame.width)!=null?o:0,height:(l=(d=h(this,x).geometry)==null?void 0:d.documentFrame.height)!=null?l:0})},compareZIndex:(i,e)=>{const t=Ii(i.geometry),n=Ii(e.geometry),s=h(this,O).get(t.decorationId),a=h(this,O).get(n.decorationId);if(!s||!a)return 0;if(s.zIndex===a.zIndex){const r=s.segments.find(f=>f.id===t.segmentId),o=a.segments.find(f=>f.id===n.segmentId);if(!r||!o)return 0;const d=r.underline?1:0,l=o.underline?1:0;return d-l}return s.zIndex-a.zIndex},emitMetrics:i=>R(this,b,cs).call(this,i)})};ns=function(i,e){var t=[];try{const a=Ke(t,new DisposableStack);return a.use(m(e,ri(r=>r?mt(i.pointerEvents):Tt),Re(r=>m(R(this,b,rs).call(this,r),Ms(pt(o=>h(this,A).error("Unexpected error handling pointer event",o,{delivery:!1}))))))),a.use(m(e,ri(r=>r?mt(h(this,be).onPointerEvent):Tt),Re(r=>void m(R(this,b,fs).call(this,r),Dt(pt(o=>h(this,A).error("Unexpected error sending pointer events to TextDecorationsViewBackgroundController",o,{delivery:!1}))))))),a.move()}catch(a){var n=a,s=!0}finally{je(t,n,s)}};ss=function(){var i=[];try{const n=Ke(i,new DisposableStack);for(const[s,a,r]of[[h(this,Y).documentScrolling,"documentScrolling",250],[h(this,Y).windowMoving,"windowMoving",250],[h(this,Y).windowResizing,"windowResizing",250]])n.use(m(s,ri(o=>o==="removeAfterTimeout"?Us(r):Tt),Re(()=>R(this,b,Ji).call(this,[a]))));return n.move()}catch(n){var e=n,t=!0}finally{je(i,e,t)}};Wi=function(i){return m(i,I(e=>h(this,O).get(e)),$(j),q)};Ji=function(i){var e;i.length!==0&&(i.forEach(t=>h(this,Ze).delete(t)),!(h(this,Ze).size>0||h(this,O).size===0)&&(h(this,be).enablePointerEvents(),(e=h(this,K))==null||e.showAllVisible()))};Ki=function(i){var e;const t=h(this,Ze).size>0;i.forEach(n=>h(this,Ze).add(n)),!(t||h(this,O).size===0)&&(h(this,be).disablePointerEvents(),(e=h(this,K))==null||e.hideAllVisible())};rs=function(i){var e,t,n,s,a,r,o,d;const l=dr({x:i.position.x-((s=(n=(t=(e=h(this,x))==null?void 0:e.geometry)==null?void 0:t.scrollPosition)==null?void 0:n.x)!=null?s:0),y:i.position.y-((d=(o=(r=(a=h(this,x))==null?void 0:a.geometry)==null?void 0:r.scrollPosition)==null?void 0:o.y)!=null?d:0)});switch(i.kind){case"pointermove":return Mi(()=>h(this,vi).next(l));case"pointerdown":return Mi(()=>h(this,yi).next(l));case"pointerup":return Mi(()=>h(this,wi).next(l));default:return Oi(new Mn(i.kind))}};as=function(i){var e,t,n,s,a,r=[];try{const l=Ke(r,Oe.startSpan("TextDecorationsViewController.#handleTextDidChange()",{attributes:{change:i}})),{visibleChanged:f}=h(this,Ge).pushTextChange(i);h(this,wt).pushNewTextRevision(i.revision);const g=m(f,I(p=>h(this,O).get(p.metadata)),$(j),q);(a=h(this,K))==null||a.requestLayout(g,{text:(e=h(this,wt).textRevision)!=null?e:Li,geometry:(s=(n=(t=h(this,x))==null?void 0:t.geometry)==null?void 0:n.revision)!=null?s:Yi}),g.length>0&&h(this,A).verbose("text changed",{change:i,visibleChangedDecorationsCount:g.length,visibleChangedSegmentsCount:Array.from(g).flatMap(p=>p.segments).length})}catch(l){var o=l,d=!0}finally{je(r,o,d)}};os=function(i){var e=[];try{const s=Ke(e,Oe.startSpan("TextDecorationsViewController.#handleGeometryWillChange()",{attributes:{event:i}})),a=vt([i.documentFrameScrolling&&h(this,ui)?"documentScrolling":null,i.windowFrameResizing?"windowMoving":null,i.windowFrameResizing?"windowResizing":null].filter(j));a&&(a.includes("documentScrolling")&&h(this,Y).documentScrolling.next("cancelRemoval"),a.includes("windowMoving")&&h(this,Y).windowMoving.next("cancelRemoval"),a.includes("windowResizing")&&h(this,Y).windowResizing.next("cancelRemoval"),R(this,b,Ki).call(this,a))}catch(s){var t=s,n=!0}finally{je(e,t,n)}};ls=function(i){var e=[];try{const s=Ke(e,Oe.startSpan("TextDecorationsViewController.#handleGeometryDidChange()",{attributes:{documentGeometry:i}}));if(i.documentFrameScrolling?h(this,Y).documentScrolling.next("cancelRemoval"):h(this,Y).documentScrolling.next("removeAfterTimeout"),i.windowFrameMoving?h(this,Y).windowMoving.next("cancelRemoval"):h(this,Y).windowMoving.next("removeAfterTimeout"),i.windowFrameResizing?h(this,Y).windowResizing.next("cancelRemoval"):h(this,Y).windowResizing.next("removeAfterTimeout"),L(this,x,i),!i.geometry)return;const{visible:a}=h(this,Ge).pushDocumentGeometryChange(i.geometry.visibleTextRange,i.geometry.revision);R(this,b,ji).call(this,h(this,K),a),h(this,A).verbose("geometry changed",{visibleTextRange:Fi(i.geometry.visibleTextRange)})}catch(s){var t=s,n=!0}finally{je(e,t,n)}};ji=function(i,e){var t,n,s,a,r,o,d,l,f,g,p,v,w;h(this,be).clear();const D=m(e!=null?e:h(this,Ge).getOnscreenTextRangeGroups(),I(S=>h(this,O).get(S.metadata)),$(j),oe);i==null||i.setViewport(D,Qe({x:(s=(n=(t=h(this,x).geometry)==null?void 0:t.scrollPosition)==null?void 0:n.x)!=null?s:0,y:(o=(r=(a=h(this,x).geometry)==null?void 0:a.scrollPosition)==null?void 0:r.y)!=null?o:0,width:(l=(d=h(this,x).geometry)==null?void 0:d.documentFrame.width)!=null?l:0,height:(g=(f=h(this,x).geometry)==null?void 0:f.documentFrame.height)!=null?g:0}),{text:(p=h(this,wt).textRevision)!=null?p:Li,geometry:(w=(v=h(this,x).geometry)==null?void 0:v.revision)!=null?w:Yi})};hs=function(i){h(this,A).verbose("geometry fetch metrics",i)};cs=function(i){h(this,A).verbose("interactive geometry metrics",i)};ds=function(i){const e=m(i.renderedVisibleOnscreenDrawables,I(s=>s.id),oe),t=m(i.visibleDrawables,I(s=>s.id),oe),n=m(i.allDrawables,I(s=>s.id),oe);h(this,A).verbose("render metrics",{decorationsRenderedOnLastRenderLoop:i.drawablesRenderedOnLastRenderLoop,renderedVisibleOnscreenDecorationCount:e.size,visibleDecorationCount:t.size,allDecorationCount:n.size}),i.drawablesRenderedOnLastRenderLoop>0&&(h(this,ci)===0&&R(this,b,us).call(this),$r(this,ci)._++)};us=async function(){const{revision:i}=await hn(m(mt(h(this,We).text),gn(1))),e=await hn(m(mt(h(this,We).lastFocusAt),gn(1))),t=(Cs()-e)/1e3;h(this,hi).duration("first_decoration_render",{labels:{revision_history_info:i<=1?"initial":i<10?"early":"late"}}).close(null,{durationInSeconds:t})};en=function(i){var e,t,n,s,a,r,o,d,l,f;return ur({x:i.x-((n=(t=(e=h(this,x).geometry)==null?void 0:e.scrollPosition)==null?void 0:t.x)!=null?n:0)+((a=(s=h(this,x).geometry)==null?void 0:s.documentFrame.x)!=null?a:0),y:i.y-((d=(o=(r=h(this,x).geometry)==null?void 0:r.scrollPosition)==null?void 0:o.y)!=null?d:0)+((f=(l=h(this,x).geometry)==null?void 0:l.documentFrame.y)!=null?f:0)})};ii=function(i){return mr({...R(this,b,en).call(this,i),width:i.width,height:i.height})};fs=function(i){return h(this,Je).onSegmentPointerEvents({pointerEnter:R(this,b,ot).call(this,i.pointerEnter),pointerLeave:R(this,b,ot).call(this,i.pointerLeave),pointerDown:R(this,b,ot).call(this,i.pointerDown),pointerUp:R(this,b,ot).call(this,i.pointerUp),pointerClick:R(this,b,ot).call(this,i.pointerClick)})};ot=function(i){var e,t,n,s,a,r,o,d;if(!i)return;const{decorationId:l,segmentId:f}=Ii(i.target),g=h(this,O).get(l),p=vt((n=(t=(e=g==null?void 0:g.segments)==null?void 0:e.find(S=>S.id===f))==null?void 0:t.rects)!=null?n:[]),v=vt((s=g==null?void 0:g.rects)!=null?s:[]),w=gr((r=(a=h(this,x).geometry)==null?void 0:a.viewportFrame)!=null?r:{x:0,y:0}),D=Ns((d=(o=h(this,x).geometry)==null?void 0:o.windowFrame)!=null?d:{x:0,y:0});return!g||!p||!v?void 0:{kind:i.kind,segmentId:f,id:l,position:R(this,b,en).call(this,i.position),rect:R(this,b,ii).call(this,i.currentTarget),segmentRects:m(p,si(S=>R(this,b,ii).call(this,S))),decorationRects:m(v,si(S=>R(this,b,ii).call(this,S))),viewportOffset:w,windowOffset:D}};const Or=({documentId:i,width:e,height:t,onMount:n})=>Hs.jsx("div",{"data-document-id":i,style:{width:e,height:t},ref:n});var Pr=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),xn=i=>{throw TypeError(i)},Xr=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&xn("Object expected");var n;n===void 0&&(n=e[Pr("dispose")]),typeof n!="function"&&xn("Object not disposable"),i.push([t,n,e])}return e},Yr=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,d,l){return l=Error(d),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,d=>(s(d),a()))}catch(d){s(d)}if(t)throw e};return a()};const Gi=ni(),ba=i=>{const e=i.getExecutionScopeDefinition("document-session");return m(i.getPlugins(["document-session","monitoring","window-management"]),kn(([t,n,s])=>lt.all([e.register({token:Es,useFactory:a=>m($i([a.resolve(t.provides.TextDocumentInfo),a.resolve(Gi)]),xe(([r,o])=>d=>Ss.createElement(Or,{...d,documentId:r.id,onMount:l=>o.next({host:l,hideDecorationsOnScroll:d.hideDecorationsOnScroll})})))},{lifetime:ht.Singleton}),Vr(e,t,n,s)])))};function Vr(i,e,t,n){var s=[];try{const o=Xr(s,new DisposableStack),d=ni();return m(Zs({scopeDefinition:i,remoteEntityToken:Ts,localEntityToken:d}),lt.use(o),kn(({remoteEntityToken:l})=>lt.all([i.register({token:Gi,useFactory:()=>$e(new ks({host:null,hideDecorationsOnScroll:!0}))},{lifetime:ht.Singleton}),i.register({token:d,useFactory:f=>m(f.resolve(Ti),xe(g=>({entity:g,disposable:g})))},{lifetime:ht.Singleton}),i.register({token:Ti,useFactory:Qs(Ti,[l,Gi,e.provides.TextDocumentInfo,n.provides.CurrentWindow,t.provides.Monitoring])},{lifetime:ht.Singleton})])),lt.use(o),xe(()=>o.move()))}catch(o){var a=o,r=!0}finally{Yr(s,a,r)}}export{ba as activate};
//# sourceMappingURL=index-ZyG0PkH-.js.map
