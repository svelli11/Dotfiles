import{c as L,l as K,Q as Z,H as S,T as j,G as $,u as q,i as T,V as ee,p as k,R as P,W as re,h as D,L as N,X as te,a as oe,Y as ne,C as z,j as se,m as ie}from"./start-BFd-djfI.js";import{DocumentGroupToken as ae,WindowFactoryToken as ce,ConnectEventSourceToken as pe}from"./index-DnatBlUk.js";import{L as ue}from"./LRUCache-D4SXcJs8-0gDlvbKA.js";import{d as de}from"./defineFactory-DJYNRBNc-BvZfVSHA.js";import"./PluginModule-CRib3PLZ-B43Hjk20.js";import"./PluginDependency-Boc6-pxl-tjuTwLTj.js";var le=Object.defineProperty,J=r=>{throw TypeError(r)},fe=(r,e,t)=>e in r?le(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,he=(r,e,t)=>fe(r,e+"",t),U=(r,e,t)=>e.has(r)||J("Cannot "+t),v=(r,e,t)=>(U(r,e,"read from private field"),t?t.call(r):e.get(r)),A=(r,e,t)=>e.has(r)?J("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),ge=(r,e,t,o)=>(U(r,e,"write to private field"),e.set(r,t),t),y,m;class we{constructor(e,t){A(this,y,new AsyncDisposableStack),A(this,m),he(this,"id"),this.id=e,ge(this,m,t)}createWindow(e){return v(this,m).createWindow(e)}documentGroupDisposedByHost(){v(this,m).close()}get disposed(){return v(this,y).disposed}use(e){return v(this,y).use(e)}async[Symbol.asyncDispose](){await v(this,y).disposeAsync()}}y=new WeakMap;m=new WeakMap;var O=(r,e)=>(e=Symbol[r])?e:Symbol.for("Symbol."+r),C=r=>{throw TypeError(r)},x=(r,e,t)=>e.has(r)||C("Cannot "+t),c=(r,e,t)=>(x(r,e,"read from private field"),t?t.call(r):e.get(r)),f=(r,e,t)=>e.has(r)?C("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),W=(r,e,t,o)=>(x(r,e,"write to private field"),e.set(r,t),t),V=(r,e,t)=>(x(r,e,"access private method"),t),F=(r,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&C("Object expected");var o;t&&(o=e[O("asyncDispose")]),o===void 0&&(o=e[O("dispose")]),typeof o!="function"&&C("Object not disposable"),r.push([t,o,e])}else t&&r.push([t]);return e},ve=(r,e,t)=>{var o=typeof SuppressedError=="function"?SuppressedError:function(n,a,p,u){return u=Error(p),u.name="SuppressedError",u.error=n,u.suppressed=a,u},s=n=>e=t?new o(n,e,"An error was suppressed during disposal"):(t=!0,n),i=n=>{for(;n=r.pop();)try{var a=n[1]&&n[1].call(n[2]);if(n[0])return Promise.resolve(a).then(i,p=>(s(p),i()))}catch(p){s(p)}if(t)throw e};return i()},h,E,b,_,w,d,I,H,B;const Q=L(),X=L();class G{constructor(e,t,o,s){f(this,I),f(this,h,new AsyncDisposableStack),f(this,E),f(this,b),f(this,_),f(this,w,c(this,h).use(new ue({capacity:10}))),f(this,d,K.createLogger("DocumentGroupManager")),W(this,E,e),W(this,b,o),W(this,_,s),c(this,h).use(t.subscribe(i=>V(this,I,H).call(this,i)))}async[Symbol.asyncDispose](){await c(this,h).disposeAsync()}}h=new WeakMap;E=new WeakMap;b=new WeakMap;_=new WeakMap;w=new WeakMap;d=new WeakMap;I=new WeakSet;H=function(r){const e=Promise.withResolvers(),t=c(this,h).use(r({connect:o=>{c(this,_).connect({groupId:o.groupId,windowId:o.windowId,api:Z(e.promise)});const s=o.groupId,i=c(this,w).get(s),n=c(this,_).getWindowGroup(o.groupId);if(!n)return S(new Error("WindowGroup not found"));if(i){if(o.connectorPort){const a=new ye(s);return c(this,d).error(a,{delivery:!1}),S(a)}}else{if(!o.connectorPort){const g=new me(s);return c(this,d).error(g,{delivery:!1}),S(g)}const a=c(this,E).createExecutionScopeController("document-group",{id:void 0,data:{groupId:s}});if(j(a))return S(a.error);const p=a.value,u=c(this,h).use(new we(s,n)),l=c(this,w).set(s,u);if(l){const[g,M]=l;M[Symbol.asyncDispose]().catch(Y=>c(this,d).error("Unexpected error disposing DocumentGroup ".concat(g),Y))}V(this,I,B).call(this,p,{...o,connectorPort:o.connectorPort},u)}return $()},disposeConnector:o=>{const s=o.groupId,i=c(this,w).get(s);return i?(c(this,d).verbose("Disposing document group ".concat(i.id,".")),c(this,w).delete(s),i.documentGroupDisposedByHost(),q(()=>i[Symbol.asyncDispose]())):$()}}));e.resolve(T(t.createClient()))};B=async function(r,e,t){var o=[];try{const a=F(o,c(this,b).duration("create_document_group")),p=F(o,new AsyncDisposableStack,!0);c(this,d).verbose("Creating document group ".concat(t.id,"."));const u=ee(e.connectorPort);return await k(P.all([r.register({token:ae,useValue:t}),r.register({token:Q,useValue:u}),r.register({token:X,useValue:{}}),r.register({token:ce,useFactory:l=>k(l.resolve(re),D(g=>T({createWindow:M=>t.createWindow({...M,executionScopeData:g.serialize()})})))},{lifetime:N.ContainerScoped})]),te.use(p),oe(()=>r.start()),ne({success:()=>{t.disposed||t.use(p.move())},failure:l=>{a.close(l),c(this,d).error("Failed to create a document group:",l,{context:t.id,delivery:!0})}}))}catch(a){var s=a,i=!0}finally{var n=ve(o,s,i);n&&await n}};class ye extends z{constructor(e){super("Unexpected connectorPort for existing document group"),this.groupId=e}toJSON(){return{...super.toJSON(),groupId:this.groupId}}}class me extends z{constructor(e){super("Expected a connectorPort to be provided for new document group"),this.groupId=e}toJSON(){return{...super.toJSON(),groupId:this.groupId}}}var _e=(r,e)=>(e=Symbol[r])?e:Symbol.for("Symbol."+r),R=r=>{throw TypeError(r)},Se=(r,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&R("Object expected");var o;o===void 0&&(o=e[_e("dispose")]),typeof o!="function"&&R("Object not disposable"),r.push([t,o,e])}return e},ke=(r,e,t)=>{var o=typeof SuppressedError=="function"?SuppressedError:function(n,a,p,u){return u=Error(p),u.name="SuppressedError",u.error=n,u.suppressed=a,u},s=n=>e=t?new o(n,e,"An error was suppressed during disposal"):(t=!0,n),i=n=>{for(;n=r.pop();)try{var a=n[1]&&n[1].call(n[2]);if(n[0])return Promise.resolve(a).then(i,p=>(s(p),i()))}catch(p){s(p)}if(t)throw e};return i()};const Te=r=>{const e=r.getExecutionScopeDefinition("global"),t=r.getExecutionScopeDefinition("document-group");return k(se([r.getPlugin("monitoring"),r.getPlugin("connector"),r.getPlugin("window-management")]),D(([o,s,i])=>P.all([...Ce(e,t,o,s,i),T(De(e,s))])))};function De(r,e){return r.onStart(async t=>{var o=[];try{const n=Se(o,new DisposableStack);return k(t.resolve(e.provides.Connector),D(a=>a.initialize("document-group")),P.use(n),D(()=>t.resolve(G)),ie(()=>n.move()))}catch(n){var s=n,i=!0}finally{ke(o,s,i)}})}function Ce(r,e,t,o,s){return[r.register({token:G,useFactory:de(G,[r.instanceToken,pe,t.provides.Monitoring,s.provides.WindowManager])},{lifetime:N.Singleton}),e.register({token:o.consumes.ConnectorConfiguration,useToken:X}),e.register({token:o.consumes.ConnectorMessageTransport,useToken:Q})]}export{Te as activate};
//# sourceMappingURL=index-DwHsR4dY.js.map
