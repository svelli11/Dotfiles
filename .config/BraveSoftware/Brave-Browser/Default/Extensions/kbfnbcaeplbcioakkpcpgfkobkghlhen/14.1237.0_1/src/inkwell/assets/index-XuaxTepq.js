import{S as M,l as L,p as g,s as P,b as U,d as N,t as C,e as Q,g as q,h as z,R as G,i as b,j as $,L as y,m as B}from"./index-uVYElzgq.js";import{CAPISuggestionStoreToken as W}from"./index-bbwY4Mlj.js";import{T as H}from"./TextRevisionSynchronizedQueue-DQV4bu5q-DwE51F-N.js";import{c as A}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{d as K}from"./defineFactory-DJYNRBNc-CmRNy_rl.js";import"./PluginModule-CRib3PLZ-LTQDm_KX.js";var R=e=>{throw TypeError(e)},I=(e,s,i)=>s.has(e)||R("Cannot "+i),t=(e,s,i)=>(I(e,s,"read from private field"),i?i.call(e):s.get(e)),l=(e,s,i)=>s.has(e)?R("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(e):s.set(e,i),S=(e,s,i,n)=>(I(e,s,"write to private field"),s.set(e,i),i),w=(e,s,i)=>(I(e,s,"access private method"),i),u,o,c,_,p,v,m,h,f,E,T,D,F;class k{constructor(s,i,n){l(this,f),l(this,u),l(this,o,new DisposableStack),l(this,c,new Map),l(this,_,new M),l(this,p,new M),l(this,v),l(this,m,new H),l(this,h,null),S(this,v,i),S(this,u,L.createLogger("CAPISuggestionProvider",i.id)),t(this,o).use(g(t(this,_),P(r=>g(s.upsert(r),U(N(a=>t(this,u).error("Unexpected error upserting CAPI suggestions",a,{delivery:!0}))))))),t(this,o).use(g(t(this,p),P(r=>s.remove(r)))),t(this,o).use(n.status.subscribe(r=>{if(r.kind==="connected"&&S(this,h,r.sessionId),r.kind==="connected"&&r.isNewSession){const a=g(t(this,c).entries(),q(([d,{sessionId:J}])=>J!==r.sessionId),Q(([d])=>d),C);a.forEach(d=>t(this,c).delete(d)),t(this,u).verbose("Reset alert collection for document ".concat(t(this,v).id," and session ID ").concat(r.sessionId)),t(this,p).next(a)}})),t(this,o).use(t(this,m).messages.subscribe(r=>w(this,f,E).call(this,r))),t(this,o).use(n.events.subscribe(r=>t(this,m).enqueue(r,"rev"in r?A(r.rev):void 0))),t(this,o).use(i.text.subscribe(({revision:r})=>t(this,m).pushNewTextRevision(r))),t(this,o).defer(()=>{t(this,p).next(C(t(this,c).keys())),t(this,c).clear(),t(this,u).verbose("Clear alert collection for document ".concat(t(this,v).id))})}[Symbol.dispose](){t(this,o).dispose()}}u=new WeakMap;o=new WeakMap;c=new WeakMap;_=new WeakMap;p=new WeakMap;v=new WeakMap;m=new WeakMap;h=new WeakMap;f=new WeakSet;E=function(e){switch(e.action){case"alert":return w(this,f,T).call(this,e);case"alert_changes":return w(this,f,D).call(this,e);case"remove":return w(this,f,F).call(this,e);default:return}};T=function({action:e,...s}){if(t(this,h)===null)return;const i=String(s.id),n={id:i,kind:"capi",revision:A(s.rev),transforms:x(s),metadata:{rawAlert:s}};t(this,c).set(i,{alert:s,sessionId:t(this,h)}),t(this,_).next([n])};D=function({action:e,...s}){var i;if(t(this,h)===null)return;const n=String(s.id),{alert:r}=(i=t(this,c).get(n))!=null?i:{};if(!r)return;const a={...r,...s},d={id:n,kind:"capi",revision:A(s.rev),transforms:x(s),metadata:{rawAlert:a}};t(this,c).set(n,{alert:a,sessionId:t(this,h)}),t(this,_).next([d])};F=function(e){const s=String(e.id);t(this,c).delete(s),t(this,p).next([s])};function x(e){if(e.transformJson){const s=e.transformJson.context;return[{context:{start:s.s,end:s.e},alternatives:e.transformJson.alternatives}]}else return e.subalerts?e.subalerts.flatMap(x):[]}const se=e=>g($([b(e.getExecutionScopeDefinition("document-session")),e.getPlugin("document-session"),e.getPlugin("suggestion"),e.getPlugin("capi")]),z(([s,i,n,r])=>G.all([...O(s,i,r,n),b(s.onStart(async a=>a.resolve(k)))])));function O(e,s,i,n){return[e.register({token:k,useFactory:K(k,[W,s.provides.TextDocument,i.provides.CAPIConnection])},{lifetime:y.Singleton}),e.register({token:W,useFactory:r=>g(r.resolve(n.provides.SuggestionStoreManager),B(a=>a.createStore("capi")))},{lifetime:y.Singleton})]}export{se as activate};
//# sourceMappingURL=index-XuaxTepq.js.map
