import{p as s,k as Q,x as g,a1 as T,a9 as D,r as z,a2 as b,aa as U,q as E,z as X,D as Y,d as Z,ab as tt,o as et,g as G,l as it,v as nt,a as $,ac as ot,G as rt,i as at,h as st,R as ct,L as M,m as dt,c as A}from"./start-BFd-djfI.js";import{s as pt}from"./share-CW4-5mF1.js";import{r as H}from"./race-BWu18h02.js";import{t as C}from"./take-gJdc_Sb0.js";import{o as N}from"./of-Boi_-3cC.js";import{d as V,c as lt}from"./delay-D1mS6Jaf.js";import{t as ut}from"./tap-BNGPOE-c.js";import{s as ft}from"./startWith-PVWOuAJK.js";import{InlineCardInteractionContextToken as ht,TextDecorationInteractionObserverToken as mt}from"./index-Cu8JTHOu.js";import{m as L}from"./NonEmptyArrayFns-oGa02u3x-CLyX5YlY.js";import{t as gt}from"./PointFns-Bd1JBOhL--ZyEh-AF.js";import{t as wt}from"./RectFns-ndpeBtT0-CdOd3O5S.js";import{d as vt}from"./defineFactory-DJYNRBNc-BvZfVSHA.js";import"./mergeAll-D275NTmK.js";import"./async-BZW1XXsj.js";import"./AsyncScheduler-BhBy18pz.js";import"./dateTimestampProvider-CV0dHcg-.js";import"./concat-Bl9EyBSW.js";import"./timer--E-2U5R1.js";import"./PluginModule-CRib3PLZ-B43Hjk20.js";function kt(e){return{x:-e.x,y:-e.y}}function yt(e,t){return{x:e.x+t.x,y:e.y+t.y}}const St={invert:kt,add:yt};function j(e){return t=>t.kind==="pointerEnter"&&t.decoration.id!==e||t.kind==="pointerLeave"&&t.decoration.id===e}function _t(e,t){return i=>{const n=i.decoration.id;return s(e,g(j(n)),D(()=>H(s(N({kind:"stop"}),V(t)),s(e,g(o=>o.decoration.id===n&&o.kind==="pointerEnter"),C(1),z(()=>null)))),g(T),C(1),ft({kind:"start",event:i}))}}function Wt(e,t){let i={kind:"not-hovering"};return s(e,g(xt),g(n=>i.kind==="not-hovering"||n.decoration.id!==i.decorationId),D(n=>H(s(N(n),V(t),D(_t(e,t-1)),ut(o=>{i=o.kind==="start"?{kind:"hovering",decorationId:o.event.decoration.id}:{kind:"not-hovering"}})),s(e,g(j(n.decoration.id)),C(1),z(()=>null)))),g(T),pt(),Q)}function xt(e){return e.kind==="pointerEnter"}var bt=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),_=e=>{throw TypeError(e)},R=(e,t,i)=>t.has(e)||_("Cannot "+i),r=(e,t,i)=>(R(e,t,"read from private field"),i?i.call(e):t.get(e)),f=(e,t,i)=>t.has(e)?_("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),w=(e,t,i,n)=>(R(e,t,"write to private field"),t.set(e,i),i),v=(e,t,i)=>(R(e,t,"access private method"),i),Mt=(e,t,i)=>{if(t!=null){typeof t!="object"&&typeof t!="function"&&_("Object expected");var n;n===void 0&&(n=t[bt("dispose")]),typeof n!="function"&&_("Object not disposable"),e.push([i,n,t])}return t},Dt=(e,t,i)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(a,l,d,h){return h=Error(d),h.name="SuppressedError",h.error=a,h.suppressed=l,h},o=a=>t=i?new n(a,t,"An error was suppressed during disposal"):(i=!0,a),c=a=>{for(;a=e.pop();)try{var l=a[1]&&a[1].call(a[2]);if(a[0])return Promise.resolve(l).then(c,d=>(o(d),c()))}catch(d){o(d)}if(i)throw t};return c()},y,W,x,S,m,p,k,u,q,B,I,J,F;class Ct{constructor(t,i,n){this.documentSessionExecution=t,this.windowFactory=i,this.decorationStoreManager=n,f(this,u),f(this,y,new AsyncDisposableStack),f(this,W),f(this,x),f(this,S),f(this,m,new Set),f(this,p,null),f(this,k,new DisposableStack),w(this,x,i),w(this,S,n.getRootStore()),w(this,W,t),r(this,y).defer(()=>b(r(this,p))),r(this,y).defer(()=>r(this,k).dispose())}observe(t){var i;const n={predicate:t.predicate,plugins:(i=t.plugins)!=null?i:[],window:null,pendingWindow:null};return r(this,m).size===0&&v(this,u,q).call(this),r(this,m).add(n),v(this,u,F).call(this,n),U(()=>{r(this,m).delete(n),n.window&&n.window.close(),n.pendingWindow&&s(n.pendingWindow,E(o=>o.close())),r(this,m).size===0&&r(this,k).dispose()})}async[Symbol.asyncDispose](){await r(this,y).disposeAsync()}}y=new WeakMap;W=new WeakMap;x=new WeakMap;S=new WeakMap;m=new WeakMap;p=new WeakMap;k=new WeakMap;u=new WeakSet;q=function(){var e=[];try{const n=Mt(e,new DisposableStack);n.use(Wt(s(X(r(this,S).onPointerHoverChange),lt(o=>Y([o.pointerLeave,o.pointerEnter].filter(T)))),100).subscribe(o=>{switch(o.kind){case"start":{const c=s(r(this,m),Z(({predicate:a})=>a(o.event.decoration.id,o.event.decoration.metadata)),tt);c?v(this,u,B).call(this,c,o.event):v(this,u,I).call(this);break}case"stop":v(this,u,I).call(this);break}})),r(this,k).dispose(),w(this,k,n.move())}catch(n){var t=n,i=!0}finally{Dt(e,t,i)}};B=function(e,t){t.decoration.focus(t.segment.id),b(r(this,p)),w(this,p,null),s(v(this,u,J).call(this,e,t),et(G(i=>it.error("Failed to create inline-card-interaction execution scope",i))))};I=function(){b(r(this,p)),w(this,p,null),r(this,S).focus(null)};J=async function(e,t){return s(v(this,u,F).call(this,e),$(async i=>{const n=St.add(t.viewportOffset,t.windowOffset),o=gt(n),c=wt(n),a={windowId:i.id,decorationId:t.decoration.id,metadata:t.decoration.metadata,geometryData:{pointerPosition:o(t.position),segmentRect:c(t.rect),segmentRects:s(t.segmentRects,L(c)),decorationRects:s(t.decorationRects,L(c))}};return ot(l=>{const d=l(r(this,W).createExecutionScopeController("inline-card-interaction",{data:a}));return d.register({token:ht,useValue:a}),at(d)})}),$(i=>(r(this,p)&&b(r(this,p)),w(this,p,i),i.start())),E(nt))};F=async function(e){if(e.window)return rt(e.window);if(e.pendingWindow)return e.pendingWindow;const t=r(this,x).createWindow({name:"inline-card",injectionOptions:{kind:"popup"},clickThroughTransparent:!1,plugins:[...e.plugins,"inline-card"],scopes:["inline-card-interaction"],fitContent:!0,initializationData:null});return e.pendingWindow=t,s(t,E(G(i=>{e.window=i,e.pendingWindow=null})))};const Qt=async e=>{const t=A(Symbol("InlineCardWindow")),i=A(Symbol("InlineCardManager")),n=e.getExecutionScopeDefinition("document-session"),o=e.getExecutionScopeDefinition("document-group");return s(e.getPlugins(["text-decoration","document-group"]),st(([c,a])=>ct.all([n.register({token:i,useFactory:vt(Ct,[n.instanceToken,t,c.provides.TextDecorationStoreManager])},{lifetime:M.Singleton}),n.register({token:mt,useFactory:l=>{const d=e.getResolutionMetadata(),h=d?[d.plugin]:[];return s(l.resolve(i),dt(K=>({observe:O=>{var P;return K.observe({...O,plugins:[...h,...(P=O.additionalPlugins)!=null?P:[]]})}})))}},{lifetime:M.Transient}),o.register({token:t,useFactory:l=>l.resolve(a.provides.WindowFactory)},{lifetime:M.Singleton})])))};export{Qt as activate};
//# sourceMappingURL=index-BLgm_taZ.js.map
