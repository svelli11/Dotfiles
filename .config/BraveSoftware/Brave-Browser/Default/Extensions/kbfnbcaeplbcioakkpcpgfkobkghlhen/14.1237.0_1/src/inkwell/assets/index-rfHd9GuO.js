import{a3 as X,S as V,v as P,l as Z,z as A,p as c,r as O,y as S,s as C,ag as q,k as j,au as ee,o as te,d as B,K as se,u as ie,m as K,b as re,f as ne,U as ae,i as E,h as oe,R as $,L as T,c as ce}from"./index-uVYElzgq.js";import{A as N,S as de,a as le,b as ue,t as pe,c as x,d as he}from"./SDUIActionHandler-BB7VREq_.js";import{E as I}from"./mergeAll-CSDR5lBs.js";import{d as me}from"./defer-BLWpl2MB.js";import{S as ge}from"./SingleConsumerBufferedEmitter-_6WCMMUA-B9gRLjc-.js";import{s as fe}from"./switchMap-BWSw-lA5.js";import{t as ve}from"./take-A312jYgg.js";import{SDUIManagerToken as Se}from"./index-DLIwY9pE.js";import{d as L}from"./defineFactory-DJYNRBNc-CmRNy_rl.js";import"./distinctUntilChanged-JrE1RNy_.js";import"./of-DPWY87hm.js";import"./delay-Cs5qaBTb.js";import"./async-dh0JxqdS.js";import"./concat-DqL665aX.js";import"./timer-B6bjwuU9.js";import"./startWith-DFLDsqXv.js";import"./merge-BJiAq4u-.js";import"./debounceTime-XokiU2Af.js";import"./tap-BL_zgIju.js";import"./share-BO0c2DMx.js";import"./skip-DI4WBx6-.js";import"./timeout-72B4Da-8.js";import"./asap-D7RGTMcn.js";import"./finalize-DNcSQJJw.js";import"./race-DbiJq4jp.js";import"./pairwise-7DNa7SKt.js";import"./throttleTime-CwYuaEy_.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-LTQDm_KX.js";var ke={connector:function(){return new V},resetOnDisconnect:!0};function _e(e,t){t===void 0&&(t=ke);var s=null,n=t.connector,o=t.resetOnDisconnect,a=o===void 0?!0:o,r=n(),m=new X(function(f){return r.subscribe(f)});return m.connect=function(){return(!s||s.closed)&&(s=me(function(){return e}).subscribe(r),a&&s.add(function(){return r=n()})),s},m}function we(e){return{[Symbol.dispose]:()=>e.unsubscribe()}}var Ie=Object.defineProperty,be=(e,t,s)=>t in e?Ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,l=(e,t,s)=>be(e,typeof t!="symbol"?t+"":t,s);class ye{constructor(){l(this,"feed",I),l(this,"currentFeed",{_tag:"None"}),l(this,"onFeedRemove",I),l(this,"onFeedEmpty",I),l(this,"header",I),l(this,"footer",I),l(this,"pushFeed",()=>({_tag:"Right",right:null})),l(this,"popFeed",P),l(this,"focusCard",()=>({_tag:"Right",right:null})),l(this,"notifyCardFocused",P),l(this,"dispose",P)}}var z=e=>{throw TypeError(e)},Y=(e,t,s)=>t.has(e)||z("Cannot "+s),i=(e,t,s)=>(Y(e,t,"read from private field"),s?s.call(e):t.get(e)),u=(e,t,s)=>t.has(e)?z("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),k=(e,t,s,n)=>(Y(e,t,"write to private field"),t.set(e,s),s),h,b,_,D,d,w,y,F,U,R;class M{constructor(t,s,n,o){u(this,h,new DisposableStack),u(this,b,Z.createLogger("SDUIManager")),u(this,_,N.create(null)),u(this,D),u(this,d),u(this,w),u(this,y),u(this,F),u(this,U,new V),u(this,R);const a=_e(A(t.items));k(this,R,o),k(this,F,n),k(this,d,new de(c(a,S(r=>r.kind==="sdui"),O(r=>r.event)),r=>n.get(r)===null?{_tag:"None"}:{_tag:"Some",value:r})),i(this,h).defer(()=>i(this,d).dispose()),k(this,w,new le(i(this,d).state)),i(this,h).defer(()=>i(this,w).dispose()),k(this,D,N.combine(i(this,d).state,i(this,_),(r,m)=>{if(m===null)return null;const f=i(this,w).getInlineItemForAlert(m);return f._tag==="None"?null:G(f.value)})),k(this,y,new ue({sendUserAction:(r,m)=>{const f=s.status.getValue();f.kind==="connected"?s.send({action:"user_action",componentId:r,userAction:m,sessionId:f.sessionId}):i(this,b).error("Cannot send user action: not connected",{delivery:!0})}},i(this,d),new ye,{disablePlagiarismSearch:()=>{throw new Error("Method not implemented.")},disableWritingExpert:()=>{throw new Error("Method not implemented.")},enablePlagiarismSearch:()=>{throw new Error("Method not implemented.")},enableWritingExpert:()=>{throw new Error("Method not implemented.")},requestWritingExpert:()=>{throw new Error("Method not implemented.")}},i(this,D).view(r=>r===null?{_tag:"None"}:{_tag:"Some",value:r.item.id}))),i(this,h).defer(()=>i(this,y).dispose()),i(this,h).use(c(a,S(r=>r.kind==="sessionStarted"),C(()=>i(this,d).onSessionStarted()))),i(this,h).use(c(a,S(r=>r.kind==="firstCheckingFinished"),C(()=>i(this,d).onFirstCheckingFinished()))),i(this,h).use(n.changes.subscribe(()=>i(this,d).notifyAlertsChanged())),i(this,h).use(we(a.connect()))}setFocusedSuggestion(t){return i(this,_).set(t),q(()=>{i(this,_).get()===t&&i(this,_).set(null)})}getInlineCardItem(t){const s=t,n=()=>{const a=i(this,w).getInlineItemForAlert(s);return a._tag==="None"?null:G(a.value)},o=c(i(this,d).state,O(n),pe(c(i(this,U),S(a=>{var r;return a===((r=n())==null?void 0:r.item.id)}))),j);return{getValue:n,subscribe:a=>o.subscribe(a)}}handle(t){const s=ee(t.actions,a=>{switch(a.type){case"nextCard":case"prevCard":case"openSettings":case"openToneDetector":case"openFeedback":case"openLearnMore":case"transition":case"openCreateSnippetModal":case"nativeOpenAssistant":case"selectAlternative":case"highlightAlert":case"openPerformanceScore":case"nativeOpenUserSatisfactionFeedback":return"ignored";case"enablePlagiarismCheck":case"disablePlagiarismCheck":return"unknown";case"showHighlights":case"hideHighlights":return"deprecated";case"notify":case"switchView":case"newRevision":case"interactPopover":return"sdui";case"openLink":case"copyToClipboard":case"stopApplyingAlerts":case"upgradeToPremium":case"openGrammarlyGo":return"external";case"closeCard":case"removeRoot":case"applyAlerts":case"removeAlerts":return"internal";default:return"unhandled"}});s.get("external");const n=s.get("internal");if(n!==void 0){i(this,b).verbose("Internal actions:",n);for(const a of n)switch(a.type){case"closeCard":i(this,U).next(t.cardId);break;case"removeRoot":i(this,d).pushRemovedRoot([t.cardId,"removeRoot"]);break;case"applyAlerts":{c(i(this,R).apply(t.scope.alertRefs.map(r=>({suggestionId:r,alternativeIndex:a.alternativeIndex}))),te(B(r=>i(this,b).error("Failed to apply alerts",r))));break}case"removeAlerts":i(this,F).remove(t.scope.alertRefs);break}}const o=s.get("sdui");return o===void 0?se():ie(async()=>i(this,y).sduiActionEvents.next({...t,actions:o}))}[Symbol.dispose](){i(this,h).dispose()}}h=new WeakMap;b=new WeakMap;_=new WeakMap;D=new WeakMap;d=new WeakMap;w=new WeakMap;y=new WeakMap;F=new WeakMap;U=new WeakMap;R=new WeakMap;function G(e){return{item:e}}var J=e=>{throw TypeError(e)},Q=(e,t,s)=>t.has(e)||J("Cannot "+s),p=(e,t,s)=>(Q(e,t,"read from private field"),s?s.call(e):t.get(e)),H=(e,t,s)=>t.has(e)?J("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),Ce=(e,t,s,n)=>(Q(e,t,"write to private field"),t.set(e,s),s),v,g;class W{constructor(t){H(this,v,new DisposableStack),H(this,g),Ce(this,g,p(this,v).use(new ge));const s=c(A(t.status),S(n=>n.kind==="connected"&&n.isNewSession));p(this,v).use(c(A(t.events),S(Me),C(n=>{c(Ae(n),K(o=>p(this,g).next({kind:"sdui",event:o})),re(B(o=>p(this,g).error(o))))}))),p(this,v).use(c(s,C(()=>p(this,g).next({kind:"sessionStarted"})))),p(this,v).use(c(s,fe(()=>c(A(t.events),S(n=>n.action==="finished"),ve(1))),C(()=>p(this,g).next({kind:"firstCheckingFinished"}))))}get items(){return p(this,g)}[Symbol.dispose](){p(this,v).dispose()}}v=new WeakMap;g=new WeakMap;function Me(e){return e.action.startsWith("sdui:")}function Ae(e){switch(e.action){case"sdui:add":return E({kind:x.Add,sdui:e.sdui,sduiRootId:e.sduiRootId,rev:e.rev});case"sdui:remove":return E({kind:x.Remove,sduiRootId:e.sduiRootId,rev:e.rev});case"sdui:update":return E({kind:x.Update,sdui:e.sdui,sduiRootId:e.sduiRootId,rev:e.rev});default:return ne(new ae(e))}}const rt=async e=>{const t=ce(Symbol("SDUIActionHandler"));return c(e.getPlugins(["capi","suggestion","capi-suggestion"]),oe(([s,n,o])=>{const a=e.getExecutionScopeDefinition("document-session");return $.all([a.register({token:Se,useToken:M}),a.register({token:M,useFactory:L(M,[W,s.provides.CAPIConnection,o.provides.CAPISuggestionStore,n.provides.SuggestionService])},{lifetime:T.Singleton}),a.register({token:W,useFactory:L(W,[s.provides.CAPIConnection])},{lifetime:T.Singleton}),a.register({token:t,useFactory:r=>c(r.resolve(M),K(m=>()=>({entity:m})))},{lifetime:T.Singleton}),E(a.onStart(async r=>$.all([Ee(r),r.realm.registerEntity({token:he,useToken:t})])))])}))};function Ee(e){return e.resolve(W)}export{rt as activate};
//# sourceMappingURL=index-rfHd9GuO.js.map
