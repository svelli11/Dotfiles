import{a6 as Ge,S as p,B as Se,k as v,p as b,aM as xe,ad as Ie,aN as qe,aO as Te,q as I,v as K,a5 as Q,b as q,l as Oe,aP as ze,d as Je,a1 as Ke,o as Ce,g as We,t as Ee,G as $,U as Qe,u as Xe,h as Ye,R as Ze,j as je,i as Ve,L as Pe,m as et,c as tt}from"./start-BFd-djfI.js";import{e as Le,T as it}from"./index-DIq9RWYQ.js";import{TextDecorationStoreManagerToken as st}from"./index-oQtk5Yhs.js";import{a as De}from"./subscribableState-Y8YW7N9Z-L1DO2Tta.js";import{d as nt}from"./defineFactory-DJYNRBNc-BvZfVSHA.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-B43Hjk20.js";function Fe(){return Ge()}var rt=Object.defineProperty,at=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),ce=t=>{throw TypeError(t)},ot=(t,e,i)=>e in t?rt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,S=(t,e,i)=>ot(t,typeof e!="symbol"?e+"":e,i),Re=(t,e,i)=>e.has(t)||ce("Cannot "+i),c=(t,e,i)=>(Re(t,e,"read from private field"),i?i.call(t):e.get(t)),g=(t,e,i)=>e.has(t)?ce("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),ct=(t,e,i,s)=>(Re(t,e,"write to private field"),e.set(t,i),i),lt=(t,e,i)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&ce("Object expected");var s;s===void 0&&(s=e[at("dispose")]),typeof s!="function"&&ce("Object not disposable"),t.push([i,s,e])}return e},ht=(t,e,i)=>{var s=typeof SuppressedError=="function"?SuppressedError:function(r,d,y,_){return _=Error(y),_.name="SuppressedError",_.error=r,_.suppressed=d,_},o=r=>e=i?new s(r,e,"An error was suppressed during disposal"):(i=!0,r),a=r=>{for(;r=t.pop();)try{var d=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(d).then(a,y=>(o(y),a()))}catch(y){o(y)}if(i)throw e};return a()},R,M,X,Y,Z,j,ee,te,ie,se,U,ne,re;class dt{constructor(e){g(this,R,new DisposableStack),g(this,M,new Set),g(this,X),g(this,Y,new p),g(this,Z,new p),g(this,j,new p),g(this,ee,new p),g(this,te,new p),g(this,ie,new p),g(this,se,new p),g(this,U,new Se(new Set)),g(this,ne,new Map),g(this,re,new p),S(this,"onPointerEnter",v(c(this,Y))),S(this,"onPointerLeave",v(c(this,Z))),S(this,"onPointerHoverChange",v(c(this,j))),S(this,"onPointerDown",v(c(this,ee))),S(this,"onPointerUp",v(c(this,te))),S(this,"onPointerClick",v(c(this,ie))),S(this,"onFocusChange",v(c(this,se))),S(this,"visibleOnscreenDecorations",De(c(this,U))),S(this,"changes",v(c(this,re))),S(this,"id",Fe()),ct(this,X,e.upsert),e.children.forEach(i=>c(this,R).use(this.add(i))),c(this,R).defer(()=>c(this,M).clear())}add(e){var i=[];try{const a=lt(i,new DisposableStack);return a.use(e.onPointerEnter.subscribe(r=>c(this,Y).next(r))),a.use(e.onPointerLeave.subscribe(r=>c(this,Z).next(r))),a.use(e.onPointerHoverChange.subscribe(r=>c(this,j).next(r))),a.use(e.onPointerDown.subscribe(r=>c(this,ee).next(r))),a.use(e.onPointerUp.subscribe(r=>c(this,te).next(r))),a.use(e.onPointerClick.subscribe(r=>c(this,ie).next(r))),a.use(e.onFocusChange.subscribe(r=>c(this,se).next(r))),a.use(e.visibleOnscreenDecorations.subscribe(r=>{c(this,ne).set(e,r);const d=b(c(this,ne).values(),xe(Ie),qe,Te);Le(d,c(this,U).getValue())||c(this,U).next(d)})),a.use(e.changes.subscribe(r=>c(this,re).next(r))),a.defer(()=>c(this,M).delete(e)),c(this,M).add(e),a.move()}catch(a){var s=a,o=!0}finally{ht(i,s,o)}}upsert(e){return c(this,X).call(this,e)}remove(e){return b(c(this,M),q(i=>i.remove(e)),Q,I(K))}get(e){for(const i of c(this,M)){const s=i.get(e);if(s)return s}return null}values(){return b(c(this,M),xe(e=>e.values()))}setVisibility(e,i){return b(c(this,M),q(s=>s.setVisibility(e,i)),Q,I(K))}focus(e,i){return b(c(this,M),q(s=>s.focus(e,i)),Q,I(K))}async[Symbol.asyncDispose](){c(this,R).dispose()}}R=new WeakMap;M=new WeakMap;X=new WeakMap;Y=new WeakMap;Z=new WeakMap;j=new WeakMap;ee=new WeakMap;te=new WeakMap;ie=new WeakMap;se=new WeakMap;U=new WeakMap;ne=new WeakMap;re=new WeakMap;var ut=Object.defineProperty,Ue=t=>{throw TypeError(t)},pt=(t,e,i)=>e in t?ut(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,D=(t,e,i)=>pt(t,typeof e!="symbol"?e+"":e,i),me=(t,e,i)=>e.has(t)||Ue("Cannot "+i),n=(t,e,i)=>(me(t,e,"read from private field"),i?i.call(t):e.get(t)),f=(t,e,i)=>e.has(t)?Ue("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),A=(t,e,i,s)=>(me(t,e,"write to private field"),e.set(t,i),i),x=(t,e,i)=>(me(t,e,"access private method"),i),vt=(t,e,i,s)=>({set _(o){A(t,e,o)},get _(){return n(t,e,s)}}),W,T,u,w,be,le,he,de,ue,pe,ve,fe,B,H,C,k,Ae,ae,Be,O;class ft{constructor(e){f(this,k),f(this,W),f(this,T,new AsyncDisposableStack),f(this,u,new Map),f(this,w,null),f(this,be,0),f(this,le,new p),f(this,he,new p),f(this,de,new p),f(this,ue,new p),f(this,pe,new p),f(this,ve,new p),f(this,fe,new p),f(this,B,new Se(new Set)),f(this,H,new p),D(this,"onPointerEnter",v(n(this,le))),D(this,"onPointerLeave",v(n(this,he))),D(this,"onPointerHoverChange",v(n(this,de))),D(this,"onPointerDown",v(n(this,ue))),D(this,"onPointerUp",v(n(this,pe))),D(this,"onPointerClick",v(n(this,ve))),D(this,"onFocusChange",v(n(this,fe))),D(this,"visibleOnscreenDecorations",De(n(this,B))),D(this,"changes",v(n(this,H))),D(this,"id"),f(this,C);var i;this.id=(i=e.id)!=null?i:Fe(),A(this,W,Oe.createLogger("TextDecorationStore",e.label)),A(this,C,ze(e.decorationsViewController)),n(this,T).use(e.segmentPointerEvents.subscribe(s=>x(this,k,Be).call(this,s))),n(this,T).use(e.visibleOnscreenDecorations.subscribe(s=>{const o=b(s,q(a=>{var r;return(r=n(this,u).get(a))==null?void 0:r.decoration}),Je(Ke),Te);Le(o,n(this,B).getValue())||n(this,B).next(o)})),n(this,T).defer(async()=>{e.onDispose(),await this.remove(n(this,u).keys()),n(this,u).clear()})}async upsert(e){var i;const s=n(this,u).get(e.id),o=e.segments.map(l=>({id:"".concat(e.id,"-").concat(vt(this,be)._++),range:l.range,updateSemantics:l.updateSemantics,interactive:l.interactive,underline:l.underline,background:l.background,metadata:l.metadata})),a=x(this,k,Ae).call(this,e.id,o),r=()=>{var l,F;return(F=(l=n(this,u).get(e.id))==null?void 0:l.visibility)!=null?F:"hidden"},d=()=>{var l;return b((l=n(this,u).get(e.id))==null?void 0:l.segments,F=>F?Array.from(F.values()):[])},y=()=>{var l;return(l=n(this,u).get(e.id))==null?void 0:l.metadata},_=(i=s==null?void 0:s.decoration)!=null?i:{id:e.id,get visibility(){return r()},get metadata(){return y()},get segments(){return d()},focus:l=>this.focus(e.id,l),show:()=>this.setVisibility([e.id],!0),hide:()=>this.setVisibility([e.id],!1),[Symbol.asyncDispose]:async()=>{await b(this.remove([e.id]),Ce(We(l=>n(this,W).error("Unexpected error while disposing decoration",l,{delivery:!0}))))}};return n(this,u).set(e.id,{decoration:_,metadata:e.metadata,visibility:e.visibility,segments:new Map(a.map(l=>[l.id,l]))}),n(this,H).next({upserted:new Map([[_.id,_]])}),b(n(this,C).upsert({...e,segments:o,visibility:e.visibility==="focused"?"visible":e.visibility}),I(()=>(n(this,W).verbose("Upserted decoration #".concat(_.id),_),_)),Ce(We(l=>{n(this,W).error("Failed to upsert decoration",l,{delivery:!0}),n(this,W).verbose("Failed to upsert decoration ".concat(_.id),l),n(this,u).delete(e.id)})))}async remove(e){const i=Ee(e);if(i.length===0)return $();for(const s of i)n(this,u).delete(s);return n(this,W).verbose("Deleted decorations:",i),n(this,H).next({removed:new Set(i)}),n(this,C).remove(i)}get(e){var i,s;return(s=(i=n(this,u).get(e))==null?void 0:i.decoration)!=null?s:null}values(){return b(n(this,u).values(),q(e=>e.decoration))}setVisibility(e,i){var s,o;const a=Ee(e);if(a.length===0)return $();let r=$();for(const d of a){const y=n(this,u).get(d);y&&(i?y.visibility=((s=n(this,w))==null?void 0:s.decoration.id)===d?"focused":"visible":(y.visibility="hidden",((o=n(this,w))==null?void 0:o.decoration.id)===d&&(r=this.focus(null))))}return b(Q([n(this,C).setVisibility({ids:a,visible:i}),r]),I(K))}focus(e,i){var s,o,a;if(e){const r=n(this,u).get(e),d=i!==void 0?r==null?void 0:r.segments.get(i):void 0;return((s=n(this,w))==null?void 0:s.decoration.id)===e&&((o=n(this,w).segment)==null?void 0:o.id)===(d==null?void 0:d.id)?$():(((a=n(this,w))==null?void 0:a.decoration.id)!==e&&x(this,k,ae).call(this,!1),A(this,w,r?{decoration:r.decoration,segment:d}:null),x(this,k,ae).call(this,!0),n(this,C).focus(e))}else return n(this,w)===null?$():(x(this,k,ae).call(this,!1),A(this,w,null),n(this,C).focus(null))}async[Symbol.asyncDispose](){await n(this,T).disposeAsync()}}W=new WeakMap;T=new WeakMap;u=new WeakMap;w=new WeakMap;be=new WeakMap;le=new WeakMap;he=new WeakMap;de=new WeakMap;ue=new WeakMap;pe=new WeakMap;ve=new WeakMap;fe=new WeakMap;B=new WeakMap;H=new WeakMap;C=new WeakMap;k=new WeakSet;Ae=function(t,e){const i=new Map(e.map(s=>[s.id,{interactive:s.interactive,background:s.background,underline:s.underline,metadata:s.metadata}]));return e.map(s=>({id:s.id,get underline(){var o;return(o=i.get(s.id))==null?void 0:o.underline},get background(){var o;return(o=i.get(s.id))==null?void 0:o.background},get interactive(){var o,a;return(a=(o=i.get(s.id))==null?void 0:o.interactive)!=null?a:!1},get metadata(){var o,a;return(a=(o=i.get(s.id))==null?void 0:o.metadata)!=null?a:s.metadata},patch:({metadata:o,underline:a,background:r,interactive:d})=>(i.set(s.id,{interactive:d!=null?d:s.interactive,metadata:o!=null?o:s.metadata,underline:a===null?void 0:a!=null?a:s.underline,background:r===null?void 0:r!=null?r:s.background}),n(this,C).patchSegment({id:t,segmentId:s.id,patch:{underline:a,background:r,interactive:d}}))}))};ae=function(t){if(n(this,w)){const e=n(this,u).get(n(this,w).decoration.id);e&&(e.visibility=t?"focused":e.visibility==="focused"?"visible":e.visibility);const i=n(this,w).decoration,s=n(this,w).segment;n(this,fe).next({decoration:i,segment:s,focused:t})}};Be=function(t){if(t.pointerEnter||t.pointerLeave){const e=x(this,k,O).call(this,t.pointerLeave),i=x(this,k,O).call(this,t.pointerEnter);n(this,de).next({pointerEnter:i,pointerLeave:e})}t.pointerDown&&x(this,k,O).call(this,t.pointerDown),t.pointerUp&&x(this,k,O).call(this,t.pointerUp),t.pointerClick&&x(this,k,O).call(this,t.pointerClick)};O=function(t){if(!t)return;const e=n(this,u).get(t.id),i=e==null?void 0:e.segments.get(t.segmentId);if(!e||!i)return;const s={kind:t.kind,segment:i,decoration:e.decoration,position:t.position,rect:t.rect,segmentRects:t.segmentRects,decorationRects:t.decorationRects,viewportOffset:t.viewportOffset,windowOffset:t.windowOffset};switch(t.kind){case"pointerEnter":n(this,le).next(s);break;case"pointerLeave":n(this,he).next(s);break;case"pointerDown":n(this,ue).next(s);break;case"pointerUp":n(this,pe).next(s);break;case"pointerClick":n(this,ve).next(s);break;default:throw new Qe(t.kind)}return s};var He=t=>{throw TypeError(t)},Me=(t,e,i)=>e.has(t)||He("Cannot "+i),h=(t,e,i)=>(Me(t,e,"read from private field"),i?i.call(t):e.get(t)),m=(t,e,i)=>e.has(t)?He("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),z=(t,e,i,s)=>(Me(t,e,"write to private field"),e.set(t,i),i),ge=(t,e,i)=>(Me(t,e,"access private method"),i),V,P,E,N,_e,we,ke,L,oe,G,ye,Ne;class J{constructor(e){m(this,G),m(this,V),m(this,P,new AsyncDisposableStack),m(this,E,new Map),m(this,N),m(this,_e,new Se(new Set)),m(this,we,Promise.withResolvers()),m(this,ke,ge(this,G,Ne).call(this)),m(this,L),m(this,oe,!1),z(this,L,e),z(this,V,Oe.createLogger("TextDecorationStoreManager",e.id));const i=h(this,P).use(ge(this,G,ye).call(this));z(this,N,h(this,P).use(new dt({children:[i],upsert:s=>i.upsert(s)}))),h(this,P).defer(()=>h(this,E).clear())}createStore(e){const i=e!==void 0?h(this,E).get(e):void 0;if(i!=null&&i.store)return i.store;const s=ge(this,G,ye).call(this,e);return h(this,N).add(s),h(this,P).use(s),s}getRootStore(){return h(this,N)}getStore(e){var i,s;return(s=(i=h(this,E).get(e))==null?void 0:i.store)!=null?s:null}setTextDecorationsViewController(e){return h(this,oe)?h(this,V).warn("Text decorations controller already connected",{delivery:!1}):(h(this,V).verbose("Connecting text decorations controller"),h(this,we).resolve(e),z(this,oe,!0)),{entity:h(this,ke)}}async[Symbol.asyncDispose](){await h(this,P).disposeAsync()}}V=new WeakMap;P=new WeakMap;E=new WeakMap;N=new WeakMap;_e=new WeakMap;we=new WeakMap;ke=new WeakMap;L=new WeakMap;oe=new WeakMap;G=new WeakSet;ye=function(t){const e=new DisposableStack,i=new p,s=new ft({id:t,label:h(this,L).id,decorationsViewController:Xe(()=>h(this,we).promise),segmentPointerEvents:v(i),visibleOnscreenDecorations:De(h(this,_e)),onDispose:()=>e.dispose()});return h(this,V).verbose("Created text decoration store",s),h(this,E).set(s.id,{store:s,segmentPointerEventObserver:i}),e.use(s.onFocusChange.subscribe(o=>{o.focused&&h(this,E).forEach(a=>{a.store!==s&&a.store.focus(null)})})),s};Ne=function(){return{getRects:t=>h(this,L).getRects(t),getBoundingRects:t=>h(this,L).getBoundingRects(t),onSegmentPointerEvents:t=>(h(this,E).forEach(e=>e.segmentPointerEventObserver.next(t)),$()),onVisibleOnscreenDecorationsDidChange:t=>(h(this,_e).next(t),$())}};const $e=tt(Symbol("LocalTextDecorationsViewControllerEntity")),mt=t=>b(je([Ve(t.getExecutionScopeDefinition("document-session")),t.getPlugin("document-session")]),Ye(([e,i])=>Ze.all(wt(e,i))));function wt(t,e){return[t.register({token:J,useFactory:nt(J,[e.provides.TextDocument])},{lifetime:Pe.Singleton}),t.register({token:st,useToken:J}),t.register({token:$e,useFactory:i=>b(i.resolve(J),et(s=>o=>s.setTextDecorationsViewController(o.entity)))},{lifetime:Pe.Singleton}),Ve(t.onStart(async i=>i.realm.registerEntity({token:it,useToken:$e})))]}export{mt as activate};
//# sourceMappingURL=index-CZ5X3_aw.js.map
