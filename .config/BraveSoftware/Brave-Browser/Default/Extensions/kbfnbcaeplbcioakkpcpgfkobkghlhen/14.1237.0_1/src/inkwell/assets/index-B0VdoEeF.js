import{a6 as ne,p as h,o as S,g as D,l as R,H as w,G as oe,u as $,q as I,aY as ce,a5 as B,b as de,a as N,a8 as he,aN as pe,aM as le,ab as L,L as ue}from"./start-BFd-djfI.js";import{EmptyWindowGroupError as Q,WindowManagerToken as we,ExecutionRealmProviderToken as fe}from"./index-BLs3wl_w.js";import{f as ve}from"./NonEmptyArrayFns-oGa02u3x-CLyX5YlY.js";import{d as _e}from"./defineFactory-DJYNRBNc-BvZfVSHA.js";import"./PluginModule-CRib3PLZ-B43Hjk20.js";import"./PluginDependency-Boc6-pxl-tjuTwLTj.js";function ge(){return"w-"+ne()}function V(t){return JSON.stringify(Object.fromEntries(Object.entries(t).sort((e,i)=>e[0].localeCompare(i[0]))))}var We=Object.defineProperty,X=t=>{throw TypeError(t)},me=(t,e,i)=>e in t?We(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,q=(t,e,i)=>me(t,typeof e!="symbol"?e+"":e,i),O=(t,e,i)=>e.has(t)||X("Cannot "+i),s=(t,e,i)=>(O(t,e,"read from private field"),i?i.call(t):e.get(t)),A=(t,e,i)=>e.has(t)?X("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),G=(t,e,i,n)=>(O(t,e,"write to private field"),e.set(t,i),i),ye=(t,e,i)=>(O(t,e,"access private method"),i),c,u,p,_,K,Z;class ke{constructor(e,i,n){A(this,K),A(this,c,new AsyncDisposableStack),A(this,u),A(this,p),q(this,"id"),q(this,"hashKey"),A(this,_,!1),this.id=e.windowId,G(this,p,e.api),this.hashKey=V(i),G(this,u,n),s(this,c).defer(async()=>{s(this,_)||(await Promise.resolve(),await h(s(this,p).closeWindow(),S(D(o=>{s(this,_)||R.error("Failed to close window: "+s(this,_)+" "+this.id,o)}))))}),s(this,c).defer(async()=>s(this,u).close()),ye(this,K,Z).call(this)}get group(){return s(this,u).group}createWindow(e){return s(this,c).disposed?w(new ReferenceError("Window is disposed")):s(this,p).createWindow(e)}updateWindow(e){return s(this,c).disposed?w(new ReferenceError("Window is disposed")):s(this,p).updateWindow(e)}replaceApp(e){return s(this,c).disposed?w(new ReferenceError("Window is disposed")):(s(this,u).markActive(),s(this,p).replaceApp(e,{transfer:[e.executionRealmData.port]}))}disposeApp(){return s(this,c).disposed?oe():(s(this,u).markInactive(),s(this,p).disposeAppAndHide())}activatePlugin(e){return s(this,c).disposed?w(new ReferenceError("Window is disposed")):s(this,p).activatePlugin({plugin:e})}isCustomInjection(e){return s(this,c).disposed?w(new ReferenceError("Window is disposed")):s(this,p).isCustomInjection(e)}close(){return $(()=>s(this,c).disposeAsync())}[Symbol.asyncDispose](){return s(this,c).disposeAsync()}}c=new WeakMap;u=new WeakMap;p=new WeakMap;_=new WeakMap;K=new WeakSet;Z=function(){if(s(this,c).disposed){G(this,_,!0);return}const t=new AbortController;h(ce(this.id,t.signal),I(()=>{R.warn("Window ".concat(this.id," is closed."),{delivery:!1}),G(this,_,!0),s(this,u).close()})),s(this,c).defer(()=>t.abort())};var Ce=Object.defineProperty,j=t=>{throw TypeError(t)},Ae=(t,e,i)=>e in t?Ce(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,Ee=(t,e,i)=>Ae(t,e+"",i),z=(t,e,i)=>e.has(t)||j("Cannot "+i),a=(t,e,i)=>(z(t,e,"read from private field"),i?i.call(t):e.get(t)),m=(t,e,i)=>e.has(t)?j("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),Me=(t,e,i,n)=>(z(t,e,"write to private field"),e.set(t,i),i),d=(t,e,i)=>(z(t,e,"access private method"),i),y,g,k,C,f,r,x,ee,te,H,ie,U,P,b,J;class Se{constructor(e,i){m(this,r),m(this,y,new AsyncDisposableStack),m(this,g,R.createLogger("WindowGroup")),Ee(this,"id"),m(this,k),m(this,C,new Set),m(this,f,new Map),this.id=e.groupId,Me(this,k,i);const n=d(this,r,H).call(this,e,{kind:"popup"});d(this,r,U).call(this,n),a(this,y).defer(async()=>{a(this,k).removeWindowGroup(this.id),await h(B(h(a(this,r,x),de(o=>o.close()))),S(D(o=>a(this,g).error("Failure in WindowGroup dispose",o,{delivery:!0}))))})}createWindow(e){return a(this,g).verbose("Creating window",e),h(d(this,r,ee).call(this,e.injectionOptions),N(i=>h(a(this,k).getExecutionRealmData(i.id),N(n=>{var o;return i.replaceApp({windowName:e.name,appName:(o=e.displayName)!=null?o:e.name,plugins:e.plugins,scopes:e.scopes,fitContent:e.fitContent,clickThroughTransparent:e.clickThroughTransparent,executionScopeData:e.executionScopeData,executionRealmData:n,initializationData:e.initializationData})}),I(()=>{const n=new AsyncDisposableStack;return n.defer(async()=>{await h(i.disposeApp(),S(D(o=>a(this,g).error("Failure in dispose app",o,{delivery:!0}))))}),{id:i.id,group:i.group,activatePlugin:o=>n.disposed?w(new he("Window is closed")):i.activatePlugin(o),close:()=>$(()=>n.disposeAsync()),[Symbol.asyncDispose]:()=>n.disposeAsync()}}))))}close(){return $(()=>a(this,y).disposeAsync())}[Symbol.asyncDispose](){return a(this,y).disposeAsync()}}y=new WeakMap;g=new WeakMap;k=new WeakMap;C=new WeakMap;f=new WeakMap;r=new WeakSet;x=function(){return pe(a(this,C),h(a(this,f).values(),le(t=>t)))};ee=function(t){return h(d(this,r,ie).call(this,t),N(e=>{var i;const n=e?t:{kind:"popup"},o=V(n),W=L((i=a(this,f).get(o))!=null?i:[]);if(W)return a(this,g).verbose("Reusing existing window ".concat(W.id," for injection options ").concat(o,".")),d(this,r,P).call(this,W),h(W.updateWindow({injectionOptions:t}),I(()=>W),S(D(()=>d(this,r,b).call(this,W))));const F=ge();return a(this,g).verbose("Creating new window ".concat(F," for injection options ").concat(o,".")),h(B([d(this,r,te).call(this,F,t),a(this,k).waitForConnection(F)]),I(([Ie,re])=>{const Y=d(this,r,H).call(this,re,n);return d(this,r,P).call(this,Y),Y}))}))};te=function(t,e){const i=L(a(this,r,x));return i?i.createWindow({id:t,injectionOptions:e}):w(new Q(this))};H=function(t,e){const i=new ke(t,e,{group:this,markActive:()=>d(this,r,P).call(this,i),markInactive:()=>d(this,r,b).call(this,i),close:()=>d(this,r,J).call(this,i)});return a(this,y).use(i),i};ie=function(t){const e=L(a(this,r,x));return e?e.isCustomInjection(t):w(new Q(this))};U=function(t){const e=a(this,f).get(t.hashKey);e?e.add(t):a(this,f).set(t.hashKey,new Set([t]))};P=function(t){d(this,r,J).call(this,t),a(this,C).add(t)};b=function(t){a(this,C).delete(t),d(this,r,U).call(this,t)};J=function(t){a(this,C).delete(t);const e=a(this,f).get(t.hashKey);e&&(e.delete(t),e.size===0&&a(this,f).delete(t.hashKey))};var se=t=>{throw TypeError(t)},ae=(t,e,i)=>e.has(t)||se("Cannot "+i),l=(t,e,i)=>(ae(t,e,"read from private field"),i?i.call(t):e.get(t)),T=(t,e,i)=>e.has(t)?se("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),De=(t,e,i,n)=>(ae(t,e,"write to private field"),e.set(t,i),i),v,E,M;class $e{constructor(e){T(this,v,new Map),T(this,E,new Map),T(this,M),De(this,M,e)}get windowGroups(){const e=ve(l(this,v).values());return e||R.error("No window groups but background is running"),e}getExecutionRealmData(e){return l(this,M).getExecutionRealmData(e)}connect(e){const i=l(this,E).get(e.windowId);i&&i.resolve(e),l(this,E).delete(e.windowId),l(this,v).has(e.groupId)||l(this,v).set(e.groupId,new Se(e,this))}waitForConnection(e){const i=Promise.withResolvers();return l(this,E).set(e,i),$(()=>i.promise)}getWindowGroup(e){var i;return(i=l(this,v).get(e))!=null?i:null}removeWindowGroup(e){l(this,v).delete(e)}}v=new WeakMap;E=new WeakMap;M=new WeakMap;const Ne=t=>t.getExecutionScopeDefinition("global").register({token:we,useFactory:_e($e,[fe])},{lifetime:ue.Singleton});export{Ne as activate};
//# sourceMappingURL=index-B0VdoEeF.js.map
