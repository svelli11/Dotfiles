import{ac as ne,p as h,o as D,d as M,l as R,N as w,K as oe,u as $,q as I,bk as ce,aa as Q,e as de,a as K,ae as he,b5 as pe,b4 as le,ah as L,L as ue}from"./index-uVYElzgq.js";import{EmptyWindowGroupError as V,WindowManagerToken as we,ExecutionRealmProviderToken as fe}from"./index-BE_XzjUW.js";import{f as ve}from"./NonEmptyArrayFns-oGa02u3x-CLyX5YlY.js";import{d as _e}from"./defineFactory-DJYNRBNc-CmRNy_rl.js";import"./PluginModule-CRib3PLZ-LTQDm_KX.js";import"./PluginDependency-Boc6-pxl-tjuTwLTj.js";function We(){return"w-"+ne()}function X(t){return JSON.stringify(Object.fromEntries(Object.entries(t).sort((e,i)=>e[0].localeCompare(i[0]))))}var ge=Object.defineProperty,Y=t=>{throw TypeError(t)},me=(t,e,i)=>e in t?ge(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,B=(t,e,i)=>me(t,typeof e!="symbol"?e+"":e,i),O=(t,e,i)=>e.has(t)||Y("Cannot "+i),s=(t,e,i)=>(O(t,e,"read from private field"),i?i.call(t):e.get(t)),A=(t,e,i)=>e.has(t)?Y("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),G=(t,e,i,n)=>(O(t,e,"write to private field"),e.set(t,i),i),ye=(t,e,i)=>(O(t,e,"access private method"),i),c,u,p,_,N,Z;class ke{constructor(e,i,n){A(this,N),A(this,c,new AsyncDisposableStack),A(this,u),A(this,p),B(this,"id"),B(this,"hashKey"),A(this,_,!1),this.id=e.windowId,G(this,p,e.api),this.hashKey=X(i),G(this,u,n),s(this,c).defer(async()=>{s(this,_)||(await Promise.resolve(),await h(s(this,p).closeWindow(),D(M(o=>{s(this,_)||R.error("Failed to close window: "+s(this,_)+" "+this.id,o)}))))}),s(this,c).defer(async()=>s(this,u).close()),ye(this,N,Z).call(this)}get group(){return s(this,u).group}createWindow(e){return s(this,c).disposed?w(new ReferenceError("Window is disposed")):s(this,p).createWindow(e)}updateWindow(e){return s(this,c).disposed?w(new ReferenceError("Window is disposed")):s(this,p).updateWindow(e)}replaceApp(e){return s(this,c).disposed?w(new ReferenceError("Window is disposed")):(s(this,u).markActive(),s(this,p).replaceApp(e,{transfer:[e.executionRealmData.port]}))}disposeApp(){return s(this,c).disposed?oe():(s(this,u).markInactive(),s(this,p).disposeAppAndHide())}activatePlugin(e){return s(this,c).disposed?w(new ReferenceError("Window is disposed")):s(this,p).activatePlugin({plugin:e})}isCustomInjection(e){return s(this,c).disposed?w(new ReferenceError("Window is disposed")):s(this,p).isCustomInjection(e)}close(){return $(()=>s(this,c).disposeAsync())}[Symbol.asyncDispose](){return s(this,c).disposeAsync()}}c=new WeakMap;u=new WeakMap;p=new WeakMap;_=new WeakMap;N=new WeakSet;Z=function(){if(s(this,c).disposed){G(this,_,!0);return}const t=new AbortController;h(ce(this.id,t.signal),I(()=>{R.warn("Window ".concat(this.id," is closed."),{delivery:!1}),G(this,_,!0),s(this,u).close()})),s(this,c).defer(()=>t.abort())};var Ce=Object.defineProperty,j=t=>{throw TypeError(t)},Ae=(t,e,i)=>e in t?Ce(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,Ee=(t,e,i)=>Ae(t,e+"",i),z=(t,e,i)=>e.has(t)||j("Cannot "+i),r=(t,e,i)=>(z(t,e,"read from private field"),i?i.call(t):e.get(t)),m=(t,e,i)=>e.has(t)?j("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),Se=(t,e,i,n)=>(z(t,e,"write to private field"),e.set(t,i),i),d=(t,e,i)=>(z(t,e,"access private method"),i),y,W,k,C,f,a,x,ee,te,b,ie,H,P,U,J;class De{constructor(e,i){m(this,a),m(this,y,new AsyncDisposableStack),m(this,W,R.createLogger("WindowGroup")),Ee(this,"id"),m(this,k),m(this,C,new Set),m(this,f,new Map),this.id=e.groupId,Se(this,k,i);const n=d(this,a,b).call(this,e,{kind:"popup"});d(this,a,H).call(this,n),r(this,y).defer(async()=>{r(this,k).removeWindowGroup(this.id),await h(Q(h(r(this,a,x),de(o=>o.close()))),D(M(o=>r(this,W).error("Failure in WindowGroup dispose",o,{delivery:!0}))))})}createWindow(e){return r(this,W).verbose("Creating window",e),h(d(this,a,ee).call(this,e.injectionOptions),K(i=>h(r(this,k).getExecutionRealmData(i.id),K(n=>{var o;return i.replaceApp({windowName:e.name,appName:(o=e.displayName)!=null?o:e.name,plugins:e.plugins,scopes:e.scopes,fitContent:e.fitContent,clickThroughTransparent:e.clickThroughTransparent,executionScopeData:e.executionScopeData,executionRealmData:n,initializationData:e.initializationData})}),I(()=>{const n=new AsyncDisposableStack;return n.defer(async()=>{await h(i.disposeApp(),D(M(o=>r(this,W).error("Failure in dispose app",o,{delivery:!0}))))}),{id:i.id,group:i.group,activatePlugin:o=>n.disposed?w(new he("Window is closed")):i.activatePlugin(o),close:()=>$(()=>n.disposeAsync()),[Symbol.asyncDispose]:()=>n.disposeAsync()}}))))}close(){return $(()=>r(this,y).disposeAsync())}[Symbol.asyncDispose](){return r(this,y).disposeAsync()}}y=new WeakMap;W=new WeakMap;k=new WeakMap;C=new WeakMap;f=new WeakMap;a=new WeakSet;x=function(){return pe(r(this,C),h(r(this,f).values(),le(t=>t)))};ee=function(t){return h(d(this,a,ie).call(this,t),K(e=>{var i;const n=e?t:{kind:"popup"},o=X(n),g=L((i=r(this,f).get(o))!=null?i:[]);if(g)return r(this,W).verbose("Reusing existing window ".concat(g.id," for injection options ").concat(o,".")),d(this,a,P).call(this,g),h(g.updateWindow({injectionOptions:t}),I(()=>g),D(M(()=>d(this,a,U).call(this,g))));const F=We();return r(this,W).verbose("Creating new window ".concat(F," for injection options ").concat(o,".")),h(Q([d(this,a,te).call(this,F,t),r(this,k).waitForConnection(F)]),I(([Ie,ae])=>{const q=d(this,a,b).call(this,ae,n);return d(this,a,P).call(this,q),q}))}))};te=function(t,e){const i=L(r(this,a,x));return i?i.createWindow({id:t,injectionOptions:e}):w(new V(this))};b=function(t,e){const i=new ke(t,e,{group:this,markActive:()=>d(this,a,P).call(this,i),markInactive:()=>d(this,a,U).call(this,i),close:()=>d(this,a,J).call(this,i)});return r(this,y).use(i),i};ie=function(t){const e=L(r(this,a,x));return e?e.isCustomInjection(t):w(new V(this))};H=function(t){const e=r(this,f).get(t.hashKey);e?e.add(t):r(this,f).set(t.hashKey,new Set([t]))};P=function(t){d(this,a,J).call(this,t),r(this,C).add(t)};U=function(t){r(this,C).delete(t),d(this,a,H).call(this,t)};J=function(t){r(this,C).delete(t);const e=r(this,f).get(t.hashKey);e&&(e.delete(t),e.size===0&&r(this,f).delete(t.hashKey))};var se=t=>{throw TypeError(t)},re=(t,e,i)=>e.has(t)||se("Cannot "+i),l=(t,e,i)=>(re(t,e,"read from private field"),i?i.call(t):e.get(t)),T=(t,e,i)=>e.has(t)?se("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),Me=(t,e,i,n)=>(re(t,e,"write to private field"),e.set(t,i),i),v,E,S;class $e{constructor(e){T(this,v,new Map),T(this,E,new Map),T(this,S),Me(this,S,e)}get windowGroups(){const e=ve(l(this,v).values());return e||R.error("No window groups but background is running"),e}getExecutionRealmData(e){return l(this,S).getExecutionRealmData(e)}connect(e){const i=l(this,E).get(e.windowId);i&&i.resolve(e),l(this,E).delete(e.windowId),l(this,v).has(e.groupId)||l(this,v).set(e.groupId,new De(e,this))}waitForConnection(e){const i=Promise.withResolvers();return l(this,E).set(e,i),$(()=>i.promise)}getWindowGroup(e){var i;return(i=l(this,v).get(e))!=null?i:null}removeWindowGroup(e){l(this,v).delete(e)}}v=new WeakMap;E=new WeakMap;S=new WeakMap;const Ke=t=>t.getExecutionScopeDefinition("global").register({token:we,useFactory:_e($e,[fe])},{lifetime:ue.Singleton});export{Ke as activate};
//# sourceMappingURL=index-CN6fy9ZB.js.map
