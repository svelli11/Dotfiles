var ie=Object.defineProperty;var N=t=>{throw TypeError(t)};var re=(t,e,s)=>e in t?ie(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var j=(t,e,s)=>re(t,typeof e!="symbol"?e+"":e,s),M=(t,e,s)=>e.has(t)||N("Cannot "+s);var n=(t,e,s)=>(M(t,e,"read from private field"),s?s.call(t):e.get(t)),u=(t,e,s)=>e.has(t)?N("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),I=(t,e,s,r)=>(M(t,e,"write to private field"),r?r.call(t,s):e.set(t,s),s),C=(t,e,s)=>(M(t,e,"access private method"),s);var z=(t,e,s,r)=>({set _(i){I(t,e,i,s)},get _(){return n(t,e,r)}});import{S as oe,B as ce,k as ae,n as B,l as V,p as c,o as de,g as J,q as G,s as X,r as le,a as ue,u as H,v as he,C as Y,U as pe,h as _,R as U,j as x,i as Z,w as fe,E as W,m as y,x as ge,L as F,c as L}from"./start-BFd-djfI.js";import{t as be}from"./subscribableState-Y8YW7N9Z-L1DO2Tta.js";import{CAPIConnectionToken as ee}from"./index-B9uHfCTo.js";import{D as we}from"./Delta-D-dso3t3-DM06-Vr-.js";import{W as me}from"./CAPIWebSocketTransport-DztTrDg1-8WOYftOV.js";import{p as ke}from"./pairwise-CN9hSkDF.js";import"./PluginModule-CRib3PLZ-B43Hjk20.js";var A,v,o,E,D,b,w,m,R,S,T,h,se,te,$,q;class Ce{constructor(e,s){u(this,h);u(this,A,new oe);u(this,v,new Map);u(this,o,new ce({kind:"disconnected",sessionId:null}));u(this,E);u(this,D);u(this,b,new DisposableStack);u(this,w,[]);u(this,m,new Map);u(this,R,!1);u(this,S,0);u(this,T,new we);j(this,"status",C(this,h,se).call(this));j(this,"events",ae(n(this,A)));n(this,b).defer(()=>B(e)),I(this,E,e),I(this,D,s),n(this,b).defer(()=>{const r=n(this,o).getValue();r.kind==="connecting"&&r.controller.abort(),n(this,o).next({kind:"disconnected",sessionId:"sessionId"in r?r.sessionId:null})})}[Symbol.dispose](){n(this,b).dispose()}connect(){if(n(this,b).disposed)return V.warn("Cannot connect after the CAPIClient was disposed.",{delivery:!1});const e=n(this,o).getValue();if(e.kind==="connecting"||e.kind==="connected")return;const s="sessionId"in e?e.sessionId:null,r=new AbortController;c(n(this,E).create({...n(this,D),previous:e.transport}),J(i=>n(this,o).next({kind:"connecting",transport:i,controller:r})),G(async i=>{if(r.signal.aborted)return B(i);const d=await i.sessionId;n(this,o).next({kind:"connected",transport:i,sessionId:d,isNewSession:d!==s}),C(this,h,q).call(this);let a=!1;const l=new DisposableStack;n(this,b).use(l),l.use(i),l.use(i.didReceive.subscribe(p=>C(this,h,te).call(this,p))),l.use(i.didError.subscribe(p=>{a=!0,n(this,o).next(c(n(this,o).getValue(),f=>({kind:"error",error:p,transport:i,sessionId:"sessionId"in f?f.sessionId:null})))})),l.use(i.didClose.subscribe(()=>{const p=c(n(this,o).getValue(),g=>"sessionId"in g?g.sessionId:null),f=new Ie(p);n(this,m).forEach(g=>g.reject(f)),n(this,m).clear(),n(this,w).forEach(({onSend:g,onReceive:k})=>{g.reject(f),k==null||k.reject(f)}),n(this,w).length=0,l.dispose(),a||n(this,o).next({kind:"disconnected",transport:i,sessionId:p})}))}),de(J(i=>{r.signal.aborted||n(this,o).next(c(n(this,o).getValue(),d=>({kind:"error",error:i,sessionId:"sessionId"in d?d.sessionId:null})))})))}toString(){const e=n(this,o).getValue();switch(e.kind){case"connecting":return"Client(connecting)";case"connected":return"Client(connected: ".concat(e.transport,")");case"disconnected":return"Client(disconnected)";case"error":return"Client(error: ".concat(e.error.message,")")}}send(e,s){const r=Promise.withResolvers();return C(this,h,$).call(this,e,r,void 0,s)}submitText(e){I(this,R,!0);const s={action:"submit_ot",deltas:[e.change.toJSON()],doc_len:n(this,T).changeLength,rev:n(this,S)};return n(this,v).set(n(this,S),e.revision),z(this,S)._++,I(this,T,n(this,T).compose(e.change)),this.send(s)}sendAndAwaitResponse(e,s){const r=Promise.withResolvers(),i=Promise.withResolvers();return c(C(this,h,$).call(this,e,r,i,s),ue(()=>H(()=>i.promise)))}}A=new WeakMap,v=new WeakMap,o=new WeakMap,E=new WeakMap,D=new WeakMap,b=new WeakMap,w=new WeakMap,m=new WeakMap,R=new WeakMap,S=new WeakMap,T=new WeakMap,h=new WeakSet,se=function(){const e=s=>{switch(s.kind){case"connecting":return{kind:"connecting"};case"connected":return{kind:"connected",sessionId:s.sessionId,isNewSession:s.isNewSession};case"disconnected":return{kind:"disconnected",sessionId:s.sessionId};case"error":return{kind:"error",sessionId:s.sessionId};default:throw new pe(s)}};return{subscribe:s=>c(n(this,o),le(e),X(s)),getValue:()=>e(n(this,o).getValue())}},te=function(e){if(n(this,R)&&"rev"in e){const r=n(this,v).get(e.rev);r===void 0?V.warn("Received an event with unknown revision: ".concat(e.rev),{delivery:!1}):Reflect.set(e,"rev",r),e.action==="finished"&&(e.checksStatus==="all_checks_succeeded"||e.checksStatus==="all_checks_failed")&&(V.verbose("Removing mapping for revision:",e.rev),n(this,v).delete(e.rev))}const s=n(this,m).get(e.id);s&&(n(this,m).delete(e.id),s.resolve(e)),n(this,A).next(e)},$=function(e,s,r,i){return n(this,w).push({message:e,onSend:s,onReceive:r,signal:i}),C(this,h,q).call(this),c(H(()=>s.promise),G(he))},q=function(){const e=n(this,o).getValue();e.kind==="connected"&&(n(this,w).forEach(({message:s,onSend:r,onReceive:i,signal:d})=>{if(d!=null&&d.aborted){r.reject(new K),i==null||i.reject(new K);return}const a=e.transport.send(s);a===void 0&&i?V.warn("onReceive callbacks are not supported by this transport",{delivery:!1}):i&&n(this,m).set(a,i),Reflect.set(s,"id",a),r.resolve(s)}),n(this,w).length=0)};class K extends Y{constructor(){super("Message aborted")}}class Ie extends Y{constructor(e){super("CAPI Connection closed (SessionId: ".concat(e,")"))}}const O=L(Symbol("CAPIClient")),Q=L(Symbol("CAPIProvider")),ne=L(Symbol("CAPIWebSocketUrl")),$e=t=>c(x([Z(t.getExecutionScopeDefinition("document-session")),t.getPlugin("document-session")]),_(([e,s])=>U.all([...Ae(t,e),ve(e,s)])));function ve(t,e){return Z(t.onStart(s=>c(s.resolve(W),_(r=>{const i=[Se(s)];return r.capiSource==="websocket"&&i.push(Te(s,e)),U.all(i)}),fe)))}function Se(t){return c(t.resolve(O),y(e=>(e.connect(),c(be(e.status),ke(),ge(([s,r])=>s.kind==="connected"&&r.kind==="disconnected"),X(()=>e.connect())))))}function Te(t,e){return c(x([t.resolve(ee),t.resolve(e.provides.TextDocument)]),y(([s,r])=>r.sanitizedTextChange.subscribe(i=>s.submitText(i))))}function Pe(t,e,s,r,i){return{create:d=>{var a,l;return new me({getURL:()=>t,clientType:xe(e.settings.clientType),clientVersion:e.settings.clientVersion,sduiRenderers:new Map(Object.entries((a=e.settings.capiOptions.sduiRenderers)!=null?a:{})),capiFeatures:[...(l=e.settings.capiOptions.clientSupports)!=null?l:[],...r],sduiComponents:i,sanitizer:s})}}}function xe(t){switch(t){case"windows":return"extension_windows";case"extension-chrome":return"extension_chrome";default:return"unknown"}}function ye(t,e,s,r){return c(e.resolve(W),_(i=>i.capiSource==="connector"?e.resolve(s.provides.CAPIProvider):c(x([e.resolve(ne),e.resolve(r.provides.TextDocument),e.resolve(r.provides.Sanitizer),t.getPlugins()]),y(([d,a,l,p])=>{const f=p.flatMap(k=>{var P;return(P=k.metadata.capiFeatures)!=null?P:[]}),g=p.flatMap(k=>{var P;return(P=k.metadata.sduiComponents)!=null?P:[]});return Pe(d,a,l,f,g)}))))}function Ae(t,e){return[c(x([t.getPlugin("document-session"),t.getPlugin("connector")]),_(([s,r])=>U.all([e.register({token:O,useFactory:i=>c(x([i.resolve(Q),i.resolve(s.provides.TextDocument),i.resolve(s.provides.Sanitizer)]),y(([d,a,l])=>new Ce(d.create(a.id),{documentId:a.id,textDidChange:a.textChange,getTextContent:()=>a.text.getValue(),sanitizer:l})))},{lifetime:F.Singleton}),e.register({token:Q,useFactory:i=>ye(t,i,r,s)},{lifetime:F.Singleton})]))),e.register({token:ne,useFactory:s=>c(s.resolve(W),y(r=>{switch(r.servicesEnvironment){case"prod":return"wss://capi.grammarly.com/fpws";case"preprod":return"wss://capi.ppgr.io/fpws";case"qa":default:return"wss://capi.qagr.io/fpws"}}))},{lifetime:F.Singleton}),e.register({token:ee,useToken:O})]}export{$e as activate};
//# sourceMappingURL=index-DwCYgNrj.js.map
