(self.webpackChunk=self.webpackChunk||[]).push([[4227],{25222:(e,t,r)=>{r.r(t),r.d(t,{Overleaf:()=>J});var i=r(36344),s=r(44071),o=r(14969),n=r(29479),a=r(90023),l=r(84714),c=r(59179),h=r(84178),d=r(44045),f=r(90572),u=r(58303),g=r(72503),m=r(95357),p=r(45013);const v="cm-line",x=e=>{const t=(0,p.OB)().browserApi.makePageScriptTransferrableClone,r=t?t({anchor:e}):{anchor:e},i=new CustomEvent("GrammarlyAssistantOverleafScrollEvent",{detail:r});document.dispatchEvent(i)};var O=r(29052),_=r(32082);class C extends g.B{constructor({selectionService:e,...t}){super({...t,selectionOrCaretPosition:(0,m.Ti)(e,t.textField),entryPointsEnabled:l.of(!0),featureFlags:{inlineRewrites:!0},focusTextField:()=>t.textField.focus(),logger:_.Y.create("CheetahIntegrationOverleaf")})}scrollHighlightIntoView(e){this.getHighlightRects(e).pipe(c.U((e=>null==e?void 0:e[0])),h.q(1),d.R(this._disposed)).subscribe((t=>{t?(0,m.sK)(t,this._textFieldLayout):(this._logger.debug("Scrolling to range for un-rendered highlight in Overleaf editor",e),x(e.start))}))}}const T=e=>(t,r,i,s,o,n,l,c,h)=>{var d,g,m,p;return new C({textField:e.target,isActiveTextField:e.isCurrentFocusedField,selectionService:t,textFieldLayout:i,replacementServiceInjector:s,textObserver:e.textObserver,geometryProvider:o,geometryLayout:n,gButtonLayout:l,docContextUpdatedEvents:(0,a.zG)(u.ij((null===(d=e.customizations)||void 0===d?void 0:d.cheetahEnableQuickReplies)?(null===(g=e.customizations)||void 0===g?void 0:g.getDocEvents)||e.getDocEvents:void 0),u.UI((t=>t(e.target).pipe(f.h(O.t.isDocContextUpdatedEvent))))),allowCustomCaretOverflow:null!==(p=null===(m=e.customizations)||void 0===m?void 0:m.cheetahOverflowCustomCaret)&&void 0!==p&&p,csState:e.csState,csActions:e.csActions,fieldSettings:e.fieldSettings,closeAssistant:h})};var b=r(41169),F=r(35961);class y{constructor(e,t,r=_.Y.create("OverleafReplacementService")){this._replacementService=e,this._textObserver=t,this._log=r,this.canPerformReplacement=e=>!this._textObserver.getCurrentTextMap().getFragmentAtOrBeforeOffset(e.start)||this._replacementService.canPerformReplacement(e),this.performReplacement=async(e,t,r)=>(this._textObserver.getCurrentTextMap().getFragmentAtOrBeforeOffset(e.pos.start)||(this._log.debug("scrolling to text before performing replacement",e.pos.start),await new Promise((t=>{requestAnimationFrame((()=>{x(e.pos.start),t()}))}))),await new Promise((e=>{requestAnimationFrame(e)})),this._replacementService.performReplacement(e,t,r)),this.insertAtCurrentSelection=async(e,t)=>this._replacementService.insertAtCurrentSelection(e,t)}get capabilities(){return this._replacementService.capabilities}}const M=e=>new b.A7(e,{innerElementsField:e.parentNode,createGbuttonShiftBehavior:()=>(0,l.of)({left:-20,top:-15})}),S=e=>t=>{const r=F.BT.create(t,e.experimentClient,{focusElement:e.field});return new y(r,t)};var N=r(33148),w=r(38759),E=r(93995),R=r(14027),A=r(32073),k=r(13391),P=r(16582),z=r(82377);class B{constructor(e){this._textObserver=e,this._textMapChangedAtom=k.h.create([0]),this._textMapChangedSubscription=new A.w0,this.highlightsFilterFactory=()=>k.h.combine((0,P.u)(),this._textMapChangedAtom,(e=>{const t=this._textObserver.getCurrentTextMap();return{filter:r=>e.filter(r)&&((e,t)=>!(!e.getFragmentAtOffset(t.start)&&!e.getFragmentAtOrBeforeOffset(t.end)))(t,r),type:z.qH.ChangeType.invalidate}})),this.dispose=()=>{this._textMapChangedSubscription.unsubscribe()},this._textMapChangedSubscription.add(this._textObserver.textMapChanged.subscribe((()=>{this._textMapChangedAtom.modify((([e])=>[e+1]))})))}}var L=r(36807);const I=_.Y.create("codeMirrorTextMapUtils"),q=e=>{let t;try{t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT)}catch(e){I.error("Error initializing tree walker for CodeMirror editor text nodes",e)}if(!t)return[];const r=[];let i;for(;i=t.nextNode();)r.push(i);return r},G=e=>{const t=e.closest(".cm-editor");return null==t?void 0:t.dataset.grammarlyText},H=e=>{const t=(e=>[...e.parentNode.querySelectorAll(".cm-lineNumbers > .cm-gutterElement:not(:first-of-type)")].map((e=>Number(e.textContent))))(e),r=(e=>{const t=Array.from(e.getElementsByClassName(v));return 1===t.length?t:t.filter((e=>{var t,r;return(null===(t=e.nextSibling)||void 0===t?void 0:t.className.includes(v))||(null===(r=e.previousSibling)||void 0===r?void 0:r.className.includes(v))}))})(e);if(0===t.length||0===r.length)return new Map;const i=new Map;for(let e=0;e<t.length;e++){const s=t[e],o=r[e];if(o){if(!(null!==o.querySelector(".cm-foldPlaceholder"))){const e=q(o);0!==e.length?i.set(s,e):o.firstChild?i.set(s,[o.firstChild]):i.set(s,[])}}}return i};var W=r(37306);class U extends W.v{constructor(e){super(),this._root=e,this._plainText=G(this._root)||"",this._richText=(new L.i).insert(this._plainText),this._log=_.Y.create("CodeMirrorTextMap"),this.getPlainText=()=>this._plainText,this.getRichText=()=>this._richText,this._lineNumberToChildNodes=H(this._root),this._childNodeOffsetList=((e,t)=>{if(0===e.size)return[];const r=[],i=t.split("\n");let s=0,o=1;for(;o<=i.length;){const t=e.get(o);t?(t.forEach((e=>{const t=e.textContent||"",i=s,n=s+t.length;r.push({lineNumber:o,node:e,text:t,startOffset:i,endOffset:n,startOffsetInNode:0}),s+=t.length})),s+=1):s+=i[o-1].length+1,o++}return r})(this._lineNumberToChildNodes,this.getPlainText()),this._characterToChildNodeOffsetMap=(e=>{const t=new Map;return e.forEach((({text:e,node:r,lineNumber:i,startOffset:s,endOffset:o,startOffsetInNode:n})=>{for(let a=0;a<=e.length;a++)t.set(s+a,{text:e,node:r,lineNumber:i,startOffset:s,endOffset:o,startOffsetInNode:n})})),t})(this._childNodeOffsetList),this.getTextFieldRoot=()=>this._root,this.getFragmentAtOffset=e=>this._characterToChildNodeOffsetMap.get(e)||null,this.getFragmentAtOrBeforeOffset=e=>this._characterToChildNodeOffsetMap.get(e)||this._characterToChildNodeOffsetMap.get(e-1)||null,this.getFragmentsByNode=e=>{const t=[];return this._childNodeOffsetList.forEach((r=>{if(r.node===e){const e={text:r.text,startOffset:r.startOffset,endOffset:r.endOffset,node:r.node,startOffsetInNode:0,notSelectable:!1};e&&t.push(e)}})),t.length?t:null},this.isEmpty=()=>0===this._characterToChildNodeOffsetMap.size||1===this._characterToChildNodeOffsetMap.size&&0===this.getPlainText().trim().length,this._log.debug("Initializing new textmap for CodeMirror 6")}getFormatHelper(){return null}}U.create=e=>new U(e);var Y=r(43417),j=r(87913);class D{constructor(e){this._integrationLayout=e,this._log=_.Y.create("OverleafScroller"),this.scrollToMark=(e,t)=>this._scroller.scrollToMark(e,t),this.scrollToRange=e=>{this._log.debug("Scroll to range for un-rendered highlight in Overleaf editor",e),x(e.start)},this._scroller=(0,j.t)({scrollToMarkRect:(e,t)=>(0,Y.W)(this._integrationLayout,e,null==t?void 0:t.paddingTop),scrollToRange:e=>this.scrollToRange(e)})}}const $=()=>!!document.querySelector("#editor-switch-rich-text:checked"),V={ruleName:"isCodeMirrorField",match:(e,t)=>t.field.classList.contains("cm-content")},K={ruleName:"isCodeMirrorFieldWithGrammarlyText",match:(e,t)=>void 0!==G(t.field)},Q={ruleName:"isOverleafCodeEditor",match:()=>!$()},X={ruleName:"isOverleafVisualEditor",match:()=>$()};var J;!function(e){e.codeEditor=N.T.contentEditable("Overleaf.codeEditor",(e=>({validationRules:[...w.u,V,K,Q],expiration:()=>{const e=document.querySelector("#editor-switch-rich-text");return e?(0,s.R)(e,"change").pipe((0,o.P)((e=>!0===e.target.checked)),(0,n.h)(void 0)):i.E},createLayout:M,textMap:{createFieldTextMap:e=>U.create(e)},createHighlightsFilterFactory:e=>new B(e).highlightsFilterFactory,createAssistantScrollerFactory:(e,t,r)=>()=>new D(r),createReplacementService:S(e),createCheetahIntegrationGetter:T}))),e.visualEditor=N.T.contentEditable("Overleaf.visualEditor",(()=>({validationRules:[...w.u,V,X],expiration:()=>{const e=document.querySelector("#editor-switch-cm6");return e?(0,s.R)(e,"change").pipe((0,o.P)((e=>!0===e.target.checked)),(0,n.h)(void 0)):i.E},createLayout:M}))),e.page=(0,E.$W)({name:"overleaf",domain:R.jF,maxIntegrationRetryCount:1/0},[e.codeEditor,e.visualEditor])}(J||(J={}))},43417:(e,t,r)=>{r.d(t,{W:()=>i});const i=(e,t,r)=>{const i=e.textField.visibleRect.getApproximate();let s=(r||0)-i.client.top;(s<=0||s>=i.size.height)&&(s=i.size.height/2);const o=t.top-s-i.client.top;requestAnimationFrame((()=>e.textField.scroller.scrollBy({top:o})))}},87913:(e,t,r)=>{r.d(t,{t:()=>c});var i=r(39953),s=r(31789),o=r(8867),n=r(12518),a=r(82440),l=r(56075);function c({scrollToMarkRect:e,scrollToRange:t}){return{scrollToMark:(r,c)=>(0,i.zG)(l.Fd.getMarkRect(r),n.vx((()=>(t((0,a.mp)(r.range)),l.Fd.getMarkRect(r)))),n.g_((e=>s._(new Error(`Cannot get mark's rect: ${r.id}: ${e.message}`))),(t=>new o.y((r=>{r.next(void 0),e(t,c)})))))}}}}]);