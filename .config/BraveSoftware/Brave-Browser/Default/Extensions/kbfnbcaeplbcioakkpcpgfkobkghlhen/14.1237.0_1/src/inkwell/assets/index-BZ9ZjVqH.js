import{a3 as tt,J as it,a4 as st,B as P,S as me,p,k as C,r as O,H as I,z as R,y as de,l as He,i as be,o as Y,d as Z,q as j,s as V,x as $,a5 as rt,a6 as nt,T as at,a7 as ot,a8 as ct,a1 as De,a as ze,R as xe,a2 as lt,h as ht,j as ut,m as mt,L as pe,a9 as dt,c as Je}from"./index-uVYElzgq.js";import{T as pt,a as ft,b as gt,c as vt,d as wt,e as yt,A as _t}from"./TextDocumentEntities-iE9yXSvn.js";import{TextDocumentToken as kt,TextDocumentInfoToken as bt,DocumentSessionToken as Dt,SanitizerToken as xt,DocumentSessionManagerToken as Pe}from"./index-Z7s1VMXC.js";import{n as Oe,e as St,c as Ft,i as fe}from"./index-Q-LSqCYN.js";import{D as ge,i as ve,a as Mt}from"./Delta-D-dso3t3-DM06-Vr-.js";import{t as Tt}from"./timeoutWith-B7tsbJ8--DgEQKW6j.js";import{t as Se}from"./take-A312jYgg.js";import{i as Wt}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{d as Fe}from"./distinctUntilChanged-JrE1RNy_.js";import{c as Ct}from"./concat-DqL665aX.js";import{m as Ie}from"./merge-BJiAq4u-.js";import{d as Rt}from"./debounceTime-XokiU2Af.js";import{s as Ve}from"./share-BO0c2DMx.js";import{s as Et}from"./switchMap-BWSw-lA5.js";import{t as $t}from"./timeout-72B4Da-8.js";import{o as At}from"./of-DPWY87hm.js";import{t as Be}from"./tap-BL_zgIju.js";import{f as zt}from"./NonEmptyArrayFns-oGa02u3x-CLyX5YlY.js";import{b as Pt}from"./finalize-DNcSQJJw.js";import{c as z,a as Ot}from"./RemoteSubscribable-CanKOUL4-C6cenfHh.js";import{d as It}from"./defineFactory-DJYNRBNc-CmRNy_rl.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-LTQDm_KX.js";import"./mergeAll-CSDR5lBs.js";import"./race-DbiJq4jp.js";import"./timer-B6bjwuU9.js";import"./async-dh0JxqdS.js";function Vt(t){return e=>new tt(i=>{const o=[],u=new st;let l=!1;const a=()=>{for(;o.length>0;){const n=o.shift();i.next(n)}};return u.add(it(t).pipe(Se(1)).subscribe({next:()=>{l=!0,a()},complete:()=>{l||(i.complete(),u.unsubscribe())},error:n=>{l||i.error(n)}})),u.add(e.subscribe({next:n=>{l?i.next(n):o.push(n)},error:n=>{i.error(n),u.unsubscribe()},complete:()=>{i.complete(),u.unsubscribe()}})),{unsubscribe:()=>u.unsubscribe()}})}var Bt=Object.defineProperty,Ne=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),ae=t=>{throw TypeError(t)},Nt=(t,e,i)=>e in t?Bt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,b=(t,e,i)=>Nt(t,typeof e!="symbol"?e+"":e,i),Ce=(t,e,i)=>e.has(t)||ae("Cannot "+i),s=(t,e,i)=>(Ce(t,e,"read from private field"),i?i.call(t):e.get(t)),f=(t,e,i)=>e.has(t)?ae("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),v=(t,e,i,o)=>(Ce(t,e,"write to private field"),e.set(t,i),i),Ue=(t,e,i)=>(Ce(t,e,"access private method"),i),we=(t,e,i)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&ae("Object expected");var o;o=e[Ne("asyncDispose")],o===void 0&&(o=e[Ne("dispose")]),typeof o!="function"&&ae("Object not disposable"),t.push([i,o,e])}else t.push([i]);return e},ye=(t,e,i)=>{var o=typeof SuppressedError=="function"?SuppressedError:function(a,n,c,h){return h=Error(c),h.name="SuppressedError",h.error=a,h.suppressed=n,h},u=a=>e=i?new o(a,e,"An error was suppressed during disposal"):(i=!0,a),l=a=>{for(;a=t.pop();)try{var n=a[1]&&a[1].call(a[2]);if(a[0])return Promise.resolve(n).then(l,c=>(u(c),l()))}catch(c){u(c)}if(i)throw e};return l()},D,F,x,ee,G,te,w,y,S,W,ie,q,H,B,se,N,E,Me,Te,re,We;class Ut{constructor(e,i,o){f(this,re),f(this,D),f(this,F,new DisposableStack),f(this,x,new P({revision:Wt,content:new ge})),f(this,ee,new P([])),f(this,G,new at({probability:.01})),f(this,te,new P(Oe())),f(this,w,!1),f(this,y,!1),f(this,S,!1),f(this,W,new P({geometry:null,windowFrameMoving:!1,windowFrameResizing:!1,documentFrameScrolling:!1})),f(this,ie,new me),f(this,q,new P(!1)),f(this,H,new me),f(this,B),f(this,se),f(this,N,{getRects:0,getBoundingRects:0}),f(this,E),b(this,"id"),b(this,"sanitizedTextChange"),b(this,"textChange",p(Ct(p(s(this,x),Se(1),O(r=>({revision:r.revision,change:r.content}))),s(this,H)),Fe((r,d)=>d.revision===r.revision),C)),b(this,"text",I(s(this,x))),b(this,"selection",I(s(this,ee))),b(this,"geometry",I(s(this,W))),b(this,"geometryWillChange",C(s(this,ie))),b(this,"hasFocus",I(s(this,q))),b(this,"lastFocusAt",I(s(this,te))),b(this,"settings"),f(this,Me,Ie(p(R(this.textChange),O(r=>r.change.ops.some(d=>ve(d)&&/[\s,!?"']$/.test(d.insert)||Mt(d)&&!ve(d))),de(r=>r)),p(R(this.textChange),Rt(4e3)))),f(this,Te,r=>({revision:r.revision,change:new ge({ops:r.change.ops.map(d=>ve(d)?{...d,insert:s(this,se).sanitize(d.insert)}:d)})})),this.id=e.id,v(this,E,e),v(this,B,i),v(this,se,o),v(this,D,He.createLogger("TextDocument",e.id)),this.settings=e.settings;const u=Tt(p(e.getText(),j(r=>{s(this,x).next(r),s(this,H).next({revision:r.revision,change:r.content})}),Y(Z(r=>{s(this,D).error("Unexpected error when fetching initial text",r,{delivery:!0})}))),{timeoutMs:5e3,defaultValue:be(),onTimeout:()=>{s(this,D).warn("Did not receive initial text within 5s.",{delivery:!1})}});s(this,F).use(p(R(e.textDidChange),Vt(u),V(r=>{const d=s(this,x).getValue();if(r.revision<=d.revision)return;const A=d.content.compose(r.change);s(this,x).next({revision:r.revision,content:A}),s(this,H).next(r)}))),s(this,F).use(e.selectionDidChange.subscribe(r=>s(this,ee).next(Array.from(r))));const l=R(e.geometryWillChange).pipe(Ve()),a=R(e.geometryDidChange).pipe(Ve());s(this,F).use(p(l,V(r=>{v(this,S,r.has("DocumentFrameScrolled")?!0:s(this,S)),v(this,y,r.has("WindowFrameChanged")?!0:s(this,y)),v(this,w,r.has("WindowFrameChanged")?!0:s(this,w)),s(this,ie).next({reasons:r,documentFrameScrolling:s(this,S),windowFrameResizing:s(this,y),windowFrameMoving:s(this,w)})}))),s(this,F).use(p(a,V(r=>{v(this,S,r.has("DocumentFrameScrolled")?!1:s(this,S)),v(this,w,r.has("WindowFrameChanged")?!1:s(this,w)),v(this,y,r.has("WindowFrameChanged")?!1:s(this,y))}))),s(this,F).use(p($(e.hasFocus),Fe(),V(r=>{r?s(this,te).next(Oe()):(v(this,S,!1),v(this,w,!1),v(this,y,!1),s(this,W).next({...s(this,W).getValue(),windowFrameMoving:s(this,w),windowFrameResizing:s(this,y),documentFrameScrolling:s(this,S)})),s(this,q).next(r)})));const n=p(l,Et(()=>{const r=s(this,w)||s(this,y)?2e3:1e3;return p(a,Se(1),$t({first:r,with:()=>At(null)}),de(d=>d===null),Be(()=>{}))}));let c=fe;const h=new me;let g=0;s(this,F).use(p(Ie($(e.hasFocus),a,n,h),Be(()=>{c=Ft(c+1)}),St(async(r,d)=>{var A=[];try{const ue=we(A,i.duration("get_geometry",{labels:{request_kind:d===0?"initial":"other"},sampler:s(this,G)}),!0);return await p(e.getGeometry(),Y(Z(et=>ue.close(et))))}catch(ue){var Ze=ue,je=!0}finally{var Ae=ye(A,Ze,je);Ae&&await Ae}}),V(rt({success:r=>{g=0,s(this,W).next({geometry:{...r,revision:c},windowFrameMoving:s(this,w),windowFrameResizing:s(this,y),documentFrameScrolling:s(this,S)})},failure:r=>{s(this,D).error("Unexpected error when fetching document geometry",r,{delivery:!0}),s(this,q).getValue()&&g<3?(g++,h.next()):s(this,B).count("get_geometry_aborted")}})))),this.sanitizedTextChange=p(R(this.textChange),Pt(s(this,Me)),O(zt),de(nt),O(r=>({change:r.reduce((d,A)=>d.compose(A.change),new ge),revision:r.at(-1).revision})),O(s(this,Te)),C)}setText(e){return s(this,E).setText(e)}setSelection(e){return s(this,E).setSelection(s(this,x).getValue().revision,e)}async getRects(e){var i,o=[];try{const n=s(this,W).getValue().geometry;n||s(this,D).warn("Calling TextDocument.getRects() with no geometry revision yet",{delivery:!1});const c=s(this,x).getValue().revision,h=(i=n==null?void 0:n.revision)!=null?i:fe,g=we(o,s(this,B).duration("get_rects",{labels:{request_kind:s(this,N).getRects===0?"initial":"other",bucket_size:Ue(this,re,We).call(this,e.size)},sampler:s(this,G)}),!0);return s(this,N).getRects++,await p(s(this,E).getRectsForRanges(c,e),j(({rects:r,textRevision:d})=>({rects:r,revision:{text:d,geometry:h}})),Y(Z(r=>{g.close(r),s(this,D).error("Unexpected error when calling RemoteDocument.getRectsForRanges()",r,{delivery:!0})})))}catch(n){var u=n,l=!0}finally{var a=ye(o,u,l);a&&await a}}async getBoundingRects(e){var i,o=[];try{const n=s(this,W).getValue().geometry;n||s(this,D).warn("Calling TextDocument.getBoundingRects() with no geometry revision yet",{delivery:!1});const c=(i=n==null?void 0:n.revision)!=null?i:fe,h=we(o,s(this,B).duration("get_bounding_rects",{labels:{request_kind:s(this,N).getBoundingRects===0?"initial":"other",bucket_size:Ue(this,re,We).call(this,e.size)},sampler:s(this,G)}),!0);return s(this,N).getBoundingRects++,await p(s(this,E).getBoundingRectForRanges(s(this,x).getValue().revision,e),j(({rects:g,textRevision:r})=>({rects:g,revision:{text:r,geometry:c}})),Y(Z(g=>{h.close(g),s(this,D).error("Unexpected error when calling RemoteDocument.getBoundingRectForRanges()",g,{delivery:!0})})))}catch(n){var u=n,l=!0}finally{var a=ye(o,u,l);a&&await a}}[Symbol.dispose](){s(this,F).dispose()}}D=new WeakMap;F=new WeakMap;x=new WeakMap;ee=new WeakMap;G=new WeakMap;te=new WeakMap;w=new WeakMap;y=new WeakMap;S=new WeakMap;W=new WeakMap;ie=new WeakMap;q=new WeakMap;H=new WeakMap;B=new WeakMap;se=new WeakMap;N=new WeakMap;E=new WeakMap;Me=new WeakMap;Te=new WeakMap;re=new WeakSet;We=function(t){return Math.ceil(t/10).toString()};var Lt=Object.defineProperty,Xe=t=>{throw TypeError(t)},Gt=(t,e,i)=>e in t?Lt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,L=(t,e,i)=>Gt(t,typeof e!="symbol"?e+"":e,i),qt=(t,e,i)=>e.has(t)||Xe("Cannot "+i),_e=(t,e,i)=>(qt(t,e,"read from private field"),i?i.call(t):e.get(t)),Ht=(t,e,i)=>e.has(t)?Xe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),J;class Jt{constructor(e,i,o){Ht(this,J,new AsyncDisposableStack),L(this,"startedAt",performance.now()),L(this,"remoteDocument"),L(this,"document"),L(this,"documentId"),L(this,"sanitizer"),this.remoteDocument=e,this.documentId=e.id,this.document=_e(this,J).use(new Ut(e,i,o)),this.sanitizer=o}use(e){return _e(this,J).use(e)}async[Symbol.asyncDispose](){await _e(this,J).disposeAsync()}}J=new WeakMap;var Xt=Object.defineProperty,Le=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),oe=t=>{throw TypeError(t)},Kt=(t,e,i)=>e in t?Xt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,Qt=(t,e,i)=>Kt(t,e+"",i),Re=(t,e,i)=>e.has(t)||oe("Cannot "+i),m=(t,e,i)=>(Re(t,e,"read from private field"),i?i.call(t):e.get(t)),T=(t,e,i)=>e.has(t)?oe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),ke=(t,e,i,o)=>(Re(t,e,"write to private field"),e.set(t,i),i),M=(t,e,i)=>(Re(t,e,"access private method"),i),Ge=(t,e,i)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&oe("Object expected");var o;i&&(o=e[Le("asyncDispose")]),o===void 0&&(o=e[Le("dispose")]),typeof o!="function"&&oe("Object not disposable"),t.push([i,o,e])}else i&&t.push([i]);return e},Yt=(t,e,i)=>{var o=typeof SuppressedError=="function"?SuppressedError:function(a,n,c,h){return h=Error(c),h.name="SuppressedError",h.error=a,h.suppressed=n,h},u=a=>e=i?new o(a,e,"An error was suppressed during disposal"):(i=!0,a),l=a=>{for(;a=t.pop();)try{var n=a[1]&&a[1].call(a[2]);if(a[0])return Promise.resolve(n).then(l,c=>(u(c),l()))}catch(c){u(c)}if(i)throw e};return l()},U,_,ce,K,le,X,Q,k,Ee,he,Ke,$e,Qe;const Zt=100;class ne{constructor(e,i,o,u){T(this,k),T(this,U,new AsyncDisposableStack),T(this,_,[]),T(this,ce),T(this,K),T(this,le),T(this,X,new P(null)),T(this,Q,He.createLogger("DocumentSessionManager")),Qt(this,"activeDocumentId",I(m(this,X))),ke(this,ce,e),ke(this,K,o),ke(this,le,u),m(this,U).use(i.documentDidCreate.subscribe(l=>{m(this,U).use(p($(l.hasFocus),Fe(),V(a=>{a?(m(this,X).next(l.id),M(this,k,Ke).call(this,l)||M(this,k,Qe).call(this,l)):m(this,X).next(null)})))})),m(this,U).use(i.documentWillDestroy.subscribe(l=>{const a=M(this,k,$e).call(this,l);a&&M(this,k,he).call(this,a,"document will destroy")}))}async[Symbol.asyncDispose](){return m(this,U).disposeAsync()}}U=new WeakMap;_=new WeakMap;ce=new WeakMap;K=new WeakMap;le=new WeakMap;X=new WeakMap;Q=new WeakMap;k=new WeakSet;Ee=function(t){const e=m(this,_).indexOf(t);if(e===-1?m(this,_).push(t):(m(this,_).splice(e,1),m(this,_).push(t)),m(this,_).length>Zt){const i=m(this,_).shift();i!==void 0&&M(this,k,he).call(this,i,"session list is overflown")}};he=function(t,e){const i=m(this,_).indexOf(t);i!==-1&&(m(this,_).splice(i,1),m(this,Q).verbose({context:t.remoteDocument.id},"Disposing session for document because ".concat(e,"."))),ot(t)};Ke=function(t){const e=M(this,k,$e).call(this,t);return e&&M(this,k,Ee).call(this,e),e};$e=function(t){var e;return(e=m(this,_).find(i=>i.remoteDocument.id===t.id))!=null?e:null};Qe=async function(t){var e=[];try{const l=Ge(e,m(this,K).duration("create_session")),a=Ge(e,new AsyncDisposableStack,!0),n=new Jt(t,m(this,K),m(this,le).create(t.id));n.use(t),m(this,Q).verbose({context:n.remoteDocument.id},"Create a session for document."),M(this,k,Ee).call(this,n),a.defer(()=>M(this,k,he).call(this,n,"session is disposed")),await p(m(this,ce).createExecutionScopeController("document-session",{id:ct?t.id:void 0,data:{documentId:t.id}}),De.use(a),ze(c=>p(xe.all([c.register({token:kt,useValue:n.document}),c.register({token:bt,useValue:n.document}),c.register({token:Dt,useValue:n}),c.register({token:xt,useValue:n.sanitizer}),c.realm.registerEntity({token:pt,useFactory:h=>z(C($(n.document.hasFocus)),h)}),c.realm.registerEntity({token:ft,useFactory:h=>z(C($(n.document.lastFocusAt)),h)}),c.realm.registerEntity({token:gt,useFactory:h=>z(C($(n.document.geometry)),h)}),c.realm.registerEntity({token:vt,useFactory:h=>z(p(R(n.document.textChange),O(g=>({revision:g.revision,change:g.change.toJSON()})),C),h)}),c.realm.registerEntity({token:wt,useFactory:h=>z(C($(n.document.selection)),h)}),c.realm.registerEntity({token:yt,useFactory:h=>z(n.document.geometryWillChange,h)})]),De.use(a),j(()=>c))),ze(c=>c.start()),lt({success:()=>{n.use(a.move())},failure:c=>{l.close(c),m(this,Q).error("Failed to create a session due to:",c,{context:n.remoteDocument.id,delivery:!0})}}))}catch(l){var i=l,o=!0}finally{var u=Yt(e,i,o);u&&await u}};const Ye=Je(),Mi=t=>xe.all([p(ut([t.getPlugin("connector"),t.getPlugin("monitoring"),be(t.getExecutionScopeDefinition("document-group")),t.getPlugin("document-group")]),ht(([e,i,o])=>xe.all([...jt(o,e,i),be(o.onStart(async u=>De.all([u.resolve(ne),u.realm.registerEntity({token:_t,useToken:Ye})])))])))]);function jt(t,e,i){return[t.register({token:Ye,useFactory:o=>p(o.resolve(Pe),mt(u=>l=>Ot(u.activeDocumentId,l)))},{lifetime:pe.Singleton}),t.register({token:Pe,useToken:ne}),t.register({token:ne,useFactory:It(ne,[t.instanceToken,e.provides.ConnectorDocumentManager,i.provides.Monitoring,qe])},{lifetime:pe.Singleton}),t.register({token:qe,useClass:dt},{lifetime:pe.Singleton})]}const qe=Je(Symbol("SanitizerProvider"));export{qe as SanitizerProviderToken,Mi as activate};
//# sourceMappingURL=index-BZ9ZjVqH.js.map
