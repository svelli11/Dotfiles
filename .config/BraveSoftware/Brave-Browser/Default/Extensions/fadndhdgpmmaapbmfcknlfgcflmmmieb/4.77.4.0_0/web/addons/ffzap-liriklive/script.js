(()=>{var g=Object.defineProperty;var p=(_,a)=>g(_,"name",{value:a,configurable:!0});(()=>{"use strict";var _={};const a={AUTHORIZE:1,PONG:2,CHANNEL_SUBSCRIBE:4,CHANNEL_UNSUBSCRIBE:8,ANNOUNCE_MESSAGE:16},h={READY:1,AUTHORIZED:2,PING:4,CHANNEL_SUBSCRIPTION_ADDED:16,CHANNEL_SUBSCRIPTION_REMOVED:32,USER_CHANNEL_DATA:64},u={EXTENSION_DEV:1,EXTENSION_ADMIN:2,LIRIK_SUB:4},l=class l{constructor(t){this.parent=t,this.socket=!1,this._connected=!1,this._connecting=!1,this._ready=!1,this._connect_attempts=1,this._joined_channels={},this._connection_buffer=[],this._announce_buffer={}}connect(){this.parent.site.getUser()&&(this._connected||this._connecting||(this._connecting=!0,this.parent.log.info("Socket: Connecting to socket server..."),this.socket=new WebSocket("wss://lirik.hnlbot.com/ws"),this.socket.binaryType="arraybuffer",this._joined_channels={},this._announce_buffer={},this.socket.onopen=()=>{if(this.parent.log.info("Socket: Connected to socket server."),this._connected=!0,this._connect_attempts=1,this.reconnecting){for(const t of this.parent.chat.iterateRooms())t&&this.parent.roomAdd(t);this.reconnecting=!1}},this.socket.onerror=()=>{this.parent.log.error("Socket: Error from socket server."),this._connecting&&(this.reconnecting=!1),this._connect_attempts++,this.reconnect()},this.socket.onclose=()=>{!this._connected||!this.socket||(this.parent.log.error("Socket: Lost connection to socket server..."),this._connect_attempts++,this.reconnect())},this.socket.onmessage=t=>{let i=JSON.parse(t.data);i=i instanceof Array?i:[i];for(const s of i)switch(s.t){case h.READY:{if(this._ready=!0,this._connection_buffer.length>0){let n=this._connection_buffer.length;for(;n--;){const r=this._connection_buffer[n];this.joinRoom(r)}this._connection_buffer=[]}break}case h.PING:{this.emit(a.PONG);break}case h.CHANNEL_SUBSCRIPTION_ADDED:{if(!s.c_id||(this._announce_buffer[s.c_id]&&(this.announceMessage(s.c_id),delete this._announce_buffer[s.c_id]),!s.c_d))continue;const{u_id:n,f:r,s_m:o}=s.c_d;if(r&u.LIRIK_SUB){const e=this.parent.chat.getUser(n);e.addSet("addon--ffzap.liriklive","addon--ffzap.liriklive--emotes-subscriber"),o>=12&&e.addSet("addon--ffzap.liriklive","addon--ffzap.liriklive--emotes-restricted")}break}case h.USER_CHANNEL_DATA:{const{u_id:n,f:r,s_m:o}=s.d;if(r&u.LIRIK_SUB){const e=this.parent.chat.getUser(n);e.addSet("addon--ffzap.liriklive","addon--ffzap.liriklive--emotes-subscriber"),o>=12&&e.addSet("addon--ffzap.liriklive","addon--ffzap.liriklive--emotes-restricted")}}}}))}reconnect(){this.disconnect(),!this.reconnecting&&(this.reconnecting=!1,this.parent.log.info("Socket: Trying to reconnect to socket server..."),setTimeout(()=>{this.reconnecting=!0,this.connect()},Math.random()*(Math.pow(2,this._connect_attempts)-1)*1e4))}disconnect(){if(this.socket)try{this.socket.close()}catch{}delete this.socket,this._connected=!1,this._connecting=!1}disconnectInternal(){this.disconnect(),this.parent.log.info("Socket: Disconnected from socket server.")}emit(t,i){!this._connected||!this.socket||this.socket.send(JSON.stringify({t,d:i}))}joinRoom(t){if(!this.parent.chat.context.get("ffzap.liriklive.sub_emoticons")||!t)return;if(!this._connected||!this._ready){this._connection_buffer.includes(t)||this._connection_buffer.push(t);return}const i=this.parent.site.getUser();!i||!i.id||(this._joined_channels[t]&&this.leaveRoom(t),this.emit(a.CHANNEL_SUBSCRIBE,{u_id:i.id,c_id:t}),this._joined_channels[t]=!0,this._announce_buffer[t]=!0)}announceMessage(t){const i=this.parent.site.getUser();!i||!i.id||this.emit(a.ANNOUNCE_MESSAGE,{c_id:t,u_id:i.id})}leaveRoom(t){this._connected&&(this._joined_channels[t]&&this.emit(a.CHANNEL_UNSUBSCRIBE,{c_id:t}),delete this._joined_channels[t])}};p(l,"Socket");let f=l;const m=class m extends FrankerFaceZ.utilities.addon.Addon{constructor(...t){super(...t),this.inject("settings"),this.inject("chat"),this.inject("chat.emotes"),this.inject("site"),this.settings.add("ffzap.liriklive.global_emoticons",{default:!0,ui:{path:"Add-Ons > Lirik LIVE >> Emotes",title:"Global Emotes",description:"Enable to show LIRIK LIVE global emotes.",component:"setting-check-box"}}),this.settings.add("ffzap.liriklive.sub_emoticons",{default:!0,ui:{path:"Add-Ons > Lirik LIVE >> Emotes",title:"Subscriber Emotes",description:"Enable to show additional LIRIK LIVE subscriber emotes.",component:"setting-check-box"}}),this.chat.context.on("changed:ffzap.liriklive.global_emoticons",this.updateEmotes,this),this.chat.context.on("changed:ffzap.liriklive.sub_emoticons",this.updateEmotes,this),this.socket=!1,this._last_emote_id=0}onEnable(){this.log.debug("FFZ:AP's Lirik LIVE module was enabled successfully."),this.updateEmotes(),this.socket=new f(this),this.chat.context.get("ffzap.liriklive.sub_emoticons")&&this.socket.connect(),this.on("chat:room-add",this.roomAdd),this.on("chat:room-remove",this.roomRemove),this.on("chat:pre-send-message",this.preSendMessage);for(const t of this.chat.iterateRooms())t&&this.roomAdd(t)}roomAdd(t){this.socket.joinRoom(t.id)}roomRemove(t){this.socket.leaveRoom(t.id)}preSendMessage(t){if(!this.chat.context.get("ffzap.liriklive.sub_emoticons"))return;const i=this.chat.getRoom(null,t.channel,!0);!i||!i.id||this.socket.announceMessage(i.id)}updateGlobalEmotes(t){const i="addon--ffzap.liriklive--emotes-global";if(this.emotes.removeDefaultSet("addon--ffzap.liriklive",i),this.emotes.unloadSet(i),!this.chat.context.get("ffzap.liriklive.global_emoticons"))return;const s=[],{global:n,gifs:r}=t;if(n)for(const e of n){const c={id:++this._last_emote_id,name:e.code,width:e.width||28,height:e.height||28};e.id?c.urls={1:`https://static-cdn.jtvnw.net/emoticons/v1/${e.id}/1.0`,2:`https://static-cdn.jtvnw.net/emoticons/v1/${e.id}/2.0`,4:`https://static-cdn.jtvnw.net/emoticons/v1/${e.id}/3.0`}:c.urls={1:`https://cdn.ffzap.com/liriklive/normal/${c.name}_1.png`,2:`https://cdn.ffzap.com/liriklive/normal/${c.name}_2.png`,4:`https://cdn.ffzap.com/liriklive/normal/${c.name}_4.png`},s.push(c)}if(r)for(const e of r){const c={id:++this._last_emote_id,animated:{1:`https://cdn.ffzap.com/liriklive/gifs/${e}_1.gif`,2:`https://cdn.ffzap.com/liriklive/gifs/${e}_2.gif`,4:`https://cdn.ffzap.com/liriklive/gifs/${e}_4.gif`},name:e,width:28,height:28,modifier:e==="lirikRAIN"};c.urls={1:`https://cache.ffzap.com/${c.animated[1]}`,2:`https://cache.ffzap.com/${c.animated[2]}`,4:`https://cache.ffzap.com/${c.animated[4]}`},s.push(c)}if(s.length===0)return;const o={emoticons:s,title:"Past Emotes",source:"LIRIK LIVE",icon:"https://cdn.ffzap.com/liriklive/icon.png",sort:51,force_global:(e,c)=>c&&c.login==="lirik"};this.emotes.addDefaultSet("addon--ffzap.liriklive",i,o)}updateSubscriberEmotes(t){const i="addon--ffzap.liriklive--emotes-subscriber";if(this.emotes.unloadSet(i),!this.chat.context.get("ffzap.liriklive.sub_emoticons"))return;const s=[],{subscriber:n}=t;if(n)for(const o of n){const e={id:++this._last_emote_id,name:o.code,width:o.width||28,height:o.height||28};o.id?e.urls={1:`https://static-cdn.jtvnw.net/emoticons/v1/${o.id}/1.0`,2:`https://static-cdn.jtvnw.net/emoticons/v1/${o.id}/2.0`,4:`https://static-cdn.jtvnw.net/emoticons/v1/${o.id}/3.0`}:e.urls={1:`https://cdn.ffzap.com/liriklive/normal/${e.name}_1.png`,2:`https://cdn.ffzap.com/liriklive/normal/${e.name}_2.png`,4:`https://cdn.ffzap.com/liriklive/normal/${e.name}_4.png`},s.push(e)}if(s.length===0)return;const r={emoticons:s,title:"Subscriber Emotes",source:"LIRIK LIVE",icon:"https://cdn.ffzap.com/liriklive/icon.png",merge_id:"addon--ffzap.liriklive--emotes-global"};this.emotes.loadSetData(i,r)}updateRestrictedEmotes(t){const i="addon--ffzap.liriklive--emotes-restricted";if(this.emotes.unloadSet(i),!this.chat.context.get("ffzap.liriklive.sub_emoticons"))return;const s=[],{restricted:n}=t;if(n)for(const o of n){const e={id:++this._last_emote_id,name:o.code,width:o.width||28,height:o.height||28};o.id?e.urls={1:`https://static-cdn.jtvnw.net/emoticons/v1/${o.id}/1.0`,2:`https://static-cdn.jtvnw.net/emoticons/v1/${o.id}/2.0`,4:`https://static-cdn.jtvnw.net/emoticons/v1/${o.id}/3.0`}:e.urls={1:`https://cdn.ffzap.com/liriklive/normal/${e.name}_1.png`,2:`https://cdn.ffzap.com/liriklive/normal/${e.name}_2.png`,4:`https://cdn.ffzap.com/liriklive/normal/${e.name}_4.png`},s.push(e)}if(s.length===0)return;const r={emoticons:s,title:"Restricted Emotes",source:"LIRIK LIVE",icon:"https://cdn.ffzap.com/liriklive/icon.png",merge_id:"addon--ffzap.liriklive--emotes-global"};this.emotes.loadSetData(i,r)}async updateEmotes(t=0){if(this._last_emote_id=0,!this.chat.context.get("ffzap.liriklive.global_emoticons")&&!this.chat.context.get("ffzap.liriklive.sub_emoticons"))return;const i=await fetch("https://cdn.ffzap.com/liriklive/emotes.json");if(i.ok){const s=await i.json();this.updateGlobalEmotes(s),this.updateSubscriberEmotes(s),this.updateRestrictedEmotes(s)}else{if(i.status===404)return;const s=(t||0)+1;s<12&&(this.log.error("Failed to fetch emotes. Trying again in 5 seconds."),setTimeout(this.updateEmotes.bind(this,s),5e3))}}};p(m,"LirikLIVE");let d=m;d.register("ffzap-liriklive",null,"3.2.2")})();})();

//# sourceMappingURL=script.js.map