(()=>{var C=Object.defineProperty;var c=(g,h)=>C(g,"name",{value:h,configurable:!0});(()=>{"use strict";var g={},h=Object.defineProperty,f=c((n,t,o)=>t in n?h(n,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[t]=o,"__defNormalProp"),u=c((n,t,o)=>(f(n,typeof t!="symbol"?t+"":t,o),o),"__publicField");const l=class l extends FrankerFaceZ.utilities.addon.Addon{constructor(...t){super(...t),u(this,"cache",new Map),u(this,"cacheEvictionTimer",null),this.inject("chat"),this.settings.add("addon.repetition_detector.similarity_threshold",{default:80,ui:{path:"Add-Ons > Chat Repetition Detector >> General Settings",title:"Similarity threshold in %",description:"Minimum similarity between 2 messages to count them as repetitions",component:"setting-text-box",process:"to_int",bounds:[0,100]}}),this.settings.add("addon.repetition_detector.repetitions_threshold",{default:2,ui:{path:"Add-Ons > Chat Repetition Detector >> General Settings",title:"Repetition threshold",description:"Amount of repetitions before the message is marked",component:"setting-text-box",process:"to_int",bounds:[0]}}),this.settings.add("addon.repetition_detector.ignore_mods",{default:!0,ui:{path:"Add-Ons > Chat Repetition Detector >> General Settings",title:"Ignore mods",description:"Do not check messages by mods or the broadcaster",component:"setting-check-box"}}),this.settings.add("addon.repetition_detector.enable_only_as_mod",{default:!0,ui:{path:"Add-Ons > Chat Repetition Detector >> General Settings",title:"Only as Moderator",description:"Enable only in channels you are a moderator in",component:"setting-check-box"}}),this.settings.add("addon.repetition_detector.cache_ttl",{default:600,ui:{path:"Add-Ons > Chat Repetition Detector >> Cache Settings",title:"Cache TTL",description:"Amount of seconds for messages to stay in the cache. A long TTL leads to high RAM usage, especially in bigger channels",component:"setting-text-box",process:"to_int",bounds:[1]},changed:()=>this.startCacheEvictionTimer(Math.min(Math.floor(this.settings.get("addon.repetition_detector.cache_ttl")/10),10))}),this.settings.add("addon.repetition_detector.text_color",{default:"#FF0000",ui:{path:"Add-Ons > Chat Repetition Detector >> Style",title:"Text Color",description:"Text color used to display repetitions in chat",component:"setting-color-box"}}),this.settings.addUI("addon.repetition_detector.pad-bottom",{path:"Add-Ons > Chat Repetition Detector",sort:1e3,component:"setting-spacer",top:"30rem",force_seen:!0});const o=this.chat.context,s=c((e,i)=>{const a=this.settings.get("addon.repetition_detector.cache_ttl")*1e3,x=this.settings.get("addon.repetition_detector.similarity_threshold");if(this.cache.has(e)){this.cache.get(e).expire=Date.now()+a;let m=1;const _=this.cache.get(e).messages;for(let p=0;p<_.length;p++)b(i,_[p].msg)>x/100&&m++;return this.cache.get(e).messages.push({msg:i,expire:Date.now()+a}),m}else return this.cache.set(e,{messages:[{msg:i,expire:Date.now()+a}],expire:Date.now()+a}),0},"checkRepetitionAndCache"),r={type:"repetition_counter",priority:-1e3,render(e,i){if(!e.repetitionCount)return null;const a=this.settings.get("addon.repetition_detector.text_color");return i("span",{style:{color:a,"margin-left":"1.5rem"}},`x${e.repetitionCount}`)},process(e,i){return!i.message||i.message===""||!o.get("context.moderator")&&this.settings.get("addon.repetition_detector.enable_only_as_mod")||this.settings.get("addon.repetition_detector.ignore_mods")&&(i.badges.moderator||i.badges.broadcaster)||(!i.repetitionCount&&i.repetitionCount!==0&&(i.repetitionCount=s(i.user.id,i.message)),i.repetitionCount>=this.settings.get("addon.repetition_detector.repetitions_threshold")&&e.push({type:"repetition_counter",repetitionCount:i.repetitionCount})),e}};this.chat.addTokenizer(r)}onEnable(){this.log.info("Enabled!"),this.startCacheEvictionTimer(Math.min(Math.floor(this.settings.get("addon.repetition_detector.cache_ttl")/10),10))}startCacheEvictionTimer(t){this.cacheEvictionTimer&&clearInterval(this.cacheEvictionTimer),this.cacheEvictionTimer=setInterval(()=>{this.log.debug("Running cache eviction cycle");for(const[o,s]of this.cache)s.expire<Date.now()?this.cache.delete(o):(s.messages=s.messages.filter(r=>r.expire>Date.now()),s.messages.length===0&&this.cache.delete(o))},t*1e3)}onDisable(){this.cacheEvictionTimer&&clearInterval(this.cacheEvictionTimer),this.cache.clear()}};c(l,"RepetitionDetector");let d=l;d.register("repetition-detector",null,"1.1.0");function b(n,t){if(n=n.replace(/\s+/g,""),t=t.replace(/\s+/g,""),!n.length&&!t.length)return 1;if(!n.length||!t.length)return 0;if(n===t)return 1;if(n.length===1&&t.length===1)return n===t?1:0;if(n.length<2||t.length<2)return 0;const o=new Map;for(let r=0;r<n.length-1;r++){const e=n.substring(r,r+2),i=o.has(e)?o.get(e)+1:1;o.set(e,i)}let s=0;for(let r=0;r<t.length-1;r++){const e=t.substring(r,r+2),i=o.has(e)?o.get(e):0;i>0&&(o.set(e,i-1),s++)}return 2*s/(n.length+t.length-2)}c(b,"compareTwoStrings")})();})();

//# sourceMappingURL=script.js.map