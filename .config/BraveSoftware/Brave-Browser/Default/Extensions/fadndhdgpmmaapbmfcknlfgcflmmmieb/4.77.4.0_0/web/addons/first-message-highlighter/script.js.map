{"version":3,"file":"first-message-highlighter/script.js","mappings":"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","sources":["webpack://ffz-addons/./src/first-message-highlighter/index.js"],"sourcesContent":["class FirstMessageHighlight extends Addon {\n\n\tknown_users = new Map();\n\n\tconstructor(...args) {\n\t\tsuper(...args);\n\n\t\tthis.inject('chat');\n\t\tthis.inject('site');\n\n\t\tthis.settings.add('first_message_highlight.enabled', {\n\t\t\tdefault: true,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> Current Session >> Settings @{\"sort\": -1}',\n\t\t\t\ttitle: 'Highlight first messages',\n\t\t\t\tdescription: 'Highlight first messages from users for this session.',\n\t\t\t\tcomponent: 'setting-check-box',\n\t\t\t\tsort: -1\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.only_moderated_channels', {\n\t\t\tdefault: false,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> Current Session >> Settings',\n\t\t\t\ttitle: 'Highlight only when moderating',\n\t\t\t\tdescription: 'Only highlight messages in chats where you are a moderator.',\n\t\t\t\tcomponent: 'setting-check-box',\n\t\t\t\tsort: -1\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.forget_user_after', {\n\t\t\tdefault: 0,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> Current Session >> Settings',\n\t\t\t\ttitle: 'Forget User After',\n\t\t\t\tdescription: 'Forget a user after a specified amount of time so they can be highlighted again.',\n\t\t\t\tcomponent: 'setting-select-box',\n\t\t\t\tdata: [\n\t\t\t\t\t{ value: 0, title: 'Disabled' },\n\t\t\t\t\t{ value: 1000 * 60 * 5, title: '5 Minutes' },\n\t\t\t\t\t{ value: 1000 * 60 * 15, title: '15 Minutes' },\n\t\t\t\t\t{ value: 1000 * 60 * 30, title: '30 Minutes' },\n\t\t\t\t\t{ value: 1000 * 60 * 60, title: '60 Minutes' },\n\t\t\t\t\t{ value: 1000 * 60 * 60 * 2, title: '2 Hours' },\n\t\t\t\t\t{ value: 1000 * 60 * 60 * 3, title: '3 Hours' },\n\t\t\t\t],\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.highlight_color', {\n\t\t\tdefault: '#3C1A1A',\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> Current Session >> Highlights',\n\t\t\t\ttitle: 'Highlight Color',\n\t\t\t\tdescription: 'Highlight color to add to the message',\n\t\t\t\tcomponent: 'setting-color-box'\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.priority', {\n\t\t\tdefault: 0,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> Current Session >> Highlights',\n\t\t\t\ttitle: 'Highlight Priority',\n\t\t\t\tdescription: 'Priority of the highlight',\n\t\t\t\tcomponent: 'setting-text-box',\n\t\t\t\ttype: 'number',\n\t\t\t\tprocess: 'to_int'\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.highlight_historical', {\n\t\t\tdefault: true,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> Current Session >> Historical Messages',\n\t\t\t\ttitle: 'Highlight logged historical messages',\n\t\t\t\tdescription: 'Highlight messages from before you joined the chat.',\n\t\t\t\tcomponent: 'setting-check-box'\n\t\t\t}\n\t\t});\n\n\t\t// First Time Chatter\n\t\tthis.settings.add('first_message_highlight.first_time_chatter', {\n\t\t\tdefault: false,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> First Time Chatter @{\"sort\": 10}',\n\t\t\t\ttitle: 'Highlight first time chatters',\n\t\t\t\tdescription: 'Highlight messages from first time chatters.',\n\t\t\t\tcomponent: 'setting-check-box',\n\t\t\t\tsort: -1\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.first_time_chatter_only_moderated_channels', {\n\t\t\tdefault: false,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> First Time Chatter',\n\t\t\t\ttitle: 'Highlight only when moderating',\n\t\t\t\tdescription: 'Only highlight messages in chats where you are a moderator.',\n\t\t\t\tcomponent: 'setting-check-box',\n\t\t\t\tsort: -1\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.first_time_chatter_color', {\n\t\t\tdefault: '#C832C866',\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> First Time Chatter',\n\t\t\t\ttitle: 'Highlight Color',\n\t\t\t\tcomponent: 'setting-color-box'\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.first_time_chatter_priority', {\n\t\t\tdefault: 0,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> First Time Chatter',\n\t\t\t\ttitle: 'Highlight Priority',\n\t\t\t\tdescription: 'Priority of the highlight',\n\t\t\t\tcomponent: 'setting-text-box',\n\t\t\t\ttype: 'number',\n\t\t\t\tprocess: 'to_int'\n\t\t\t}\n\t\t});\n\n\t\t// Returning Chatter\n\t\tthis.settings.add('first_message_highlight.returning_chatter', {\n\t\t\tdefault: false,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> Returning Chatter @{\"sort\": 11}',\n\t\t\t\ttitle: 'Highlight returning chatters',\n\t\t\t\tdescription: 'Highlight messages from returning chatters.',\n\t\t\t\tcomponent: 'setting-check-box',\n\t\t\t\tsort: -1\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.returning_chatter_only_moderated_channels', {\n\t\t\tdefault: false,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> Returning Chatter',\n\t\t\t\ttitle: 'Highlight only when moderating',\n\t\t\t\tdescription: 'Only highlight messages in chats where you are a moderator.',\n\t\t\t\tcomponent: 'setting-check-box',\n\t\t\t\tsort: -1\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.returning_chatter_color', {\n\t\t\tdefault: '#3296E666',\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> Returning Chatter',\n\t\t\t\ttitle: 'Highlight Color',\n\t\t\t\tcomponent: 'setting-color-box'\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.add('first_message_highlight.returning_chatter_priority', {\n\t\t\tdefault: 0,\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > First Message Highlight >> Returning Chatter',\n\t\t\t\ttitle: 'Highlight Priority',\n\t\t\t\tdescription: 'Priority of the highlight',\n\t\t\t\tcomponent: 'setting-text-box',\n\t\t\t\ttype: 'number',\n\t\t\t\tprocess: 'to_int'\n\t\t\t}\n\t\t});\n\n\t\tthis.settings.addUI('first_message_highlight.pad-bottom', {\n\t\t\tpath: 'Add-Ons > First Message Highlight >> Returning Chatter',\n\t\t\tsort: 1000,\n\t\t\tcomponent: 'setting-spacer',\n\t\t\ttop: '25rem',\n\t\t\tforce_seen: true\n\t\t});\n\n\t\tthis.chat.addHighlightReason('first-message', 'First message from a user during this session');\n\t\tthis.chat.addHighlightReason('first-time-chatter', 'First messages from a user new to the channel');\n\t\tthis.chat.addHighlightReason('returning-chatter', 'First messages from a user returning to the channel');\n\n\t\tconst outerThis = this;\n\t\tthis.messageHighlighter = {\n\t\t\ttype: 'message_highlighter',\n\t\t\tpriority: 0,\n\n\t\t\tprocess(tokens, msg) {\n\t\t\t\t// First Time Chatter\n\t\t\t\touterThis.highlightFirstTimeChatter(this, msg);\n\n\t\t\t\t// Returning Chatter\n\t\t\t\touterThis.highlightReturningChatter(this, msg);\n\n\t\t\t\t// First Message\n\t\t\t\touterThis.highlightMessage(this, msg);\n\t\t\t}\n\t\t}\n\t}\n\n\tonEnable() {\n\t\tthis.on('settings:changed:first_message_highlight.forget_user_after', this.clearChatLines, this);\n\n\t\tthis.chat.addTokenizer(this.messageHighlighter);\n\t\tthis.emit('chat:update-lines');\n\t}\n\n\tonDisable() {\n\t\tthis.chat.removeTokenizer(this.messageHighlighter);\n\t\tthis.known_users.clear();\n\t\tthis.emit('chat:update-lines');\n\t}\n\n\tclearChatLines() {\n\t\tfor(const { message } of this.chat.iterateMessages()) {\n\t\t\tmessage.first_highlight = null;\n\t\t}\n\n\t\tthis.known_users.clear();\n\n\t\tthis.emit('chat:update-lines');\n\t}\n\n\tshouldHighlight(msg) {\n\t\t// If we have a cached value, return it.\n\t\tif (msg.first_highlight != null)\n\t\t\treturn msg.first_highlight;\n\n\t\t// Don't highlight messages without a user, or with the local user\n\t\tif (!msg.user?.userID || msg.user.userID == this.site.getUser()?.id)\n\t\t\treturn false;\n\n\t\t// Get the last timestamp for this user\n\t\tconst last_ts = this.known_users.get(msg.user.userID) ?? 0;\n\n\t\t// If the last timestamp is in the past...\n\t\tif (last_ts < msg.timestamp) {\n\t\t\t// Save this timestamp as the new last timestamp\n\t\t\tthis.known_users.set(msg.user.userID, msg.timestamp);\n\n\t\t\t// How long should we remember a user?\n\t\t\tconst forget_user_after = this.settings.get('first_message_highlight.forget_user_after');\n\n\t\t\t// We highlight the message if one of the following is true:\n\t\t\t// 1. last_ts is unset (so zero)\n\t\t\t// 2. forgot_user_after is NOT zero and last_ts is more than that much time in the past\n\t\t\tif (last_ts === 0 || (forget_user_after !== 0 && msg.timestamp - last_ts >= forget_user_after)) {\n\t\t\t\tmsg.first_highlight = true;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\t// If we got here, this is not a new message to highlight.\n\t\tmsg.first_highlight = false;\n\t\treturn false;\n\t}\n\n\thighlightMessage(ctx, msg) {\n\t\tif (!this.settings.get('first_message_highlight.enabled')) return;\n\n\t\tif (this.settings.get('first_message_highlight.only_moderated_channels')) {\n\t\t\tif (!this.chat.context.get('context.moderator'))\n\t\t\t\treturn;\n\t\t}\n\n\t\tconst shouldHighlight = this.shouldHighlight(msg);\n\n\t\tif (msg.isHistorical) {\n\t\t\tif (!this.settings.get('first_message_highlight.highlight_historical')) {\n\t\t\t\tthis.known_users.delete(msg.user.userID);\n\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (!shouldHighlight) return;\n\n\t\tctx.applyHighlight(\n\t\t\tmsg,\n\t\t\tthis.settings.get('first_message_highlight.priority'),\n\t\t\tthis.settings.get('first_message_highlight.highlight_color'),\n\t\t\t'first-message'\n\t\t);\n\t}\n\n\thighlightFirstTimeChatter(ctx, msg) {\n\t\tif (!this.chat.context.get('first_message_highlight.first_time_chatter')) return;\n\n\t\tif (this.settings.get('first_message_highlight.first_time_chatter_only_moderated_channels')) {\n\t\t\tif (!this.chat.context.get('context.moderator'))\n\t\t\t\treturn;\n\t\t}\n\n\t\tif (!msg.ffz_first_msg) return;\n\n\t\tctx.applyHighlight(\n\t\t\tmsg,\n\t\t\tthis.settings.get('first_message_highlight.first_time_chatter_priority'),\n\t\t\tthis.settings.get('first_message_highlight.first_time_chatter_color'),\n\t\t\t'first-time-chatter'\n\t\t);\n\t}\n\n\thighlightReturningChatter(ctx, msg) {\n\t\tif (!this.chat.context.get('first_message_highlight.returning_chatter')) return;\n\n\t\tif (this.settings.get('first_message_highlight.returning_chatter_only_moderated_channels')) {\n\t\t\tif (!this.chat.context.get('context.moderator'))\n\t\t\t\treturn;\n\t\t}\n\n\t\tif (!msg.ffz_returning) return;\n\n\t\tctx.applyHighlight(\n\t\t\tmsg,\n\t\t\tthis.settings.get('first_message_highlight.returning_chatter_priority'),\n\t\t\tthis.settings.get('first_message_highlight.returning_chatter_color'),\n\t\t\t'returning-chatter'\n\t\t);\n\t}\n}\n\nFirstMessageHighlight.register();\n"],"names":["args","outerThis","tokens","msg","message","last_ts","forget_user_after","ctx","shouldHighlight","FirstMessageHighlight"],"sourceRoot":""}