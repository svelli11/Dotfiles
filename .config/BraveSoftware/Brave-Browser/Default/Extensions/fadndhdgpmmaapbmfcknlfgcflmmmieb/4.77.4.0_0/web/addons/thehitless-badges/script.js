(()=>{var m=Object.defineProperty;var h=(o,l)=>m(o,"name",{value:l,configurable:!0});(()=>{var o={};const{createElement:l,setChildren:p}=FrankerFaceZ.utilities.dom,{Mutex:g}=FrankerFaceZ.utilities.object;function u(b,e){return fetch(`https://thehitless.com/api/${b}`,e).then(t=>t.ok?t.json():null)}h(u,"get");const n=class n extends FrankerFaceZ.utilities.addon.Addon{constructor(...e){super(...e),this.inject("chat"),this.inject("chat.badges"),this.waiting=new g(4),this.thbadges={},this.users=new Map}async onEnable(){const e=this.onMessage.bind(this);await this.loadTHBadges().then(()=>this.buildBadges()),this.on("site.channel:update-bar",this.updateChannelTHBadge,this),this.chat.addTokenizer({type:"thehitless-badges",process:e}),this.emit("chat:update-lines")}onDisable(){this.removeBadges(),this.chat.removeTokenizer("thehitless-badges"),this.emit("chat:update-lines")}onMessage(e,t){const s=t?.user,a=s?.login;if(a){const r=this.getUser(s.userID);r instanceof Promise&&r.then(i=>{if(!i||!i.userId)return;const c=i.userId.badge;if(c){const f=`addon-thehitless-badges-${c}`;this.chat.getUser(s.id,a).addBadge("thehitless-badges",f),this.emit("chat:update-lines-by-user",s.id,a,!1,!0)}})}return e}getUser(e,t=!1){const s=this.users.get(e);if(s){if(!s.done)return t?s.promise:null;if(Date.now()<=s.time+3e5)return s.value}if(this.load_wait)return this.load_wait.then(()=>this.getUser(e,t));const a=this.waiting.wait().then(r=>this._getUser(e).then(i=>(this.users.set(e,{done:!0,value:i,time:Date.now()}),i)).catch(i=>{throw this.users.set(e,{done:!0,value:null,time:Date.now()}),i}).finally(r));return this.users.set(e,{done:!1,promise:a}),a}async _getUser(e){const t=await u(`users/browser-ext/${e}`);return t.userId?t:null}async loadTHBadges(){const e=await u("badges");if(this.thbadges={},!e)return;const t=e.reduce((s,a)=>(s[a._id]={...a},s),{});this.thbadges=t}clearUserData(){for(const e of this.chat.iterateUsers())e.removeAllBadges("thehitless-badges");this.users.clear()}updateBadge(e){const t=`addon-thehitless-badges-${e._id}`,s={id:t,tooltipExtra:()=>{if(e.name)return`
TheHitless Badge - ${e.name}`},slot:333,image:e.url,urls:{1:e.url,2:e.url,3:e.url,4:e.url},svg:!1,click_url:"https://thehitless.com/"};return this.badges.loadBadgeData(t,s),t}buildBadges(){const e=this.old_badges;for(const[t,s]of Object.entries(this.thbadges))e&&e.has(t)?e.delete(t):this.updateBadge(s);if(e)for(const t of e){const s=`addon-thehitless-badges-${t}`;this.badges.removeBadge(s,!1)}this.old_badges=new Set(Object.keys(this.thbadges)),this.badges.buildBadgeCSS()}removeBadges(){for(const e of Object.keys(this.thbadges)){const t=`addon-thehitless-badges-${e}`;this.badges.removeBadge(t,!1)}this.old_badges=new Set,this.badges.buildBadgeCSS()}};h(n,"TheHitlessBadges");let d=n;d.register("thehitless-badges",null,"1.0")})();})();

//# sourceMappingURL=script.js.map