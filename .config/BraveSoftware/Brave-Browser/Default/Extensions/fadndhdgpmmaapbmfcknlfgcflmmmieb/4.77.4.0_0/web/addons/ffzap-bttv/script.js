(()=>{var w=Object.defineProperty;var u=(T,m)=>w(T,"name",{value:m,configurable:!0});(()=>{"use strict";var T={};const _=class _{constructor(t,e){this.parent=t,this.socket=!1,this._connected=!1,this._connecting=!1,this._connect_attempts=1,this._joined_channels={},this._connection_buffer=[],this._events=e}connect(){this.parent.site.getUser()&&(this._connected||this._connecting||(this._connecting=!0,this.parent.log.info("Socket: Connecting to socket server..."),this.socket=new WebSocket("wss://sockets.betterttv.net/ws"),this.socket.onopen=()=>{if(this.parent.log.info("Socket: Connected to socket server."),this._connected=!0,this._connect_attempts=1,this._connection_buffer.length>0){let t=this._connection_buffer.length;for(;t--;){const e=this._connection_buffer[t];this.joinChannel(e)}this._connection_buffer=[]}this.reconnecting&&(this.reconnecting=!1)},this.socket.onerror=()=>{this.parent.log.error("Socket: Error from socket server."),this._connect_attempts++,this.reconnect()},this.socket.onclose=()=>{!this._connected||!this.socket||(this.parent.log.info("Socket: Lost connection to socket server..."),this._connect_attempts++,this.reconnect())},this.socket.onmessage=t=>{let e;try{e=JSON.parse(t.data)}catch(s){this.parent.log.error("Socket: Error parsing message",s)}!e||!this._events[e.name]||(this.parent.log.debug("Socket: Received event",e),this._events[e.name](e.data))}))}reconnect(){this.disconnect(),this._connecting!==!1&&(this._connecting=!1,this.parent.log.info("Socket: Trying to reconnect to socket server..."),setTimeout(()=>{this.reconnecting=!0,this.connect()},Math.random()*(Math.pow(2,this._connect_attempts)-1)*1e4))}disconnect(){if(this.socket)try{this.socket.close()}catch{}delete this.socket,this._connected=!1,this._connecting=!1}disconnectInternal(){this.disconnect(),this.parent.log.info("Socket: Disconnected from socket server.")}emit(t,e){!this._connected||!this.socket||this.socket.send(JSON.stringify({name:t,data:e}))}broadcastMe(t){this._connected&&this.parent.site.getUser()&&this.emit("broadcast_me",{provider:"twitch",providerId:this.parent.site.getUser().id,channel:t})}joinChannel(t){if(!this._connected){this._connection_buffer.includes(t)||this._connection_buffer.push(t);return}!t||!t.length||(this._joined_channels[t]&&this.partChannel(t),this.emit("join_channel",{name:t}),this._joined_channels[t]=!0,this.broadcastMe(t))}partChannel(t){this._connected&&t.length&&(this._joined_channels[t]&&this.emit("part_channel",{name:t}),delete this._joined_channels[t])}};u(_,"Socket");let m=_;const E=class E{constructor(t,e,s,n){this.parent=t,this.userID=e,this.badge=s,this.setID=`addon--ffzap.betterttv--emotes-pro-${this.userID}`,this.emotes=n||[],this.loadBadge(s,!0),this.loadEmotes(n,!0)}isBadgeEqual(t=null){return this.badge?.url==t?.url&&this.badge?.startedAt==t?.startedAt}areEmotesEqual(t=[]){return this.emotes.length===t.length&&t.every(e=>this.emotes.includes(e.id))}loadBadge(t=null,e=!1){if(window.BetterTTV||!e&&this.isBadgeEqual(t))return!1;if(this.badge=t,t){const s={image:t.url,title:`BetterTTV Pro
(Since ${this.parent.i18n.formatDate(new Date(t.startedAt))})`};this.parent.chat.getUser(this.userID).addBadge("addon--ffzap.betterttv",this.parent.getProBadgeID(),s)}else this.parent.chat.getUser(this.userID).removeBadge("addon--ffzap.betterttv",this.parent.getProBadgeID());return!0}loadEmotes(t=[],e=!1){if(!e&&this.areEmotesEqual(t))return!1;this.emotes=t.map(o=>o.id);const s=[];for(let o=0;o<t.length;o++)s.push(this.parent.convertBTTVEmote(t[o]));const n={emotes:s,personal:!0,title:"Personal Emotes",source:"BetterTTV",icon:"https://betterttv.com/favicon.png"};return s.length?(this.parent.emotes.loadSetData(this.setID,n,!0),this.parent.chat.getUser(this.userID).addSet("addon--ffzap.betterttv",this.setID)):this.unload(),!0}unload(){this.parent.emotes.unloadSet(this.setID,!0)}};u(E,"ProUser");let b=E;const k=class k extends FrankerFaceZ.utilities.addon.Addon{constructor(...t){super(...t),this.inject("settings"),this.inject("chat"),this.inject("chat.emotes"),this.inject("chat.badges"),this.inject("site"),this.inject("i18n"),this.inject("load_tracker"),this.settings.add("ffzap.betterttv.global_emoticons",{default:!0,ui:{path:"Add-Ons > BetterTTV Emotes >> Emotes",title:"Global Emotes",description:"Enable to show global BetterTTV emoticons.",component:"setting-check-box"}}),this.settings.add("ffzap.betterttv.arbitrary_emoticons",{default:!0,ui:{path:"Add-Ons > BetterTTV Emotes >> Emotes",title:"Arbitrary Emotes",description:"Enable to show arbitrary emoticons (like D:, :tf: and similar).",component:"setting-check-box"}}),this.settings.add("ffzap.betterttv.channel_emoticons",{default:!0,ui:{path:"Add-Ons > BetterTTV Emotes >> Emotes",title:"Channel Emotes",description:"Enable to show per-channel BetterTTV emoticons.",component:"setting-check-box"}}),this.settings.add("ffzap.betterttv.update_messages",{default:!0,ui:{path:"Add-Ons > BetterTTV Emotes >> Emotes > Live Emote Updates",title:"Show update messages",description:"Show messages in chat when emotes are updated in the current channel.",component:"setting-check-box"}}),this.settings.add("ffzap.betterttv.pro_badges",{default:!0,ui:{path:"Add-Ons > BetterTTV Emotes >> Pro",title:"Pro Badges",description:"Enable to show BetterTTV Pro badges.",component:"setting-check-box"}}),this.settings.add("ffzap.betterttv.pro_emoticons",{default:!0,ui:{path:"Add-Ons > BetterTTV Emotes >> Pro",title:"Pro Emoticons",description:"Enable to show BetterTTV Pro emoticons.",component:"setting-check-box"}}),this.chat.context.on("changed:ffzap.betterttv.global_emoticons",this.updateEmotes,this),this.chat.context.on("changed:ffzap.betterttv.arbitrary_emoticons",this.updateEmotes,this),this.chat.context.on("changed:ffzap.betterttv.channel_emoticons",this.updateEmotes,this),this.chat.context.on("changed:ffzap.betterttv.pro_badges",()=>{this.addProBadge(),this.updateProStatus(),this.emit("chat:update-lines")},this),this.chat.context.on("changed:ffzap.betterttv.pro_emoticons",this.updateProStatus,this),this.pro_users={},this.night_subs={},this.socket=!1,this.room_emotes={},this.on("chat:reload-data",e=>{if((!e||e.badges)&&this.addBadges(),!e||e.emotes){this.updateGlobalEmotes();for(const s of this.chat.iterateRooms())s&&this.updateChannel(s)}})}onEnable(){this.log.debug("FFZ:AP's BetterTTV Emotes module was enabled successfully."),this.emotes.setProvider("addon--ffzap.betterttv",{name:this.addon_manifest.name,icon:this.addon_manifest.icon}),this.on("chat:room-add",this.roomAdd),this.on("chat:room-remove",this.roomRemove),this.on("chat:receive-message",this.onReceiveMessage),this.addBadges(),this.socket=new m(this,this.getSocketEvents()),this.updateGlobalEmotes(),this.shouldSocketBeConnected()&&this.socket.connect();for(const t of this.chat.iterateRooms())t&&this.updateChannel(t);this.addProBadge()}roomAdd(t){this.updateChannel(t)}roomRemove(t){this.updateChannel(t),this.shouldSocketBeConnected()&&this.socket.partChannel(t.id)}onReceiveMessage(t){const e=this.resolve("site").getUser();if(e){const s=t.message.user.id;e.id===s&&this.socket.broadcastMe(`twitch:${t.channelID}`)}}addEmoteUpdateMessage(t,e){const s=t.replace("twitch:",""),n=this.chat.getRoom(s);this.addChatNotice(n,e)}addChatNotice(t,e,s=!0){t.login&&this.settings.get("ffzap.betterttv.update_messages")&&this.resolve("site.chat").addNotice(t.login,{message:e,icon:new URL("https://betterttv.com/favicon.png"),tokenize:s})}getSocketEvents(){return{lookup_user:t=>{let e=!1,s=!1;if(t.subscribed&&(this.night_subs[t.providerId]||(this.night_subs[t.providerId]=!0,this.chat.getUser(t.providerId).addSet("addon--ffzap.betterttv","addon--ffzap.betterttv--emotes-special-night"),e=!0)),t.pro){let n=this.pro_users[t.providerId];n||(n=this.pro_users[t.providerId]=new b(this,t.providerId,t.badge,t.emotes),e=!0,s=!0),this.chat.context.get("ffzap.betterttv.pro_emoticons")&&n.loadEmotes(t.emotes)&&(e=!0),n.loadBadge(t.badge)&&(s=!0)}(e||s)&&this.emit("chat:update-lines-by-user",t.providerId,t.name,e,s)},emote_create:({channel:t,emote:e})=>{this.log.info(t,e);const s=this.room_emotes[t];if(!s||s.some(a=>a.id===e.id))return;const o=this.convertBTTVEmote(e);s.push(o),this.emotes.addEmoteToSet(this.getChannelSetID(t,!1),o),this.addEmoteUpdateMessage(t,`Added the emote ${o.name} (${o.name})`)},emote_delete:({channel:t,emoteId:e})=>{const s=this.room_emotes[t];if(!s)return;const n=s.find(o=>o.id===e);n&&(this.room_emotes[t]=s.filter(o=>o.id!==e),this.emotes.removeEmoteFromSet(this.getChannelSetID(t,!1),e),this.addEmoteUpdateMessage(t,`Removed the emote ${n.name}`))},emote_update:({channel:t,...e})=>{const s=e.emote,n=this.room_emotes[t];if(!n)return;const o=n.find(r=>r.id===s.id);if(!o)return;const a=o.name;o.name=s.code,this.emotes.addEmoteToSet(this.getChannelSetID(t,!1),o),this.addEmoteUpdateMessage(t,`Renamed the emote ${a} to ${o.name} (${o.name})`)}}}getProBadgeID(){return"addon--ffzap.betterttv--badges-bttv-pro"}addProBadge(){const t=this.chat.context.get("ffzap.betterttv.pro_badges")&&!window.BetterTTV;if(this.removeProBadge(!t),!t)return;const e={id:"bttv-pro",slot:21,title:"BetterTTV Pro",no_invert:!0,image:"https://cdn.betterttv.net/badges/pro/0b58eba8-e49c-4ed7-ae7d-be0b524502e6.png"};this.badges.loadBadgeData(this.getProBadgeID(),e)}removeProBadge(t=!0){this.badges.deleteBulk("addon.ffzap-bttv",this.getProBadgeID()),this.badges.removeBadge(this.getProBadgeID(),t)}async addBadges(t=0){if(window.BetterTTV){this.log.info("Not adding BTTV badges because BTTV is present.");return}const e=await fetch("https://api.betterttv.net/3/cached/badges");if(e.ok){const s=await e.json(),n=[],o=new RegExp(/\/badges\/(\w+)\.svg/);let a=s.length;for(;a--;){const r=s[a];if(!o.test(r.badge.svg))continue;const c=o.exec(r.badge.svg)[1];if(!n[c]){const l={id:`bttv-${c}`,slot:21,image:r.badge.svg,svg:!0,title:r.badge.description,no_invert:!0};n[c]=!0,this.badges.loadBadgeData(`addon--ffzap.betterttv--badges-bttv-${c}`,l)}this.chat.getUser(r.providerId).addBadge("addon--ffzap.betterttv",`addon--ffzap.betterttv--badges-bttv-${c}`)}}else{if(e.status===404)return;const s=(t||0)+1;s<12&&(this.log.error("Failed to fetch badges. Trying again in 5 seconds."),setTimeout(this.addBadges.bind(this,s),5e3))}}async updateGlobalEmotes(t=0){this.load_tracker.schedule("chat-data","ffzap-bttv-global");const e="addon--ffzap.betterttv--emotes-global";this.emotes.removeDefaultSet("addon--ffzap.betterttv",e),this.emotes.unloadSet(e);const s="addon--ffzap.betterttv--global-effects";if(this.emotes.removeDefaultSet("addon--ffzap.betterttv",s),this.emotes.unloadSet(s),!this.chat.context.get("ffzap.betterttv.global_emoticons")){this.load_tracker.notify("chat-data","ffzap-bttv-global",!1);return}const n=await fetch("https://api.betterttv.net/3/cached/emotes/global");if(n.ok){const o=await n.json(),a=[],r=[],c=[],l=[];let d={};if(this.emotes?.ModifierFlags?.Hidden){const i=this.emotes.ModifierFlags;d={"c!":i.Hidden|i.Cursed,"w!":i.Hidden|i.GrowX,"z!":i.Hidden|i.NoSpace,"v!":i.Hidden|i.FlipY,"h!":i.Hidden|i.FlipX,"l!":i.Hidden|(i.Rotate90??0),"r!":i.Hidden|(i.Rotate270??0)}}const h={cvMask:"3px 0 0 0",cvHazmat:"3px 0 0 0",SoSnowy:"2px 0 0 0",IceCold:"2px 0 0 0",TopHat:null,SantaHat:null,ReinDeer:null,CandyCane:null};let g=o.length;for(;g--;){let i=o[g];d[i.code]&&(i.modifier=!0,i.modifier_flags=d[i.code],i.modifier_prefix=!0),i=this.convertBTTVEmote(i),i.modifier|=Object.prototype.hasOwnProperty.call(h,i.name),i.modifier_offset=h[i.name];const B=/[^A-Za-z0-9]/.test(i.name);i.channel&&i.channel==="night"?c.push(i):i.modifier_flags?l.push(i):B?r.push(i):a.push(i)}let p;c.length>0&&(p={emotes:c,title:"Night (Legacy)",source:"BetterTTV",icon:"https://betterttv.com/favicon.png",sort:50},this.emotes.loadSetData("addon--ffzap.betterttv--emotes-special-night",p));let f=[];if(f=f.concat(a),this.chat.context.get("ffzap.betterttv.arbitrary_emoticons")&&(f=f.concat(r)),f.length===0&&l.length===0){this.load_tracker.notify("chat-data","ffzap-bttv-global",!1);return}p={emotes:f,title:"Global Emotes",source:"BetterTTV",icon:"https://betterttv.com/favicon.png",_type:1},this.emotes.addDefaultSet("addon--ffzap.betterttv",e,p),p={emotes:l,title:"Global Effects",source:"BetterTTV",icon:"https://betterttv.com/favicon.png",_type:1},this.emotes.addDefaultSet("addon--ffzap.betterttv",s,p),this.load_tracker.notify("chat-data","ffzap-bttv-global",!0)}else{if(n.status===404)return;const o=(t||0)+1;o<12&&(this.log.error("Failed to fetch global emotes. Trying again in 5 seconds."),setTimeout(this.updateGlobalEmotes.bind(this,o),5e3))}}getChannelSetID(t,e=!0){return`addon--ffzap.betterttv--channel-${e?this.getBTTVRoomID(t):t}`}getBTTVRoomID(t){return`twitch:${t}`}convertBTTVEmote({id:t,code:e,user:s,animated:n,width:o,height:a,modifier:r,modifier_flags:c,modifier_prefix:l}){const d=/[^A-Za-z0-9]/.test(e),h={urls:{1:`https://cdn.betterttv.net/emote/${t}/1x.webp`,2:`https://cdn.betterttv.net/emote/${t}/2x.webp`,4:`https://cdn.betterttv.net/emote/${t}/3x.webp`},id:t,name:e,width:o||28,height:a||28,modifier:r,modifier_flags:c,modifier_prefix:l,owner:{display_name:s&&s.displayName,name:s&&s.name},require_spaces:d,click_url:`https://betterttv.com/emotes/${t}`};return n&&(h.animated=h.urls,h.urls={1:`https://cdn.betterttv.net/emote/${t}/static/1x.webp`,2:`https://cdn.betterttv.net/emote/${t}/static/2x.webp`,4:`https://cdn.betterttv.net/emote/${t}/static/3x.webp`}),h}async updateChannel(t,e=0){this.load_tracker.schedule("chat-data",`ffzap-bttv-channel-${t.id}`);const s=this.getChannelSetID(t.id);t.removeSet("addon--ffzap.betterttv",s);const n=this.getBTTVRoomID(t.id);if(this.shouldSocketBeConnected()&&this.socket.joinChannel(n),!this.chat.context.get("ffzap.betterttv.channel_emoticons")){this.load_tracker.notify("chat-data",`ffzap-bttv-channel-${t.id}`,!1);return}const o=await fetch(`https://api.betterttv.net/3/cached/users/twitch/${t.id}`);if(o.ok){const a=this.room_emotes[n]=[],{channelEmotes:r,sharedEmotes:c,bots:l}=await o.json(),d=r.concat(c);for(const p of l){const f=t.getUser(null,p);f&&f.addBadge("ffz",2)}let h=d.length;for(;h--;)d[h].user=d[h].user||t&&{displayName:t.login,name:t.login},a.push(this.convertBTTVEmote(d[h]));if(!a.length){this.load_tracker.notify("chat-data",`ffzap-bttv-channel-${t.id}`,!1);return}const g={emotes:a,title:"Channel Emotes",title_is_channel:!0,source:"BetterTTV",icon:"https://betterttv.com/favicon.png",_type:1};a.length?(this.emotes.loadSetData(s,g,!1),t.addSet("addon--ffzap.betterttv",s)):t.removeSet("addon--ffzap.betterttv",s),this.load_tracker.notify("chat-data",`ffzap-bttv-channel-${t.id}`,!0)}else{if(o.status===404){this.load_tracker.notify("chat-data",`ffzap-bttv-channel-${t.id}`,!1);return}const a=(e||0)+1;a<12?(this.log.error("Failed to fetch channel emotes. Trying again in 5 seconds."),setTimeout(this.updateChannel.bind(this,t,a),5e3)):(this.log.error("Failed to fetch channel emotes."),this.load_tracker.notify("chat-data",`ffzap-bttv-channel-${t.id}`,!1))}}updateEmotes(){this.updateGlobalEmotes();for(const t of this.chat.iterateRooms())t&&this.updateChannel(t)}shouldSocketBeConnected(){return this.chat.context.get("ffzap.betterttv.pro_badges")||this.chat.context.get("ffzap.betterttv.pro_emoticons")}updateProStatus(){if(this.shouldSocketBeConnected()){this.socket.connect();for(const t of this.chat.iterateRooms())t&&this.updateChannel(t)}else{for(const t in this.ProUsers)({}).hasOwnProperty.call(this.ProUsers,t)&&this.ProUsers[t].unload();this.ProUsers={},this.socket.disconnectInternal()}}};u(k,"BetterTTV");let v=k;v.register("ffzap-bttv",null,"3.3.24")})();})();

//# sourceMappingURL=script.js.map