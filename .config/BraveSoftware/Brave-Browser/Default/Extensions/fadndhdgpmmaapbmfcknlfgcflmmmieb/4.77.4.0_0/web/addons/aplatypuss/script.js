(()=>{var I=Object.defineProperty;var r=(T,l)=>I(T,"name",{value:l,configurable:!0});(()=>{var T={},l=Object.defineProperty,g=r((D,t,e)=>t in D?l(D,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):D[t]=e,"__defNormalProp"),s=r((D,t,e)=>(g(D,typeof t!="symbol"?t+"":t,e),e),"__publicField");const c=class c extends FrankerFaceZ.utilities.addon.Addon{constructor(...t){super(...t),s(this,"HOST_URL","https://ffz.thetiki.club"),s(this,"ASSETS_URL",`${this.HOST_URL}/static`),s(this,"CHANNELS_IDS",["39464264"]),s(this,"ADDON_ID","addon.aplatypuss"),s(this,"ADDON_NAME","APlatypuss"),s(this,"ADDON_EMOTES_ID",`${this.ADDON_ID}.emotes`),s(this,"EMOTICONS_SETTINGS_CHECK",`${this.ADDON_ID}.enable_emotes`),s(this,"ADDON_BADGES_ID",`${this.ADDON_ID}.badges`),s(this,"BADGES_SETTINGS_CHECK",`${this.ADDON_ID}.enable_badges`),s(this,"BADGE_PREFIX",`${this.ADDON_ID}.badge`),s(this,"BADGES_START_SLOT",420),s(this,"DEFAULT_BADGE_URL","https://thetiki.club/"),s(this,"REFRESH_TIME_SETTINGS",`${this.ADDON_ID}.refresh_time`),s(this,"MIN_REFRESH_TIME_SECONDS",20),s(this,"DEFAULT_REFRESH_TIME_SECONDS",60),s(this,"REFRESH_TIME_SECONDS",this.settings.get(this.REFRESH_TIME_SETTINGS)??this.DEFAULT_REFRESH_TIME_SECONDS),s(this,"UPDATE_TIMER_ID",null),s(this,"SHOULD_REFRESH",!0),s(this,"BADGES_KEYS",[]),s(this,"CURRENT_BADGES",{}),s(this,"CURRENT_BADGES_USERS",{}),this.inject("settings"),this.inject("chat"),this.inject("chat.badges"),this.inject("chat.emotes"),this.settings.add(this.EMOTICONS_SETTINGS_CHECK,{default:!0,ui:{path:`Add-Ons > ${this.ADDON_NAME} >> Emotes`,title:"Show Emotes",description:"Enable to show custom emotes.",component:"setting-check-box"},changed:()=>this.updateAllChannels()}),this.settings.add(this.BADGES_SETTINGS_CHECK,{default:!0,ui:{path:`Add-Ons > ${this.ADDON_NAME} >> Badges`,title:"Enable Badges",description:"Enable to show custom badges",component:"setting-check-box"},changed:()=>this.updateAllChannels()}),this.settings.add(this.REFRESH_TIME_SETTINGS,{default:this.DEFAULT_REFRESH_TIME_SECONDS,ui:{path:`Add-Ons > ${this.ADDON_NAME} >> Refresh`,title:"Refresh Time",description:"Time in seconds to check for updates",component:"setting-text-box",process:(e,S)=>{let E=parseInt(e);return E=E<this.MIN_REFRESH_TIME_SECONDS?this.MIN_REFRESH_TIME_SECONDS:E,E}},changed:e=>{e!=this.REFRESH_TIME_SECONDS&&(this.REFRESH_TIME_SECONDS=e,this.log.info(`new refresh time, ${this.REFRESH_TIME_SECONDS}`),clearInterval(this.UPDATE_TIMER_ID),this.UPDATE_TIMER_ID=setInterval(()=>{this.refreshData()},this.REFRESH_TIME_SECONDS*1e3))}}),setTimeout(()=>this.enable(),0)}enable(){this.log.info("addon was enabled"),this.on("chat:room-add",this.roomChange),this.on("chat:room-remove",this.roomChange),this.on("chat:room-update-login",this.roomChange),this.refreshData(),this.UPDATE_TIMER_ID=setInterval(()=>{this.refreshData()},this.REFRESH_TIME_SECONDS*1e3)}onDisable(){clearInterval(this.UPDATE_TIMER_ID)}async refreshData(){this.log.info("refreshing emotes and badges"),this.updateAllChannels(!1),await this.updateBadges(0,!1),this.SHOULD_REFRESH||clearInterval(this.UPDATE_TIMER_ID)}roomChange(t){this.updateChannel(t)}updateChannel(t,e){this.CHANNELS_IDS.indexOf(t._id)==-1?(this.unloadEmotes(),this.disableBadges(),this.SHOULD_REFRESH=!1,this.log.info(`disabling on room ${t._id} (is not present in the ID's list)`)):this.updateChannelEmotes(t,e)}updateAllChannels(t=!0){for(const e of this.chat.iterateRooms())e&&this.updateChannel(e,t)}async updateChannelEmotes(t,e=0,S=!0){if(t.removeSet(this.ADDON_ID,this.ADDON_EMOTES_ID),!this.chat.context.get(this.EMOTICONS_SETTINGS_CHECK))return;const E=await fetch(`${this.HOST_URL}/emotes.json`);if(E.ok){const n=[];for(const h of await E.json()){const a=/[^A-Za-z0-9]/.test(h.code),i={id:h.code,urls:{1:void 0},name:h.code,width:h.width,height:h.width,require_spaces:a,modifier:h.modifier!==void 0,modifier_offset:h.modifier};i.urls={1:`${this.ASSETS_URL}/${h.id}_1X.webp`,2:`${this.ASSETS_URL}/${h.id}_2X.webp`,4:`${this.ASSETS_URL}/${h.id}_3X.webp`},n.push(i)}let _=[];_=_.concat(n);const d={emoticons:_,title:"Channel Emotes",source:`${this.ADDON_NAME}`,icon:`${this.ASSETS_URL}/icon.png`};t.addSet(this.ADDON_ID,this.ADDON_EMOTES_ID,d)}else{if(E.status===404||!S)return;const n=(e||0)+1;n<12&&(this.log.error("Failed to fetch emotes. Trying again in 5 seconds."),setTimeout(this.updateChannelEmotes.bind(this,t,n),5e3))}}async updateBadges(t=0,e=!0){if(!this.settings.get(this.BADGES_SETTINGS_CHECK))return;const S=await fetch(`${this.HOST_URL}/badgesDefinitions.json`),E=await fetch(`${this.HOST_URL}/badgesUsers.json`);if(S.ok&&E.ok){const n=await S.json(),_=await E.json();this.BADGES_KEYS=Object.keys(n);const d={},h={};for(let a=0;a<this.BADGES_KEYS.length;a++){const i=n[this.BADGES_KEYS[a]],o=`${this.BADGE_PREFIX}.${this.BADGES_KEYS[a].toLowerCase()}`;d[o]={id:`${o}`,addon:this.ADDON_ID,name:this.BADGES_KEYS[a],title:i.tooltip,slot:this.BADGES_START_SLOT+a,image:this.ASSETS_URL+i.image1,urls:{1:`${this.ASSETS_URL}/${i.image1}`,2:`${this.ASSETS_URL}/${i.image2}`,4:`${this.ASSETS_URL}/${i.image3}`},click_url:i.url??this.DEFAULT_BADGE_URL},h[o]=i.users??[]}for(let a=0;a<_.length;a++){const i=_[a];for(let o=0;o<i.badges.length;o++){const R=`${this.BADGE_PREFIX}.${i.badges[o].toLowerCase()}`;h[R]=h[R].concat(i.user)}}if(!(JSON.stringify(d)===JSON.stringify(this.CURRENT_BADGES)||JSON.stringify(h)===JSON.stringify(this.CURRENT_BADGES_USERS))){this.log.info("Badge info differs, updating ..."),this.CURRENT_BADGES=d,this.CURRENT_BADGES_USERS=h;for(let a=0;a<this.BADGES_KEYS.length;a++){const i=`${this.BADGE_PREFIX}.${this.BADGES_KEYS[a].toLowerCase()}`;this.badges.loadBadgeData(i,this.CURRENT_BADGES[i]),this.badges.setBulk(this.ADDON_BADGES_ID,i,this.CURRENT_BADGES_USERS[i])}this.badges.buildBadgeCSS(),this.emit("chat:update-lines")}}else{if(S.status===404||!e)return;const n=(t||0)+1;n<12&&(this.log.error("Failed to fetch badges. Trying again in 5 seconds."),setTimeout(this.updateBadges.bind(this,n),5e3))}}disableBadges(){for(let t=0;t<this.BADGES_KEYS.length;t++){const e=`${this.BADGE_PREFIX}.${this.BADGES_KEYS[t].toLowerCase()}`;this.badges.deleteBulk(this.ADDON_BADGES_ID,e)}this.badges.buildBadgeCSS(),this.emit("chat:update-lines")}unloadEmotes(){this.emotes.unloadSet(this.ADDON_ID,this.ADDON_EMOTES_ID)}};r(c,"Aplatypuss");let A=c;A.register("aplatypuss")})();})();

//# sourceMappingURL=script.js.map