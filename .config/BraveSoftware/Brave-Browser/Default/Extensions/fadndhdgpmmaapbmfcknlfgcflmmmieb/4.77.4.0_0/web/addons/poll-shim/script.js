(()=>{var W=Object.defineProperty;var p=(_,g)=>W(_,"name",{value:g,configurable:!0});(()=>{"use strict";var _={},g={};function o(e){var i=g[e];if(i!==void 0)return i.exports;var t=g[e]={exports:{}};return _[e](t,t.exports,o),t.exports}p(o,"__webpack_require__"),o.m=_,o.d=(e,i)=>{for(var t in i)o.o(i,t)&&!o.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:i[t]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce((i,t)=>(o.f[t](e,i),i),[])),o.u=e=>""+(e===366?"poll-shim/vue":e)+".js",o.g=function(){if(typeof globalThis=="object")return globalThis;try{return this||new Function("return this")()}catch{if(typeof window=="object")return window}}(),o.o=(e,i)=>Object.prototype.hasOwnProperty.call(e,i),(()=>{var e={},i="ffz-addons:";o.l=(t,n,s,a)=>{if(e[t]){e[t].push(n);return}var r,l;if(s!==void 0)for(var d=document.getElementsByTagName("script"),h=0;h<d.length;h++){var c=d[h];if(c.getAttribute("src")==t||c.getAttribute("data-webpack")==i+s){r=c;break}}r||(l=!0,r=document.createElement("script"),r.charset="utf-8",r.timeout=120,o.nc&&r.setAttribute("nonce",o.nc),r.setAttribute("data-webpack",i+s),r.src=t,r.src.indexOf(window.location.origin+"/")!==0&&(r.crossOrigin="anonymous")),e[t]=[n];var u=p((v,k)=>{r.onerror=r.onload=null,clearTimeout(f);var S=e[t];if(delete e[t],r.parentNode&&r.parentNode.removeChild(r),S&&S.forEach(A=>A(k)),v)return v(k)},"onScriptComplete"),f=setTimeout(u.bind(null,void 0,{type:"timeout",target:r}),12e4);r.onerror=u.bind(null,r.onerror),r.onload=u.bind(null,r.onload),l&&document.head.appendChild(r)}})(),o.r=e=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var i=o.g.document;if(!e&&i&&(i.currentScript&&(e=i.currentScript.src),!e)){var t=i.getElementsByTagName("script");if(t.length)for(var n=t.length-1;n>-1&&!e;)e=t[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e+"../"})(),(()=>{var e={996:0};o.f.j=(n,s)=>{var a=o.o(e,n)?e[n]:void 0;if(a!==0)if(a)s.push(a[2]);else{var r=new Promise((c,u)=>a=e[n]=[c,u]);s.push(a[2]=r);var l=o.p+o.u(n),d=new Error,h=p(c=>{if(o.o(e,n)&&(a=e[n],a!==0&&(e[n]=void 0),a)){var u=c&&(c.type==="load"?"missing":c.type),f=c&&c.target&&c.target.src;d.message="Loading chunk "+n+` failed.
(`+u+": "+f+")",d.name="ChunkLoadError",d.type=u,d.request=f,a[1](d)}},"loadingEnded");o.l(l,h,"chunk-"+n,n)}};var i=p((n,s)=>{var[a,r,l]=s,d,h,c=0;if(a.some(f=>e[f]!==0)){for(d in r)o.o(r,d)&&(o.m[d]=r[d]);if(l)var u=l(o)}for(n&&n(s);c<a.length;c++)h=a[c],o.o(e,h)&&e[h]&&e[h][0](),e[h]=0},"webpackJsonpCallback"),t=globalThis.ffzAddonsWebpackJsonp=globalThis.ffzAddonsWebpackJsonp||[];t.forEach(i.bind(null,0)),t.push=i.bind(null,t.push.bind(t))})();var O={};const{generateUUID:y}=FrankerFaceZ.utilities.object,P=["embed-chat","popout"],m=class m extends FrankerFaceZ.utilities.addon.Addon{constructor(...i){super(...i),this.inject("site"),this.inject("site.router"),this.inject("site.twitch_data"),this.settings.addUI("addon.poll-shim.info",{path:'Add-Ons > Poll-Shim >> Info @{"sort": -1000}',no_filter:!0,component:()=>o.e(366).then(o.bind(o,2945)),shouldBeActive:()=>this.shouldBeActive,isActive:()=>this.active,hasPubSub:()=>this.pubsub_open,hasWS:()=>this._socket!=null&&this._socket.readyState===WebSocket.OPEN,isAuthed:()=>this.socket_auth,getChannel:()=>this.getUser(),getSelf:()=>this.getSelf(),getWS:()=>this._socket,getPolls:()=>this.polls,on:(...t)=>this.on(...t),off:(...t)=>this.off(...t)}),this.settings.add("addon.poll-shim.enabled",{default:!0,ui:{path:'Add-Ons > Poll-Shim >> General @{"sort": -500}',title:"Enable Poll-Shim.",component:"setting-check-box"},changed:()=>this.onNavigate()}),this.settings.add("addon.poll-shim.user",{default:null,requires:["context.channelID","context.session.user.id","context.route.name"],process:(t,n)=>{if(n==null||typeof n!="string"){const s=t.get("context.route.name");return typeof s=="string"&&s.startsWith("dash-")?t.get("context.channelID"):t.get("context.session.user.id")}return n},ui:{path:"Add-Ons > Poll-Shim >> General",title:"Channel",description:"Set this to override the channel where polls should be run. Please note that you must be a moderator of the channel in question to run a poll.",component:()=>o.e(366).then(o.bind(o,6247))},changed:()=>{this.active?(this.deactivate(),this.shouldBeActive&&this.activate()):this.onNavigate()}}),this.settings.add("addon.poll-shim.address",{default:"ws://localhost:31337",ui:{path:"Add-Ons > Poll-Shim >> Connectivity",title:"Address",description:"Connect to this address for polls.",component:"setting-text-box"},changed:()=>{this._socket&&this._socket.reconnect()}}),this.settings.add("addon.poll-shim.key",{default:y(),ui:{path:"Add-Ons > Poll-Shim >> Authentication",title:"Passphrase",description:`The server you connect to must authenticate with this passphrase to be allowed to create polls.

**Note:** This value changes every page load until you manually set it.`,component:"setting-text-box"},changed:()=>{this._socket&&this._socket.reconnect()}}),this.settings.add("addon.poll-shim.client-key",{default:"",ui:{path:"Add-Ons > Poll-Shim >> Authentication",title:"Client Passphrase",description:"If this is set, the client will authenticate by sending this passphrase to the server once the server connects.",component:"setting-text-box"},changed:()=>{this._socket&&this._socket.reconnect()}}),this.url_provider=()=>this.settings.get("addon.poll-shim.address"),this.active=!1,this.polls=new Set,this.updating_polls=new Set,this.socket_auth=!1,this.onWSClose=this.onWSClose.bind(this),this.onWSMessage=this.onWSMessage.bind(this),this.onWSOpen=this.onWSOpen.bind(this)}get shouldBeActive(){if(!this.enabled&&!this.enabling||this.errored||!this.settings.get("addon.poll-shim.enabled"))return!1;this.settings.main_context.update("addon.poll-shim.user");const i=this.settings.get("addon.poll-shim.user"),t=this.site.getCore();if(!i||!t||!t.pubsub)return!1;const n=this.router.current_name;if(typeof n!="string"||!P.includes(n)&&!n.startsWith("dash-"))return!1;const s=this.settings.get("context.channelID");return s&&s==i}async onEnable(){this.ReconnectingWebSocket=(await o.e(496).then(o.bind(o,7496))).default,this.on("site.router:route",this.onNavigate,this),this.onNavigate()}onDisable(){this.off("site.router:route",this.onNavigate,this),this.active&&this.deactivate()}onNavigate(){const i=this.shouldBeActive;i&&!this.active?this.activate():!i&&this.active&&this.deactivate()}async activate(){if(!this.enabled&&!this.enabling)return;const i=this.settings.get("addon.poll-shim.user"),t=this.site.getCore();if(!i||!t||!t.pubsub)return;this.channel_id=i;const[n,s]=await Promise.all([this.getUser(),this.getSelf()]);if(!n){this.channel_id=null;return}this.log.info("Activating shim."),this._unsub=t.pubsub.subscribe({topic:`polls.${i}`,success:()=>{this.pubsub_open=!0,this.emit(":update")},failure:a=>{this.log.error("Failed to listen to pubsub",a),this.errored=!0,this.pubsub_open=!1,this.deactivate()},onMessage:a=>this.onPubSub(a)}),this._socket=new this.ReconnectingWebSocket(this.url_provider,[],{maxEnqueuedMessages:0}),this._socket.addEventListener("open",this.onWSOpen),this._socket.addEventListener("close",this.onWSClose),this._socket.addEventListener("message",this.onWSMessage),this.active=!0,this.emit(":update")}deactivate(){this.log.info("Deactivating shim."),this._unsub&&(this._unsub(),this._unsub=null),this._socket&&(this._socket.close(),this._socket.removeEventListener("open",this.onWSOpen),this._socket.removeEventListener("close",this.onWSClose),this._socket.removeEventListener("message",this.onWSMessage),this._socket=null),this._open_timer&&(clearTimeout(this._open_timer),this._open_timer=null),this.updating_polls.clear(),this.polls.clear(),this.pubsub_open=!1,this.socket_auth=!1,this.channel_id=null,this._user=null,this._self=null,this.active=!1,this.emit(":update")}onPubSub(i){const t=i.type;(t==="POLL_UPDATE"||t==="POLL_COMPLETE")&&this.handlePoll(i.data.poll)}send(i,t={}){this._socket&&(typeof t!="object"&&(t={data:t}),t.type=i,this._socket.send(JSON.stringify(t)))}onWSOpen(){this.log.debug("WebSocket Connected"),this.emit(":update");const i=this.settings.get("addon.poll-shim.client-key");i&&i.length&&this.send("auth",{data:i}),this._open_timer=setTimeout(()=>{this._open_timer&&(clearTimeout(this._open_timer),this._open_timer=null),this._socket&&this._socket.reconnect()},1e3)}onWSClose(){this._open_timer&&(clearTimeout(this._open_timer),this._open_timer=null),this.log.debug("WebSocket Closed"),this.polls.clear(),this.updating_polls.clear(),this.socket_auth=!1,this.emit(":update")}async getUser(){if(this._user)return this._user;const i=this.channel_id;return i?(this._user=await this.twitch_data.getUser(i),this._user):(this._user=null,null)}async getSelf(){if(this._self)return this._self;const i=this.channel_id;if(!i)return this._self=null,null;const t=this.site.getUser();return t&&t.id==i?this._self={isModerator:!0,isEditor:!0}:this._self=await this.twitch_data.getUserSelf(i),this._self}onWSMessage(i){let t;try{t=JSON.parse(i.data)}catch(s){this.log.debug("Invalid WS Message",s);return}if(!t||!t.type)return;this.log.debug("WebSocket Message",t);const n=t.type;if(n==="auth"){if(this.socket_auth||t.data!==this.settings.get("addon.poll-shim.key")){this.log.debug("WebSocket Authentication Error. Reconnecting."),this.send("error",{id:"bad_auth"}),this._socket.close(),setTimeout(()=>{this._socket&&this._socket.reconnect()},1e3),this.emit(":update");return}this.socket_auth=!0,this.send("auth_ok"),this.log.info("WebSocket Connected and Authorized"),Promise.all([this.getUser(),this.getSelf()]).then(([s,a])=>{if(!s)return this.send("error",{id:"no_user"});const r=a&&a.isModerator,l=s.roles||{};this.send("user",{id:s.id,login:s.login,display_name:s.displayName,can_create:r&&(l.isAffiliate||l.isPartner)})}),this._open_timer&&(clearTimeout(this._open_timer),this._open_timer=null),this.emit(":update");return}else this.socket_auth||this.send("error",{id:"no_auth"});if(n==="create"){if(typeof t.title!="string")return this.send("error",{id:"no_title"});const s=t.title.trim();if(!s.length)return this.send("error",{id:"no_title"});if(!Array.isArray(t.choices)||t.choices.some(h=>typeof h!="string"&&h.length>50))return this.send("error",{id:"bad_choices"});if(!this.channel_id)return this.send("error",{id:"no_channel"});const a=t.duration||60;if(typeof a!="number"||a<15||isNaN(a)||a>180)return this.send("error",{id:"bad_duration"});const r=t.subscriberMultiplier||!1,l=t.subscriberOnly||!1,d=t.bits||0;if(typeof d!="number"||d>1e4)return this.send("error",{id:"bad_bits"});this.twitch_data.createPoll(this.channel_id,s,t.choices,{duration:a,subscriberMultiplier:r,subscriberOnly:l,bits:d}).then(async h=>{if(!h){const c=await this.getUser(),u=c?.roles||{};if(!c)return this.send("error",{id:"cannot_poll",err:"Invalid channel ID or API error."});if(!u.isAffiliate&&!u.isPartner)return this.send("error",{id:"cannot_poll",err:"Channel does not have access to Polls. Must be affiliate or partner."});this.send("error",{id:"cannot_poll",err:"Unable to create poll."})}this.polls.add(h.id),this.send("created",{id:h.id}),h.durationSeconds=a,this.handlePoll(h),this.emit(":update")}).catch(h=>{this.send("error",{id:"cannot_poll",err:String(h)})});return}if(n==="listen"){t.id||this.send("error",{id:"no_id"}),this.polls.add(t.id),this.updating_polls.add(t.id),this.twitch_data.getPoll(t.id).then(s=>{this.updating_polls.has(t.id)&&(s||(s={id:t.id,status:"COMPLETED",choices:[]}),this.handlePoll(s))}),this.emit(":update");return}if(n==="get"){t.id||this.send("error",{id:"no_id"}),this.updating_polls.add(t.id),this.twitch_data.getPoll(t.id).then(s=>{this.updating_polls.has(t.id)&&(s||(s={id:t.id,status:"COMPLETED",choices:[]}),this.handlePoll(s,!0))}),this.emit(":update");return}if(n==="end"){t.id||this.send("error",{id:"no_id"}),this.twitch_data.terminatePoll(t.id).then(()=>{this.updating_polls.delete(t.id),this.polls.delete(t.id),this.send("ended",{id:t.id})}),this.emit(":update");return}this.send("error",{id:"unknown_command"})}handlePoll(i,t=!1,n="update"){if(!this.active||!this._socket)return;const s=w(i);this.updating_polls.delete(s.id),!(!this.polls.has(s.id)&&!t)&&(s.ended&&(this.polls.delete(s.id),this.emit(":update")),this.send(n,{poll:s}))}};p(m,"PollShim");let b=m;b.register("poll-shim",null,"0.2.2");function w(e,i){if(!e)return{id:i,ended:!0,choices:[]};const t=e.status!=="ACTIVE";let n=e.durationSeconds||e.duration_seconds,s=e.remaining_duration_milliseconds;if(n==null){const l=e.endedAt||e.ended_at,d=e.startedAt||e.startedAt;d&&l?n=Math.floor((Date.parse(l)-Date.parse(d))/1e3):n=0}if(s==null)if(t)s=0;else{const l=e.startedAt||e.startedAt;l?s=Math.max(0,n*1e3-(Date.now()-Date.parse(l))):s=n*1e3}const a=[],r={id:e.id||e.poll_id,ended:t,duration:n,remaining:s,choices:a};for(const l of e.choices)l&&a.push({text:l.title,votes:l.votes?.total||0});return r}p(w,"formatPoll")})();})();

//# sourceMappingURL=script.js.map