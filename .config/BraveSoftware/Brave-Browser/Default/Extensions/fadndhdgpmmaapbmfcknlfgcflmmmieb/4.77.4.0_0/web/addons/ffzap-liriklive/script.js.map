{"version":3,"file":"ffzap-liriklive/script.js","mappings":"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","sources":["webpack://ffz-addons/./src/ffzap-liriklive/socket.js","webpack://ffz-addons/./src/ffzap-liriklive/index.js"],"sourcesContent":["const REQUEST_TYPES = {\n\tAUTHORIZE: 1 << 0, //not implemented here\n\tPONG: 1 << 1, //should be the response to the PING evemt\n\tCHANNEL_SUBSCRIBE: 1 << 2,\n\tCHANNEL_UNSUBSCRIBE: 1 << 3,\n\tANNOUNCE_MESSAGE: 1 << 4,\n};\n\nconst EVENT_TYPES = {\n\tREADY: 1 << 0, //you should receive that from the server directly after connecting\n\tAUTHORIZED: 1 << 1, //not implemeneted here\n\tPING: 1 << 2, //just respond with PONG request type, not yet implemented but ima kick cons eventually via that\n\tCHANNEL_SUBSCRIPTION_ADDED: 1 << 4,\n\tCHANNEL_SUBSCRIPTION_REMOVED: 1 << 5,\n\tUSER_CHANNEL_DATA: 1 << 6,\n};\n\nconst USER_FLAGS = {\n\tEXTENSION_DEV: 1 << 0,\n\tEXTENSION_ADMIN: 1 << 1,\n\tLIRIK_SUB: 1 << 2,\n};\n\nexport default class Socket {\n\tconstructor(parent) {\n\t\tthis.parent = parent;\n\n\t\tthis.socket = false;\n\t\tthis._connected = false;\n\t\tthis._connecting = false;\n\t\tthis._ready = false;\n\t\tthis._connect_attempts = 1;\n\t\tthis._joined_channels = {};\n\t\tthis._connection_buffer = [];\n\t\tthis._announce_buffer = {};\n\t}\n\n\tconnect() {\n\t\tif (!this.parent.site.getUser()) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._connected || this._connecting) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._connecting = true;\n\n\t\tthis.parent.log.info('Socket: Connecting to socket server...');\n\n\t\tthis.socket = new WebSocket('wss://lirik.hnlbot.com/ws');\n\t\tthis.socket.binaryType = 'arraybuffer';\n\n\t\tthis._joined_channels = {};\n\t\tthis._announce_buffer = {};\n\n\t\tthis.socket.onopen = () => {\n\t\t\tthis.parent.log.info('Socket: Connected to socket server.');\n\n\t\t\tthis._connected = true;\n\t\t\tthis._connect_attempts = 1;\n\n\t\t\tif (this.reconnecting) {\n\t\t\t\tfor (const room of this.parent.chat.iterateRooms()) {\n\t\t\t\t\tif (room) this.parent.roomAdd(room);\n\t\t\t\t}\n\n\t\t\t\tthis.reconnecting = false;\n\t\t\t}\n\t\t};\n\n\t\tthis.socket.onerror = () => {\n\t\t\tthis.parent.log.error('Socket: Error from socket server.');\n\n\t\t\tif (this._connecting) {\n\t\t\t\tthis.reconnecting = false;\n\t\t\t}\n\n\t\t\tthis._connect_attempts++;\n\t\t\tthis.reconnect();\n\t\t};\n\n\t\tthis.socket.onclose = () => {\n\t\t\tif (!this._connected || !this.socket) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.parent.log.error('Socket: Lost connection to socket server...');\n\n\t\t\tthis._connect_attempts++;\n\t\t\tthis.reconnect();\n\t\t};\n\n\t\tthis.socket.onmessage = message => {\n\t\t\tlet json = JSON.parse(message.data);\n\t\t\tjson = json instanceof Array ? json : [json];\n\n\t\t\tfor (const evt of json) {\n\t\t\t\tswitch(evt.t) {\n\t\t\t\t\tcase EVENT_TYPES.READY: {\n\t\t\t\t\t\tthis._ready = true;\n\t\n\t\t\t\t\t\tif (this._connection_buffer.length > 0) {\n\t\t\t\t\t\t\tlet i = this._connection_buffer.length;\n\t\t\t\t\t\t\twhile (i--) {\n\t\t\t\t\t\t\t\tconst channel = this._connection_buffer[i];\n\t\t\t\t\t\t\t\tthis.joinRoom(channel);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthis._connection_buffer = [];\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\n\t\t\t\t\tcase EVENT_TYPES.PING: {\n\t\t\t\t\t\tthis.emit(REQUEST_TYPES.PONG);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\n\t\t\t\t\tcase EVENT_TYPES.CHANNEL_SUBSCRIPTION_ADDED: {\n\t\t\t\t\t\tif (!evt.c_id) continue;\n\t\t\t\t\t\tif (this._announce_buffer[evt.c_id]) {\n\t\t\t\t\t\t\tthis.announceMessage(evt.c_id);\n\t\t\t\t\t\t\tdelete this._announce_buffer[evt.c_id];\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!evt.c_d) continue;\n\n\t\t\t\t\t\tconst {u_id, f: flags, s_m} = evt.c_d;\n\t\n\t\t\t\t\t\tif (flags & USER_FLAGS.LIRIK_SUB) {\n\t\t\t\t\t\t\tconst user = this.parent.chat.getUser(u_id);\n\t\t\t\t\t\t\tuser.addSet('addon--ffzap.liriklive', 'addon--ffzap.liriklive--emotes-subscriber');\n\t\t\t\t\t\t\tif (s_m >= 12) {\n\t\t\t\t\t\t\t\tuser.addSet('addon--ffzap.liriklive', 'addon--ffzap.liriklive--emotes-restricted');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\n\t\t\t\t\tcase EVENT_TYPES.USER_CHANNEL_DATA: {\n\t\t\t\t\t\tconst {u_id, f: flags, s_m} = evt.d;\n\t\n\t\t\t\t\t\tif (flags & USER_FLAGS.LIRIK_SUB) {\n\t\t\t\t\t\t\tconst user = this.parent.chat.getUser(u_id);\n\t\t\t\t\t\t\tuser.addSet('addon--ffzap.liriklive', 'addon--ffzap.liriklive--emotes-subscriber');\n\t\t\t\t\t\t\tif (s_m >= 12) {\n\t\t\t\t\t\t\t\tuser.addSet('addon--ffzap.liriklive', 'addon--ffzap.liriklive--emotes-restricted');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t}\n\n\treconnect() {\n\t\tthis.disconnect();\n\n\t\tif (this.reconnecting) {\n\t\t\treturn;\n\t\t}\n\t\tthis.reconnecting = false;\n\n\t\tthis.parent.log.info('Socket: Trying to reconnect to socket server...');\n\n\t\tsetTimeout(() => {\n\t\t\tthis.reconnecting = true;\n\t\t\tthis.connect();\n\t\t}, Math.random() * (Math.pow(2, this._connect_attempts) - 1) * 10000);\n\t}\n\n\tdisconnect() {\n\t\tif (this.socket) {\n\t\t\ttry {\n\t\t\t\tthis.socket.close();\n\t\t\t} catch (e) {\n\t\t\t\t// Error\n\t\t\t}\n\t\t}\n\n\t\tdelete this.socket;\n\n\t\tthis._connected = false;\n\t\tthis._connecting = false;\n\t}\n\n\tdisconnectInternal() {\n\t\tthis.disconnect();\n\n\t\tthis.parent.log.info('Socket: Disconnected from socket server.');\n\t}\n\n\temit(event_type, data) {\n\t\tif (!this._connected || !this.socket) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.socket.send(JSON.stringify({\n\t\t\tt: event_type,\n\t\t\td: data,\n\t\t}));\n\t}\n\n\tjoinRoom(channel_id) {\n\t\tif (!this.parent.chat.context.get('ffzap.liriklive.sub_emoticons')) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!channel_id) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this._connected || !this._ready) {\n\t\t\tif (!this._connection_buffer.includes(channel_id)) {\n\t\t\t\tthis._connection_buffer.push(channel_id);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tconst user = this.parent.site.getUser();\n\t\tif (!user || !user.id) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._joined_channels[channel_id]) {\n\t\t\tthis.leaveRoom(channel_id);\n\t\t}\n\n\t\tthis.emit(REQUEST_TYPES.CHANNEL_SUBSCRIBE, {\n\t\t\tu_id: user.id,\n\t\t\tc_id: channel_id,\n\t\t});\n\t\tthis._joined_channels[channel_id] = true;\n\n\t\tthis._announce_buffer[channel_id] = true; \n\t}\n\n\tannounceMessage(channel_id) {\n\t\tconst user = this.parent.site.getUser();\n\t\tif (!user || !user.id) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.emit(REQUEST_TYPES.ANNOUNCE_MESSAGE, {\n\t\t\tc_id: channel_id,\n\t\t\tu_id: user.id,\n\t\t});\n\t}\n\n\tleaveRoom(channel_id) {\n\t\tif (!this._connected) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._joined_channels[channel_id]) {\n\t\t\tthis.emit(REQUEST_TYPES.CHANNEL_UNSUBSCRIBE, {\n\t\t\t\tc_id: channel_id,\n\t\t\t});\n\t\t}\n\t\tdelete this._joined_channels[channel_id];\n\t}\n}\n","import Socket from './socket';\n\n/*const GIF_EMOTES_MODE = {\n\tDISABLED: 0,\n\tSTATIC: 1,\n\tANIMATED: 2,\n};*/\n\nclass LirikLIVE extends Addon {\n\tconstructor(...args) {\n\t\tsuper(...args);\n\n\t\tthis.inject('settings');\n\t\tthis.inject('chat');\n\t\tthis.inject('chat.emotes');\n\t\tthis.inject('site');\n\n\t\tthis.settings.add('ffzap.liriklive.global_emoticons', {\n\t\t\tdefault: true,\n\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > Lirik LIVE >> Emotes',\n\t\t\t\ttitle: 'Global Emotes',\n\t\t\t\tdescription: 'Enable to show LIRIK LIVE global emotes.',\n\t\t\t\tcomponent: 'setting-check-box',\n\t\t\t},\n\t\t});\n\n\t\t/*this.settings.add('ffzap.liriklive.gif_emotes_mode', {\n\t\t\tdefault: 2,\n\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > Lirik LIVE >> Emotes',\n\t\t\t\ttitle: 'GIF Emotes',\n\t\t\t\tdescription: 'Change the mode of how GIF emotes are showing up.',\n\t\t\t\tcomponent: 'setting-select-box',\n\t\t\t\tdata: [\n\t\t\t\t\t{ value: 0, title: 'Disabled' },\n\t\t\t\t\t{ value: 1, title: 'Enabled (Static GIF Emotes)' },\n\t\t\t\t\t{ value: 2, title: 'Enabled (Animated GIF Emotes)' },\n\t\t\t\t],\n\t\t\t},\n\t\t});*/\n\n\t\tthis.settings.add('ffzap.liriklive.sub_emoticons', {\n\t\t\tdefault: true,\n\n\t\t\tui: {\n\t\t\t\tpath: 'Add-Ons > Lirik LIVE >> Emotes',\n\t\t\t\ttitle: 'Subscriber Emotes',\n\t\t\t\tdescription: 'Enable to show additional LIRIK LIVE subscriber emotes.',\n\t\t\t\tcomponent: 'setting-check-box',\n\t\t\t},\n\t\t});\n\n\t\tthis.chat.context.on('changed:ffzap.liriklive.global_emoticons', this.updateEmotes, this);\n\t\t//this.chat.context.on('changed:ffzap.liriklive.gif_emotes_mode', this.updateEmotes, this);\n\t\tthis.chat.context.on('changed:ffzap.liriklive.sub_emoticons', this.updateEmotes, this);\n\n\t\tthis.socket = false;\n\t\tthis._last_emote_id = 0;\n\t}\n\n\tonEnable() {\n\t\tthis.log.debug('FFZ:AP\\'s Lirik LIVE module was enabled successfully.');\n\n\t\tthis.updateEmotes();\n\n\t\tthis.socket = new Socket(this);\n\n\t\tif (this.chat.context.get('ffzap.liriklive.sub_emoticons')) {\n\t\t\tthis.socket.connect();\n\t\t}\n\n\t\tthis.on('chat:room-add', this.roomAdd);\n\t\tthis.on('chat:room-remove', this.roomRemove);\n\t\tthis.on('chat:pre-send-message', this.preSendMessage);\n\n\t\tfor (const room of this.chat.iterateRooms()) {\n\t\t\tif (room) this.roomAdd(room);\n\t\t}\n\t}\n\n\troomAdd(room) {\n\t\tthis.socket.joinRoom(room.id);\n\t}\n\n\troomRemove(room) {\n\t\tthis.socket.leaveRoom(room.id);\n\t}\n\n\tpreSendMessage(event) {\n\t\tif (!this.chat.context.get('ffzap.liriklive.sub_emoticons')) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst room = this.chat.getRoom(null, event.channel, true);\n\t\tif (!room || !room.id) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.socket.announceMessage(room.id);\n\t}\n\n\tupdateGlobalEmotes(data) {\n\t\tconst realID = 'addon--ffzap.liriklive--emotes-global';\n\t\tthis.emotes.removeDefaultSet('addon--ffzap.liriklive', realID);\n\t\tthis.emotes.unloadSet(realID);\n\n\t\tif (!this.chat.context.get('ffzap.liriklive.global_emoticons')) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst emotes = [];\n\n\t\tconst { global, gifs } = data;\n\n\t\tif (global) {\n\t\t\tfor (const dataEmote of global) {\n\t\t\t\tconst emote = {\n\t\t\t\t\tid: ++this._last_emote_id,\n\t\t\t\t\tname: dataEmote.code,\n\t\t\t\t\twidth: dataEmote.width || 28,\n\t\t\t\t\theight: dataEmote.height || 28,\n\t\t\t\t};\n\n\t\t\t\tif (dataEmote.id) {\n\t\t\t\t\temote.urls = {\n\t\t\t\t\t\t1: `https://static-cdn.jtvnw.net/emoticons/v1/${dataEmote.id}/1.0`,\n\t\t\t\t\t\t2: `https://static-cdn.jtvnw.net/emoticons/v1/${dataEmote.id}/2.0`,\n\t\t\t\t\t\t4: `https://static-cdn.jtvnw.net/emoticons/v1/${dataEmote.id}/3.0`,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\temote.urls = {\n\t\t\t\t\t\t1: `https://cdn.ffzap.com/liriklive/normal/${emote.name}_1.png`,\n\t\t\t\t\t\t2: `https://cdn.ffzap.com/liriklive/normal/${emote.name}_2.png`,\n\t\t\t\t\t\t4: `https://cdn.ffzap.com/liriklive/normal/${emote.name}_4.png`,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\temotes.push(emote);\n\t\t\t}\n\t\t}\n\n\t\tif (gifs) {\n\t\t\t/*const gifMode = this.chat.context.get('ffzap.liriklive.gif_emotes_mode');\n\t\t\tif (gifMode !== GIF_EMOTES_MODE.DISABLED) { // eslint-disable-line*/\n\t\t\tfor (const emoteName of gifs) {\n\t\t\t\tconst emote = {\n\t\t\t\t\tid: ++this._last_emote_id,\n\t\t\t\t\tanimated: {\n\t\t\t\t\t\t1: `https://cdn.ffzap.com/liriklive/gifs/${emoteName}_1.gif`,\n\t\t\t\t\t\t2: `https://cdn.ffzap.com/liriklive/gifs/${emoteName}_2.gif`,\n\t\t\t\t\t\t4: `https://cdn.ffzap.com/liriklive/gifs/${emoteName}_4.gif`,\n\t\t\t\t\t},\n\t\t\t\t\tname: emoteName,\n\t\t\t\t\twidth: 28,\n\t\t\t\t\theight: 28,\n\t\t\t\t\tmodifier: emoteName === 'lirikRAIN',\n\t\t\t\t};\n\n\t\t\t\temote.urls = {\n\t\t\t\t\t1: `https://cache.ffzap.com/${emote.animated[1]}`,\n\t\t\t\t\t2: `https://cache.ffzap.com/${emote.animated[2]}`,\n\t\t\t\t\t4: `https://cache.ffzap.com/${emote.animated[4]}`\n\t\t\t\t}\n\n\t\t\t\temotes.push(emote);\n\t\t\t}\n\t\t}\n\n\t\tif (emotes.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst set = {\n\t\t\temoticons: emotes,\n\t\t\ttitle: 'Past Emotes',\n\t\t\tsource: 'LIRIK LIVE',\n\t\t\ticon: 'https://cdn.ffzap.com/liriklive/icon.png',\n\t\t\tsort: 51,\n\t\t\tforce_global: (emote_set, channel) => channel && channel.login === 'lirik',\n\t\t};\n\n\t\tthis.emotes.addDefaultSet('addon--ffzap.liriklive', realID, set);\n\t}\n\n\tupdateSubscriberEmotes(data) {\n\t\tconst realID = 'addon--ffzap.liriklive--emotes-subscriber';\n\t\tthis.emotes.unloadSet(realID);\n\n\t\tif (!this.chat.context.get('ffzap.liriklive.sub_emoticons')) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst emotes = [];\n\n\t\tconst { subscriber } = data;\n\n\t\tif (subscriber) {\n\t\t\tfor (const dataEmote of subscriber) {\n\t\t\t\tconst emote = {\n\t\t\t\t\tid: ++this._last_emote_id,\n\t\t\t\t\tname: dataEmote.code,\n\t\t\t\t\twidth: dataEmote.width || 28,\n\t\t\t\t\theight: dataEmote.height || 28,\n\t\t\t\t};\n\n\t\t\t\tif (dataEmote.id) {\n\t\t\t\t\temote.urls = {\n\t\t\t\t\t\t1: `https://static-cdn.jtvnw.net/emoticons/v1/${dataEmote.id}/1.0`,\n\t\t\t\t\t\t2: `https://static-cdn.jtvnw.net/emoticons/v1/${dataEmote.id}/2.0`,\n\t\t\t\t\t\t4: `https://static-cdn.jtvnw.net/emoticons/v1/${dataEmote.id}/3.0`,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\temote.urls = {\n\t\t\t\t\t\t1: `https://cdn.ffzap.com/liriklive/normal/${emote.name}_1.png`,\n\t\t\t\t\t\t2: `https://cdn.ffzap.com/liriklive/normal/${emote.name}_2.png`,\n\t\t\t\t\t\t4: `https://cdn.ffzap.com/liriklive/normal/${emote.name}_4.png`,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\temotes.push(emote);\n\t\t\t}\n\t\t}\n\n\t\tif (emotes.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst set = {\n\t\t\temoticons: emotes,\n\t\t\ttitle: 'Subscriber Emotes',\n\t\t\tsource: 'LIRIK LIVE',\n\t\t\ticon: 'https://cdn.ffzap.com/liriklive/icon.png',\n\t\t\tmerge_id: 'addon--ffzap.liriklive--emotes-global',\n\t\t};\n\n\t\tthis.emotes.loadSetData(realID, set);\n\t}\n\n\tupdateRestrictedEmotes(data) {\n\t\tconst realID = 'addon--ffzap.liriklive--emotes-restricted';\n\t\tthis.emotes.unloadSet(realID);\n\n\t\tif (!this.chat.context.get('ffzap.liriklive.sub_emoticons')) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst emotes = [];\n\n\t\tconst { restricted } = data;\n\n\t\tif (restricted) {\n\t\t\tfor (const dataEmote of restricted) {\n\t\t\t\tconst emote = {\n\t\t\t\t\tid: ++this._last_emote_id,\n\t\t\t\t\tname: dataEmote.code,\n\t\t\t\t\twidth: dataEmote.width || 28,\n\t\t\t\t\theight: dataEmote.height || 28,\n\t\t\t\t};\n\n\t\t\t\tif (dataEmote.id) {\n\t\t\t\t\temote.urls = {\n\t\t\t\t\t\t1: `https://static-cdn.jtvnw.net/emoticons/v1/${dataEmote.id}/1.0`,\n\t\t\t\t\t\t2: `https://static-cdn.jtvnw.net/emoticons/v1/${dataEmote.id}/2.0`,\n\t\t\t\t\t\t4: `https://static-cdn.jtvnw.net/emoticons/v1/${dataEmote.id}/3.0`,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\temote.urls = {\n\t\t\t\t\t\t1: `https://cdn.ffzap.com/liriklive/normal/${emote.name}_1.png`,\n\t\t\t\t\t\t2: `https://cdn.ffzap.com/liriklive/normal/${emote.name}_2.png`,\n\t\t\t\t\t\t4: `https://cdn.ffzap.com/liriklive/normal/${emote.name}_4.png`,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\temotes.push(emote);\n\t\t\t}\n\t\t}\n\n\t\tif (emotes.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst set = {\n\t\t\temoticons: emotes,\n\t\t\ttitle: 'Restricted Emotes',\n\t\t\tsource: 'LIRIK LIVE',\n\t\t\ticon: 'https://cdn.ffzap.com/liriklive/icon.png',\n\t\t\tmerge_id: 'addon--ffzap.liriklive--emotes-global',\n\t\t};\n\n\t\tthis.emotes.loadSetData(realID, set);\n\t}\n\n\tasync updateEmotes(attempts = 0) {\n\t\tthis._last_emote_id = 0;\n\n\t\tif (!this.chat.context.get('ffzap.liriklive.global_emoticons') && !this.chat.context.get('ffzap.liriklive.sub_emoticons')) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst response = await fetch('https://cdn.ffzap.com/liriklive/emotes.json');\n\t\tif (response.ok) {\n\t\t\tconst data = await response.json();\n\n\t\t\tthis.updateGlobalEmotes(data);\n\t\t\tthis.updateSubscriberEmotes(data);\n\t\t\tthis.updateRestrictedEmotes(data);\n\t\t} else {\n\t\t\tif (response.status === 404) return;\n\n\t\t\tconst newAttempts = (attempts || 0) + 1;\n\t\t\tif (newAttempts < 12) {\n\t\t\t\tthis.log.error('Failed to fetch emotes. Trying again in 5 seconds.');\n\t\t\t\tsetTimeout(this.updateEmotes.bind(this, newAttempts), 5000);\n\t\t\t}\n\t\t}\n\t}\n}\n\nLirikLIVE.register();\n"],"names":["REQUEST_TYPES","EVENT_TYPES","USER_FLAGS","parent","room","message","json","evt","i","channel","u_id","flags","s_m","user","event_type","data","channel_id","Socket","args","event","realID","emotes","global","gifs","dataEmote","emote","emoteName","set","emote_set","subscriber","restricted","attempts","response","newAttempts","LirikLIVE"],"sourceRoot":""}