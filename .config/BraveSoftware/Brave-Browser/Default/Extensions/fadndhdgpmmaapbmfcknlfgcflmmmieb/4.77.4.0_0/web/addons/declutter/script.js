(()=>{var C=Object.defineProperty;var u=(p,s)=>C(p,"name",{value:s,configurable:!0});(()=>{"use strict";var p={};const s={enabled:!1,similarity_threshold:80,repetitions_threshold:3,ignore_mods:!0,force_enable_when_mod:!1,cache_ttl:30};var m=Object.defineProperty,w=u((d,t,e)=>t in d?m(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e,"__defNormalProp"),o=u((d,t,e)=>(w(d,typeof t!="symbol"?t+"":t,e),e),"__publicField");const _=class _ extends FrankerFaceZ.utilities.addon.Addon{constructor(...t){super(...t),o(this,"cache",new Map),o(this,"cacheEvictionTimer"),o(this,"chatContext"),o(this,"RepetitionCounter"),o(this,"userId"),o(this,"compareTwoStrings",(e,i)=>{if(e=e.replace(/\s+/g,""),i=i.replace(/\s+/g,""),!e.length&&!i.length)return 1;if(!e.length||!i.length)return 0;if(e===i)return 1;if(e.length===1&&i.length===1)return e===i?1:0;if(e.length<2||i.length<2)return 0;const a=new Map;for(let n=0;n<e.length-1;n++){const r=e.substring(n,n+2),l=a.has(r)?a.get(r)+1:1;a.set(r,l)}let h=0;for(let n=0;n<i.length-1;n++){const r=i.substring(n,n+2),l=a.has(r)?a.get(r):0;l>0&&(a.set(r,l-1),h++)}return 2*h/(e.length+i.length-2)}),o(this,"checkRepetitionAndCache",e=>{const i=this.settings.get("addon.declutter.similarity_threshold")??s.similarity_threshold,a=this.settings.get("addon.declutter.repetitions_threshold")??s.repetitions_threshold;let h=0;for(const[r,l]of this.cache)if(i===100?e.toLowerCase()===r.toLowerCase()&&(h+=l?.length??1):this.compareTwoStrings(e.toLowerCase(),r.toLowerCase())>i/100&&(h+=l?.length??1),h>=a)break;const n=this.cache.get(e)??[];return this.cache.set(e,[...n,Date.now()+this.cacheTtl]),this.log.debug("("+h+"): "+e),h}),o(this,"onEnable",()=>{this.log.debug("Enabling Declutterer"),this.updateConstants(),this.chat.context.on("changed:addon.declutter.cache_ttl",this.updateConstants,this),this.on("chat:receive-message",this.handleMessage,this)}),o(this,"updateConstants",()=>{this.cache_ttl=this.chat.context.get("addon.declutter.cache_ttl"),this.startCacheEvictionTimer(Math.min(Math.max(1,Math.floor(this.cache_ttl/10)),10))}),o(this,"onDisable",()=>{this.log.debug("Disabling Declutterer"),this.off("chat:receive-message",this.handleMessage,this),this.cacheEvictionTimer&&clearInterval(this.cacheEvictionTimer),this.cache=new Map}),o(this,"startCacheEvictionTimer",e=>{this.cacheEvictionTimer&&clearInterval(this.cacheEvictionTimer),this.cacheEvictionTimer=setInterval(()=>{this.log.debug("Running cache eviction cycle");for(const[i,a]of this.cache){const h=a?.filter(n=>n>Date.now())??[];h.length===0?this.cache.delete(i):this.cache.set(i,h)}},e*1e3)}),o(this,"handleMessage",e=>{if(!e.message||e.defaultPrevented||this.chatContext&&this.chatContext.get("context.moderator")&&!this.settings.get("addon.declutter.force_enable_when_mod"))return;const i=e.message;if(i.ffz_removed||i.deleted||!i.ffz_tokens||this.settings.get("addon.declutter.ignore_mods")&&(i.badges.moderator||i.badges.broadcaster)||i.user&&this.userId&&i.user.id==this.userId)return;!i.repetitionCount&&i.repetitionCount!==0&&(i.repetitionCount=this.checkRepetitionAndCache(i.message));const a=this.settings.get("addon.declutter.repetitions_threshold")??s.repetitions_threshold;i.repetitionCount>=a&&e.preventDefault()}),this.inject("chat"),this.inject("settings"),this.inject("site"),this.chatContext=this.chat.context,this.userId=this.site?.getUser()?.id,this.cacheTtl=(this.settings.get("addon.declutter.cache_ttl")??s.cache_ttl)*1e3}};u(_,"Logic");let g=_;const{createElement:c}=FrankerFaceZ.utilities.dom,b=class b extends FrankerFaceZ.utilities.addon.Addon{constructor(...t){super(...t),this.toggleEnabled=this.toggleEnabled.bind(this),this.inject("chat"),this.inject("settings"),this.inject("site.fine"),this.inject("i18n"),this.register("logic",g,!0),this.settings.add("addon.declutter.enabled",{default:s.enabled,ui:{path:"Add-Ons > Declutterer >> General Settings",title:"Enable by Default",description:"Enable add-on by default. Otherwise, enable the add-on per channel via the toggle button next to chat settings",component:"setting-check-box"}}),this.settings.add("addon.declutter.similarity_threshold",{default:s.similarity_threshold,ui:{path:"Add-Ons > Declutterer >> Filter Settings",title:"Similarity threshold in %",description:"Minimum similarity between 2 messages to count them as repetitions",component:"setting-text-box",process:"to_int",bounds:[0,100]}}),this.settings.add("addon.declutter.repetitions_threshold",{default:s.repetitions_threshold,ui:{path:"Add-Ons > Declutterer >> Filter Settings",title:"Repetition threshold",description:"Amount of repetitions before the message is marked",component:"setting-text-box",process:"to_int",bounds:[0]}}),this.settings.add("addon.declutter.ignore_mods",{default:s.ignore_mods,ui:{path:"Add-Ons > Declutterer >> Mod Settings",title:"Ignore mods",description:"Do not limit messages by mods or the broadcaster",component:"setting-check-box"}}),this.settings.add("addon.declutter.force_enable_when_mod",{default:s.force_enable_when_mod,ui:{path:"Add-Ons > Declutterer >> Mod Settings",title:"Force enabled when Moderator",description:"Force filtering even in channels you are a moderator in",component:"setting-check-box"}}),this.settings.add("addon.declutter.cache_ttl",{default:s.cache_ttl,ui:{path:"Add-Ons > Declutterer >> Cache Settings",title:"Cache TTL",description:"Amount of seconds for messages to stay in the cache. A long TTL leads to high RAM usage, especially in bigger channels",component:"setting-text-box",process:"to_int",bounds:[1]}}),this.logic.disable(),this.set_enabled=null,this.ChatInput=this.fine.define("chat-input"),this.logic.on(":enabled",this.updateButtons,this),this.logic.on(":disabled",this.updateButtons,this)}onEnable(){this.chat.context.on("changed:addon.declutter.enabled",this.checkEnabled,this),this.checkEnabled(),this.ChatInput.on("mount",this.updateButton,this),this.ChatInput.on("update",this.updateButton,this),this.updateButtons()}async onDisable(){await this.logic.disable();for(const t of this.ChatInput.instances)this.removeButton(t);this.ChatInput.off("mount",this.updateButton,this),this.ChatInput.off("update",this.updateButton,this)}checkEnabled(){const t=this.set_enabled??this.chat.context.get("addon.declutter.enabled");t&&!this.logic.enabled?this.logic.enable():!t&&this.logic.enabled&&this.logic.disable()}updateButtons(){if(this.ChatInput&&(this.enabling||this.enabled))for(const t of this.ChatInput.instances)this.updateButton(t)}toggleEnabled(){this.set_enabled=!this.logic.enabled,this.checkEnabled()}updateButton(t){const e=this.fine.getHostNode(t);if(e){if(t._ffz_declutter_button||(t._ffz_declutter_button=c("div",{class:"tw-relative ffz-il-tooltip__container"},c("button",{class:`tw-border-radius-medium tw-button-icon--primary ffz-core-button 
							tw-inline-flex tw-interactive tw-justify-content-center 
							tw-overflow-hidden tw-relative tw-button-icon`,onclick:this.toggleEnabled},c("span",{class:"tw-button-icon__icon"},t._ffz_declutter_icon=c("figure",{class:"ffz-i-zreknarf"}))),c("div",{class:"ffz-il-tooltip ffz-il-tooltip--up ffz-il-tooltip--align-right"},this.i18n.t("addon.pn.button.title","Toggle Declutterer").replace("PrattleNot","Declutterer"),t._ffz_declutter_enabled_tip=c("div",null)))),!e.contains(t._ffz_declutter_button)){const i=e.querySelector(".chat-input__buttons-container > div:last-child");i&&i.insertBefore(t._ffz_declutter_button,i.firstChild)}t._ffz_declutter_icon.className=this.logic.enabled?"ffz-i-chat":"ffz-i-chat-empty",t._ffz_declutter_enabled_tip.classList.toggle("tw-mg-t-1",this.logic.enabled),t._ffz_declutter_enabled_tip.textContent=this.logic.enabled?this.i18n.t("addon.pn.button.enabled","Declutterer is currently enabled. Click to disable.").replace("PrattleNot","Declutterer"):null}}removeButton(t){t._ffz_declutter_button&&(t._ffz_declutter_button.remove(),t._ffz_declutter_button=null,t._ffz_declutter_enabled_tip=null)}};u(b,"Declutter");let f=b;f.register("declutter",null,"1.0.0")})();})();

//# sourceMappingURL=script.js.map