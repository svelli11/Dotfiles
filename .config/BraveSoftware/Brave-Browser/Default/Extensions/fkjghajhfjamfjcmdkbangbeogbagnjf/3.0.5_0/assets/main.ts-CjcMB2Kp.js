import{b as l,g as M,A as T,s as A,a as tt,c as V,S as k,d as U,e as dt,C as $,f as pt,h as J,n as ct,w as N,i as q,j as Nt,k as ue,l as X,m as le,r as fe}from"./utils-DSlpwFzy.js";import{O as Rt,a as xt,T as Bt,G as Dt,b as Ht,c as jt,R as de,l as R,e as S,M as P,B as ht,d as K,f as pe,K as he,Y as Mt,g as me,h as ye,i as ge,P as H,j as we}from"./logging-DFlNDjhV.js";function ut(t){this.message=t}ut.prototype=new Error,ut.prototype.name="InvalidCharacterError";var _t=typeof window<"u"&&window.atob&&window.atob.bind(window)||function(t){var e=String(t).replace(/=+$/,"");if(e.length%4==1)throw new ut("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,r,a=0,i=0,s="";r=e.charAt(i++);~r&&(n=a%4?64*n+r:r,a++%4)?s+=String.fromCharCode(255&n>>(-2*a&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return s};function Te(t){var e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(n){return decodeURIComponent(_t(n).replace(/(.)/g,function(r,a){var i=a.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i}))}(e)}catch{return _t(e)}}function z(t){this.message=t}function be(t,e){if(typeof t!="string")throw new z("Invalid token specified");var n=(e=e||{}).header===!0?0:1;try{return JSON.parse(Te(t.split(".")[n]))}catch(r){throw new z("Invalid token specified: "+r.message)}}z.prototype=new Error,z.prototype.name="InvalidTokenError";const Gt=/^(www.|m.)?twitch.tv$/i,_e=/^\/(?!(videos\/\d+|[^/]+\/clip\/.+|settings|popout|subscriptions|wallet|inventory|drops|directory))/i,Ie=/^\/(moderator\/.+)|([^/]+\/(videos|clips?|schedule|about))/i;function Y(t){const e=t.match(/(twitch\.tv\/)(moderator\/)?([^/]+)($|\/)/);return(e==null?void 0:e[3].toLowerCase())||null}function Q(){return Math.random().toString(36).substring(2,15)}function Yt(t,e){const n=be(t);if(e!==n.nonce)throw new Error("Invalid nonce parameter during authorization");return n}function Ce(t){const{hostname:e,pathname:n}=new URL(t);return Gt.test(e)&&_e.test(n)}function Ee(t){const{hostname:e,pathname:n}=new URL(t);return Gt.test(e)&&Ie.test(n)}async function Se(){return l.permissions.contains({origins:Rt[xt.TWITCH]})}async function Le(){const t=new URL("https://id.twitch.tv/oauth2/authorize"),e=await l.identity.getRedirectURL();return t.searchParams.append("client_id",Bt),t.searchParams.append("redirect_uri",e),t.searchParams.append("response_type","token id_token"),t.searchParams.append("scope","openid user:read:follows"),t.searchParams.append("force_verify","true"),t.searchParams.append("state",Q()),t.searchParams.append("nonce",Q()),t.href}async function Oe(){const t=await Le(),e=new URL(t).searchParams.get("state"),n=new URL(t).searchParams.get("nonce"),r=await l.identity.launchWebAuthFlow({url:t,interactive:!0}),a=new URL(r),i=a.hash?new URLSearchParams(a.hash.substring(1)):a.searchParams;if(e!==i.get("state"))throw new Error("Invalid state parameter during authorization");const s=i.get("access_token"),c=i.get("id_token");if(!c||!n)throw new Error;const p=Yt(c,n),o=p.sub,u=p.preferred_username;if(s&&o){const{logins:f=[]}=await M(["logins"]),h={type:T.TWITCH,accessToken:s,userId:o,username:u};await A({logins:f.filter(m=>m.type!==T.TWITCH).concat(h)})}}const Pe=tt();async function ke(t){const e=new URL("https://accounts.google.com/o/oauth2/v2/auth"),n=await l.identity.getRedirectURL();return e.searchParams.append("client_id",t),e.searchParams.append("redirect_uri",n),e.searchParams.append("response_type","code"),e.searchParams.append("scope","openid email profile https://www.googleapis.com/auth/youtube.readonly"),e.searchParams.append("prompt","consent"),e.searchParams.append("access_type","offline"),e.searchParams.append("state",Q()),e.searchParams.append("nonce",Q()),e.href}async function ve(){const{logins:t}=await M(["logins"]),e=t==null?void 0:t.find(O=>O.type===T.YOUTUBE_OAUTH_CREDENTIALS),n=(e==null?void 0:e.clientId)||Dt,r=e==null?void 0:e.clientSecret,a=await ke(n),i=new URL(a).searchParams.get("state"),s=new URL(a).searchParams.get("nonce"),c=new URL(a).searchParams.get("redirect_uri"),p=await l.identity.launchWebAuthFlow({url:a,interactive:!0}),o=new URL(p),u=o.hash?new URLSearchParams(o.hash.substring(1)):o.searchParams;if(i!==u.get("state"))throw new Error("Invalid state parameter during authorization");const f=u.get("code");if(!f)throw new Error("No code returned to log in with");const h=r?Ht:`${jt}/google/exchange-code`,g=await(await fetch(h,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(r?{client_id:n,client_secret:r,grant_type:"authorization_code",redirect_uri:c,code:f}:{redirectUri:c,code:f})})).json(),{id_token:b,access_token:w,refresh_token:_,expires_in:L}=g,D=Date.now()/1e3+L;if(!b||!s)throw new Error;const v=Yt(b,s),{email:y,name:I,sub:C}=v;if(C){const{logins:O=[]}=await M(["logins"]),ie={type:T.YOUTUBE,userId:C,email:y,name:I,clientId:n,clientSecret:r,accessToken:w,refreshToken:_,expiry:D},oe=[T.YOUTUBE,T.YOUTUBE_OAUTH_CREDENTIALS];await A({logins:O.filter(ce=>!oe.includes(ce.type)).concat(ie)})}}async function Ft({clientId:t,clientSecret:e,refreshToken:n,accessToken:r,expiry:a}){if(a-Date.now()/1e3<de){R("Refreshing YouTube access token");const s=e?Ht:`${jt}/google/refresh-token`,p=await fetch(s,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e?{client_id:t,client_secret:e,grant_type:"refresh_token",refresh_token:n}:{refreshToken:n})}),o=await p.json();if(p.status>=400)return S(`${o.error}: ${o.error_description}`),{accessToken:r,expiry:a};const u=o.access_token,f=Date.now()/1e3+o.expires_in;return A({logins:Pe.logins.map(h=>h.type===T.YOUTUBE&&h.accessToken===r?{...h,accessToken:u,expiry:f}:h)}),{accessToken:u,expiry:f}}return{accessToken:r,expiry:a}}const Ue=tt();async function Ae(){const t={type:T.KICK};await A({logins:Ue.logins.filter(e=>e.type!==T.KICK).concat(t)})}const It=tt();async function mt(t){let e;switch(t){case T.YOUTUBE:{const r=V(It);r&&r.clientId&&r.clientSecret&&(e={type:T.YOUTUBE_OAUTH_CREDENTIALS,clientId:r.clientId,clientSecret:r.clientSecret}),A({youtubeSubscriptions:null},k.LOCAL);break}}const n=It.logins.filter(r=>r.type!==t)||[];e&&n.push(e),A({logins:n}),n.length===0&&(l.action.setBadgeText({text:""}),l.action.setBadgeBackgroundColor({color:ht}))}async function $e(){l.runtime.onMessage.addListener(t=>{switch(t.type){case P.LOGIN_TWITCH:{Oe();break}case P.LOGIN_YOUTUBE:{ve();break}case P.LOGIN_KICK:{Ae();break}case P.LOGOUT:{mt(t.accountType);break}}})}var Ne="Expected a function",Ct=NaN,Re="[object Symbol]",xe=/^\s+|\s+$/g,Be=/^[-+]0x[0-9a-f]+$/i,De=/^0b[01]+$/i,He=/^0o[0-7]+$/i,je=parseInt,Me=typeof U=="object"&&U&&U.Object===Object&&U,Ge=typeof self=="object"&&self&&self.Object===Object&&self,Ye=Me||Ge||Function("return this")(),Fe=Object.prototype,Ke=Fe.toString,We=Math.max,Xe=Math.min,st=function(){return Ye.Date.now()};function qe(t,e,n){var r,a,i,s,c,p,o=0,u=!1,f=!1,h=!0;if(typeof t!="function")throw new TypeError(Ne);e=Et(e)||0,lt(n)&&(u=!!n.leading,f="maxWait"in n,i=f?We(Et(n.maxWait)||0,e):i,h="trailing"in n?!!n.trailing:h);function m(y){var I=r,C=a;return r=a=void 0,o=y,s=t.apply(C,I),s}function d(y){return o=y,c=setTimeout(w,e),u?m(y):s}function g(y){var I=y-p,C=y-o,O=e-I;return f?Xe(O,i-C):O}function b(y){var I=y-p,C=y-o;return p===void 0||I>=e||I<0||f&&C>=i}function w(){var y=st();if(b(y))return _(y);c=setTimeout(w,g(y))}function _(y){return c=void 0,h&&r?m(y):(r=a=void 0,s)}function L(){c!==void 0&&clearTimeout(c),o=0,r=p=a=c=void 0}function D(){return c===void 0?s:_(st())}function v(){var y=st(),I=b(y);if(r=arguments,a=this,p=y,I){if(c===void 0)return d(p);if(f)return c=setTimeout(w,e),m(p)}return c===void 0&&(c=setTimeout(w,e)),s}return v.cancel=L,v.flush=D,v}function lt(t){var e=typeof t;return!!t&&(e=="object"||e=="function")}function Ve(t){return!!t&&typeof t=="object"}function Je(t){return typeof t=="symbol"||Ve(t)&&Ke.call(t)==Re}function Et(t){if(typeof t=="number")return t;if(Je(t))return Ct;if(lt(t)){var e=typeof t.valueOf=="function"?t.valueOf():t;t=lt(e)?e+"":e}if(typeof t!="string")return t===0?t:+t;t=t.replace(xe,"");var n=De.test(t);return n||He.test(t)?je(t.slice(2),n?2:8):Be.test(t)?Ct:+t}var ze=qe;const Qe=dt(ze),Ze="/assets/main.ts-loader-tT2wjKZZ.js";async function tn(){return(await l.tabs.query({url:Rt[xt.TWITCH]})).filter(e=>e.url?Ce(e.url):!1)}function Kt(t){l.tabs.onUpdated.addListener(async(e,n,r)=>{n.status==="complete"&&e===t&&await l.scripting.executeScript({target:{tabId:t},files:[Ze]})})}async function en(t){const{autoMuteTabs:e,openTabsInBackground:n}=await M(["autoMuteTabs","openTabsInBackground"]),r=await l.tabs.create({url:`https://twitch.tv/${t.username}`,active:!n});e&&(l.tabs.update(r.id,{muted:!0}),Kt(r.id)),n||await new Promise(a=>{function i(s,c){c.status==="complete"&&s===r.id&&(a(),l.tabs.onUpdated.removeListener(i))}l.tabs.onUpdated.addListener(i),setTimeout(()=>{l.tabs.onUpdated.removeListener(i),a()},5e3)})}async function nn(t,e,n){const{autoMuteTabs:r,favorites:a,openTabsInBackground:i}=await M(["autoMuteTabs","favorites","openTabsInBackground"]);if((n?J(n,t,a):1)>0){const c=!i;await l.tabs.update(e.id,{url:`https://twitch.tv/${t.username}`,active:c||void 0}),r&&Kt(e.id),c&&await new Promise(p=>{setTimeout(p,5e3),l.tabs.onUpdated.addListener((o,u,f)=>{u.status==="complete"&&o===e.id&&p()})})}}async function rn(t){if(!await Se()){S("Tried to open Twitch tabs but did not have host permission for Twitch");return}const{favorites:n,maxStreams:r,autoMuteTabs:a,hiddenChannels:i}=await M(["favorites","maxStreams","autoMuteTabs","hiddenChannels"]);if(!r||!n)return;const s=t.filter(d=>d.type===$.TWITCH).filter(d=>!(i!=null&&i.twitch.map(g=>g.toLowerCase()).includes(d.username.toLowerCase()))).filter(d=>!!d.viewerCount&&pt(n,d)).sort((d,g)=>J(d,g,n)),c=await tn(),p=c.map(d=>Y(d.url)).filter(Boolean),o=c.filter(d=>d.url&&!Ee(d.url)).filter(d=>{var g;return(!a||((g=d.mutedInfo)==null?void 0:g.muted))&&!!Y(d.url)}).sort((d,g)=>{const b=s.find(_=>_.username===Y(d.url)),w=s.find(_=>_.username===Y(g.url));return b?w?J(b,w,n):-1:1}).reverse().slice(0,Number(r)),u=s.filter(d=>!p.includes(d.username)).slice(0,Number(r)),f=Math.max(0,Number(r)-c.length),h=u.slice(0,f),m=Math.min(u.length-f,o.length);for(let d=0;d<h.length;d++)await en(h[d]);for(let d=0;d<m;d++){const g=u[f+d],b=o[d],w=Y(b.url);if(w===g.username)continue;const _=s.find(L=>L.username===w);await nn(g,b,_)}}var St=1/0,Wt=9007199254740991,an=17976931348623157e292,Lt=NaN,sn="[object Function]",on="[object GeneratorFunction]",cn="[object Symbol]",un=/^\s+|\s+$/g,ln=/^[-+]0x[0-9a-f]+$/i,fn=/^0b[01]+$/i,dn=/^0o[0-7]+$/i,pn=/^(?:0|[1-9]\d*)$/,hn=parseInt,mn=Object.prototype,Xt=mn.toString,yn=Math.ceil,gn=Math.max;function wn(t,e,n){var r=-1,a=t.length;e<0&&(e=-e>a?0:a+e),n=n>a?a:n,n<0&&(n+=a),a=e>n?0:n-e>>>0,e>>>=0;for(var i=Array(a);++r<a;)i[r]=t[r+e];return i}function Tn(t,e){return e=e??Wt,!!e&&(typeof t=="number"||pn.test(t))&&t>-1&&t%1==0&&t<e}function bn(t,e,n){if(!Z(n))return!1;var r=typeof e;return(r=="number"?Cn(n)&&Tn(e,n.length):r=="string"&&e in n)?In(n[e],t):!1}function _n(t,e,n){(n?bn(t,e,n):e===void 0)?e=1:e=gn(kn(e),0);var r=t?t.length:0;if(!r||e<1)return[];for(var a=0,i=0,s=Array(yn(r/e));a<r;)s[i++]=wn(t,a,a+=e);return s}function In(t,e){return t===e||t!==t&&e!==e}function Cn(t){return t!=null&&Sn(t.length)&&!En(t)}function En(t){var e=Z(t)?Xt.call(t):"";return e==sn||e==on}function Sn(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=Wt}function Z(t){var e=typeof t;return!!t&&(e=="object"||e=="function")}function Ln(t){return!!t&&typeof t=="object"}function On(t){return typeof t=="symbol"||Ln(t)&&Xt.call(t)==cn}function Pn(t){if(!t)return t===0?t:0;if(t=vn(t),t===St||t===-St){var e=t<0?-1:1;return e*an}return t===t?t:0}function kn(t){var e=Pn(t),n=e%1;return e===e?n?e-n:e:0}function vn(t){if(typeof t=="number")return t;if(On(t))return Lt;if(Z(t)){var e=typeof t.valueOf=="function"?t.valueOf():t;t=Z(e)?e+"":e}if(typeof t!="string")return t===0?t:+t;t=t.replace(un,"");var n=fn.test(t);return n||dn.test(t)?hn(t.slice(2),n?2:8):ln.test(t)?Lt:+t}var Un=_n;const qt=dt(Un),et=t=>async(e,n)=>{const r=new URL(`${pe}${e}`);n.forEach(([s,c])=>{c&&r.searchParams.append(s,String(c))});const a=await fetch(r.href,{method:"GET",headers:{"Client-ID":Bt,Authorization:`Bearer ${t}`}}),i=await a.json();if(a.status>=400)throw i;return i};async function An(t,e){let n="";const r=[];do{const a=await et(t)("/channels/followed",[["user_id",e],["first",K],["after",n]]);n=a.pagination.cursor,r.push(...a.data)}while(n);return r}async function $n(t,e){const n=[];let r="";do{const a=await et(t)("/streams/followed",[["user_id",e],["first",K],["after",r]]);r=a.pagination.cursor,n.push(...a.data)}while(r);return n}async function Nn(t,e){const n=[];let r="";return await Promise.all(qt(e,K).map(async a=>{do{const i=await et(t)("/streams",[...a.map(s=>["user_login",s]),["first",K],["after",r]]);r=i.pagination.cursor,n.push(...i.data)}while(r)})),n}async function Rn(t,e,n){const[r,a]=await Promise.all([$n(t,e),Nn(t,n)]);return[...r,...a]}async function xn(t,e,n){const[r,a]=await Promise.all([An(t,e),Rn(t,e,n)]),i=new Set(r.map(u=>u.broadcaster_login.toLowerCase())),s=n.filter(u=>!i.has(u.toLowerCase())),c=[...r.map(u=>["id",u.broadcaster_id]),...s.map(u=>["login",u])];return(await Promise.all(qt(c,K).map(async u=>(await et(t)("/users",u)).data))).flat().map(u=>{const f=a.find(m=>m.user_id===u.id),h={type:$.TWITCH,username:u.login.toLowerCase(),displayName:u.display_name};return f&&(h.displayName=f.user_name,h.viewerCount=f.viewer_count,h.game=f.game_name,h.title=f.title,h.thumbnail=f.thumbnail_url,h.start=f.started_at),u&&(h.displayName=u.display_name,h.profilePic=u.profile_image_url),h})}function Bn(t){if(typeof t=="object"&&t&&"status"in t&&typeof t.status=="number"&&[400,401].includes(t.status))S(t),R("Logged out of Twitch account due to (assumed) invalid access token"),mt(T.TWITCH);else throw t}const Dn=()=>async(t,e=[])=>{const n=new URL(`${he}${t}`);e.forEach(([i,s])=>{s&&n.searchParams.append(i,String(s))});const r=await fetch(n.href,{method:"GET"}),a=await r.json();if(r.status>=400)throw a;return a};function Hn(t){return Promise.all(t.map(e=>Dn()(`/channels/${e}`)))}async function jn(t){return(await Hn(t)).map(n=>{var i,s,c,p;const r=n.livestream,a={type:$.KICK,username:n.user.username.toLowerCase(),profilePic:(i=n.user)==null?void 0:i.profile_pic,displayName:n.user.username};return r&&(a.viewerCount=r.viewer_count,a.category=(c=(s=r.categories)==null?void 0:s[0])==null?void 0:c.name,a.title=r.session_title,a.thumbnail=(p=r.thumbnail)==null?void 0:p.url,a.start=r.start_time),a})}var Mn="Expected a function",Vt="__lodash_hash_undefined__",Jt=1/0,Gn="[object Function]",Yn="[object GeneratorFunction]",Fn="[object Symbol]",Kn=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Wn=/^\w*$/,Xn=/^\./,qn=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Vn=/[\\^$.*+?()[\]{}|]/g,Jn=/\\(\\)?/g,zn=/^\[object .+?Constructor\]$/,Qn=typeof U=="object"&&U&&U.Object===Object&&U,Zn=typeof self=="object"&&self&&self.Object===Object&&self,yt=Qn||Zn||Function("return this")();function tr(t,e){return t==null?void 0:t[e]}function er(t){var e=!1;if(t!=null&&typeof t.toString!="function")try{e=!!(t+"")}catch{}return e}var nr=Array.prototype,rr=Function.prototype,zt=Object.prototype,it=yt["__core-js_shared__"],Ot=function(){var t=/[^.]+$/.exec(it&&it.keys&&it.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}(),Qt=rr.toString,gt=zt.hasOwnProperty,Zt=zt.toString,ar=RegExp("^"+Qt.call(gt).replace(Vn,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Pt=yt.Symbol,sr=nr.splice,ir=te(yt,"Map"),W=te(Object,"create"),kt=Pt?Pt.prototype:void 0,vt=kt?kt.toString:void 0;function x(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function or(){this.__data__=W?W(null):{}}function cr(t){return this.has(t)&&delete this.__data__[t]}function ur(t){var e=this.__data__;if(W){var n=e[t];return n===Vt?void 0:n}return gt.call(e,t)?e[t]:void 0}function lr(t){var e=this.__data__;return W?e[t]!==void 0:gt.call(e,t)}function fr(t,e){var n=this.__data__;return n[t]=W&&e===void 0?Vt:e,this}x.prototype.clear=or;x.prototype.delete=cr;x.prototype.get=ur;x.prototype.has=lr;x.prototype.set=fr;function G(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function dr(){this.__data__=[]}function pr(t){var e=this.__data__,n=nt(e,t);if(n<0)return!1;var r=e.length-1;return n==r?e.pop():sr.call(e,n,1),!0}function hr(t){var e=this.__data__,n=nt(e,t);return n<0?void 0:e[n][1]}function mr(t){return nt(this.__data__,t)>-1}function yr(t,e){var n=this.__data__,r=nt(n,t);return r<0?n.push([t,e]):n[r][1]=e,this}G.prototype.clear=dr;G.prototype.delete=pr;G.prototype.get=hr;G.prototype.has=mr;G.prototype.set=yr;function B(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function gr(){this.__data__={hash:new x,map:new(ir||G),string:new x}}function wr(t){return rt(this,t).delete(t)}function Tr(t){return rt(this,t).get(t)}function br(t){return rt(this,t).has(t)}function _r(t,e){return rt(this,t).set(t,e),this}B.prototype.clear=gr;B.prototype.delete=wr;B.prototype.get=Tr;B.prototype.has=br;B.prototype.set=_r;function nt(t,e){for(var n=t.length;n--;)if(Ar(t[n][0],e))return n;return-1}function Ir(t,e){e=Lr(e,t)?[e]:Sr(e);for(var n=0,r=e.length;t!=null&&n<r;)t=t[vr(e[n++])];return n&&n==r?t:void 0}function Cr(t){if(!ne(t)||Pr(t))return!1;var e=$r(t)||er(t)?ar:zn;return e.test(Ur(t))}function Er(t){if(typeof t=="string")return t;if(Tt(t))return vt?vt.call(t):"";var e=t+"";return e=="0"&&1/t==-Jt?"-0":e}function Sr(t){return ee(t)?t:kr(t)}function rt(t,e){var n=t.__data__;return Or(e)?n[typeof e=="string"?"string":"hash"]:n.map}function te(t,e){var n=tr(t,e);return Cr(n)?n:void 0}function Lr(t,e){if(ee(t))return!1;var n=typeof t;return n=="number"||n=="symbol"||n=="boolean"||t==null||Tt(t)?!0:Wn.test(t)||!Kn.test(t)||e!=null&&t in Object(e)}function Or(t){var e=typeof t;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?t!=="__proto__":t===null}function Pr(t){return!!Ot&&Ot in t}var kr=wt(function(t){t=Rr(t);var e=[];return Xn.test(t)&&e.push(""),t.replace(qn,function(n,r,a,i){e.push(a?i.replace(Jn,"$1"):r||n)}),e});function vr(t){if(typeof t=="string"||Tt(t))return t;var e=t+"";return e=="0"&&1/t==-Jt?"-0":e}function Ur(t){if(t!=null){try{return Qt.call(t)}catch{}try{return t+""}catch{}}return""}function wt(t,e){if(typeof t!="function"||e&&typeof e!="function")throw new TypeError(Mn);var n=function(){var r=arguments,a=e?e.apply(this,r):r[0],i=n.cache;if(i.has(a))return i.get(a);var s=t.apply(this,r);return n.cache=i.set(a,s),s};return n.cache=new(wt.Cache||B),n}wt.Cache=B;function Ar(t,e){return t===e||t!==t&&e!==e}var ee=Array.isArray;function $r(t){var e=ne(t)?Zt.call(t):"";return e==Gn||e==Yn}function ne(t){var e=typeof t;return!!t&&(e=="object"||e=="function")}function Nr(t){return!!t&&typeof t=="object"}function Tt(t){return typeof t=="symbol"||Nr(t)&&Zt.call(t)==Fn}function Rr(t){return t==null?"":Er(t)}function xr(t,e,n){var r=t==null?void 0:Ir(t,e);return r===void 0?n:r}var Br=xr;const E=dt(Br),ft=t=>async(e,n)=>{const r=new URL(`${me}${e}`);n.forEach(([c,p])=>{p&&r.searchParams.append(c,String(p))});const a={};"apiKey"in t&&(a["X-GOOG-API-KEY"]=t.apiKey),"clientId"in t&&(a["Client-ID"]=t.clientId),"accessToken"in t&&(a.Authorization=`Bearer ${t.accessToken}`);const i=await fetch(r.href,{method:"GET",headers:a}),s=await i.json();if(i.status>=400)throw s;return s},ot=new Map;async function Ut(t){let e;const{addedChannels:n}=t;if("accessToken"in t){const o=await Ft({clientId:t.clientId,clientSecret:t.clientSecret,accessToken:t.accessToken,refreshToken:t.refreshToken,expiry:t.expiry});e=ft({clientId:t.clientId,accessToken:o.accessToken})}else e=ft({apiKey:t.apiKey});const a=(await Promise.all(n.map(async o=>{var _,L,D,v,y,I,C,O;if(ot.has(o))return ot.get(o);let u=await e("/channels",[["part","snippet,id,contentDetails"],["forUsername",o]]);u.items||(u=await e("/channels",[["part","snippet,id,contentDetails"],["id",o]]));const f=(_=u.items)==null?void 0:_[0];if(!f)return null;const h=f.id,m=(D=(L=f.contentDetails)==null?void 0:L.relatedPlaylists)==null?void 0:D.uploads,d=(v=f.snippet)==null?void 0:v.title,g=(y=f.snippet)==null?void 0:y.customUrl,b=(O=(C=(I=f.snippet)==null?void 0:I.thumbnails)==null?void 0:C.default)==null?void 0:O.url;if(!m||!h||!g||!d)return null;const w={type:$.YOUTUBE,id:h,manualInputQuery:o,uploadsPlaylist:m,customUrl:g,displayName:d,profilePic:b};return ot.set(o,w),w}))).filter(ct),s=(await Promise.all(a.map(async o=>{var u;if(!o.uploadsPlaylist)return[];try{return(u=(await e("/playlistItems",[["part","snippet,contentDetails"],["playlistId",o.uploadsPlaylist],["maxResults",Mt]])).items)==null?void 0:u.filter(h=>E(h,"snippet.thumbnails.default.url","").includes("default_live")).map(h=>{var m;return(m=h.contentDetails)==null?void 0:m.videoId}).filter(ct)}catch(f){if(E(f,"error.code")!==404)throw f}return[]}))).flat().join(","),c=s?await e("/videos",[["part","snippet,id,liveStreamingDetails"],["id",s]]):{items:[]};return a.map(o=>{var u;try{const h=(((u=c.items)==null?void 0:u.filter(m=>{var d,g;return((d=m.snippet)==null?void 0:d.channelId)===o.id&&((g=m.snippet)==null?void 0:g.liveBroadcastContent)==="live"}))??[]).map(m=>{const d=Number(E(m,"liveStreamingDetails.concurrentViewers","0")),g=E(m,"snippet.thumbnails.high.url",E(m,"snippet.thumbnails.default.url")),b=E(m,"liveStreamingDetails.actualStartTime"),w=E(m,"snippet.title"),_=m.id;return{...o,viewerCount:d,thumbnail:g,start:b,title:w,videoId:_}});return h.length>0?h:[o]}catch(f){return S(f),[o]}}).flat()}async function re(t){const e=t.clientId||Dt,n=await Ft({clientId:e,clientSecret:t.clientSecret,accessToken:t.accessToken,refreshToken:t.refreshToken,expiry:t.expiry}),r=ft({accessToken:n.accessToken,clientId:e}),a=[];let i;do{const s=await r("/subscriptions",[["part","snippet,contentDetails"],["mine","true"],["maxResults",Mt],["pageToken",i]]);s.items&&a.push(...s.items.map(c=>{const p=E(c,"snippet.resourceId.channelId",""),o=E(c,"snippet.title","");return p&&o?{channelId:p,displayName:o}:null}).filter(ct)),i=s.nextPageToken}while(i);return A({youtubeSubscriptions:{fetchTime:Date.now()/1e3,subscriptions:a}},k.LOCAL),a}async function Dr(t){var r;const n=(r=(await N(k.LOCAL)).youtubeSubscriptions)==null?void 0:r.fetchTime;return n==null||Date.now()/1e3-n>ye?re(t):null}function Hr(t){S(t);const e=E(t,"error.status");e&&["UNAUTHENTICATED","PERMISSION_DENIED"].includes(e)&&(R("Logged out of YouTube account due to (assumed) invalid access token"),mt(T.YOUTUBE),l.notifications.create("youtube-logged-out",{title:"YouTube needs to be reauthenticated",message:"Your authentication token was likely revoked. You need to log into YouTube again.",type:"basic",iconUrl:"icons/icon128.png"}))}const j=tt(k.SYNCED);function At(t){const{hiddenChannels:e,favorites:n}=j;return t.filter(r=>!(r.type===$.TWITCH&&(e!=null&&e.twitch.map(a=>a.toLowerCase()).includes(le(r))))).filter(r=>r.viewerCount!=null&&pt(n,r)).sort((r,a)=>J(r,a,n))}l.notifications.onClicked.addListener(async t=>{const{mostRecentChannels:e}=await N(k.LOCAL),n=e==null?void 0:e.channels.find(r=>t===q(r));n&&l.tabs.create({url:Nt(n),active:!0})});async function jr(t){return!!(await l.tabs.query({})).some(n=>n.url&&n.url===Nt(t))}async function Mr(t,e){const{notifications:n}=j;if(n){const r=At(t),i=At(e)[0];i&&(!r[0]||q(i)!==q(r[0]))&&(await jr(i)||await l.notifications.create(q(i),{title:`${i.displayName} is live!`,message:"Click to view their stream.",type:"basic",iconUrl:"icons/icon128.png"}))}}async function F(){const{favorites:t,hiddenChannels:e}=await N(),{mostRecentChannels:n}=await N(k.LOCAL),a=((n==null?void 0:n.channels)||[]).filter(c=>{const p=c.type===$.TWITCH&&(e==null?void 0:e.twitch.map(u=>u.toLowerCase()).includes(c.username.toLowerCase())),o=c.type===$.YOUTUBE&&(e==null?void 0:e.youtube.includes(c.manualInputQuery.toLowerCase()));return!p&&!o}),i=a.some(c=>c.viewerCount!=null&&pt(t,c)),s=a.reduce((c,p)=>c+(p.viewerCount!=null?1:0),0);await l.action.setBadgeText({text:String(s)}),await l.action.setBadgeBackgroundColor({color:i?ge:ht})}async function bt(t){const{mostRecentChannels:e}=await N(k.LOCAL);Mr((e==null?void 0:e.channels)||[],t),await A({mostRecentChannels:{fetchTime:Date.now()/1e3,channels:t}},k.LOCAL),l.runtime.sendMessage({type:P.SEND_CHANNELS,data:t}).catch(n=>{R(n)}),F()}async function ae(){var p;R("Fetching data",new Date().toISOString());const{logins:t,addedChannels:e,autoOpenTabs:n}=j,r=t==null?void 0:t.find(o=>o.type===T.TWITCH),a=t==null?void 0:t.find(o=>o.type===T.YOUTUBE_API_KEY),i=t==null?void 0:t.find(o=>o.type===T.KICK);let s=V(j);const c=[];if(r)try{const o=await xn(r.accessToken,r.userId,(e==null?void 0:e.twitch)||[]);c.push(...o)}catch(o){Bn(o)}if(i)try{const o=await jn((e==null?void 0:e.kick)||[]);c.push(...o)}catch(o){S(o)}if(a||s)try{const o=s!=null&&s.clientId&&(s!=null&&s.clientSecret)?{accessToken:s.accessToken,refreshToken:s.refreshToken,clientId:s.clientId,clientSecret:s.clientSecret,expiry:s.expiry,addedChannels:(e==null?void 0:e.youtube)||[]}:a?{apiKey:a==null?void 0:a.apiKey,addedChannels:(e==null?void 0:e.youtube)||[]}:null;if(o)try{const u=await Ut(o);c.push(...u)}catch(u){if(S(u),a&&"accessToken"in o){R("Using YouTube API Key as fallback");const f=await Ut({apiKey:a.apiKey,addedChannels:o.addedChannels});c.push(...f)}else throw u}}catch(o){Hr(o)}await bt(c),s=V(j),s&&((p=Dr(s))==null||p.catch(S)),n&&rn(c)}async function se(){const{logins:t,enabled:e,pollDelay:n}=await N(),r=!!await l.alarms.get(H);await l.alarms.clear(H),e&&t&&ue(t)?(r||ae(),await l.alarms.create(H,{delayInMinutes:Number(n)})):await bt([])}const at=Qe(se,3e3);async function $t(){await l.alarms.clear(H),at()}function Gr(){X([{key:"logins",cb:$t},{key:"pollDelay",cb:at},{key:"addedChannels",cb:$t}]),X([{key:"enabled",cb:t=>{t?se():(l.alarms.clear(H),bt([]))}}]),X([{key:"favorites",cb:F},{key:"hiddenChannels",cb:F}]),X([{key:"mostRecentChannels",cb:F}])}function Yr(){l.alarms.onAlarm.addListener(t=>{switch(t.name){case H:{at();break}}}),l.runtime.onMessage.addListener(async t=>{switch(t.type){case P.FORCE_FETCH_CHANNELS:{ae();break}case P.GET_CHANNELS:{const{mostRecentChannels:e}=await N(k.LOCAL);l.runtime.sendMessage({type:P.SEND_CHANNELS,data:(e==null?void 0:e.channels)||[]}).catch(n=>{R(n)});break}case P.FETCH_YOUTUBE_SUBSCRIPTIONS:{const e=V(j);e&&re(e);break}}})}function Fr(){Yr(),Gr(),F(),at()}l.action.setBadgeBackgroundColor({color:ht});l.action.setBadgeTextColor&&l.action.setBadgeTextColor({color:we});$e();Fr();l.runtime.onInstalled.addListener(()=>{l.contextMenus.create({id:"Browser Action",title:"Open Full Page Viewer",contexts:["action"]},()=>{l.runtime.lastError&&S(l.runtime.lastError)}),l.contextMenus.create({id:"Request Host Permissions",title:"Request Host Permissions",contexts:["action"]},()=>{l.runtime.lastError&&S(l.runtime.lastError)})});l.contextMenus.onClicked.addListener(async t=>{switch(t.menuItemId){case"Browser Action":{const e=l.runtime.getURL("/src/ui/pages/fullscreen.html");await l.tabs.create({url:e,active:!0});break}case"Request Host Permissions":{await fe();break}}});
